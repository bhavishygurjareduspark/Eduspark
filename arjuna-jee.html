<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EduSparK - Admin Account Deletion Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg-dark: #121212; --card-bg: #1e1e1e; --text-light: #f1f2f6; --text-muted: #a4b0be;
            --primary: #ff3333; --primary-light: #ff6666; --danger: #e74c3c; --success: #27ae60;
            --border-color: rgba(255, 255, 255, 0.1); --border-radius: 8px;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-dark); color: var(--text-light); margin: 0; padding: 20px;
            font-size: 16px; line-height: 1.6;
        }
        .container { max-width: 900px; margin: 0 auto; background-color: var(--card-bg); padding: 25px; border-radius: var(--border-radius); border: 1px solid var(--border-color); }
        h1, h2 { color: var(--primary-light); border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; }
        input[type="email"], input[type="password"], input[type="text"], textarea {
            width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px;
            background-color: var(--bg-dark); color: var(--text-light); box-sizing: border-box; font-size: 1rem;
        }
        input:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(255, 51, 51, 0.3); }
        button {
            padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;
            font-size: 1rem; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-light); }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #ff4757; }
        button:disabled { background-color: #555; cursor: not-allowed; opacity: 0.7; }
        .hidden { display: none !important; }
        #logContainer {
            margin-top: 20px; padding: 15px; background-color: var(--bg-dark); border-radius: 4px;
            border: 1px solid var(--border-color); max-height: 300px; overflow-y: auto; white-space: pre-wrap;
            font-family: "Courier New", Courier, monospace; font-size: 0.9rem;
        }
        .log-error { color: var(--danger); }
        .log-success { color: var(--success); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background-color: rgba(255, 255, 255, 0.05); }
        #resultsTableBody tr:hover { background-color: rgba(255, 255, 255, 0.03); }
        .spinner {
            display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .info-box { padding: 15px; background-color: rgba(243, 156, 18, 0.1); border-left: 4px solid #f39c12; border-radius: 4px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>EduSparK - Admin Account Deletion Tool</h1>

        <!-- Login Section -->
        <div id="loginSection">
            <h2>Admin Login</h2>
            <div class="info-box">
                <strong>Important:</strong> You must first mark your account as an admin in the Firestore database.
                <ol>
                    <li>Go to your Firebase Console -> Firestore Database.</li>
                    <li>Navigate to the `users` collection.</li>
                    <li>Find your own user document (by your UID).</li>
                    <li>Add a new field: `isAdmin` (Type: Boolean) and set it to `true`.</li>
                </ol>
            </div>
            <div class="form-group">
                <label for="adminEmail">Admin Email</label>
                <input type="email" id="adminEmail" placeholder="your-admin-email@example.com">
            </div>
            <div class="form-group">
                <label for="adminPassword">Admin Password</label>
                <input type="password" id="adminPassword" placeholder="••••••••">
            </div>
            <button class="btn-primary" id="loginBtn">Login</button>
        </div>

        <!-- Admin Tool Section -->
        <div id="adminToolSection" class="hidden">
            <h2>Find and Delete Spam Accounts</h2>
            <div class="info-box" style="border-left-color: var(--danger); background-color: rgba(231, 76, 60, 0.1);">
                <strong>DANGER ZONE:</strong> Deleting accounts is permanent and cannot be undone. This will remove the user from Authentication and delete their data from the `users` collection in Firestore. Double-check your selections.
            </div>
            <div class="form-group">
                <label for="usernamePrefix">Search by Username Prefix</label>
                <input type="text" id="usernamePrefix" placeholder="e.g., beastx">
            </div>
            <button class="btn-primary" id="searchBtn">Find Accounts</button>
            <hr style="border-color: var(--border-color); margin: 25px 0;">

            <div id="resultsSection" class="hidden">
                <h3 id="resultsHeader">Found Accounts (0)</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button id="selectAllBtn">Select All</button>
                    <button id="deselectAllBtn">Deselect All</button>
                </div>
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color);">
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllCheckboxHeader"></th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>UID</th>
                                <th>Created At</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <!-- Results will be injected here -->
                        </tbody>
                    </table>
                </div>
                <button class="btn-danger" id="deleteBtn" style="margin-top: 20px;" disabled>
                    Delete Selected Accounts
                </button>
            </div>
        </div>

        <div id="logContainer">Welcome. Please log in as an administrator.</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-functions.js"></script>

    <script>
        const $ = (selector) => document.querySelector(selector);

        // --- DOM Elements ---
        const loginSection = $('#loginSection');
        const adminToolSection = $('#adminToolSection');
        const loginBtn = $('#loginBtn');
        const searchBtn = $('#searchBtn');
        const deleteBtn = $('#deleteBtn');
        const selectAllBtn = $('#selectAllBtn');
        const deselectAllBtn = $('#deselectAllBtn');
        const selectAllCheckboxHeader = $('#selectAllCheckboxHeader');
        const logContainer = $('#logContainer');
        const resultsSection = $('#resultsSection');
        const resultsTableBody = $('#resultsTableBody');
        const resultsHeader = $('#resultsHeader');

        // --- Firebase Config ---
        // IMPORTANT: Replace this with your actual Firebase project configuration.
        // This is the same config from your books.html file.
        const firebaseConfig = {
          apiKey: "AIzaSyBNi6BHTKNd62VAY7q1oHQmxjZ3r0MUA9U",
          authDomain: "edusparkk.xyz",
          projectId: "eduspark-new",
          storageBucket: "eduspark-new.firebasestorage.app",
          messagingSenderId: "564501033350",
          appId: "1:564501033350:web:70c0f9873f96e9bd74fc07",
          measurementId: "G-NM2SE3DE7J"
        };

        // --- Firebase Services ---
        let app, auth, db, functions, adminDeleteUsers;

        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            if (type === 'error') entry.classList.add('log-error');
            if (type === 'success') entry.classList.add('log-success');
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function toggleSpinner(btn, show = true) {
            if (show) {
                btn.disabled = true;
                btn.dataset.originalText = btn.innerHTML;
                btn.innerHTML = '<span class="spinner"></span> Working...';
            } else {
                btn.disabled = false;
                btn.innerHTML = btn.dataset.originalText || 'Action';
            }
        }

        function initializeFirebase() {
            try {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                functions = firebase.functions();
                adminDeleteUsers = functions.httpsCallable('adminDeleteUsers');
                log("Firebase initialized successfully.", "success");
            } catch (error) {
                log(`Firebase initialization failed: ${error.message}`, "error");
                console.error(error);
            }
        }
        
        async function handleLogin() {
            const email = $('#adminEmail').value;
            const password = $('#adminPassword').value;

            if (!email || !password) {
                log("Email and password are required.", "error");
                return;
            }

            toggleSpinner(loginBtn, true);
            log("Attempting to log in as admin...");
            try {
                await auth.signInWithEmailAndPassword(email, password);
                const user = auth.currentUser;
                if (user) {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists && userDoc.data().isAdmin === true) {
                        log(`Login successful. Welcome, admin ${user.email}.`, "success");
                        loginSection.classList.add('hidden');
                        adminToolSection.classList.remove('hidden');
                    } else {
                        log("Login failed: This account is not an administrator.", "error");
                        await auth.signOut();
                    }
                }
            } catch (error) {
                log(`Login failed: ${error.message}`, "error");
            } finally {
                toggleSpinner(loginBtn, false);
            }
        }

        async function findAccounts() {
            const prefix = $('#usernamePrefix').value.trim();
            if (prefix.length < 3) {
                log("Please enter a username prefix of at least 3 characters.", "error");
                return;
            }

            toggleSpinner(searchBtn, true);
            log(`Searching for users with prefix: "${prefix}"...`);
            resultsTableBody.innerHTML = '';
            resultsSection.classList.add('hidden');
            deleteBtn.disabled = true;

            try {
                const result = await adminDeleteUsers({ action: 'find', prefix: prefix });
                const users = result.data.users;
                
                log(`Found ${users.length} matching accounts.`, "success");
                resultsHeader.textContent = `Found Accounts (${users.length})`;
                
                if (users.length > 0) {
                    populateResultsTable(users);
                    resultsSection.classList.remove('hidden');
                }
            } catch (error) {
                log(`Error finding accounts: ${error.message}`, "error");
            } finally {
                toggleSpinner(searchBtn, false);
            }
        }
        
        function populateResultsTable(users) {
            resultsTableBody.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="user-checkbox" data-uid="${user.uid}"></td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>${user.uid}</td>
                    <td>${new Date(user.createdAt).toLocaleString()}</td>
                `;
                resultsTableBody.appendChild(row);
            });
        }

        async function deleteSelectedAccounts() {
            const checkboxes = document.querySelectorAll('.user-checkbox:checked');
            const uidsToDelete = Array.from(checkboxes).map(cb => cb.dataset.uid);

            if (uidsToDelete.length === 0) {
                log("No accounts selected for deletion.", "error");
                return;
            }

            const confirmation = confirm(`ARE YOU SURE?\n\nYou are about to permanently delete ${uidsToDelete.length} accounts. This action cannot be undone.`);
            if (!confirmation) {
                log("Deletion cancelled by user.");
                return;
            }
            
            toggleSpinner(deleteBtn, true);
            log(`Starting deletion of ${uidsToDelete.length} accounts...`);
            
            try {
                const result = await adminDeleteUsers({ action: 'delete', uids: uidsToDelete });
                const { successCount, failureCount, errors } = result.data;
                log(`Deletion complete. Success: ${successCount}, Failed: ${failureCount}.`, failureCount > 0 ? "error" : "success");
                if (errors && errors.length > 0) {
                    errors.forEach(err => log(`- Failure reason: ${err}`, "error"));
                }
                // Refresh the list
                await findAccounts();
            } catch (error) {
                log(`A critical error occurred during deletion: ${error.message}`, "error");
            } finally {
                toggleSpinner(deleteBtn, false);
            }
        }
        
        function updateDeleteButtonState() {
            const anyChecked = document.querySelectorAll('.user-checkbox:checked').length > 0;
            deleteBtn.disabled = !anyChecked;
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', initializeFirebase);
        loginBtn.addEventListener('click', handleLogin);
        searchBtn.addEventListener('click', findAccounts);
        deleteBtn.addEventListener('click', deleteSelectedAccounts);

        resultsTableBody.addEventListener('change', (e) => {
            if (e.target.classList.contains('user-checkbox')) {
                updateDeleteButtonState();
            }
        });
        
        selectAllCheckboxHeader.addEventListener('click', (e) => {
            const isChecked = e.target.checked;
            document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = isChecked);
            updateDeleteButtonState();
        });
        
        selectAllBtn.addEventListener('click', () => {
             document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = true);
             selectAllCheckboxHeader.checked = true;
             updateDeleteButtonState();
        });
        
        deselectAllBtn.addEventListener('click', () => {
             document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = false);
             selectAllCheckboxHeader.checked = false;
             updateDeleteButtonState();
        });

    </script>
</body>
</html>
