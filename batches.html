<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
      content="default-src 'self' https://*.firebaseio.com https://*.firebasedatabase.app https://*.googleapis.com https://*.gstatic.com https://cdnjs.cloudflare.com https://unpkg.com https://cdn.jsdelivr.net;
               script-src 'self' 'unsafe-inline' https://www.gstatic.com/firebasejs/ https://unpkg.com https://cdn.jsdelivr.net https://www.google.com/recaptcha/api.js https://*.google.com https://www.gstatic.com/recaptcha/;
               style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com https://unpkg.com;
               font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com;
               img-src 'self' data: blob: https: http://via.placeholder.com https://firebasestorage.googleapis.com;
               connect-src 'self' wss://*.firebaseio.com https://*.googleapis.com https://*.firebaseio.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://firestore.googleapis.com https://firebaseinstallations.googleapis.com https://firebasestorage.googleapis.com https://firebaseappcheck.googleapis.com;
               object-src 'none';
               base-uri 'self';
               form-action 'self';
               frame-src 'self' https://www.google.com/recaptcha/ https://*.google.com;">
    <title>EduSparK - Explore Batches</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
  <script src="https://www.google.com/recaptcha/enterprise.js?render=6Lf781IrAAAAAKUivV71zU3gRGRX2pSwvJbsR4zx"></script>
  <!-- Your code -->

    <style>
        :root {
            --primary-color: #ff3333; /* EduSparK Red */
            --primary-light: #ff6666;
            --primary-dark: #cc0000;
            --secondary-color: #000000; /* Dark Theme Secondary */
            --secondary-light: #2a2a2a;
            --secondary-dark: #000000;
            --text-light: #f1f2f6;
            --text-dark: #dfe4ea;
            --text-muted: #a4b0be;
            --bg-light: #1e1e1e;
            --bg-dark: #121212;
            --card-bg: #212121;
            --card-bg-dark: #1a1a1a;
            --gradient: linear-gradient(135deg, #ff3333, #cc0000);
            --gradient-light: linear-gradient(135deg, #ff6666, #ff3333);
            --shadow-sm: 0 2px 5px rgba(0, 0, 0, 0.35);
            --shadow-md: 0 6px 12px rgba(0, 0, 0, 0.4);
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --header-height: 70px;
            --nav-height: 70px;
            --max-width: 1200px;
            --skeleton-bg: #303030;
            --skeleton-highlight: #404040;
            --profile-header-bg: linear-gradient(135deg, rgba(30, 30, 30, 0.9), rgba(18, 18, 18, 0.98));
            --notification-unread-dot: #3498db;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Poppins', sans-serif; background-color: var(--bg-dark); color: var(--text-dark);
            min-height: 100vh; padding-top: var(--header-height); padding-bottom: var(--nav-height);
            line-height: 1.6; overflow-x: hidden;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-dark); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.7s ease, visibility 0.7s ease; opacity: 1; visibility: visible; }
        .loading-overlay.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .loading-logo-container { display: flex; align-items: center; margin-bottom: 25px; animation: logoPulse 2s infinite ease-in-out; }
        .loading-logo-icon { font-size: 3.5rem; color: var(--primary-color); margin-right: 15px; }
        .loading-logo-text { font-size: 2.2rem; font-weight: 700; color: var(--primary-light); letter-spacing: 1px; }
        .loading-dots { display: flex; justify-content: center; align-items: center; margin-bottom: 30px; }
        .loading-dots span { width: 12px; height: 12px; margin: 0 6px; background-color: var(--primary-color); border-radius: 50%; animation: loadingBounce 1.4s infinite ease-in-out both; }
        .loading-dots span:nth-child(1) { animation-delay: -0.32s; } .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        .loading-message { color: var(--text-muted); font-size: 1rem; min-height:1.2em; text-align:center; width:80%;}
        @keyframes logoPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes loadingBounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        .header { background-color: rgba(18, 18, 18, 0.85); backdrop-filter: blur(15px) saturate(180%); color: var(--text-light); height: var(--header-height); display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-md); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; padding: 0 20px; transition: height 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease; border-bottom: 1px solid rgba(255, 51, 51, 0.1); }
        .header.scrolled { height: 65px; background-color: rgba(18, 18, 18, 0.95); box-shadow: 0 6px 25px rgba(0, 0, 0, 0.25); }
        .logo-container { display: flex; align-items: center; }
        .logo { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); display: flex; align-items: center; text-decoration: none; transition: transform 0.3s ease; }
        .logo:hover { transform: scale(1.05); }
        .logo i { margin-right: 10px; font-size: 1.6rem; }
        .header-actions { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; display: flex; align-items: center; justify-content: center; background: var(--gradient); color: white; font-weight: 600; font-size: 1rem; }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%;}
        .user-avatar:hover { transform: scale(1.1); box-shadow: 0 0 15px rgba(255, 51, 51, 0.5); }

        .search-container { position: relative; width: 250px; transition: all 0.3s ease; margin-left: auto; margin-right: 10px; }
        .search-input { width: 100%; padding: 10px 15px 10px 40px; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 30px; background-color: rgba(255, 255, 255, 0.05); color: var(--text-light); font-family: 'Poppins', sans-serif; transition: all 0.3s ease; font-size: 0.9rem; }
        .search-input::placeholder { color: rgba(255, 255, 255, 0.5); }
        .search-input:focus { outline: none; background-color: rgba(255, 255, 255, 0.1); box-shadow: 0 0 0 2px var(--primary-light); border-color: var(--primary-light); }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-light); opacity: 0.6; font-size: 1rem; }
        .search-results { position: absolute; top: calc(100% + 8px); left: 0; right: 0; background-color: var(--card-bg); border-radius: var(--border-radius-sm); box-shadow: var(--shadow-md); max-height: 300px; overflow-y: auto; z-index: 1001; display: none; border: 1px solid rgba(255,255,255,0.1); }
        .search-result-item { padding: 10px 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); cursor: pointer; transition: background-color 0.2s ease; }
        .search-result-item:hover { background-color: rgba(255, 255, 255, 0.08); }
        .search-result-item h4 { font-size: 0.9rem; color: var(--text-dark); margin-bottom: 3px; }
        .search-result-item p { font-size: 0.75rem; color: var(--text-muted); }
        .no-results { padding: 15px; text-align: center; color: var(--text-muted); font-size: 0.85rem; }
        .search-toggle-btn { background: none; border: none; color: var(--text-light); font-size: 1.2rem; cursor: pointer; padding: 5px; display: none; }
         @media (max-width: 768px) { .search-container { position: absolute; top: calc(var(--header-height) + 10px); left: 10px; right: 10px; width: auto; z-index: 999; background-color: var(--bg-light); padding: 10px; border-radius: var(--border-radius-sm); box-shadow: var(--shadow-md); opacity: 0; visibility: hidden; transform: translateY(-10px); transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease; } .search-container.active { opacity: 1; visibility: visible; transform: translateY(0); } .search-toggle-btn { display: block; order: -1; margin-right: 5px; } }
         @media (max-width: 420px) { .logo-text { font-size: 1.5rem; } .logo i { margin-right: 5px; } }

        .container { padding: 20px; max-width: var(--max-width); margin: 0 auto; }
        .page-title { font-size: 2rem; margin-bottom: 25px; color: var(--primary-color); text-align: center; }

        .batches-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; margin-top: 20px; }
        .batch-card { background-color: var(--card-bg); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow-md); transition: var(--transition); border: 1px solid rgba(255, 255, 255, 0.08); display: flex; flex-direction: column; position: relative; }
        .batch-card:hover { transform: translateY(-10px) scale(1.03); box-shadow: 0 10px 20px rgba(0,0,0,0.6), 0 0 15px rgba(255,51,51,0.3); }
        .batch-img-container { width: 100%; padding-top: 56.25%; /* 16:9 Aspect Ratio */ position: relative; background-color: var(--skeleton-bg); overflow: hidden;}
        .batch-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .batch-card:hover .batch-img { transform: scale(1.1); }
        .batch-price-tag { position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); color: var(--primary-light); padding: 6px 12px; border-radius: var(--border-radius-sm); font-size: 0.9rem; font-weight: 600; z-index: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .batch-enroll-status { position: absolute; top: 12px; left: 12px; background-color: #2ecc71; color: white; padding: 6px 14px; border-radius: var(--border-radius-sm); font-size: 0.85rem; font-weight: 600; z-index: 1; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 5px rgba(46,204,113,0.3); }
        .batch-info { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .batch-name { font-size: 1.3rem; font-weight: 600; color: var(--primary-light); margin-bottom: 15px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; min-height: 2.6em; line-height: 1.3; }
        .batch-description-items { margin-bottom: 18px; font-size: 0.9rem; color: var(--text-muted); }
        .batch-desc-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px dashed rgba(255,255,255,0.1); }
        .batch-desc-item:last-child { border-bottom: none; }
        .batch-desc-item .label { font-weight: 500; color: var(--text-dark); display: flex; align-items: center; gap: 6px;}
        .batch-desc-item .label i { color: var(--primary-light); font-size: 0.9em; opacity: 0.8;}
        .batch-desc-item .value { color: var(--primary-light); text-align: right; }
        .batch-action-btn { background: var(--gradient); color: white; border: none; padding: 12px 20px; border-radius: var(--border-radius-sm); cursor: pointer; transition: var(--transition); font-weight: 500; font-size: 1rem; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: auto; text-decoration: none; }
        .batch-action-btn:hover { background: var(--gradient-light); transform: translateY(-3px); box-shadow: 0 6px 12px rgba(255,51,51,0.4); }
        .batch-action-btn:disabled { background: var(--secondary-light); opacity: 0.6; cursor: not-allowed; }
        .batch-card.batch-card-highlighted { /* For JS search result highlight */
            outline: 3px solid var(--primary-color);
            box-shadow: 0 0 25px var(--primary-light) !important; 
            transition: outline 0.4s ease-out, box-shadow 0.4s ease-out;
        }

        .skeleton-batch-card .batch-img-container { background-color: var(--skeleton-bg); animation: pulse-bg 1.5s infinite; }
        .skeleton-batch-card .batch-name { width: 80%; height: 1.5em; background-color: var(--skeleton-bg); animation: pulse-bg 1.5s infinite; margin-bottom: 15px; border-radius:4px; }
        .skeleton-batch-card .batch-desc-item { height: 1em; background-color: var(--skeleton-bg); animation: pulse-bg 1.5s infinite; margin-bottom:8px; border-radius:4px;}
        .skeleton-batch-card .batch-action-btn { height: 40px; background-color: var(--skeleton-bg); animation: pulse-bg 1.5s infinite; margin-top:20px; border-radius:var(--border-radius-sm);}
        @keyframes pulse-bg { 0% { background-color: var(--skeleton-bg); } 50% { background-color: var(--skeleton-highlight); } 100% { background-color: var(--skeleton-bg); } }

        .support-page { display: flex; flex-direction: column; height: calc(100vh - var(--header-height) - var(--nav-height)); background-color: var(--bg-light); border-radius: var(--border-radius); margin:20px auto; max-width: var(--max-width); padding: 0;}
        .support-header { background-color: var(--card-bg); padding: 15px 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        .support-header h2 { color: var(--primary-light); font-size: 1.5rem; margin:0; }
        .support-header-meta { font-size:0.8rem; color:var(--text-muted); margin-top:2px; text-align:left; }
        .faq-btn { background-color: transparent; border: 1px solid var(--primary-color); color: var(--primary-color); padding: 6px 12px; border-radius: var(--border-radius-sm); font-size: 0.85rem; cursor: pointer; transition: background-color 0.3s, color 0.3s;}
        .faq-btn:hover { background-color: var(--primary-color); color: white; }
        .chat-area { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        .chat-message { max-width: 75%; padding: 10px 15px; margin-bottom: 10px; border-radius: var(--border-radius); line-height: 1.5; word-break: break-word; animation: messageAppear 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); }
        .chat-message.user { background-color: var(--primary-color); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-message.admin { background-color: var(--card-bg-dark); color: var(--text-dark); align-self: flex-start; border-bottom-left-radius: 4px; }
        .chat-message.system { background-color: var(--secondary-light); color: var(--text-muted); align-self: center; font-size:0.8rem; padding: 5px 10px; max-width:90%; text-align:center;}
        @keyframes messageAppear { to { opacity: 1; transform: translateY(0); } }
        .message-meta { font-size: 0.7rem; color: rgba(255,255,255,0.6); margin-top: 5px; text-align: right; }
        .chat-message.admin .message-meta { text-align: left; }
        .support-input-area { display: flex; flex-direction:column; padding: 15px; border-top: 1px solid rgba(255,255,255,0.1); background-color: var(--card-bg); }
        .support-input-wrapper {display:flex;}
        .support-input { flex-grow: 1; padding: 12px 15px; border: 1px solid rgba(255,255,255,0.15); border-radius: var(--border-radius-sm); background-color: var(--bg-light); color: var(--text-dark); font-size: 0.95rem; }
        .support-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(255,51,51,0.2); }
        .send-support-btn { background: var(--gradient); color: white; border: none; padding: 0 20px; margin-left: 10px; border-radius: var(--border-radius-sm); cursor: pointer; font-size: 1.1rem; transition: background-color 0.3s, transform 0.2s;}
        .send-support-btn:hover { background: var(--gradient-light); transform: scale(1.05); }
        .quick-responses-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .quick-response-btn { background-color: var(--secondary-light); color: var(--text-light); border: 1px solid rgba(255,255,255,0.1); padding: 6px 10px; border-radius: var(--border-radius-sm); font-size: 0.8rem; cursor: pointer; transition: background-color 0.3s, border-color 0.3s, transform 0.2s; }
        .quick-response-btn:hover { background-color: var(--primary-light); color:white; border-color:var(--primary-light); transform: translateY(-2px); }

        .profile-page { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-dark); z-index: 2000; transform: translateX(100%); transition: transform 0.5s cubic-bezier(0.645, 0.045, 0.355, 1), opacity 0.5s ease; overflow-y: auto; padding-top: var(--header-height); padding-bottom: calc(var(--nav-height) + 20px); opacity:0; visibility: hidden; }
        .profile-page.active { transform: translateX(0); opacity:1; visibility: visible;}
        .profile-page-content { padding: 20px; max-width: var(--max-width); margin: 0 auto;}
        .page-back-btn { background: rgba(0,0,0,0.4); border:none; color: var(--primary-light); font-size: 1.3rem; position: absolute; left: 15px; top: calc(var(--header-height) - 55px); /* Adjusted to be inside profile-page but aligned with header space */ cursor:pointer; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:50%; z-index:2005; transition: background-color 0.3s, transform 0.2s;}
        .page-back-btn:hover { background: rgba(0,0,0,0.6); transform: scale(1.1); }
        
        .profile-main-header { display: flex; flex-direction: column; align-items: center; text-align: center; background: var(--profile-header-bg); padding: 30px 20px; border-radius: var(--border-radius); box-shadow: var(--shadow-md); margin-bottom: 25px; position: relative; }
        .profile-avatar-lg { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 5px solid var(--primary-color); margin-bottom: 15px; background: var(--gradient); color: white; font-size: 3rem; display:flex; align-items:center; justify-content:center; font-weight:700; box-shadow: 0 0 25px rgba(255,51,51,0.4); }
        .profile-avatar-lg img {width:100%; height:100%; border-radius:50%; object-fit:cover;}
        #profileNameLarge { font-size: 2rem; margin-bottom: 3px; color: var(--text-light); }
        #profileUsernameLarge { color: var(--primary-light); margin-bottom: 12px; font-size:1.1rem; opacity: 0.9; }
        .profile-meta-info { display: flex; gap: 12px 20px; /* row-gap column-gap */ color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px; flex-wrap: wrap; justify-content: center; align-items: center; }
        .profile-meta-info span { display: flex; align-items: center; gap: 6px;}
        .profile-meta-info span i { color:var(--primary-light); opacity: 0.8; }

        .profile-sections-grid { display: grid; grid-template-columns: 1fr; gap: 25px; margin-bottom: 25px; }
        @media (min-width: 768px) { .profile-sections-grid { grid-template-columns: repeat(2, 1fr); } }
        
        .profile-section-card { background: var(--card-bg); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); border: 1px solid rgba(255,255,255,0.05); }
        .profile-section-card h3 { font-size: 1.3rem; color: var(--primary-light); margin-bottom: 15px; border-bottom: 1px solid rgba(255,51,51,0.2); padding-bottom: 10px; display: flex; align-items: center; gap: 8px;}
        .profile-section-card h3 i { opacity: 0.8; }

        #profileBioText { color: var(--text-dark); line-height: 1.7; font-size:0.95rem; white-space: pre-wrap; word-break: break-word; }
        
        .profile-stats-container { display: flex; justify-content: space-around; align-items: center; text-align: center; padding: 10px 0;}
        .stat-item { padding:10px; }
        .stat-item .value { font-size: 2rem; font-weight:700; color:var(--primary-color); display:block; line-height: 1.1; }
        .stat-item .label { font-size:0.85rem; color:var(--text-muted); text-transform:uppercase; margin-top: 5px;}

        #profileEnrolledBatchesList { list-style: none; padding: 0; display: grid; gap: 15px;}
        .enrolled-batch-item-profile {
            background: var(--card-bg-dark); border-radius: var(--border-radius-sm);
            padding: 15px; display: flex; flex-direction: column; 
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-left: 4px solid var(--primary-color);
        }
        .enrolled-batch-item-profile:hover { transform: translateY(-4px) translateX(2px); box-shadow: var(--shadow-sm), 0 0 10px rgba(255,51,51,0.2); }
        .enrolled-batch-item-profile-header { display: flex; align-items: center; gap: 15px; margin-bottom: 12px; }
        .enrolled-batch-item-profile-header img { width: 80px; height: 45px; object-fit: cover; border-radius: 4px; background-color: var(--skeleton-bg); }
        .enrolled-batch-item-profile-header .name { font-weight: 600; font-size: 1.1rem; color: var(--text-light); flex-grow: 1; }
        .enrolled-batch-item-profile-details { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px; padding-left: 5px;}
        .enrolled-batch-item-profile-details span { display: block; margin-bottom: 3px; }
        .enrolled-batch-item-profile-details i { margin-right: 6px; color: var(--primary-light); opacity: 0.7;}
        .view-course-btn-profile {
            background: var(--gradient); color: white; border: none; padding: 10px 18px;
            font-size: 0.9rem; border-radius: var(--border-radius-sm); cursor: pointer; 
            transition: background-color 0.3s, transform 0.2s; text-decoration: none; align-self: flex-start;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .view-course-btn-profile:hover { background: var(--gradient-light); transform: translateY(-2px);}
        .view-course-btn-profile i { font-size: 0.9em; }

        .profile-actions-footer { display:flex; gap:15px; margin-top:30px; justify-content:center;}
        .profile-action-btn { background: var(--secondary-light); color:white; border:none; padding:12px 25px; border-radius: var(--border-radius-sm); font-size:1rem; cursor:pointer; flex:1; max-width:200px; text-align:center; transition: background-color 0.3s, transform 0.2s; display: flex; align-items:center; justify-content:center; gap: 8px;}
        .profile-action-btn:hover { background-color: var(--secondary-dark); transform: translateY(-3px); box-shadow: var(--shadow-sm); }
        .edit-profile { background: var(--gradient); }
        .edit-profile:hover { background: var(--gradient-light); }

        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: rgba(26, 26, 26, 0.9); backdrop-filter: blur(12px) saturate(180%); display: flex; justify-content: space-around; align-items: center; height: var(--nav-height); z-index: 1000; box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.2); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .nav-item { color: var(--text-muted); font-size: 1.3rem; padding: 10px; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.3s ease, color 0.3s ease; position: relative; }
        .nav-item:hover { color: var(--primary-light); transform: translateY(-4px); }
        .nav-item.active { color: var(--primary-color); transform: translateY(-4px); }
        .nav-item.active::after { content: ''; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; background-color: var(--primary-color); border-radius: 50%; box-shadow: 0 0 10px var(--primary-color); }
        .nav-item .unread-badge { position: absolute; top: 8px; right: 8px; background-color: var(--notification-unread-dot); color: white; font-size: 0.6rem; font-weight: bold; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 0 2px var(--bg-light); }
        .action-nav-btn { background: var(--gradient); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.7rem; transform: translateY(-20px); box-shadow: 0 8px 25px rgba(255, 51, 51, 0.45); transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: pointer; border: none; outline: none; z-index: 1001; position:relative; /* For tooltip */ }
        .action-nav-btn:hover { transform: translateY(-25px) scale(1.1); box-shadow: 0 12px 30px rgba(255, 51, 51, 0.6); background: var(--gradient-light); }
        .action-nav-btn.active { background: var(--primary-dark); }
        /* Nav Tooltips */
        .nav-item[data-tooltip]::before, .action-nav-btn[data-tooltip]::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 5px); /* Position above the item */
            left: 50%;
            transform: translateX(-50%) translateY(5px); /* Start slightly down for entry anim */
            background-color: var(--secondary-dark);
            color: var(--text-light);
            padding: 5px 10px;
            border-radius: var(--border-radius-sm);
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s, transform 0.2s ease-out;
            z-index: 1005;
            box-shadow: var(--shadow-sm);
            pointer-events: none;
        }
        .nav-item[data-tooltip]:hover::before, .action-nav-btn[data-tooltip]:hover::before {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
        .action-nav-btn[data-tooltip]:hover::before { /* Adjust tooltip for center button */
             bottom: calc(100% + 15px); /* Higher due to button's own translateY */
        }


        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.85); z-index: 2500; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(10px); padding: 20px 0; }
        .modal.active { display: flex; opacity: 1; }
        .modal-content { background-color: var(--card-bg-dark); border-radius: var(--border-radius); width: 90%; max-width: 480px; padding: 30px; box-shadow: var(--shadow-md); transform: translateY(-20px) scale(0.95); transition: transform 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease; position: relative; max-height: 90vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); }
        .modal.active .modal-content { transform: translateY(0) scale(1); }
        .close-modal { position: absolute; top: 10px; right: 10px; font-size: 1.8rem; color: var(--text-muted); cursor: pointer; background: none; border: none; width: 40px; height: 40px; display:flex; align-items:center; justify-content:center; transition: color 0.3s, transform 0.2s;}
        .close-modal:hover { color: var(--primary-color); transform: rotate(90deg); }
        .modal-title { font-size: 1.6rem; margin-bottom: 25px; color: var(--primary-light); text-align: center; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-dark); font-size: 0.9rem; }
        .form-input, .form-textarea { width: 100%; padding: 12px 15px; border: 1px solid rgba(255, 255, 255, 0.15); border-radius: var(--border-radius-sm); font-family: 'Poppins', sans-serif; background-color: var(--bg-light); color: var(--text-dark); transition: var(--transition); font-size: 0.95rem; }
        .form-textarea { resize: vertical; min-height: 80px; }
        .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(255, 51, 51, 0.3); }
        .submit-btn { background: var(--gradient); color: white; border: none; padding: 12px 18px; border-radius: var(--border-radius-sm); font-size: 1rem; font-weight: 500; cursor: pointer; width: 100%; transition: var(--transition); margin-top: 10px; display: flex; align-items: center; justify-content: center; }
        .submit-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(255, 51, 51, 0.4); background: var(--gradient-light); }
        .submit-btn:disabled { background: var(--secondary-light); opacity: 0.6; cursor: not-allowed; }
        .auth-separator { display: flex; align-items: center; text-align: center; color: var(--text-muted); margin: 18px 0; font-size: 0.8rem; }
        .auth-separator::before, .auth-separator::after { content: ''; flex: 1; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .auth-separator:not(:empty)::before { margin-right: .5em; } .auth-separator:not(:empty)::after { margin-left: .5em; }
        .google-btn { background-color: #4285F4 !important; color: white !important; } /* Important to override gradient */
        .google-btn:hover:not(:disabled) { background-color: #357ae8 !important; }
        .google-btn i { margin-right: 10px; }
        .auth-switch { text-align: center; margin-top: 20px; color: var(--text-muted); font-size: 0.9rem; }
        .auth-switch a { color: var(--primary-color); font-weight: 500; cursor: pointer; text-decoration: none;}
        .auth-switch a:hover { text-decoration: underline; }
        .profile-picture-upload-area { text-align: center; margin-bottom: 15px; }
        .profile-picture-preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-color); margin: 0 auto 10px; display: block; background-color: var(--secondary-light); }
        .upload-picture-label { display: inline-block; padding: 8px 15px; background-color: var(--secondary-light); color: var(--text-light); border-radius: var(--border-radius-sm); cursor: pointer; transition: background-color 0.3s; }
        .upload-picture-label:hover { background-color: var(--primary-color); }
        #profilePictureInput { display: none; }

        .notifications-page { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-dark); z-index: 2000; transform: translateX(100%); transition: transform 0.5s cubic-bezier(0.645, 0.045, 0.355, 1), opacity 0.5s ease; opacity:0; visibility: hidden; display:flex; flex-direction:column;}
        .notifications-page.active { transform: translateX(0); opacity:1; visibility: visible;}
        .notifications-header { padding: 0 15px; background: var(--card-bg-dark); color: white; display:flex; align-items:center; justify-content:space-between; height:var(--header-height); border-bottom:1px solid rgba(255,255,255,0.1);}
        .notifications-header .page-back-btn {position: static; transform: none; /* Reset profile page back btn style */}
        .notifications-header h2 { margin: 0; font-size: 1.4rem; }
        .mark-all-read-btn { background: transparent; border:1px solid var(--primary-light); color: var(--primary-light); padding: 5px 10px; border-radius:var(--border-radius-sm); font-size:0.8rem; cursor:pointer; display:inline-flex; align-items:center; gap:5px; transition: background-color 0.3s, color 0.3s;}
        .mark-all-read-btn:hover { background-color: var(--primary-light); color:white; }
        .mark-all-read-btn .spinner { width:14px; height:14px; border-width:2px; }
        .notifications-list-container { flex:1; overflow-y:auto; padding:15px;}
        .notification-item { background-color: var(--card-bg); border-radius: var(--border-radius-sm); padding: 15px; margin-bottom: 12px; display:flex; align-items:flex-start; border-left:4px solid var(--primary-color); transition: background-color 0.3s, transform 0.2s; cursor:pointer;}
        .notification-item.unread { background-color: rgba(52, 152, 219, 0.08); border-left-color: var(--notification-unread-dot); font-weight:500;}
        .notification-item:hover { background-color: var(--card-bg-dark); transform: translateX(5px); }
        .notification-icon { font-size:1.4rem; margin-right:15px; color:var(--primary-light); margin-top:3px;}
        .notification-title { font-size:1rem; font-weight:600; color: var(--text-light); margin-bottom:5px;}
        .notification-message { font-size:0.9rem; color:var(--text-muted); line-height:1.5; margin-bottom:8px;}
        .notification-timestamp { font-size:0.75rem; color: var(--text-muted); opacity:0.8;}

        .faq-modal-content { max-width: 600px; }
        .faq-item { margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
        .faq-item:last-child { border-bottom: none; padding-bottom: 0; }
        .faq-question { font-weight: 600; color: var(--primary-light); margin-bottom: 8px; font-size: 1.1rem; }
        .faq-answer { font-size: 0.95rem; color: var(--text-dark); line-height: 1.7; }

        #toastContainer { position: fixed; top: 25px; right: 25px; z-index: 3000; display:flex; flex-direction:column; gap:10px; }
        .toast { padding: 15px 25px; border-radius: var(--border-radius-sm); background-color: var(--secondary-light); color: white; box-shadow: var(--shadow-md); transform: translateX(calc(100% + 30px)); transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); display: flex; align-items: center; max-width:380px; border-left:5px solid var(--primary-color); pointer-events:all; }
        .toast.show { transform: translateX(0); }
        .toast.success { background-color: #27ae60; border-left-color: #2ecc71; }
        .toast.error { background-color: #e74c3c; border-left-color: #ff4757; }
        .toast i { margin-right: 12px; font-size:1.3rem; }
        .toast span { flex-grow:1;}
        .toast-close { margin-left:15px; cursor:pointer; opacity:0.7; font-size:1.2rem; background:none; border:none; color:white; padding:0;}
        .toast-close:hover { opacity:1; }
        .empty-state { text-align: center; padding: 50px 20px; color: var(--text-muted); width:100%; display:none; flex-direction:column; align-items:center; justify-content:center; min-height:200px;}
        .empty-state i { font-size: 3.5rem; margin-bottom: 20px; color: var(--primary-color); opacity:0.5;}
        .empty-state h3 { margin-bottom: 12px; color:var(--text-light); font-size:1.3rem; }
        .empty-state p { font-size:0.95rem; }
        .spinner { display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; margin-right:5px; }
        .submit-btn .spinner, .batch-action-btn .spinner, .mark-all-read-btn .spinner { display:none; }
        .submit-btn.loading .spinner, .batch-action-btn.loading .spinner, .mark-all-read-btn.loading .spinner { display:inline-block; }
        .submit-btn.loading span:not(.spinner), .batch-action-btn.loading span:not(.spinner), .mark-all-read-btn.loading span:not(.icon-text) { opacity:0.5; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .page-content { display: none; }
        .page-content.active { display: block; animation: fadeInPage 0.5s ease-out; }
        @keyframes fadeInPage { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) {
            :root { --header-height: 65px; --nav-height: 65px; }
            body { padding-top: var(--header-height); padding-bottom: var(--nav-height); }
            .header { padding: 0 15px; }
            .page-back-btn { top: calc(var(--header-height) - 52px); } /* Adjust for smaller header */
            .batches-grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
            .profile-avatar-lg { width: 100px; height:100px; font-size: 2.5rem;}
            #profileNameLarge {font-size: 1.6rem;}
            .profile-section-card h3 {font-size: 1.1rem;}
            .enrolled-batch-item-profile-header .name { font-size: 1rem; }
            .support-page {height: calc(100vh - var(--header-height) - var(--nav-height) - 20px); margin: 10px;}
            .support-header h2 { font-size: 1.3rem; }
            .faq-btn { font-size: 0.75rem; padding: 5px 10px; }
            .notifications-header h2 { font-size: 1.2rem; }
            .mark-all-read-btn { font-size: 0.7rem; padding: 4px 8px;}
        }
         @media (max-width: 576px) {
            .batches-grid { grid-template-columns: 1fr; }
            .modal-content {width:95%; padding:20px;}
            .profile-avatar-lg { width: 80px; height:80px; font-size: 2rem;}
            .page-title { font-size: 1.6rem;}
            .quick-responses-container { justify-content: center; }
            .profile-sections-grid { grid-template-columns: 1fr; }
            .profile-actions-footer { flex-direction: column; align-items: center;}
            .profile-action-btn { width: 100%; max-width: 280px;}
         }
    </style>
</head>
<body data-theme="dark">

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-logo-container"> <i class="fas fa-chalkboard-teacher loading-logo-icon"></i> <span class="loading-logo-text">EduSparK</span> </div>
        <div class="loading-dots"> <span></span><span></span><span></span> </div>
        <p class="loading-message" id="loadingMessage">Loading Courses...</p>
    </div>

    <header class="header">
        <div class="logo-container"> <a href="#" class="logo" id="logoLink"> <i class="fas fa-chalkboard-teacher"></i> <span class="logo-text">EduSparK</span> </a> </div>
        <div class="search-container" id="searchContainer"> <i class="fas fa-search search-icon"></i> <input type="text" class="search-input" id="searchInput" placeholder="Search batches..."> <div class="search-results" id="searchResults"></div> </div>
        <div class="header-actions"> <button class="search-toggle-btn" id="searchToggleBtn" aria-label="Toggle Search"> <i class="fas fa-search"></i> </button> <div class="user-avatar" id="userAvatar"> <span id="avatarInitials">Eâœ¨</span> </div> </div>
    </header>

    <div id="allBatchesPage" class="page-content active">
        <div class="container">
            <h1 class="page-title" data-aos="fade-right">Explore Our Batches</h1>
            <div class="batches-grid" id="allBatchesContainer">
                <!-- Batch cards loaded here -->
            </div>
            <div class="empty-state" id="emptyStateAllBatches"> <i class="fas fa-search-minus"></i> <h3>No Batches Found</h3> <p>Check back later for new batches!</p> </div>
        </div>
    </div>

    <div id="myBatchesPage" class="page-content">
        <div class="container">
            <h1 class="page-title">My Enrolled Batches</h1>
            <div class="batches-grid" id="myBatchesContainer">
                <!-- Enrolled batch cards loaded here -->
            </div>
            <div class="empty-state" id="emptyStateMyBatches"> <i class="fas fa-folder-open"></i> <h3>No Enrolled Batches</h3> <p>Explore our batches and enroll in courses that interest you!</p> </div>
        </div>
    </div>

    <div id="supportPage" class="page-content">
        <div class="support-page">
            <div class="support-header">
                <div>
                    <h2>Support Chat</h2>
                    <p class="support-header-meta">Chat with our support team.</p>
                </div>
                <button class="faq-btn" id="faqBtn"><i class="fas fa-question-circle"></i> View FAQs</button>
            </div>
            <div class="chat-area" id="chatArea">
                 <div class="empty-state" id="emptyStateSupport" style="margin:auto;"> <i class="fas fa-comments"></i> <h3>Start a Conversation</h3> <p>Ask us anything! Type your message below or use a quick response.</p> </div>
            </div>
            <div class="support-input-area">
                <div class="support-input-wrapper">
                    <input type="text" id="supportInput" class="support-input" placeholder="Type your message...">
                    <button class="send-support-btn" id="sendSupportBtn"><i class="fas fa-paper-plane"></i></button>
                </div>
                <div class="quick-responses-container" id="quickResponsesContainer">
                    <!-- Quick response buttons loaded by JS -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="profile-page" id="profilePage">
        <button class="page-back-btn" id="profileBackBtn" aria-label="Go Back"> <i class="fas fa-arrow-left"></i> </button>
        <div class="profile-page-content">
            <div class="profile-main-header" data-aos="fade-down">
                <div class="profile-avatar-lg" id="profileAvatarLarge"> <span id="profileAvatarInitialsLarge">U</span> </div>
                <h1 id="profileNameLarge">User Loading...</h1>
                <p id="profileUsernameLarge">@loading</p>
                <div class="profile-meta-info">
                    <span id="profileEmailLarge"><i class="fas fa-envelope"></i> loading...</span>
                    <span id="profileJoinedLarge"><i class="fas fa-calendar-alt"></i> Joined: -</span>
                    <span id="profilePointsLarge"><i class="fas fa-star"></i> Points: 0</span>
                    <span id="profileLastActiveLarge"><i class="fas fa-history"></i> Last Seen: -</span>
                </div>
            </div>

            <div class="profile-sections-grid">
                <div class="profile-section-card" data-aos="fade-up" data-aos-delay="100">
                    <h3><i class="fas fa-id-card"></i> Bio</h3>
                    <p id="profileBioText">Loading bio...</p>
                </div>
                
                <div class="profile-section-card" data-aos="fade-up" data-aos-delay="200">
                    <h3><i class="fas fa-chart-bar"></i> Stats</h3>
                    <div class="profile-stats-container">
                        <div class="stat-item">
                            <span class="value" id="profileBatchesEnrolledCount">0</span>
                            <span class="label">Batches Enrolled</span>
                        </div>
                         <div class="stat-item"> <!-- Example additional stat -->
                            <span class="value" id="profilePointsStat">0</span>
                            <span class="label">Total Points</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="profile-section-card" data-aos="fade-up" data-aos-delay="300">
                <h3><i class="fas fa-graduation-cap"></i> My Enrolled Batches</h3>
                <ul id="profileEnrolledBatchesList">
                     <!-- Enrolled batches listed by JS in new card format -->
                </ul>
                <div class="empty-state" id="emptyStateProfileBatches" style="min-height:100px; padding:20px 0;"> <i class="far fa-list-alt"></i> <p>Your enrolled batches will appear here.</p> </div>
            </div>

            <div class="profile-actions-footer" data-aos="fade-up" data-aos-delay="400">
                <button class="profile-action-btn edit-profile" id="editProfileBtn"><i class="fas fa-user-edit"></i> Edit Profile</button>
                <button class="profile-action-btn logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>
    </div>

    <div class="notifications-page" id="notificationsPage">
         <div class="notifications-header"> 
            <button class="page-back-btn" id="notificationsBackBtn" aria-label="Go Back"> <i class="fas fa-arrow-left"></i> </button> 
            <h2>Notifications</h2> 
            <button class="mark-all-read-btn" id="markAllNotificationsReadBtn" style="display:none;">
                <span class="spinner"></span>
                <span class="icon-text"><i class="fas fa-check-double"></i> Mark All Read</span>
            </button> 
        </div>
        <div class="notifications-list-container" id="notificationsListContainer"> 
            <div class="empty-state" id="emptyStateNotifications"> <i class="fas fa-bell-slash"></i> <h3>No Notifications</h3> <p>Important updates will appear here.</p> </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item" id="notificationsNavBtn" data-tooltip="Notifications"> <i class="fas fa-bell"></i> <span class="unread-badge" id="unreadNotificationsBadge" style="display: none;">0</span> </div>
        <div class="nav-item active" id="allBatchesNavBtn" data-tooltip="All Batches"> <i class="fas fa-th-large"></i> </div>
        <button class="action-nav-btn" id="supportNavBtn" data-tooltip="Support Chat" aria-label="Support Chat"> <i class="fas fa-headset"></i> </button>
        <div class="nav-item" id="myBatchesNavBtn" data-tooltip="My Batches"> <i class="fas fa-bookmark"></i> </div>
        <div class="nav-item" id="profileNavBtn" data-tooltip="Profile"> <i class="fas fa-user"></i> </div>
    </nav>

    <!-- Modals: Login, Signup, Edit Profile -->
    <div class="modal" id="loginModal"> <div class="modal-content"><button class="close-modal" id="closeLoginModal" aria-label="Close">&times;</button> <h2 class="modal-title">Welcome Back!</h2><form id="loginForm"><div class="form-group"> <label for="loginEmail" class="form-label">Email</label> <input type="email" id="loginEmail" class="form-input" required autocomplete="email"> </div><div class="form-group"> <label for="loginPassword" class="form-label">Password</label> <input type="password" id="loginPassword" class="form-input" required autocomplete="current-password"> </div><button type="submit" class="submit-btn" id="loginBtn"><span class="spinner"></span><span>Login</span></button></form><div class="auth-separator"><span>OR</span></div><button class="submit-btn google-btn" id="googleLoginBtn"><span class="spinner"></span><span><i class="fab fa-google"></i> Continue with Google</span></button><div class="auth-switch"> Don't have an account? <a id="switchToSignup">Sign up</a> </div></div></div>
    <div class="modal" id="signupModal"> <div class="modal-content"><button class="close-modal" id="closeSignupModal" aria-label="Close">&times;</button> <h2 class="modal-title">Join EduSparK</h2><form id="signupForm"><div class="form-group"> <label for="signupName" class="form-label">Full Name</label> <input type="text" id="signupName" class="form-input" required autocomplete="name"> </div><div class="form-group"> <label for="signupUsername" class="form-label">Username</label> <input type="text" id="signupUsername" class="form-input" required autocomplete="username"> <small style="font-size:0.75rem; color:var(--text-muted)">3-15 chars, lowercase, numbers, _, .</small></div><div class="form-group"> <label for="signupEmail" class="form-label">Email</label> <input type="email" id="signupEmail" class="form-input" required autocomplete="email"> </div><div class="form-group"> <label for="signupPassword" class="form-label">Password</label> <input type="password" id="signupPassword" class="form-input" required autocomplete="new-password"> </div><button type="submit" class="submit-btn" id="signupBtn"><span class="spinner"></span><span>Create Account</span></button></form><div class="auth-separator"><span>OR</span></div><button class="submit-btn google-btn" id="googleSignupBtn"><span class="spinner"></span><span><i class="fab fa-google"></i> Sign up with Google</span></button><div class="auth-switch"> Already have an account? <a id="switchToLogin">Login</a> </div></div></div>
    <div class="modal" id="editProfileModal"> <div class="modal-content"><button class="close-modal" id="closeEditProfileModal" aria-label="Close">&times;</button> <h2 class="modal-title">Edit Profile</h2><form id="editProfileForm"><div class="profile-picture-upload-area"><img src="https://via.placeholder.com/100?text=Pic" alt="Profile Preview" id="profilePicturePreview" class="profile-picture-preview"><input type="file" id="profilePictureInput" accept="image/*"><label for="profilePictureInput" class="upload-picture-label"><i class="fas fa-camera"></i> Change Picture</label></div><div class="form-group"> <label for="editProfileName" class="form-label">Full Name</label> <input type="text" id="editProfileName" class="form-input" required> </div><div class="form-group"> <label for="editProfileUsername" class="form-label">Username</label> <input type="text" id="editProfileUsername" class="form-input" required><small style="font-size:0.75rem; color:var(--text-muted)">3-15 chars, lowercase, numbers, _, .</small></div><div class="form-group"> <label for="editProfileBio" class="form-label">Bio</label> <textarea id="editProfileBio" class="form-textarea" rows="3" placeholder="Tell us a bit about yourself..."></textarea> </div><button type="submit" class="submit-btn" id="saveProfileBtn"><span class="spinner"></span><span>Save Changes</span></button></form></div></div>
    
    <div class="modal" id="faqModal">
        <div class="modal-content faq-modal-content">
            <button class="close-modal" id="closeFaqModal" aria-label="Close">&times;</button>
            <h2 class="modal-title">Frequently Asked Questions</h2>
            <div id="faqListContainer">
                <div class="empty-state" id="emptyStateFaq" style="display:none; min-height:100px;">
                    <i class="fas fa-info-circle"></i> <p>FAQs will appear here. Currently unavailable.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init({ duration: 600, easing: 'ease-out-cubic', once: true, offset: 50 });

        const firebaseConfig = { // IMPORTANT: REPLACE WITH YOUR ACTUAL FIREBASE CONFIG
            apiKey: "AIzaSyBNi6BHTKNd62VAY7q1oHQmxjZ3r0MUA9U", // Replace with your actual API key
            authDomain: "eduspark-new.firebaseapp.com",
            projectId: "eduspark-new",
            storageBucket: "eduspark-new.appspot.com",
            messagingSenderId: "564501033350",
            appId: "1:564501033350:web:70c0f9873f96e9bd74fc07",
            measurementId: "G-NM2SE3DE7J"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
       
  function onClick(e) {
    e.preventDefault();
    grecaptcha.enterprise.ready(async () => {
      const token = await grecaptcha.enterprise.execute('6Lf781IrAAAAAKUivV71zU3gRGRX2pSwvJbsR4zx', {action: 'LOGIN'});
    });
  }

        const $ = (s) => document.querySelector(s);
        const $$ = (s) => document.querySelectorAll(s);

        const elements = {
            loadingOverlay: $('#loadingOverlay'), loadingMessage: $('#loadingMessage'), body: document.body, header: $('.header'),
            userAvatar: $('#userAvatar'), avatarInitials: $('#avatarInitials'),
            logoLink: $('#logoLink'), searchInput: $('#searchInput'), searchResults: $('#searchResults'), searchContainer: $('#searchContainer'),searchToggleBtn:$("#searchToggleBtn"),
            
            allBatchesNavBtn: $('#allBatchesNavBtn'), myBatchesNavBtn: $('#myBatchesNavBtn'),
            supportNavBtn: $('#supportNavBtn'), profileNavBtn: $('#profileNavBtn'), notificationsNavBtn: $('#notificationsNavBtn'),
            
            allBatchesPage: $('#allBatchesPage'), myBatchesPage: $('#myBatchesPage'),
            supportPage: $('#supportPage'), profilePage: $('#profilePage'), notificationsPage: $('#notificationsPage'),
            
            allBatchesContainer: $('#allBatchesContainer'), emptyStateAllBatches: $('#emptyStateAllBatches'),
            myBatchesContainer: $('#myBatchesContainer'), emptyStateMyBatches: $('#emptyStateMyBatches'),
            
            chatArea: $('#chatArea'), supportInput: $('#supportInput'), sendSupportBtn: $('#sendSupportBtn'), emptyStateSupport: $('#emptyStateSupport'),
            quickResponsesContainer: $('#quickResponsesContainer'), faqBtn: $('#faqBtn'),

            profileBackBtn: $('#profileBackBtn'), profileAvatarLarge: $('#profileAvatarLarge'),
            profileAvatarInitialsLarge: $('#profileAvatarInitialsLarge'), profileNameLarge: $('#profileNameLarge'),
            profileUsernameLarge: $('#profileUsernameLarge'), profileEmailLarge: $('#profileEmailLarge'),
            profileJoinedLarge: $('#profileJoinedLarge'), 
            profilePointsLarge: $('#profilePointsLarge'), profileLastActiveLarge: $('#profileLastActiveLarge'),
            profileBioText: $('#profileBioText'), 
            profileBatchesEnrolledCount: $('#profileBatchesEnrolledCount'), profilePointsStat: $('#profilePointsStat'),
            profileEnrolledBatchesList: $('#profileEnrolledBatchesList'), emptyStateProfileBatches: $('#emptyStateProfileBatches'),
            editProfileBtn: $('#editProfileBtn'), logoutBtn: $('#logoutBtn'),

            notificationsListContainer: $('#notificationsListContainer'), notificationsBackBtn: $('#notificationsBackBtn'), 
            emptyStateNotifications: $('#emptyStateNotifications'), unreadNotificationsBadge: $('#unreadNotificationsBadge'),
            markAllNotificationsReadBtn: $('#markAllNotificationsReadBtn'),
            
            loginModal: $('#loginModal'), signupModal: $('#signupModal'), editProfileModal: $('#editProfileModal'), faqModal: $('#faqModal'),
            closeLoginModal: $('#closeLoginModal'), closeSignupModal: $('#closeSignupModal'), closeEditProfileModal: $('#closeEditProfileModal'), closeFaqModal: $('#closeFaqModal'),
            loginForm: $('#loginForm'), signupForm: $('#signupForm'), editProfileForm: $('#editProfileForm'),
            switchToSignup: $('#switchToSignup'), switchToLogin: $('#switchToLogin'),
            googleLoginBtn: $('#googleLoginBtn'), googleSignupBtn: $('#googleSignupBtn'),
            profilePictureInput: $('#profilePictureInput'), profilePicturePreview: $('#profilePicturePreview'),
            faqListContainer: $('#faqListContainer'), emptyStateFaq: $('#emptyStateFaq'),
            toastContainer: $('#toastContainer')
        };

        let currentUser = null, userData = null, isUserDataLoading = true, currentChatThreadId = null;
        let userEnrolledBatchesIds = [];
        let allBatchesCache = [];
        let tempProfilePicFile = null;
        let listeners = { user: null, batches: null, enrolledBatches: null, supportChatThread: null, supportChatMessages: null, userNotifications: null, allBatchesSearch: null };
        const BATCHES_PER_PAGE = 9; 
        let lastVisibleBatch = null;
        let isLoadingBatches = false;
        let hasMoreBatches = true;
        let lastActiveMainPageKey = 'allBatches'; // For back button logic

        const QUICK_RESPONSES = ["How to enroll?", "What are the timings?", "Fee structure?", "Need tech support"];
        const FAQS = [
            { q: "How do I enroll in a batch?", a: "To enroll, find the batch you're interested in on the 'All Batches' page and click the 'Explore & Enroll' button. If a batch link is provided, it may take you to an external site for enrollment." },
            { q: "Can I access recordings if I miss a live class?", a: "This depends on the specific batch. Please check the batch description or contact support for details about recordings for a particular batch." },
            { q: "What are the payment options?", a: "Payment options are usually detailed on the batch enrollment page, which you can access via the 'Explore & Enroll' or 'Go to Course' button. We use external links for batch specific pages." },
            { q: "How do I get support for a technical issue?", a: "You can use the 'Support Chat' feature available on the bottom navigation bar. Our team will assist you as soon as possible." },
            { q: "Is there a mobile app?", a: "Currently, EduSparK Batches is web-based and accessible on all devices through your browser. A dedicated mobile app might be considered in the future." }
        ];

        const loadingMessages = [ "Loading Courses...", "Fetching Your Profile...", "Preparing the Awesomeness...", "Sparking Your Learning...", "Almost Ready..." ];
        let loadingMessageIndex = 0;
        let loadingInterval;

        function startLoadingMessages() {
            if (elements.loadingMessage) {
                elements.loadingMessage.textContent = loadingMessages[0];
                loadingInterval = setInterval(() => {
                    loadingMessageIndex = (loadingMessageIndex + 1) % loadingMessages.length;
                    elements.loadingMessage.textContent = loadingMessages[loadingMessageIndex];
                }, 2000); 
            }
        }
        function stopLoadingMessages() { clearInterval(loadingInterval); }

        function escapeHTML(str) { if (str === null || str === undefined) return ''; return String(str).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
        function showToast(message, type = "info", duration = 3500) { const toastId='toast-'+Date.now();const t=document.createElement('div');t.className=`toast ${type}`;t.id=toastId;let i='fas fa-info-circle';type==='success'&&(i='fas fa-check-circle');type==='error'&&(i='fas fa-times-circle');t.innerHTML=`<i class="${i}"></i><span>${escapeHTML(message)}</span><button class="toast-close" aria-label="Close toast">&times;</button>`;elements.toastContainer.appendChild(t);requestAnimationFrame(()=>t.classList.add('show'));t.querySelector('.toast-close').onclick=()=>{t.classList.remove('show');setTimeout(()=>{t.parentElement&&t.remove()},500)};setTimeout(()=>{const currentToast=document.getElementById(toastId); if(currentToast){currentToast.classList.remove('show');setTimeout(()=>{currentToast.parentElement&&currentToast.remove()},500)}},duration);}
        function openModal(modalEl) { modalEl.classList.add('active'); elements.body.style.overflow = 'hidden'; AOS.refresh(); }
        function closeModal(modalEl) { modalEl.classList.remove('active'); const anyModalActive=!!$$('.modal.active').length;const anyPageActive=!!$$('.profile-page.active, .notifications-page.active').length;if(!anyModalActive && !anyPageActive)elements.body.style.overflow = 'auto'; }
        function getInitials(name) { if(!name || typeof name !=='string')return 'U';const p=name.trim().split(' ').filter(s=>s.length>0);if(p.length===0)return 'U';if(p.length===1)return p[0].charAt(0).toUpperCase();return(p[0].charAt(0)+p[p.length-1].charAt(0)).toUpperCase(); }
        function formatDate(ts) { if(!ts)return 'N/A';const d=ts.toDate?ts.toDate():new Date(ts);return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}); }
        function formatDateTime(ts) { if(!ts)return 'N/A';const d=ts.toDate?ts.toDate():new Date(ts);return `${d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'})} ${d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`; }

        function toggleSpinner(btn, show) { if (!btn) return; const spinner = btn.querySelector('.spinner'); const textSpans = btn.querySelectorAll('span:not(.spinner)'); btn.disabled = show; if(spinner) spinner.style.display = show ? 'inline-block' : 'none'; textSpans.forEach(s => s.style.opacity = show ? (s.classList.contains('icon-text') ? 1: 0.5) : 1); if(show) btn.classList.add('loading'); else btn.classList.remove('loading');}
        function cleanupListeners() { for(const k in listeners) { if(listeners[k]) { try{ listeners[k](); } catch(e){} listeners[k]=null; } } }
        function hideLoadingOverlay() { elements.loadingOverlay.classList.add('hidden'); stopLoadingMessages(); }
        
        async function createNotification(userId, title, message, type = 'info', link = null) {
            if(!userId) return;
            try {
                await db.collection('users').doc(userId).collection('batches_notification').add({
                    title: title, message: message, type: type, link: link, 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(), read: false
                });
            } catch (error) { console.error("Error creating notification:", error); }
        }

        auth.onAuthStateChanged(async (user) => {
            console.log("Batches Auth State Changed. User:", user ? user.uid : 'No User');
            cleanupListeners();
            currentUser = user;
            if (user) {
                isUserDataLoading = true;
                updateUIAfterLogin(); 

                listeners.user = db.collection('users').doc(user.uid).onSnapshot(async (doc) => {
                    console.log("User doc snapshot received for batches page. Exists:", doc.exists);
                    if (doc.exists) {
                        userData = { id: doc.id, ...doc.data() };
                        userEnrolledBatchesIds = userData.enrolledBatches || [];
                        isUserDataLoading = false;
                        updateUIAfterLogin(); 
                        loadInitialData(); 
                        fetchUserNotifications();
                        setupAllBatchesListenerForSearch();
                        loadSupportChatThreadListener(); 
                    } else { 
                        console.log("User exists in Auth but not Firestore. Creating document...");
                        await createUserDocument(user, user.displayName, null, null);
                    }
                     if (!elements.loadingOverlay.classList.contains('hidden')) hideLoadingOverlay();
                }, (error) => {
                    console.error("Error fetching user data:", error);
                    showToast("Could not load your profile. Please refresh.", "error");
                    userData = null; isUserDataLoading = false; updateUIAfterLogin();
                     if (!elements.loadingOverlay.classList.contains('hidden')) hideLoadingOverlay();
                });
                 try {
                    await db.collection('users').doc(user.uid).update({ lastActive: firebase.firestore.FieldValue.serverTimestamp() })
                    .catch(err => { if (err.code === 'not-found') console.warn("User doc not found for lastActive, will be created."); else console.error("Error updating lastActive:", err);});
                } catch (e) { /* caught */ }

            } else { 
                userData = null; isUserDataLoading = false;
                userEnrolledBatchesIds = [];
                currentChatThreadId = null;
                allBatchesCache = [];
                if (listeners.allBatchesSearch) listeners.allBatchesSearch(); listeners.allBatchesSearch = null; 
                
                updateUIAfterLogout();
                closeAllPagesAndModals();
                resetNavigation();
                
                if (elements.allBatchesContainer) elements.allBatchesContainer.innerHTML = '';
                if (elements.myBatchesContainer) elements.myBatchesContainer.innerHTML = '';
                if (elements.chatArea) { elements.chatArea.innerHTML = ''; if (elements.emptyStateSupport) elements.emptyStateSupport.style.display = 'flex';}
                if (elements.notificationsListContainer) { elements.notificationsListContainer.innerHTML = ''; if (elements.emptyStateNotifications) elements.emptyStateNotifications.style.display = 'flex'; }
                if (elements.profileEnrolledBatchesList) { elements.profileEnrolledBatchesList.innerHTML = ''; if(elements.emptyStateProfileBatches) elements.emptyStateProfileBatches.style.display = 'flex';}


                if (elements.emptyStateAllBatches) { elements.emptyStateAllBatches.innerHTML = `<i class="fas fa-sign-in-alt"></i><h3>Login to Discover Batches</h3><p>Please login to see available batches.</p>`; elements.emptyStateAllBatches.style.display = 'flex';}
                if (!elements.loadingOverlay.classList.contains('hidden')) hideLoadingOverlay();
            }
        });

        async function createUserDocument(firebaseUser, nameOverride, usernameOverride, bioOverride) {
            const name = nameOverride || firebaseUser.displayName || "EduSpark User";
            let username = usernameOverride;
            if (!username && firebaseUser.email) {
                username = firebaseUser.email.split('@')[0].replace(/[^a-z0-9_.]/gi, '').toLowerCase();
                if (username.length > 15) username = username.substring(0, 15);
                 if (username.length < 3) username = `user${Date.now().toString().slice(-7)}`;
            } else if (!username) {
                 username = `user${Date.now().toString().slice(-7)}`;
            }
             try { 
                const usernameSnapshot = await db.collection('users').where('username', '==', username).get();
                if (!usernameSnapshot.empty && usernameSnapshot.docs[0].id !== firebaseUser.uid) {
                    username = `${username.substring(0,10)}${Date.now().toString().slice(-5)}`;
                }
            } catch (e) { console.warn("Error checking username uniqueness:", e); }

            const initialUserData = {
                uid: firebaseUser.uid, email: firebaseUser.email, name: name, username: username,
                bio: bioOverride || "Passionate learner exploring new horizons on EduSparK!", 
                profilePictureURL: firebaseUser.photoURL || null,
                points: 0, createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                enrolledBatches: [], isAdmin: false
            };
            try {
                await db.collection('users').doc(firebaseUser.uid).set(initialUserData);
                console.log("User document created for:", firebaseUser.uid);
                showToast("Welcome! Your EduSparK account is set up.", "success");
            } catch (error) { console.error("Error creating user document in Firestore:", error); showToast("Error setting up your account.", "error"); }
        }

        function loadInitialData() {
            if (!currentUser || isUserDataLoading) return;
            fetchBatches(false); 
            if (elements.myBatchesPage.classList.contains('active')) fetchMyBatches();
        }

        function updateUIAfterLogin() {
            elements.body.classList.add('logged-in'); elements.body.classList.remove('logged-out');
            if (elements.emptyStateAllBatches && elements.emptyStateAllBatches.querySelector('h3').textContent.startsWith('Login')) { // Clear login prompt
                 elements.emptyStateAllBatches.innerHTML = `<i class="fas fa-search-minus"></i> <h3>No Batches Found</h3> <p>Check back later for new batches!</p>`;
                 elements.emptyStateAllBatches.style.display = 'none'; // Will be shown if fetchBatches finds nothing
            }
            if (userData) {
                if (userData.profilePictureURL) elements.userAvatar.innerHTML = `<img src="${escapeHTML(userData.profilePictureURL)}" alt="User Avatar">`;
                else elements.userAvatar.innerHTML = `<span id="avatarInitials">${getInitials(userData.name)}</span>`;
                
                // Always update these if elements exist, for consistency when profile page is opened
                if(elements.profileAvatarLarge){ 
                    if (userData.profilePictureURL) elements.profileAvatarLarge.innerHTML = `<img src="${escapeHTML(userData.profilePictureURL)}" alt="Profile Picture">`;
                    else elements.profileAvatarLarge.innerHTML = `<span id="profileAvatarInitialsLarge">${getInitials(userData.name)}</span>`;
                    
                    elements.profileNameLarge.textContent = escapeHTML(userData.name);
                    elements.profileUsernameLarge.textContent = `@${escapeHTML(userData.username)}`;
                    elements.profileEmailLarge.innerHTML = `<i class="fas fa-envelope"></i> ${escapeHTML(userData.email)}`;
                    elements.profileJoinedLarge.innerHTML = `<i class="fas fa-calendar-alt"></i> Joined: ${formatDate(userData.createdAt)}`;
                    elements.profilePointsLarge.innerHTML = `<i class="fas fa-star"></i> Points: ${userData.points !== undefined ? userData.points : 0}`;
                    elements.profileLastActiveLarge.innerHTML = `<i class="fas fa-history"></i> Last Seen: ${userData.lastActive ? formatDateTime(userData.lastActive) : 'N/A'}`;
                    elements.profileBioText.textContent = escapeHTML(userData.bio || "No bio yet. Add one by editing your profile!");
                    elements.profileBatchesEnrolledCount.textContent = userEnrolledBatchesIds.length;
                    elements.profilePointsStat.textContent = userData.points !== undefined ? userData.points : 0;
                    renderProfileEnrolledBatches(); 
                }
            } else { 
                elements.userAvatar.innerHTML = `<span id="avatarInitials">L</span>`; 
                if(elements.profileAvatarLarge) {
                     elements.profileAvatarLarge.innerHTML = `<span id="profileAvatarInitialsLarge">U</span>`;
                     elements.profileNameLarge.textContent = 'User...';
                     elements.profileUsernameLarge.textContent = '@loading';
                     elements.profileEmailLarge.innerHTML = `<i class="fas fa-envelope"></i> loading...`;
                     elements.profileJoinedLarge.innerHTML = `<i class="fas fa-calendar-alt"></i> Joined: -`;
                     elements.profilePointsLarge.innerHTML = `<i class="fas fa-star"></i> Points: ...`;
                     elements.profileLastActiveLarge.innerHTML = `<i class="fas fa-history"></i> Last Seen: ...`;
                     elements.profileBioText.textContent = 'Loading bio...';
                     elements.profileBatchesEnrolledCount.textContent = '0';
                     elements.profilePointsStat.textContent = '0';
                }
            }
        }
        function updateUIAfterLogout() {
            elements.body.classList.remove('logged-in'); elements.body.classList.add('logged-out');
            elements.userAvatar.innerHTML = `<span id="avatarInitials">U</span>`;
            if (elements.unreadNotificationsBadge) elements.unreadNotificationsBadge.style.display = 'none';

            if (elements.profileAvatarLarge) { 
                elements.profileAvatarLarge.innerHTML = `<span id="profileAvatarInitialsLarge">U</span>`;
                elements.profileNameLarge.textContent = 'User Name';
                elements.profileUsernameLarge.textContent = '@username';
                elements.profileEmailLarge.innerHTML = `<i class="fas fa-envelope"></i> email@example.com`;
                elements.profileJoinedLarge.innerHTML = `<i class="fas fa-calendar-alt"></i> Joined: -`;
                elements.profilePointsLarge.innerHTML = `<i class="fas fa-star"></i> Points: 0`;
                elements.profileLastActiveLarge.innerHTML = `<i class="fas fa-history"></i> Last Seen: -`;
                elements.profileBioText.textContent = 'Login to see your bio.';
                elements.profileBatchesEnrolledCount.textContent = '0';
                elements.profilePointsStat.textContent = '0';
                elements.profileEnrolledBatchesList.innerHTML = '';
                elements.emptyStateProfileBatches.style.display = 'flex';
            }
        }

                // THIS IS AN ASSUMPTION OF YOUR CURRENT WORKING FUNCTION
        function createBatchCardHTML(batch) {
            const isEnrolled = userEnrolledBatchesIds.includes(batch.id); // Assuming you have this
            let descItemsHTML = '';
            // ... [your existing code to build descItemsHTML] ...
            if (batch.instructorName) { descItemsHTML += ` <div class="batch-desc-item"> <span class="label"><i class="fas fa-chalkboard-teacher"></i> Instructor:</span> <span class="value">${escapeHTML(batch.instructorName)}</span> </div>`;}
            if (batch.durationText) { descItemsHTML += ` <div class="batch-desc-item"> <span class="label"><i class="far fa-clock"></i> Duration:</span> <span class="value">${escapeHTML(batch.durationText)}</span> </div>`;}
            if (batch.lessonsCount) { descItemsHTML += ` <div class="batch-desc-item"> <span class="label"><i class="fas fa-book-open"></i> Lessons:</span> <span class="value">${escapeHTML(batch.lessonsCount)}</span> </div>`;}
            if (batch.difficulty) { descItemsHTML += ` <div class="batch-desc-item"> <span class="label"><i class="fas fa-signal"></i> Difficulty:</span> <span class="value">${escapeHTML(batch.difficulty)}</span> </div>`;}


            // **THIS IS THE PART WE'LL CHANGE**
            // const oldButtonHTML = `<button class="batch-action-btn" data-action="some_action_you_had" data-batch-id="${batch.id}">...</button>`;
            
            // **NEW LINKED BUTTON HTML**
            const detailPageLink = `batch-detail.html?batchId=${batch.id}`;
            const newButtonHTML = `
                <a href="${detailPageLink}" class="batch-action-btn" data-batch-id="${batch.id}">
                    <span class="spinner" style="display:none;"></span> <!-- Keep spinner if needed for future JS actions -->
                    <span><i class="fas fa-search-plus"></i> View Details</span>
                </a>`;

            return `
                <div class="batch-card" data-id="${batch.id}" data-aos="fade-up" data-aos-anchor-placement="top-bottom">
                    <div class="batch-img-container">
                        <img src="${escapeHTML(batch.imageUrl) || 'https://via.placeholder.com/400x225/333/888?text=EduSpark+Batch'}" alt="${escapeHTML(batch.name)}" class="batch-img" loading="lazy">
                        ${batch.priceDisplay ? `<div class="batch-price-tag">${escapeHTML(batch.priceDisplay)}</div>` : ''}
                        ${isEnrolled ? `<div class="batch-enroll-status"><i class="fas fa-check-circle"></i> Enrolled</div>` : ''}
                    </div>
                    <div class="batch-info">
                        <h3 class="batch-name">${escapeHTML(batch.name)}</h3>
                        ${descItemsHTML ? `<div class="batch-description-items">${descItemsHTML}</div>` : ''}
                        ${newButtonHTML} 
                    </div>
                </div>`;
        }

        function renderSkeletonBatchCards(container, count) { 
            let skeletons = '';
            for (let i = 0; i < count; i++) {
                skeletons += `
                    <div class="batch-card skeleton-batch-card" data-aos="fade-up">
                        <div class="batch-img-container"></div>
                        <div class="batch-info">
                            <div class="batch-name"></div>
                            <div class="batch-description-items"> <div class="batch-desc-item"></div> <div class="batch-desc-item"></div> <div class="batch-desc-item"></div> </div>
                            <div class="batch-action-btn"></div>
                        </div>
                    </div>`;
            }
            container.innerHTML = skeletons;
        }

        async function fetchBatches(loadMore = false) { 
            if(isLoadingBatches||(!hasMoreBatches&&loadMore))return;
            isLoadingBatches=true;
            if(!currentUser && elements.emptyStateAllBatches) { // If logged out, ensure login prompt is shown.
                elements.allBatchesContainer.innerHTML = '';
                elements.emptyStateAllBatches.innerHTML = `<i class="fas fa-sign-in-alt"></i><h3>Login to Discover Batches</h3><p>Please login to see available batches.</p>`;
                elements.emptyStateAllBatches.style.display='flex';
                isLoadingBatches = false;
                return;
            }

            if(!loadMore){renderSkeletonBatchCards(elements.allBatchesContainer,BATCHES_PER_PAGE);lastVisibleBatch=null;hasMoreBatches=true;elements.allBatchesContainer.innerHTML=''} 
            if(elements.emptyStateAllBatches)elements.emptyStateAllBatches.style.display='none';
            let query=db.collection('batches').where('status','==','active').orderBy('createdAt','desc').limit(BATCHES_PER_PAGE);
            if(loadMore&&lastVisibleBatch)query=query.startAfter(lastVisibleBatch);
            try{
                const snapshot=await query.get();
                if(!loadMore && elements.allBatchesContainer.querySelector('.skeleton-batch-card'))elements.allBatchesContainer.innerHTML=''; 
                const newBatches=[];
                snapshot.forEach(doc=>newBatches.push({id:doc.id,...doc.data()}));
                newBatches.forEach(batch=>{
                    const existingBatch = allBatchesCache.find(b => b.id === batch.id);
                    if (!existingBatch) allBatchesCache.push(batch); else Object.assign(existingBatch, batch); // Update cache
                    elements.allBatchesContainer.insertAdjacentHTML('beforeend', createBatchCardHTML(batch));
                });
                if(newBatches.length>0)lastVisibleBatch=snapshot.docs[snapshot.docs.length-1];
                hasMoreBatches=newBatches.length===BATCHES_PER_PAGE;
                if(elements.allBatchesContainer.children.length===0&&!loadMore){if(elements.emptyStateAllBatches)elements.emptyStateAllBatches.style.display='flex'} 
                AOS.refresh(); 
            }catch(error){
                console.error("Error fetching batches:",error);showToast("Could not load batches. Please try again.","error");
                if(!loadMore&&elements.emptyStateAllBatches && elements.allBatchesContainer.innerHTML==='')elements.emptyStateAllBatches.style.display='flex';
            }finally{isLoadingBatches=false;}
        }
        window.addEventListener('scroll', () => { if (elements.allBatchesPage.classList.contains('active') && (window.innerHeight + window.scrollY) >= document.body.offsetHeight - 300 && !isLoadingBatches && hasMoreBatches && currentUser) { fetchBatches(true); } });

        async function fetchMyBatches() { 
            if(!currentUser || isUserDataLoading){if(elements.emptyStateMyBatches)elements.emptyStateMyBatches.style.display='flex';elements.myBatchesContainer.innerHTML = ''; return} 
            renderSkeletonBatchCards(elements.myBatchesContainer,userEnrolledBatchesIds.length||3);
            if(userEnrolledBatchesIds.length===0){elements.myBatchesContainer.innerHTML='';if(elements.emptyStateMyBatches)elements.emptyStateMyBatches.style.display='flex';return} 
            if(elements.emptyStateMyBatches)elements.emptyStateMyBatches.style.display='none';
            try{
                const batchPromises=userEnrolledBatchesIds.map(id=>db.collection('batches').doc(id).get());
                const batchDocs=await Promise.all(batchPromises);
                elements.myBatchesContainer.innerHTML='';
                const myBatchesData = [];
                batchDocs.forEach(doc=>{if(doc.exists){const batchData = { id: doc.id, ...doc.data() }; myBatchesData.push(batchData); elements.myBatchesContainer.insertAdjacentHTML('beforeend', createBatchCardHTML(batchData));}});
                if(elements.myBatchesContainer.children.length===0){if(elements.emptyStateMyBatches)elements.emptyStateMyBatches.style.display='flex'} 
                // Profile page list is updated by updateUIAfterLogin -> renderProfileEnrolledBatches
                AOS.refresh();
            }catch(error){console.error("Error fetching my batches:",error);showToast("Could not load your enrolled batches.","error");if(elements.emptyStateMyBatches&&elements.myBatchesContainer.innerHTML==='')elements.emptyStateMyBatches.style.display='flex'}}
        
        elements.allBatchesContainer.addEventListener('click', handleBatchActionClick);
        elements.myBatchesContainer.addEventListener('click', handleBatchActionClick);

        async function handleBatchActionClick(e){
            const button = e.target.closest('.batch-action-btn');
            if (!button || !currentUser) { if(!currentUser) openModal(elements.loginModal); return; }
            if (isUserDataLoading) { showToast("Please wait, user data is loading.", "info"); return; }

            const action = button.dataset.action;
            const batchId = button.dataset.batchId;
            const batchLink = button.dataset.batchLink;

            toggleSpinner(button, true);

            if(action === 'enroll_explore'){
                if (!userEnrolledBatchesIds.includes(batchId)) {
                    try {
                        const batchDocRef = db.collection('batches').doc(batchId);
                        const batchDoc = await batchDocRef.get();
                        if(!batchDoc.exists) {showToast("This batch is no longer available.", "error"); toggleSpinner(button, false); return;}
                        const batchData = batchDoc.data();

                        await db.collection('users').doc(currentUser.uid).update({
                            enrolledBatches: firebase.firestore.FieldValue.arrayUnion(batchId)
                        });
                        // Only increment if enrollmentCount exists to avoid creating it if not used
                        if (batchData.enrollmentCount !== undefined) {
                            await batchDocRef.update({ enrollmentCount: firebase.firestore.FieldValue.increment(1) });
                        }
                        
                        // userEnrolledBatchesIds will be updated by the user snapshot listener
                        showToast(`Successfully enrolled in ${batchData.name}!`, "success");
                        await createNotification(currentUser.uid, "Enrollment Success!", `You are now enrolled in "${batchData.name}".`, "success", batchLink || '#');

                        // Optimistically update card if it's in allBatchesContainer or myBatchesContainer
                        const cardToUpdate = button.closest('.batch-card');
                        if(cardToUpdate) {
                            const updatedCardHTML = createBatchCardHTML({...batchData, id: batchId}); // Pass a copy
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = updatedCardHTML;
                            cardToUpdate.replaceWith(tempDiv.firstChild);
                            AOS.refreshHard(); // For replaced element
                        }
                        // Profile will auto-update its list due to user data listener.
                        if(elements.myBatchesPage.classList.contains('active')) fetchMyBatches();

                    } catch(err){ console.error("Error enrolling in batch:", err); showToast("Enrollment failed. Please try again.", "error"); }
                }
                 if(batchLink && batchLink !== '#') window.open(batchLink, '_blank');

            } else if (action === 'goto_course'){
                 if(batchLink && batchLink !== '#') window.open(batchLink, '_blank');
                 else showToast("Course link not available for this batch.", "info");
            }
            toggleSpinner(button, false);
        }

        async function renderProfileEnrolledBatches(batchesData = null) {
            elements.profileEnrolledBatchesList.innerHTML = '';
            elements.emptyStateProfileBatches.style.display = 'none';

            if (!currentUser || userEnrolledBatchesIds.length === 0) {
                elements.emptyStateProfileBatches.style.display = 'flex';
                return;
            }
            
            let batchesToRender = batchesData;
            if(!batchesToRender && userEnrolledBatchesIds.length > 0){ 
                 const batchPromises = userEnrolledBatchesIds.map(id => db.collection('batches').doc(id).get());
                 try {
                     const batchDocs = await Promise.all(batchPromises);
                     batchesToRender = batchDocs.filter(doc => doc.exists).map(doc => ({id: doc.id, ...doc.data()}));
                 } catch (error) {
                    console.error("Error fetching batches for profile list:", error);
                    elements.profileEnrolledBatchesList.innerHTML = '<li class="empty-state" style="display:block; min-height:50px; padding:10px 0;">Error loading enrolled batches.</li>';
                    AOS.refresh(); return;
                 }
            }
            
            if(batchesToRender && batchesToRender.length === 0 && userEnrolledBatchesIds.length > 0) {
                elements.profileEnrolledBatchesList.innerHTML = '<li class="empty-state" style="display:block; min-height:50px; padding:10px 0;">Some enrolled batches may no longer exist or could not be loaded.</li>';
                AOS.refresh(); return;
            } else if (!batchesToRender || batchesToRender.length === 0) {
                elements.emptyStateProfileBatches.style.display = 'flex';
                 AOS.refresh(); return;
            }

            batchesToRender.forEach(batch => {
                const li = document.createElement('li');
                li.className = 'enrolled-batch-item-profile'; 
                li.setAttribute('data-aos', 'fade-left'); 
                li.innerHTML = `
                    <div class="enrolled-batch-item-profile-header">
                        <img src="${escapeHTML(batch.imageUrl || 'https://via.placeholder.com/160x90/333/888?text=N/A')}" alt="${escapeHTML(batch.name)}">
                        <span class="name">${escapeHTML(batch.name)}</span>
                    </div>
                    <div class="enrolled-batch-item-profile-details">
                        ${batch.instructorName ? `<span><i class="fas fa-chalkboard-teacher"></i> ${escapeHTML(batch.instructorName)}</span>` : ''}
                        ${batch.durationText ? `<span><i class="far fa-clock"></i> ${escapeHTML(batch.durationText)}</span>` : ''}
                        ${batch.priceDisplay && batch.priceDisplay.toLowerCase() !== 'free' ? `<span><i class="fas fa-dollar-sign"></i> ${escapeHTML(batch.priceDisplay)}</span>` : (batch.priceDisplay ? `<span><i class="fas fa-gift"></i> ${escapeHTML(batch.priceDisplay)}</span>` : `<span><i class="fas fa-gift"></i> Free</span>`)}
                    </div>
                    <a href="${escapeHTML(batch.batchLink || '#')}" target="_blank" class="view-course-btn-profile" ${(!batch.batchLink || batch.batchLink ==='#') ? 'style="opacity:0.6; cursor:default;"' : ''}>
                        <i class="fas fa-external-link-alt"></i> View Course
                    </a>
                `;
                elements.profileEnrolledBatchesList.appendChild(li);
            });
            AOS.refresh();
        }

        function initializeQuickResponses(){
            elements.quickResponsesContainer.innerHTML = '';
            QUICK_RESPONSES.forEach(text => {
                const btn = document.createElement('button');
                btn.className = 'quick-response-btn';
                btn.textContent = text;
                btn.onclick = () => { elements.supportInput.value = text; elements.supportInput.focus(); };
                elements.quickResponsesContainer.appendChild(btn);
            });
        }
        
        async function loadSupportChatThreadListener() {
            if (!currentUser || isUserDataLoading) return;
            if (listeners.supportChatThread) listeners.supportChatThread();

            let threadQuerySnapshot;
            try { threadQuerySnapshot = await db.collection('support_threads').where('userId', '==', currentUser.uid).limit(1).get(); } 
            catch (error) { console.error("Error fetching support thread:", error); showToast("Could not initialize support chat.", "error"); return; }
            
            if (threadQuerySnapshot.empty) {
                const newThreadRef = db.collection('support_threads').doc();
                currentChatThreadId = newThreadRef.id;
                try {
                    await newThreadRef.set({
                        userId: currentUser.uid, userName: userData.name || "EduSpark User",
                        userProfilePic: userData.profilePictureURL || null, status: 'open', 
                        lastMessage: "Support thread started.", lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastMessageSender: 'system', unreadByAdmin: true, unreadByUser: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) { console.error("Error creating new support thread:", error); showToast("Could not start support chat.", "error"); return; }
            } else { currentChatThreadId = threadQuerySnapshot.docs[0].id; }
            
            listeners.supportChatThread = db.collection('support_threads').doc(currentChatThreadId)
                .onSnapshot(async (docSnapshot) => {
                    if(docSnapshot.exists){
                        const threadData = docSnapshot.data();
                        if (threadData.unreadByUser && threadData.lastMessageSender === 'admin' && !pages.support.classList.contains('active') && !pages.notifications.classList.contains('active') ) {
                             // Notification only if support or notifications not active
                             await createNotification(currentUser.uid, "New Support Reply", `Admin: "${threadData.lastMessage.substring(0,30)}..."`, 'support_reply', '#support'); 
                        }
                        if(pages.support.classList.contains('active') && threadData.unreadByUser){
                             db.collection('support_threads').doc(currentChatThreadId).update({unreadByUser: false}).catch(e => console.warn("Could not mark unreadByUser to false", e));
                        }
                    }
                }, error => { console.error("Error listening to support thread:", error); showToast("Support chat connection error.", "warning");});

            loadSupportChatMessages();
        }

        function loadSupportChatMessages(){
            if (!currentChatThreadId) return;
            if (listeners.supportChatMessages) listeners.supportChatMessages();
            elements.emptyStateSupport.style.display = 'none';

            listeners.supportChatMessages = db.collection('support_threads').doc(currentChatThreadId)
                .collection('messages').orderBy('timestamp', 'asc') 
                .onSnapshot(snapshot => {
                    const currentMessageIds = new Set(Array.from(elements.chatArea.children).map(el => el.dataset.messageId));
                    let newMessagesAdded = false;

                    if(snapshot.empty && elements.chatArea.innerHTML === ''){ elements.emptyStateSupport.style.display = 'flex'; } 
                    else { elements.emptyStateSupport.style.display = 'none'; }

                    snapshot.docChanges().forEach(change => {
                        if (change.type === "added") {
                            const msg = change.doc.data();
                            const msgId = change.doc.id;

                            if (!currentMessageIds.has(msgId)) { 
                                const msgDiv = document.createElement('div');
                                msgDiv.dataset.messageId = msgId; 
                                msgDiv.classList.add('chat-message', msg.senderId === currentUser.uid ? 'user' : (msg.senderId === 'system' ? 'system' : 'admin'));
                                msgDiv.innerHTML = `<p>${escapeHTML(msg.text)}</p><div class="message-meta">${msg.timestamp ? formatDateTime(msg.timestamp) : 'Sending...'}</div>`;
                                elements.chatArea.insertBefore(msgDiv, elements.chatArea.firstChild);
                                newMessagesAdded = true;
                            }
                        }
                    });
                    if(newMessagesAdded || elements.chatArea.scrollTop === 0) { elements.chatArea.scrollTop = 0; }
                }, error => {
                    console.error("Error fetching support messages:", error); showToast("Could not load chat messages.", "error");
                    elements.emptyStateSupport.style.display = 'flex';
                });
        }

        elements.sendSupportBtn.addEventListener('click', sendSupportMessage);
        elements.supportInput.addEventListener('keypress', (e) => { if(e.key === 'Enter' && !e.shiftKey) {e.preventDefault(); sendSupportMessage();} });

        async function sendSupportMessage() {
            const text = elements.supportInput.value.trim();
            if (!text || !currentChatThreadId || !currentUser || isUserDataLoading) return;
            toggleSpinner(elements.sendSupportBtn, true);
            const tempMessageId = `temp_${Date.now()}`; 

            const msgDiv = document.createElement('div');
            msgDiv.dataset.messageId = tempMessageId;
            msgDiv.classList.add('chat-message', 'user');
            msgDiv.innerHTML = `<p>${escapeHTML(text)}</p><div class="message-meta">Sending...</div>`;
            elements.chatArea.insertBefore(msgDiv, elements.chatArea.firstChild);
            elements.chatArea.scrollTop = 0; 
            elements.supportInput.value = '';

            try {
                await db.collection('support_threads').doc(currentChatThreadId).collection('messages').add({
                    senderId: currentUser.uid, text: text, timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                await db.collection('support_threads').doc(currentChatThreadId).update({
                    lastMessage: text.substring(0, 70), lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastMessageSender: 'user', unreadByAdmin: true, status: 'pending_admin' 
                });
                 if(elements.emptyStateSupport.style.display === 'flex') elements.emptyStateSupport.style.display = 'none';
            } catch (error) {
                console.error("Error sending support message:", error); showToast("Message could not be sent.", "error");
                const failedMsgEl = elements.chatArea.querySelector(`[data-message-id="${tempMessageId}"]`);
                if(failedMsgEl) failedMsgEl.remove();
            } finally { toggleSpinner(elements.sendSupportBtn, false); }
        }
        
        elements.faqBtn.onclick = () => { renderFAQs(); openModal(elements.faqModal); };
        elements.closeFaqModal.onclick = () => closeModal(elements.faqModal);

        function renderFAQs() {
            elements.faqListContainer.innerHTML = '';
            if (FAQS.length === 0) { elements.emptyStateFaq.style.display = 'flex'; return; }
            elements.emptyStateFaq.style.display = 'none';
            FAQS.forEach(faq => {
                const itemDiv = document.createElement('div'); itemDiv.className = 'faq-item';
                itemDiv.innerHTML = `<div class="faq-question">${escapeHTML(faq.q)}</div><div class="faq-answer">${escapeHTML(faq.a)}</div>`; 
                elements.faqListContainer.appendChild(itemDiv);
            });
        }
        
        const pages = { allBatches: elements.allBatchesPage, myBatches: elements.myBatchesPage, support: elements.supportPage, profile: elements.profilePage, notifications: elements.notificationsPage };
        const navButtons = { allBatches: elements.allBatchesNavBtn, myBatches: elements.myBatchesNavBtn, support: elements.supportNavBtn, profile: elements.profileNavBtn, notifications: elements.notificationsNavBtn };

        function setActivePage(pageKey) { 
             Object.values(pages).forEach(p=>p.classList.remove('active')); 
             Object.values(navButtons).forEach(b=>b.classList.remove('active')); 
             
             if(pages[pageKey]) pages[pageKey].classList.add('active'); 
             if(navButtons[pageKey]) navButtons[pageKey].classList.add('active');
             
             AOS.refresh();

             if(pageKey==='myBatches'&&currentUser)fetchMyBatches();
             else if(pageKey==='support'&&currentUser){ if(!currentChatThreadId && !isUserDataLoading) loadSupportChatThreadListener(); else loadSupportChatMessages(); } 
             else if(pageKey==='profile'&&currentUser) updateUIAfterLogin();
             else if(pageKey==='notifications'&&currentUser)fetchUserNotifications();
             else if(pageKey==='allBatches') { if(elements.allBatchesContainer.innerHTML==='' && currentUser) fetchBatches(false); else if (!currentUser) fetchBatches(false); /* Show login prompt if no current user */ }
        }
        
        function updateLastActiveMainPage() {
             const activeMainNavItem = Array.from(document.querySelectorAll('.nav-item.active, .action-nav-btn.active'))
                .find(b => b !== elements.profileNavBtn && b !== elements.notificationsNavBtn); // Exclude flyout page buttons
            if (activeMainNavItem && navButtons[activeMainNavItem.id.replace('NavBtn','')]) {
                 lastActiveMainPageKey = activeMainNavItem.id.replace('NavBtn','');
            }
        }

        elements.allBatchesNavBtn.onclick = () => { setActivePage('allBatches'); lastActiveMainPageKey = 'allBatches'; };
        elements.myBatchesNavBtn.onclick = () => { if (currentUser) { setActivePage('myBatches'); lastActiveMainPageKey = 'myBatches';} else openModal(elements.loginModal); };
        elements.supportNavBtn.onclick = () => { if (currentUser) {setActivePage('support'); lastActiveMainPageKey = 'support';} else openModal(elements.loginModal); };
        
        elements.profileNavBtn.onclick = () => { if (currentUser) { updateLastActiveMainPage(); openPage(elements.profilePage); setActivePage('profile');} else openModal(elements.loginModal); };
        elements.notificationsNavBtn.onclick = () => { if (currentUser) { updateLastActiveMainPage(); openPage(elements.notificationsPage); setActivePage('notifications');} else openModal(elements.loginModal); };
        
        elements.logoLink.onclick = (e) => { e.preventDefault(); setActivePage('allBatches'); lastActiveMainPageKey = 'allBatches'; closeAllFlyoutPages(); };
        elements.userAvatar.onclick = () => { if (currentUser) { updateLastActiveMainPage(); openPage(elements.profilePage); setActivePage('profile'); } else openModal(elements.loginModal); };


        function openPage(pageEl){ pageEl.classList.add('active'); elements.body.style.overflow = 'hidden'; AOS.refresh();}
        function closePage(pageEl){ pageEl.classList.remove('active'); if(!$$('.profile-page.active, .notifications-page.active').length && !$$('.modal.active').length) elements.body.style.overflow='auto';}
        function closeAllFlyoutPages() { 
            if (elements.profilePage.classList.contains('active')) closePage(elements.profilePage);
            if (elements.notificationsPage.classList.contains('active')) closePage(elements.notificationsPage);
        }

        elements.profileBackBtn.onclick = () => { closePage(elements.profilePage); setActivePage(lastActiveMainPageKey || 'allBatches');};
        elements.notificationsBackBtn.onclick = () => { closePage(elements.notificationsPage); setActivePage(lastActiveMainPageKey || 'allBatches');};
        
        elements.editProfileBtn.addEventListener('click', () => { if(currentUser && userData){ $('#editProfileName').value = userData.name || ''; $('#editProfileUsername').value = userData.username || ''; $('#editProfileBio').value = userData.bio || ''; elements.profilePicturePreview.src = userData.profilePictureURL || "https://via.placeholder.com/100?text=Pic"; tempProfilePicFile = null; openModal(elements.editProfileModal);} else if(!currentUser) {openModal(elements.loginModal);} });
        elements.logoutBtn.addEventListener('click', async () => { toggleSpinner(elements.logoutBtn,true); try {await auth.signOut();}catch(e){showToast("Logout failed.", "error");}finally{toggleSpinner(elements.logoutBtn,false);/* UI update via onAuthStateChanged */}});
        
        elements.profilePictureInput.addEventListener('change', (e)=>{ const file = e.target.files[0]; if(file){ if (file.size > 2 * 1024 * 1024) { showToast("Image too large (Max 2MB).", "error"); elements.profilePictureInput.value = ''; return; } tempProfilePicFile = file; const reader = new FileReader(); reader.onload = (event)=>{ elements.profilePicturePreview.src = event.target.result;}; reader.readAsDataURL(file);}});
        elements.editProfileForm.addEventListener('submit', async (e) => { e.preventDefault(); if(!currentUser || !userData) return; const newName = $('#editProfileName').value; const newUsername = $('#editProfileUsername').value.trim().toLowerCase(); const newBio = $('#editProfileBio').value; if (!/^[a-z0-9_.]{3,15}$/.test(newUsername)) { showToast("Username: 3-15 chars, lowercase, numbers, '_', '.'", "error"); return; } const btn = $('#saveProfileBtn'); toggleSpinner(btn,true); try { if (newUsername !== userData.username) { const usernameSnapshot = await db.collection('users').where('username', '==', newUsername).get(); if (!usernameSnapshot.empty && usernameSnapshot.docs[0].id !== currentUser.uid) { showToast("Username already taken.", "error"); toggleSpinner(btn,false); return;} } let profilePictureURL = userData.profilePictureURL; if(tempProfilePicFile){ const storageRef = storage.ref(`profile_pictures/${currentUser.uid}/${Date.now()}_${tempProfilePicFile.name}`); const uploadTask = await storageRef.put(tempProfilePicFile); profilePictureURL = await uploadTask.ref.getDownloadURL(); tempProfilePicFile=null;} await db.collection('users').doc(currentUser.uid).update({ name: newName, username: newUsername, bio: newBio, profilePictureURL: profilePictureURL }); showToast("Profile updated!", "success"); closeModal(elements.editProfileModal); } catch(err){ console.error("Profile update error:", err); showToast("Profile update failed: " + err.message + (err.code ? ` (Code: ${err.code})` : ''), "error");} finally {toggleSpinner(btn,false);}});

        async function fetchUserNotifications() { 
            if(!currentUser||isUserDataLoading){if(elements.emptyStateNotifications)elements.emptyStateNotifications.style.display='flex';elements.notificationsListContainer.innerHTML='';return} 
            if(elements.emptyStateNotifications)elements.emptyStateNotifications.style.display='none';
            if(listeners.userNotifications)listeners.userNotifications();
            
            listeners.userNotifications=db.collection('users').doc(currentUser.uid).collection('batches_notification').orderBy('timestamp','desc').limit(30).onSnapshot(snapshot=>{
                elements.notificationsListContainer.innerHTML='';let unreadCount=0;
                if(snapshot.empty){if(elements.emptyStateNotifications)elements.emptyStateNotifications.style.display='flex'}
                else{
                    if(elements.emptyStateNotifications)elements.emptyStateNotifications.style.display='none';
                    snapshot.forEach(doc=>{
                        const notif={id:doc.id,...doc.data()}; if(!notif.read)unreadCount++;
                        let iconClass='fa-info-circle'; if(notif.type==='success')iconClass='fa-check-circle'; else if(notif.type==='support_reply')iconClass='fa-headset'; else if(notif.type==='warning')iconClass='fa-exclamation-triangle'; else if(notif.type==='error')iconClass='fa-times-circle';
                        elements.notificationsListContainer.insertAdjacentHTML('beforeend',` <div class="notification-item ${notif.read?'':'unread'}" data-id="${notif.id}" data-link="${notif.link || ''}" data-aos="fade-left" data-aos-delay="50"> <div class="notification-icon"><i class="fas ${iconClass}"></i></div> <div class="notification-content"> <h4 class="notification-title">${escapeHTML(notif.title)}</h4> <p class="notification-message">${escapeHTML(notif.message)}</p> <p class="notification-timestamp">${notif.timestamp ? formatDateTime(notif.timestamp) : 'Just now'}</p> </div> </div>`);
                    })
                };
                if(elements.unreadNotificationsBadge){elements.unreadNotificationsBadge.textContent=unreadCount>9?'9+':unreadCount;elements.unreadNotificationsBadge.style.display=unreadCount>0?'flex':'none'}
                elements.markAllNotificationsReadBtn.style.display = unreadCount > 0 ? 'inline-flex' : 'none';
                AOS.refresh();
            },err=>{console.error("Error fetching notifications:",err);showToast("Failed to load notifications.","error"); if(elements.emptyStateNotifications && elements.notificationsListContainer.innerHTML==='')elements.emptyStateNotifications.style.display='flex'});
        }
        elements.notificationsListContainer.addEventListener('click', async (e) => { 
            const item = e.target.closest('.notification-item'); 
            if (item && currentUser) {
                const notifId = item.dataset.id; const notifLink = item.dataset.link;
                if (item.classList.contains('unread') && notifId) {
                    try { await db.collection('users').doc(currentUser.uid).collection('batches_notification').doc(notifId).update({read: true});} 
                    catch (err) { console.error("Error marking notification read:", err); } 
                }
                if (notifLink) {
                    if (notifLink.startsWith('#')) { 
                        const pageKey = notifLink.substring(1);
                        if (pages[pageKey]) {
                            updateLastActiveMainPage(); // Save current main page before switching
                            closePage(elements.notificationsPage); 
                            setActivePage(pageKey);
                            if (pageKey === 'profile' || pageKey === 'support') { // If link is to another flyout or a main page
                                 openPage(pages[pageKey]);
                            }
                            // else: it was a main content page, setActivePage handled it.
                        }
                    } else { window.open(notifLink, '_blank');}
                }
            } 
        });
        elements.markAllNotificationsReadBtn.onclick = async () => {
            if (!currentUser || !userData) return;
            const unreadNotifsQuery = db.collection('users').doc(currentUser.uid).collection('batches_notification').where('read', '==', false);
            try {
                toggleSpinner(elements.markAllNotificationsReadBtn, true);
                const batch = db.batch();
                const snapshot = await unreadNotifsQuery.get();
                if(snapshot.empty){showToast("No unread notifications.", "info"); return;}
                snapshot.docs.forEach(doc => { batch.update(doc.ref, { read: true }); });
                await batch.commit();
                showToast("All notifications marked as read.", "success");
            } catch (error) { console.error("Error marking all notifications read:", error); showToast("Failed to mark all as read.", "error");} 
            finally { toggleSpinner(elements.markAllNotificationsReadBtn, false); }
        };
        
        elements.loginForm.addEventListener('submit', async (e)=>{ e.preventDefault(); const em =$('#loginEmail').value; const pw = $('#loginPassword').value; const btn = $('#loginBtn'); toggleSpinner(btn,true); try {await auth.signInWithEmailAndPassword(em,pw); closeModal(elements.loginModal); } catch(err){ showToast(err.message,"error");} finally {toggleSpinner(btn,false);}});
        elements.signupForm.addEventListener('submit', async (e)=>{ e.preventDefault(); const nm = $('#signupName').value; const un = $('#signupUsername').value.trim().toLowerCase(); const em = $('#signupEmail').value; const pw = $('#signupPassword').value; if (!/^[a-z0-9_.]{3,15}$/.test(un)) { showToast("Username: 3-15 chars, lowercase, numbers, '_', '.'", "error"); return; } if(pw.length<6){showToast("Password too short.", "error"); return;} const btn = $('#signupBtn'); toggleSpinner(btn,true); try { const methods = await auth.fetchSignInMethodsForEmail(em); if (methods.length > 0) { showToast("Email already in use.", "error"); toggleSpinner(btn,false); return; } const usernameSnapshot = await db.collection('users').where('username', '==', un).get(); if(!usernameSnapshot.empty){showToast("Username taken.","error");toggleSpinner(btn,false);return;} await auth.createUserWithEmailAndPassword(em,pw); closeModal(elements.signupModal); /* createUserDocument is handled by onAuthStateChanged if doc missing */ } catch(err){ showToast(err.message, "error");} finally {toggleSpinner(btn,false);}});
        elements.googleLoginBtn.onclick = async () => { const prov = new firebase.auth.GoogleAuthProvider(); toggleSpinner(elements.googleLoginBtn,true); try {await auth.signInWithPopup(prov); closeModal(elements.loginModal);} catch(err){showToast(err.message,"error");}finally{toggleSpinner(elements.googleLoginBtn,false);}};
        elements.googleSignupBtn.onclick = async () => { const prov = new firebase.auth.GoogleAuthProvider();toggleSpinner(elements.googleSignupBtn,true); try {await auth.signInWithPopup(prov); closeModal(elements.signupModal);} catch(err){showToast(err.message,"error");}finally{toggleSpinner(elements.googleSignupBtn,false);}};
        elements.switchToSignup.onclick = ()=>{closeModal(elements.loginModal); openModal(elements.signupModal);};
        elements.switchToLogin.onclick = ()=>{closeModal(elements.signupModal); openModal(elements.loginModal);};
        elements.closeLoginModal.onclick = () => closeModal(elements.loginModal);
        elements.closeSignupModal.onclick = () => closeModal(elements.signupModal);
        elements.closeEditProfileModal.onclick = () => closeModal(elements.editProfileModal);
        $$('.modal').forEach(m => m.addEventListener('click', (e)=>{if(e.target===m)closeModal(m);}));
        
        function closeAllPagesAndModals() { Object.values(pages).forEach(p=>p.classList.remove('active')); $$('.modal.active').forEach(closeModal); closeAllFlyoutPages(); }
        function resetNavigation() { setActivePage('allBatches'); lastActiveMainPageKey = 'allBatches'; } 

        function setupAllBatchesListenerForSearch() { if (!currentUser) {allBatchesCache = []; if(listeners.allBatchesSearch) listeners.allBatchesSearch(); listeners.allBatchesSearch = null; return;} if(listeners.allBatchesSearch) return; listeners.allBatchesSearch = db.collection('batches').where('status', '==', 'active').onSnapshot(snapshot => {allBatchesCache = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()})); console.log("Batches search cache updated:", allBatchesCache.length); if (elements.searchInput.value.length >=2) handleBatchSearch(); /* Re-filter if search input has text */}, error => {console.error("Error listening to batches for search:", error); showToast("Search might be limited due to network error.", "warning");});}
        let searchTimeout;
        elements.searchInput.addEventListener('input', () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(handleBatchSearch, 300); });
        elements.searchInput.addEventListener('focus', () => { if (elements.searchInput.value.length >=2) handleBatchSearch(); }); // Show results on focus if query present
        function handleBatchSearch(){ if (!currentUser) {elements.searchResults.style.display = 'none'; return; } const query = elements.searchInput.value.toLowerCase().trim(); if(query.length < 2) { elements.searchResults.style.display = 'none'; return; } const results = allBatchesCache.filter(batch => batch.name.toLowerCase().includes(query) || (batch.descriptionItems && batch.descriptionItems.some(item => String(item.value).toLowerCase().includes(query) || String(item.label).toLowerCase().includes(query))) || (batch.instructorName && batch.instructorName.toLowerCase().includes(query)) ).slice(0, 5); renderBatchSearchResults(results);}
        function renderBatchSearchResults(results){ if(results.length === 0){ elements.searchResults.innerHTML = '<div class="no-results">No batches found.</div>';} else { elements.searchResults.innerHTML = results.map(batch => ` <div class="search-result-item" data-batch-id="${batch.id}"> <h4>${escapeHTML(batch.name)}</h4> <p>${escapeHTML(batch.instructorName || (batch.descriptionItems && batch.descriptionItems.length > 0 ? batch.descriptionItems[0].label +': '+ batch.descriptionItems[0].value : 'Course'))}</p> </div> `).join('');} elements.searchResults.style.display = 'block';}
        elements.searchResults.addEventListener('click', (e)=>{ const item = e.target.closest('.search-result-item'); if(!currentUser) {openModal(elements.loginModal); return;} if(item && item.dataset.batchId){ setActivePage('allBatches'); lastActiveMainPageKey = 'allBatches'; const batchCard = elements.allBatchesContainer.querySelector(`.batch-card[data-id="${item.dataset.batchId}"]`); if(batchCard){ batchCard.scrollIntoView({behavior: 'smooth', block: 'center'}); batchCard.classList.add('batch-card-highlighted'); setTimeout(() => batchCard.classList.remove('batch-card-highlighted'), 2500); } else { showToast("Batch found. It might be further down the list, try scrolling.", "info");} elements.searchResults.style.display = 'none'; elements.searchInput.value = ''; if (elements.searchContainer.classList.contains('active') && window.innerWidth <= 768) { elements.searchContainer.classList.remove('active'); } } });
        document.addEventListener('click', (e)=>{ if (!elements.searchContainer.contains(e.target)) { elements.searchResults.style.display = 'none'; } if (elements.searchContainer.classList.contains('active') && window.innerWidth <= 768 && !elements.searchContainer.contains(e.target) && e.target !== elements.searchToggleBtn){ elements.searchContainer.classList.remove('active'); }});
        elements.searchToggleBtn.addEventListener('click', (e)=>{ e.stopPropagation(); elements.searchContainer.classList.toggle('active'); if(elements.searchContainer.classList.contains('active')) elements.searchInput.focus(); else elements.searchResults.style.display = 'none'; });
        window.addEventListener('scroll', () => { if (window.scrollY > 50) elements.header.classList.add('scrolled'); else elements.header.classList.remove('scrolled'); });

        document.addEventListener('DOMContentLoaded', () => {
            startLoadingMessages();
            initializeQuickResponses();
            resetNavigation(); 
            // Auth state change will handle initial data loading and UI setup.
        });
    </script>
</body>
</html>
