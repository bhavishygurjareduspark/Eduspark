<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
      content="default-src 'self' https://*.firebaseio.com https://*.firebasedatabase.app https://*.googleapis.com https://*.gstatic.com https://cdnjs.cloudflare.com https://unpkg.com https://cdn.jsdelivr.net;
               script-src 'self' 'unsafe-inline' https://www.gstatic.com/firebasejs/ https://unpkg.com https://cdn.jsdelivr.net https://www.google.com/recaptcha/api.js https://*.google.com https://www.gstatic.com/recaptcha/;
               style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com https://unpkg.com;
               font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com;
               img-src 'self' data: blob: https: http://via.placeholder.com https://firebasestorage.googleapis.com;
               connect-src 'self' wss://*.firebaseio.com https://*.googleapis.com https://*.firebaseio.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://firestore.googleapis.com https://firebaseinstallations.googleapis.com https://firebasestorage.googleapis.com https://firebaseappcheck.googleapis.com;
               object-src 'none';
               base-uri 'self';
               form-action 'self';
               frame-src 'self' https://www.google.com/recaptcha/ https://*.google.com;">
    <title>EduSparK - Share Knowledge</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app-check.js"></script>

    <style>
        :root {
            --primary-color: #ff3333;
            --primary-light: #ff6666;
            --primary-dark: #cc0000; /* Darker primary */
            --secondary-color: #000000;
            --secondary-light: #2a2a2a; /* Lighter secondary */
            --secondary-dark: #000000;
            --text-light: #f1f2f6;
            --text-dark: #dfe4ea;
            --text-muted: #a4b0be;
            --bg-light: #1e1e1e; /* Slightly lighter dark bg */
            --bg-dark: #121212; /* Very dark bg */
            --card-bg: #212121; /* Darker card bg */
            --card-bg-dark: #1a1a1a; /* Darker modal bg */
            --gradient: linear-gradient(135deg, #ff3333, #cc0000);
            --gradient-light: linear-gradient(135deg, #ff6666, #ff3333);
            --gradient-dark: linear-gradient(135deg, #ff0000, #990000);
            --shadow-sm: 0 2px 5px rgba(0, 0, 0, 0.35);
            --shadow-md: 0 6px 12px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.45);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.5);
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --border-radius-xs: 6px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.15s ease-out;
            --header-height: 70px;
            --nav-height: 70px;
            --max-width: 1200px;
            --skeleton-bg: #303030;
            --skeleton-highlight: #404040;
            --credit-color: #ffd700; /* Gold color for credits */
            --star-color: #f1c40f; /* Yellow for stars */
            --profile-header-bg: linear-gradient(135deg, rgba(30, 30, 30, 0.9), rgba(18, 18, 18, 0.98));
            --notification-unread-dot: #3498db;
            --notification-bg-success: rgba(39, 174, 96, 0.15);
            --notification-border-success: #27ae60;
            --notification-bg-info: rgba(52, 152, 219, 0.15);
            --notification-border-info: #3498db;
            --notification-bg-warning: rgba(243, 156, 18, 0.15);
            --notification-border-warning: #f39c12;
            --notification-bg-error: rgba(231, 76, 60, 0.15);
            --notification-border-error: #e74c3c;
            --status-pending-bg: #f39c12;
            --status-rejected-bg: #e74c3c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
             scroll-behavior: smooth;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-dark);
            min-height: 100vh;
            padding-top: var(--header-height);
            padding-bottom: var(--nav-height);
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-dark);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 9999;
            transition: opacity 0.7s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.7s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 1; visibility: visible;
        }
        .loading-overlay.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .loading-logo-container { display: flex; align-items: center; margin-bottom: 25px; animation: logoPulse 2s infinite ease-in-out; }
        .loading-logo-icon { font-size: 3.5rem; color: var(--primary-color); margin-right: 15px; }
        .loading-logo-text { font-size: 2.2rem; font-weight: 700; color: var(--primary-light); letter-spacing: 1px; }
        .loading-dots { display: flex; justify-content: center; align-items: center; margin-bottom: 30px; }
        .loading-dots span { width: 12px; height: 12px; margin: 0 6px; background-color: var(--primary-color); border-radius: 50%; animation: loadingBounce 1.4s infinite ease-in-out both; }
        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        .loading-message { color: var(--text-muted); font-size: 1rem; font-style: italic; max-width: 80%; text-align: center; animation: fadeInText 1.5s ease-out forwards; opacity: 0; animation-delay: 0.5s;}
        @keyframes logoPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes loadingBounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        @keyframes fadeInText { to { opacity: 1; } }

        .header {
            background-color: rgba(18, 18, 18, 0.85); backdrop-filter: blur(15px) saturate(180%); -webkit-backdrop-filter: blur(15px) saturate(180%); color: var(--text-light); height: var(--header-height); display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-md); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; padding: 0 20px; transition: height 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease; border-bottom: 1px solid rgba(255, 51, 51, 0.1);
        }
        .header.scrolled { height: 65px; background-color: rgba(18, 18, 18, 0.95); box-shadow: 0 6px 25px rgba(0, 0, 0, 0.25); }
        .logo-container { display: flex; align-items: center; flex-shrink: 0; }
        .logo { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); display: flex; align-items: center; text-decoration: none; transition: transform 0.3s ease; position: relative; padding: 5px 0; }
        .logo:hover { transform: scale(1.05); }
        .logo i { margin-right: 10px; font-size: 1.6rem; color: var(--primary-color); transition: transform 0.3s ease; }
        .logo:hover i { transform: rotate(-10deg); }
        .logo-text { display: inline-block; position: relative; transition: opacity 0.3s ease; }
        @media (max-width: 420px) { .logo-text { font-size: 1.5rem; } .logo i { margin-right: 5px; } }
        .header-actions { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .header-credits { display: flex; align-items: center; gap: 8px; color: var(--text-light); font-weight: 600; font-size: 0.9rem; cursor: pointer; padding: 6px 12px; border-radius: 25px; background-color: rgba(255, 255, 255, 0.07); transition: background-color 0.3s ease, transform 0.2s ease; border: 1px solid rgba(255, 255, 255, 0.1); }
        .header-credits:hover { background-color: rgba(255, 255, 255, 0.15); transform: scale(1.05); }
        .header-credits i { font-size: 1.1rem; color: var(--credit-color); }
        #headerCreditsAmount { min-width: 20px; text-align: right; }

        .search-container { position: relative; width: 250px; transition: all 0.3s ease; margin-left: auto; margin-right: 10px; }
        .search-input { width: 100%; padding: 10px 15px 10px 40px; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 30px; background-color: rgba(255, 255, 255, 0.05); color: var(--text-light); font-family: 'Poppins', sans-serif; transition: all 0.3s ease; font-size: 0.9rem; }
        .search-input::placeholder { color: rgba(255, 255, 255, 0.5); }
        .search-input:focus { outline: none; background-color: rgba(255, 255, 255, 0.1); box-shadow: 0 0 0 2px var(--primary-light); border-color: var(--primary-light); }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-light); opacity: 0.6; font-size: 1rem; pointer-events: none; }
        .search-results { position: absolute; top: calc(100% + 8px); left: 0; right: 0; background-color: var(--card-bg); border-radius: var(--border-radius-sm); box-shadow: var(--shadow-xl); max-height: 350px; overflow-y: auto; z-index: 1001; display: none; animation: fadeInDown 0.3s ease forwards; border: 1px solid rgba(255, 255, 255, 0.1); }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .search-result-item { padding: 12px 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); cursor: pointer; transition: background-color 0.2s ease; }
        .search-result-item:hover { background-color: rgba(255, 255, 255, 0.08); }
        .search-result-item h4 { font-size: 0.95rem; color: var(--text-dark); margin-bottom: 5px; font-weight: 500; }
        .search-result-item p { font-size: 0.8rem; color: var(--text-muted); }
        .no-results { padding: 20px; text-align: center; color: var(--text-muted); font-size: 0.9rem; }
        .search-toggle-btn { background: none; border: none; color: var(--text-light); font-size: 1.2rem; cursor: pointer; padding: 5px; display: none; }
        @media (max-width: 768px) { .search-container { position: absolute; top: calc(var(--header-height) + 10px); left: 10px; right: 10px; width: auto; z-index: 999; background-color: var(--bg-light); padding: 10px; border-radius: var(--border-radius-sm); box-shadow: var(--shadow-lg); opacity: 0; visibility: hidden; transform: translateY(-10px); transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease; } .search-container.active { opacity: 1; visibility: visible; transform: translateY(0); } .search-toggle-btn { display: block; order: -1; margin-right: 5px; } .search-results { top: calc(100% + 5px); left: 0; right: 0; width: 100%; } .search-container.active ~ .header-actions .header-credits { display: none; } }
        @media (max-width: 576px) { .search-container { top: calc(var(--header-height) + 5px); } .header-actions { gap: 8px; } .header-credits { padding: 5px 8px; font-size: 0.8rem; } .header-credits i { font-size: 1rem; } }
        @media (max-width: 420px) { .header-credits { display: none; } .header-actions .search-toggle-btn { margin-right: 0;} }

        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; display: flex; align-items: center; justify-content: center; background: var(--gradient); color: white; font-weight: 600; font-size: 1rem; position: relative; overflow: hidden; flex-shrink: 0; }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%;}
        .user-avatar::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 70%); opacity: 0; transition: opacity 0.4s ease; }
        .user-avatar:hover { transform: scale(1.1); box-shadow: 0 0 15px rgba(255, 51, 51, 0.5); }
        .user-avatar:hover::after { opacity: 1; }

        .popular-books-section { padding: 30px 20px; background: linear-gradient(180deg, rgba(18, 18, 18, 0.9) 0%, rgba(18, 18, 18, 0) 100%), var(--bg-dark); margin-bottom: 20px; }
        .section-title { font-size: 1.8rem; margin-bottom: 25px; color: var(--primary-light); position: relative; display: inline-block; font-weight: 600; padding-bottom: 10px; text-align: center; width: 100%; }
        .section-title::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 70px; height: 4px; background: var(--gradient); border-radius: 4px; animation: scaleIn 0.6s ease-out forwards; }
        @keyframes scaleIn { from { transform: translateX(-50%) scaleX(0); } to { transform: translateX(-50%) scaleX(1); } }
        .popular-books-carousel { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 20px; -ms-overflow-style: none; scrollbar-width: none; }
        .popular-books-carousel::-webkit-scrollbar { display: none; }
        .popular-book-card { flex: 0 0 auto; width: 160px; background-color: var(--card-bg); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow-md); transition: var(--transition); border: 1px solid rgba(255, 255, 255, 0.08); position: relative; cursor: pointer; }
        .popular-book-card:hover { transform: translateY(-8px) scale(1.03); box-shadow: var(--shadow-lg); }
        .popular-book-img-container { height: 200px; overflow: hidden; position: relative; background-color: rgba(255, 255, 255, 0.05); display: flex; align-items: center; justify-content: center; }
        .popular-book-img { width: auto; height: 100%; object-fit: cover; transition: transform 0.5s ease; } /* Changed from width:100% for better fit */
        .popular-book-card:hover .popular-book-img { transform: scale(1.1); }
        .popular-book-info { padding: 12px; }
        .popular-book-title { font-size: 0.9rem; font-weight: 600; color: var(--text-dark); margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .popular-book-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px; }
        .popular-book-meta i { color: var(--primary-color); font-size: 0.8rem; }

        .container { padding: 20px; max-width: var(--max-width); margin: 0 auto; }
        .page-title { font-size: 2rem; margin-bottom: 25px; color: var(--primary-color); position: relative; display: inline-block; font-weight: 600; padding-bottom: 10px; }
        .page-title::after { content: ''; position: absolute; bottom: 0; left: 0; width: 60px; height: 4px; background: var(--gradient); border-radius: 4px; transform-origin: left; animation: scaleInMain 0.6s ease-out forwards; }
        @keyframes scaleInMain { from { transform: scaleX(0); } to { transform: scaleX(1); } }
        .category-filter-container { margin-bottom: 25px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding: 10px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .category-filter-item { padding: 8px 18px; border-radius: 20px; background-color: var(--card-bg); color: var(--text-muted); font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; border: 1px solid transparent; }
        .category-filter-item:hover { background-color: var(--secondary-light); color: var(--text-light); transform: translateY(-2px); }
        .category-filter-item.active { background: var(--gradient); color: white; font-weight: 600; box-shadow: 0 4px 10px rgba(255, 51, 51, 0.3); border-color: var(--primary-dark); }
        
        /* Updated books-grid */
        .books-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; margin-top: 20px; }
        #booksGridLoadingIndicator { grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--text-muted); font-size: 1rem; display: none; }
        #booksGridLoadingIndicator .spinner { width: 24px; height: 24px; border-color: var(--text-muted); border-top-color: var(--primary-color); margin-right: 10px; vertical-align: middle; }

        .skeleton { background-color: var(--skeleton-bg); animation: pulse-bg 1.5s infinite ease-in-out; border-radius: 4px; }
        .skeleton-img { height: 220px; border-radius: var(--border-radius-sm) var(--border-radius-sm) 0 0; }
        /* Skeleton for new compact main card */
        .skeleton-book-card.main-compact .skeleton-img { height: 200px; }
        .skeleton-book-card.main-compact .skeleton-info { padding: 12px; }
        .skeleton-book-card.main-compact .skeleton-text.title { width: 90%; height: 1.1em; margin-top: 5px; margin-bottom: 8px; }
        .skeleton-book-card.main-compact .skeleton-text.meta { width: 40%; height: 0.9em; margin-left: auto; margin-right: auto; margin-bottom: 10px; } /* Centered meta */
        .skeleton-book-card.main-compact .skeleton-btn { height: 34px; border-radius: var(--border-radius-sm); margin-top: auto; }


        .skeleton-text { height: 1em; margin-bottom: 10px; }
        .skeleton-btn { height: 38px; border-radius: var(--border-radius-sm); margin-top: 15px; }
        .skeleton-book-card { background-color: var(--card-bg); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow-md); border: 1px solid rgba(255, 255, 255, 0.08); /* height: 390px; */ display: flex; flex-direction: column; } /* Removed fixed height */
        .skeleton-book-card .skeleton-img { flex-shrink: 0; background-color: var(--skeleton-bg); animation: pulse-bg 1.5s infinite ease-in-out; }
        .skeleton-book-card .skeleton-info { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .skeleton-book-card .skeleton-text.title { width: 85%; height: 1.2em; margin-top: 5px; }
        .skeleton-book-card .skeleton-text.author { width: 60%; height: 0.9em; margin-top: 8px; }
        .skeleton-book-card .skeleton-text.meta { width: 40%; height: 0.8em; margin-top: 15px; }
        .skeleton-book-card .skeleton-btn { margin-top: auto; background-color: var(--skeleton-bg); animation: pulse-bg 1.5s infinite ease-in-out; }
        .skeleton-popular-book { flex: 0 0 auto; width: 160px; }
        .skeleton-popular-book .skeleton-img { height: 200px; border-radius: var(--border-radius-sm) var(--border-radius-sm) 0 0; background-color: var(--skeleton-bg); animation: pulse-bg 1.5s infinite ease-in-out; }
        .skeleton-popular-book .skeleton-info { padding: 12px; }
        .skeleton-popular-book .skeleton-text.title { width: 80%; height: 1em; margin-bottom: 8px; }
        .skeleton-popular-book .skeleton-text.meta { width: 50%; height: 0.8em; margin-top: 8px; }
        .skeleton-history-item { height: 80px; background-color: var(--skeleton-bg); border-radius: var(--border-radius-sm); animation: pulse-bg 1.5s infinite ease-in-out; margin-bottom: 15px; }
        .skeleton-notification-item { display: flex; align-items: flex-start; padding: 15px; background-color: var(--skeleton-bg); border-radius: var(--border-radius-sm); margin-bottom: 12px; animation: pulse-bg 1.5s infinite ease-in-out; }
        .skeleton-notification-item .skeleton-icon { width: 36px; height: 36px; border-radius: 50%; background-color: var(--skeleton-highlight); margin-right: 15px; }
        .skeleton-notification-item .skeleton-content { flex: 1; }
        .skeleton-notification-item .skeleton-text.title { width: 60%; height: 1.1em; margin-bottom: 8px; background-color: var(--skeleton-highlight); }
        .skeleton-notification-item .skeleton-text.message { width: 90%; height: 0.9em; margin-bottom: 10px; background-color: var(--skeleton-highlight); }
        .skeleton-notification-item .skeleton-text.timestamp { width: 30%; height: 0.7em; background-color: var(--skeleton-highlight); }
        @keyframes pulse-bg { 0% { background-color: var(--skeleton-bg); } 50% { background-color: var(--skeleton-highlight); } 100% { background-color: var(--skeleton-bg); } }

        .book-card { background-color: var(--card-bg); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow-md); transition: transform 0.3s ease, box-shadow 0.3s ease; position: relative; border: 1px solid rgba(255, 255, 255, 0.08); display: flex; flex-direction: column; /* height: 100%; */ opacity: 0; transform: translateY(20px); animation: cardFadeInUp 0.5s ease forwards; } /* Removed height:100% for natural height based on content */
        @keyframes cardFadeInUp { to { opacity: 1; transform: translateY(0); } }
        .books-grid .book-card:nth-child(1), #profileBooksContainer .book-card:nth-child(1) { animation-delay: 0.05s; }
        .books-grid .book-card:nth-child(2), #profileBooksContainer .book-card:nth-child(2) { animation-delay: 0.1s; }
        .books-grid .book-card:nth-child(3), #profileBooksContainer .book-card:nth-child(3) { animation-delay: 0.15s; }
        .book-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: var(--shadow-lg); }
        .book-img-container { height: 220px; overflow: hidden; position: relative; background-color: rgba(255, 255, 255, 0.05); display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .book-img { width: auto; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
        .book-card:hover .book-img { transform: scale(1.08); }
        .book-info { padding: 15px; flex: 1; display: flex; flex-direction: column; background-color: var(--card-bg); }
        .book-title { font-size: 1rem; font-weight: 600; margin-bottom: 8px; color: var(--text-dark); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; min-height: 2.4em; }
        .book-author { font-size: 0.85rem; color: var(--primary-light); margin-bottom: 12px; font-weight: 500; }
        .book-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 0.75rem; color: var(--text-muted); }
        .book-meta span { display: flex; align-items: center; gap: 5px; }
        .book-meta i { color: var(--primary-color); font-size: 0.8rem; }
        .book-admin-info { font-size: 0.7rem; color: var(--text-muted); margin-top: auto; padding-top: 10px; border-top: 1px dashed rgba(255, 255, 255, 0.15); display: flex; align-items: center; gap: 5px; }
        .book-admin-info i { color: var(--primary-color); font-size: 0.8rem; }
        .action-btn { background: var(--gradient); color: white; border: none; padding: 10px 14px; border-radius: var(--border-radius-sm); display: flex; align-items: center; justify-content: center; width: 100%; cursor: pointer; transition: var(--transition); font-weight: 500; font-size: 0.9rem; position: relative; overflow: hidden; box-shadow: var(--shadow-sm); margin-top: auto; gap: 8px; }
        .action-btn::after { content: ''; position: absolute; top: -50%; left: -75%; width: 50%; height: 200%; background: linear-gradient(to right, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0) 100%); transform: skewX(-25deg); transition: left 0.7s ease; pointer-events: none; }
        .action-btn:hover::after { left: 125%; }
        .action-btn i { font-size: 0.9rem; }
        .action-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 8px 18px rgba(255, 51, 51, 0.4); background: var(--gradient-light); }
        .action-btn:disabled { background: var(--secondary-light) !important; opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; }

        /* Styles for new compact main book card */
        .book-card-main .book-info {
            padding: 12px;
        }
        .book-card-main .book-img-container { /* slightly smaller image for compact card */
            height: 200px; 
        }
        .book-card-main .book-title {
            font-size: 0.9rem;
            min-height: 2.2em; /* for 2 lines of text */
            margin-bottom: 8px;
        }
        .book-meta-main-page { /* For download count on main page card */
            justify-content: center !important;
            margin-bottom: 10px !important;
            font-size: 0.8rem;
        }
        .book-card-main .action-btn {
            font-size: 0.85rem;
            padding: 8px 12px;
        }
        /* End of new compact main book card styles */


        .status-badge { position: absolute; top: 10px; right: 10px; padding: 4px 9px; border-radius: var(--border-radius-xs); font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; z-index: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.3); backdrop-filter: blur(3px); }
        .status-badge.status-approved { background-color: rgba(39, 174, 96, 0.85); color: white; }
        .status-badge.status-pending { background-color: rgba(243, 156, 18, 0.85); color: white; }
        .status-badge.status-rejected { background-color: rgba(231, 76, 60, 0.85); color: white; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: rgba(26, 26, 26, 0.9); backdrop-filter: blur(12px) saturate(180%); -webkit-backdrop-filter: blur(12px) saturate(180%); display: flex; justify-content: space-around; align-items: center; height: var(--nav-height); z-index: 1000; box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.2); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .nav-item { color: var(--text-muted); font-size: 1.3rem; padding: 10px; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.3s ease, color 0.3s ease; position: relative; }
        .nav-item:hover { color: var(--primary-light); transform: translateY(-4px); }
        .nav-item.active { color: var(--primary-color); transform: translateY(-4px); }
        .nav-item.active::after { content: ''; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; background-color: var(--primary-color); border-radius: 50%; box-shadow: 0 0 10px var(--primary-color); animation: fadeIn 0.3s ease; }
        .nav-item .unread-badge { position: absolute; top: 8px; right: 8px; background-color: var(--notification-unread-dot); color: white; font-size: 0.6rem; font-weight: bold; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 0 2px var(--bg-light); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .add-btn { background: var(--gradient); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.7rem; transform: translateY(-20px); box-shadow: 0 8px 25px rgba(255, 51, 51, 0.45); transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease; cursor: pointer; border: none; outline: none; z-index: 1001; position: relative; overflow: hidden; }
        .add-btn::before { content: ''; position: absolute; inset: 0; border-radius: 50%; background: var(--gradient); opacity: 0.6; z-index: -1; animation: pulse-glow 2s infinite ease-out; }
        .add-btn:hover { transform: translateY(-25px) scale(1.1); box-shadow: 0 12px 30px rgba(255, 51, 51, 0.6); background: var(--gradient-light); }
        .add-btn:hover::before { animation-play-state: paused; }
        @keyframes pulse-glow { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 51, 51, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 51, 51, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 51, 51, 0); } }

        .profile-page { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-dark); z-index: 2000; transform: translateX(100%); transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); overflow-y: auto; padding: 0; opacity: 0; visibility: hidden; }
        .profile-page.active { transform: translateX(0); opacity: 1; visibility: visible; }
        .profile-page-content { padding: 20px; padding-top: var(--header-height); padding-bottom: calc(var(--nav-height) + 40px); max-width: var(--max-width); margin: 0 auto;}
        .page-back-btn { background: rgba(0, 0, 0, 0.4); border: none; color: var(--primary-light); font-size: 1.3rem; position: absolute; left: 15px; top: calc(15px + (var(--header-height) - 60px) / 2); cursor: pointer; transition: transform 0.3s ease, background-color 0.3s ease; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; backdrop-filter: blur(5px); z-index: 5; }
        .page-back-btn:hover { transform: scale(1.1); background-color: rgba(255, 51, 51, 0.3); color: white; }

        .profile-main-header { display: flex; flex-direction: column; align-items: center; text-align: center; background: var(--profile-header-bg); padding: 40px 20px 30px; border-radius: var(--border-radius); box-shadow: var(--shadow-lg); margin-bottom: 30px; position: relative; }
        .profile-main-header::before { content: ''; position: absolute; top:0; left:0; right:0; bottom:0; background-image: url("data:image/svg+xml,%3Csvg width='52' height='26' viewBox='0 0 52 26' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23ff3333' fill-opacity='0.04'%3E%3Cpath d='M10 10c0-2.21-1.79-4-4-4-3.314 0-6-2.686-6-6h2c0 2.21 1.79 4 4 4 3.314 0 6 2.686 6 6 0 2.21 1.79 4 4 4 3.314 0 6 2.686 6 6 0 2.21 1.79 4 4 4v2c-3.314 0-6-2.686-6-6 0-2.21-1.79-4-4-4-3.314 0-6-2.686-6-6zm25.464-1.95l8.486 8.486-1.414 1.414-8.486-8.486 1.414-1.414z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); opacity: 0.5; z-index: 0; border-radius: var(--border-radius); }
        .profile-avatar-lg { width: 130px; height: 130px; border-radius: 50%; object-fit: cover; border: 5px solid var(--primary-color); margin-bottom: 20px; background: var(--gradient); color: white; font-size: 3.2rem; display: flex; align-items: center; justify-content: center; font-weight: 700; box-shadow: 0 12px 30px rgba(0, 0, 0, 0.5); position: relative; z-index: 1; transition: transform 0.4s ease, box-shadow 0.4s ease; overflow: hidden; }
        .profile-avatar-lg img { width: 100%; height: 100%; object-fit: cover;}
        .profile-avatar-lg:hover { transform: scale(1.08) translateY(-5px); box-shadow: 0 0 35px rgba(255, 51, 51, 0.6); }
        #profileNameLarge { font-size: 2.2rem; margin-bottom: 5px; color: var(--text-light); font-weight: 700; text-shadow: 0 3px 8px rgba(0,0,0,0.6); z-index: 1;}
        #profileUsernameLarge { color: var(--primary-light); margin-bottom: 10px; font-size: 1.2rem; font-weight: 500; display: inline-block; padding: 5px 15px; background: rgba(0,0,0,0.4); border-radius: 25px; z-index: 1;}
        #profileEmailLarge, #profileJoinedLarge { color: var(--text-muted); margin-bottom: 8px; font-size: 0.95rem; display: inline-flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.25); padding: 6px 12px; border-radius: 20px; z-index: 1;}
        #profileEmailLarge i, #profileJoinedLarge i { color: var(--primary-color); }
        .profile-bio-box { margin-top: 20px; color: var(--text-light); line-height: 1.7; font-size: 0.95rem; padding: 20px 25px; background-color: rgba(255, 255, 255, 0.05); border-radius: var(--border-radius-sm); border-left: 4px solid var(--primary-color); text-align: left; position: relative; box-shadow: var(--shadow-sm); max-width: 600px; width:100%; z-index: 1; }
        .profile-bio-box::before { content: '\f10d'; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; top: 15px; right: 20px; font-size: 1.8rem; color: var(--primary-color); opacity: 0.1; }
        .profile-info-prompt { background-color: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-light); padding: 10px 15px; border-radius: var(--border-radius-sm); font-size: 0.9rem; margin-top: 15px; text-align: center; cursor: pointer; transition: var(--transition); z-index:1; }
        .profile-info-prompt:hover { background-color: rgba(255, 215, 0, 0.2); }
        .profile-info-prompt i { margin-right: 8px; color: var(--credit-color); }

        .profile-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .profile-dashboard-item { background-color: var(--card-bg); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow-md); transition: transform 0.3s ease, box-shadow 0.3s ease; border: 1px solid rgba(255,255,255,0.08);}
        .profile-dashboard-item:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .profile-dashboard-item h3 { font-size: 1.3rem; color: var(--primary-light); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .points-amount-large { font-size: 3.5rem; font-weight: 700; color: var(--primary-color); margin-bottom: 10px; line-height: 1.1; text-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .profile-dashboard-item p { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px; }
        .withdraw-btn-large { width: 100%; font-size: 1rem; padding: 12px 20px; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }
        .stat-card { background-color: rgba(255,255,255,0.05); padding: 15px; border-radius: var(--border-radius-sm); text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .stat-value { display: block; font-size: 2rem; font-weight: 700; color: var(--primary-color); margin-bottom: 5px; }
        .stat-label-card { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .profile-tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; overflow-x: auto; }
        .profile-tab-btn { background: none; border: none; color: var(--text-muted); font-size: 1rem; font-weight: 500; padding: 10px 18px; cursor: pointer; transition: color 0.3s ease, border-bottom-color 0.3s ease; border-bottom: 3px solid transparent; white-space: nowrap; }
        .profile-tab-btn:hover { color: var(--primary-light); }
        .profile-tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: 600; }
        .profile-tab-content { display: none; animation: tabFadeIn 0.5s ease forwards; }
        .profile-tab-content.active { display: block; }
        @keyframes tabFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .profile-section-title { font-size: 1.6rem; margin-bottom: 20px; color: var(--primary-light); font-weight: 600; position: relative; padding-bottom: 10px; text-align: center; }
        .profile-section-title::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 70px; height: 3px; background: var(--gradient); border-radius: 3px; }
        #profileBooksContainer { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-top: 20px; min-height: 200px; }
        #profileBooksContainer .book-card { opacity: 0; transform: translateY(20px); animation: cardFadeInUp 0.5s ease forwards; }
        .load-more-container { text-align: center; margin: 30px 0; }
        .load-more-btn { background: var(--gradient); color: white; border: none; padding: 12px 25px; border-radius: var(--border-radius-sm); font-size: 1rem; cursor: pointer; transition: var(--transition); font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 10px; box-shadow: var(--shadow-md); }
        .load-more-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(255, 51, 51, 0.5); background: var(--gradient-light); }
        .load-more-btn:disabled { background: var(--secondary-light); opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none; }
        #withdrawalHistoryContainer { display: flex; flex-direction: column; gap: 15px; min-height: 100px; flex-wrap: wrap; margin-top: 20px; }
        .withdrawal-item { padding: 15px 20px; border-radius: var(--border-radius-sm); background-color: rgba(255, 255, 255, 0.04); display: flex; justify-content: space-between; align-items: center; transition: var(--transition); border-left: 4px solid var(--primary-color); opacity: 0; transform: scale(0.95); animation: itemFadeInScale 0.4s ease forwards; width: 100%; word-break: break-word; }
        #withdrawalHistoryContainer .withdrawal-item:nth-child(1) { animation-delay: 0.1s; }
        #withdrawalHistoryContainer .withdrawal-item:nth-child(2) { animation-delay: 0.15s; }
        #withdrawalHistoryContainer .withdrawal-item:nth-child(3) { animation-delay: 0.2s; }
        @keyframes itemFadeInScale { to { opacity: 1; transform: scale(1); } }
        .withdrawal-item:hover { transform: translateX(5px) scale(1.01); box-shadow: var(--shadow-sm); border-left-color: var(--primary-light); }
        .withdrawal-info { flex: 1; margin-right: 15px; }
        .withdrawal-amount { font-weight: 600; color: var(--primary-color); margin-bottom: 5px; font-size: 1.05rem; }
        .withdrawal-method { font-size: 0.85rem; color: var(--text-light); margin-bottom: 5px; word-break: break-all; }
        .withdrawal-date { font-size: 0.8rem; color: var(--text-muted); }
        .withdrawal-status { padding: 6px 12px; border-radius: var(--border-radius-xs); font-size: 0.8rem; font-weight: 600; text-transform: uppercase; flex-shrink: 0; text-align: center; min-width: 80px; }
        .withdrawal-status.status-pending { background-color: var(--status-pending-bg, #f39c12); color: white; }
        .withdrawal-status.status-completed { background-color: var(--notification-border-success, #27ae60); color: white; } /* Matched success color */
        .withdrawal-status.status-rejected { background-color: var(--status-rejected-bg, #e74c3c); color: white; }

        .point-system-info-tabbed { background-color: rgba(255, 255, 255, 0.04); border-radius: var(--border-radius); padding: 25px; margin-top:20px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .point-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed rgba(255, 255, 255, 0.15); }
        .point-item:last-child { border-bottom: none; }
        .point-action { font-weight: 500; color: var(--text-light); font-size: 0.9rem; }
        .point-value { color: var(--primary-color); font-weight: 600; font-size: 1rem; }
        .profile-actions-footer { display: flex; gap: 15px; margin-top: 40px; justify-content: center; padding-bottom: 20px; flex-wrap: wrap; border-top: 1px solid rgba(255,255,255,0.1); padding-top:30px;}
        .profile-action-btn { color: white; border: none; padding: 12px 25px; border-radius: var(--border-radius-sm); font-size: 1rem; cursor: pointer; transition: var(--transition); font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 10px; box-shadow: var(--shadow-md); position: relative; overflow: hidden; flex: 1; min-width: 180px; max-width: 220px; }
        .profile-action-btn::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.1); opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .profile-action-btn:hover:not(:disabled) { transform: translateY(-3px); }
        .profile-action-btn:hover:not(:disabled)::after { opacity: 1; }
        .edit-profile { background: var(--gradient); }
        .edit-profile:hover:not(:disabled) { background: var(--gradient-light); box-shadow: 0 8px 20px rgba(255, 51, 51, 0.5); }
        .security-settings-btn { background: var(--secondary-color); border: 1px solid var(--primary-color); }
        .security-settings-btn:hover:not(:disabled) { background: var(--secondary-light); box-shadow: 0 6px 15px rgba(255, 51, 51, 0.3); }
        .logout-btn { background: var(--secondary-light); }
        .logout-btn:hover:not(:disabled) { background: #333; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); }

        .notifications-page { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-dark); z-index: 2000; transform: translateX(100%); transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0; visibility: hidden; display: flex; flex-direction: column; }
        .notifications-page.active { transform: translateX(0); opacity: 1; visibility: visible; }
        .notifications-header { padding: 0 15px; background: var(--card-bg-dark); color: white; display: flex; align-items: center; justify-content: space-between; height: var(--header-height); box-shadow: var(--shadow-md); border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; position: relative; }
        .notifications-actions { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); }
        .mark-all-read-btn { background: none; border: none; color: var(--primary-light); font-size: 0.85rem; font-weight: 500; cursor: pointer; padding: 8px 12px; border-radius: var(--border-radius-sm); transition: background-color 0.2s ease, color 0.2s ease; }
        .mark-all-read-btn:hover:not(:disabled) { background-color: rgba(255,255,255,0.1); color: white; }
        .mark-all-read-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .mark-all-read-btn i { margin-right: 6px; }
        .notifications-tabs { display: flex; background-color: var(--card-bg); padding: 0 10px; flex-shrink: 0; }
        .notification-tab-btn { flex: 1; text-align: center; background: none; border: none; color: var(--text-muted); font-size: 0.95rem; font-weight: 500; padding: 12px 10px; cursor: pointer; transition: color 0.3s ease, border-bottom-color 0.3s ease; border-bottom: 3px solid transparent; white-space: nowrap; position: relative; }
        .notification-tab-btn:hover { color: var(--primary-light); }
        .notification-tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: 600; }
        .nav-item-dot { position: absolute; top: 10px; right: 10px; width: 8px; height: 8px; background-color: var(--primary-color); border-radius: 50%; box-shadow: 0 0 0 2px var(--card-bg); }
        .notifications-content-area { flex: 1; overflow-y: hidden; position: relative; }
        .notifications-list-container { position: absolute; top: 0; left:0; width: 100%; height: 100%; overflow-y: auto; padding: 15px; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .notifications-list-container.active { opacity: 1; visibility: visible; }

        .notification-group { margin-bottom: 20px; }
        .notification-group-date { font-size: 0.9rem; font-weight: 600; color: var(--text-muted); margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.1); text-transform: uppercase; letter-spacing: 0.5px; }
        .notification-item { background-color: var(--card-bg); border-radius: var(--border-radius-sm); padding: 15px; margin-bottom: 12px; display: flex; align-items: flex-start; box-shadow: var(--shadow-sm); border-left: 4px solid transparent; transition: background-color 0.3s ease, transform 0.2s ease; cursor: pointer; opacity: 0; animation: itemFadeInScale 0.4s ease forwards; }
        .notification-item:hover { background-color: var(--secondary-light); transform: translateX(3px); }
        .notification-item.unread { background-color: rgba(52, 152, 219, 0.08); border-left-color: var(--notification-unread-dot); }
        .notification-item.unread .notification-title { color: var(--primary-light); font-weight: 700; }
        .notification-item.type-success { border-left-color: var(--notification-border-success); }
        .notification-item.type-success.unread { background-color: var(--notification-bg-success); }
        .notification-item.type-info { border-left-color: var(--notification-border-info); }
        .notification-item.type-info.unread { background-color: var(--notification-bg-info); }
        .notification-item.type-warning { border-left-color: var(--notification-border-warning); }
        .notification-item.type-warning.unread { background-color: var(--notification-bg-warning); }
        .notification-item.type-error { border-left-color: var(--notification-border-error); }
        .notification-item.type-error.unread { background-color: var(--notification-bg-error); }
        .notification-item.type-announcement { border-left-color: var(--primary-color); }
        .notification-item.type-announcement.unread { background-color: rgba(255, 51, 51, 0.10); }
        .notification-icon { font-size: 1.4rem; width: 40px; height: 40px; flex-shrink: 0; margin-right: 15px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background-color: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: background-color 0.3s ease, border-color 0.3s ease; }
        .notification-item.type-success .notification-icon { color: var(--notification-border-success); }
        .notification-item.type-info .notification-icon { color: var(--notification-border-info); }
        .notification-item.type-warning .notification-icon { color: var(--notification-border-warning); }
        .notification-item.type-error .notification-icon { color: var(--notification-border-error); }
        .notification-item.type-announcement .notification-icon { color: var(--primary-color); }
        .notification-item.type-success.unread .notification-icon { background-color: var(--notification-bg-success); border-color: var(--notification-border-success); }
        .notification-item.type-info.unread .notification-icon { background-color: var(--notification-bg-info); border-color: var(--notification-border-info); }
        .notification-item.type-warning.unread .notification-icon { background-color: var(--notification-bg-warning); border-color: var(--notification-border-warning); }
        .notification-item.type-error.unread .notification-icon { background-color: var(--notification-bg-error); border-color: var(--notification-border-error); }
        .notification-item.type-announcement.unread .notification-icon { background-color: rgba(255, 51, 51, 0.15); border-color: var(--primary-color); }
        .notification-content { flex: 1; }
        .notification-title { font-size: 1rem; font-weight: 600; color: var(--text-light); margin-bottom: 5px; }
        .notification-message { font-size: 0.9rem; color: var(--text-muted); line-height: 1.5; margin-bottom: 8px; word-break: break-word; }
        .notification-timestamp { font-size: 0.75rem; color: var(--text-muted); opacity: 0.8; margin-top: 4px; }

        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.85); z-index: 2500; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); padding: 20px 0; }
        .modal.active { display: flex; opacity: 1; }
        .modal-content { background-color: var(--card-bg-dark); border-radius: var(--border-radius); width: 90%; max-width: 480px; padding: 30px; box-shadow: var(--shadow-xl); transform: translateY(-20px) scale(0.95); transition: transform 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease; position: relative; max-height: 90vh; overflow-y: auto; border: 1px solid rgba(255, 255, 255, 0.1); }
        .modal.active .modal-content { transform: translateY(0) scale(1); }
        .modal-content::-webkit-scrollbar { width: 6px; }
        .modal-content::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 6px; }
        .modal-content::-webkit-scrollbar-track { background-color: rgba(255,255,255,0.05); }
        .close-modal { position: absolute; top: 10px; right: 10px; font-size: 1.8rem; color: var(--text-muted); cursor: pointer; background: none; border: none; transition: transform 0.3s ease, color 0.3s ease; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; line-height: 1; z-index: 10; }
        .close-modal:hover { color: var(--primary-color); transform: rotate(90deg) scale(1.1); }
        .modal-title { font-size: 1.6rem; margin-bottom: 25px; color: var(--primary-light); text-align: center; position: relative; padding-bottom: 12px; font-weight: 600; }
        .modal-title::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 60px; height: 4px; background: var(--gradient); border-radius: 4px; }
        .form-group { margin-bottom: 20px; position: relative; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-dark); font-size: 0.9rem; }
        .form-input, .form-textarea { width: 100%; padding: 12px 15px; border: 1px solid rgba(255, 255, 255, 0.15); border-radius: var(--border-radius-sm); font-family: 'Poppins', sans-serif; background-color: var(--bg-light); color: var(--text-dark); transition: var(--transition); font-size: 0.95rem; }
        .form-textarea { resize: vertical; min-height: 80px; }
        .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(255, 51, 51, 0.3); }
        
        /* New Button Loading Styles */
        .btn-loading-dots-container {
            display: inline-flex; /* Changed from inline-block to flex for better alignment */
            align-items: center; /* Vertically align dots with text */
            margin-left: 8px; /* Space between text and dots */
        }
        .btn-loading-dots-container span {
            display: inline-block;
            width: 6px;
            height: 6px;
            margin: 0 1px;
            background-color: currentColor; /* Inherit color from button text (usually white) */
            border-radius: 50%;
            animation: btnLoadingBounce 1.4s infinite ease-in-out both;
        }
        .btn-loading-dots-container span:nth-child(1) { animation-delay: -0.32s; }
        .btn-loading-dots-container span:nth-child(2) { animation-delay: -0.16s; }
        /* Removed btnLoadingBounce, using main loadingBounce */
        
        .button-is-loading {
            position: relative; /* Needed for shimmer */
            overflow: hidden; /* Needed for shimmer */
        }
        .button-is-loading::before { /* Shimmer element */
            content: '';
            position: absolute;
            top: 0; left: -150%; /* Start further off-screen for a better effect */
            width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.25), transparent);
            transform: skewX(-25deg); /* Angled shimmer */
            animation: loadingShimmer 1.8s infinite linear; /* Slower and linear for smoother look */
            pointer-events: none;
        }
        @keyframes loadingShimmer {
            0% { left: -150%; }
            100% { left: 150%; } /* Move completely across and off-screen */
        }

        /* End of New Button Loading Styles */

        /* General Button spinner, NOT for the new loading effect, but for indicators like on loadMoreBooks */
        .spinner { display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; }
        .submit-btn, .tutorial-btn, .profile-action-btn, .load-more-btn, .withdraw-btn, .withdraw-btn-large, .action-btn { position: relative; }

        .submit-btn > .button-text-content,
        .tutorial-btn > .button-text-content,
        .profile-action-btn > .button-text-content,
        .load-more-btn > .button-text-content,
        .withdraw-btn > .button-text-content,
        .withdraw-btn-large > .button-text-content,
        .action-btn > .button-text-content {
            transition: opacity 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px; /* For icon and text */
        }

        .submit-btn.loading > .button-text-content,
        .tutorial-btn.loading > .button-text-content,
        .profile-action-btn.loading > .button-text-content,
        .load-more-btn.loading > .button-text-content, /* Load more might still use simple spinner */
        .withdraw-btn.loading > .button-text-content,
        .withdraw-btn-large.loading > .button-text-content,
        .action-btn.loading > .button-text-content {
             opacity: 0.7; /* Dim the original text a bit instead of hiding fully for context */
        }
         /* For buttons that specifically use the .spinner class and not the new loading dots */
        .load-more-btn .spinner { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); }
        .load-more-btn.loading > .button-text-content { opacity: 0;}


        .submit-btn, .tutorial-btn { color: white; border: none; padding: 12px 18px; border-radius: var(--border-radius-sm); font-size: 1rem; font-weight: 500; cursor: pointer; width: 100%; transition: var(--transition); margin-top: 10px; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-sm); position: relative; overflow: hidden; }
        .submit-btn { background: var(--gradient); }
        .tutorial-btn { background: var(--secondary-light); }
        .submit-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(255, 51, 51, 0.5); background: var(--gradient-light); }
        .tutorial-btn:hover:not(:disabled) { background: #333; transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .submit-btn:disabled, .tutorial-btn:disabled { background: var(--secondary-light) !important; opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .submit-btn::after { content: ''; position: absolute; top: -50%; left: -75%; width: 50%; height: 200%; background: linear-gradient(to right, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0) 100%); transform: skewX(-25deg); transition: left 0.7s ease; pointer-events: none; }
        .submit-btn:hover:not(:disabled)::after { left: 125%; }


        /* Google Button & Separator Styles */
        .auth-separator { display: flex; align-items: center; text-align: center; color: var(--text-muted); margin: 18px 0; font-size: 0.8rem; }
        .auth-separator::before, .auth-separator::after { content: ''; flex: 1; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .auth-separator:not(:empty)::before { margin-right: .5em; }
        .auth-separator:not(:empty)::after { margin-left: .5em; }
        .google-btn { background-color: #4285F4 !important; color: white !important; }
        .google-btn:hover:not(:disabled) { background-color: #357ae8 !important; box-shadow: 0 8px 20px rgba(66, 133, 244, 0.4) !important; }
        .google-btn i { margin-right: 10px; font-size: 1.1em; }

        .auth-switch { text-align: center; margin-top: 20px; color: var(--text-muted); font-size: 0.9rem; }
        .auth-switch a { color: var(--primary-color); font-weight: 500; cursor: pointer; transition: color 0.3s ease; text-decoration: none; }
        .auth-switch a:hover { color: var(--primary-light); text-decoration: underline; }

        .withdrawal-options { display: flex; flex-direction: column; gap: 12px; margin: 25px 0; }
        .withdrawal-option { display: flex; align-items: center; padding: 15px; border-radius: var(--border-radius-sm); background-color: rgba(255, 255, 255, 0.05); cursor: pointer; transition: var(--transition); border: 2px solid transparent; }
        .withdrawal-option:hover { background-color: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.2); transform: scale(1.02); }
        .withdrawal-option.active { border: 2px solid var(--primary-color); background-color: rgba(255, 51, 51, 0.1); transform: scale(1.02); }
        .withdrawal-icon { width: 40px; height: 40px; border-radius: 50%; background: var(--gradient); color: white; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0; font-size: 1.1rem; box-shadow: var(--shadow-sm); }
        .withdrawal-details { flex: 1; }
        .withdrawal-title { font-size: 1rem; font-weight: 600; margin-bottom: 3px; color: var(--text-dark); }
        .withdrawal-description { font-size: 0.85rem; color: var(--text-muted); }
        .amount-selection { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin: 25px 0; }
        .amount-option { padding: 12px; text-align: center; border-radius: var(--border-radius-sm); background-color: rgba(255, 255, 255, 0.05); cursor: pointer; transition: var(--transition); font-weight: 500; border: 2px solid transparent; font-size: 0.9rem; }
        .amount-option:hover { background-color: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.2); transform: scale(1.03); }
        .amount-option.active { background: var(--gradient); color: white; border-color: var(--primary-dark); transform: scale(1.03); }
        .payment-details { margin-top: 20px; display: none; animation: fadeIn 0.5s ease forwards; }
        .payment-details.active { display: block; }
        .pin-info-text { font-size: 0.8rem; color: var(--text-muted); text-align: center; margin-top: 15px; }

        /* Referral Modal Styles */
        .referral-content { text-align: center; }
        .referral-code-box {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 15px 20px;
            border-radius: var(--border-radius-sm);
            margin: 20px auto;
            border: 1px dashed var(--primary-color);
            max-width: 350px;
        }
        .referral-code-box p { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px; }
        .referral-code {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-light);
            letter-spacing: 1px;
            padding: 8px;
            background-color: rgba(0,0,0,0.2);
            border-radius: var(--border-radius-xs);
            display: inline-block;
            margin-bottom: 15px;
        }
        .copy-referral-btn {
            background: var(--gradient); color: white; border: none; padding: 10px 20px;
            border-radius: var(--border-radius-sm); cursor: pointer; transition: var(--transition);
            font-weight: 500; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 8px;
        }
        .copy-referral-btn:hover { background: var(--gradient-light); transform: translateY(-2px); }
        .referral-stats { margin-top: 25px; display: flex; justify-content: space-around; gap: 15px; }
        .referral-stat-item {
            background-color: rgba(255, 255, 255, 0.03); padding: 15px;
            border-radius: var(--border-radius-sm); flex: 1;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .referral-stat-item .value { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); display: block; }
        .referral-stat-item .label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; }
        .referral-info { font-size: 0.85rem; color: var(--text-muted); margin-top: 25px; line-height: 1.6; }
        .referral-info strong { color: var(--primary-light); }

        .credit-options-list { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        #creditModalUserCredits { color: var(--credit-color); font-weight: 700; }

        #bookDetailModal .modal-content { max-width: 650px; }
        .book-detail-layout { display: flex; gap: 25px; }
        .book-detail-image { flex-shrink: 0; width: 200px; height: 280px; }
        .book-detail-image img { width: 100%; height: 100%; object-fit: cover; border-radius: var(--border-radius-sm); box-shadow: var(--shadow-md); }
        .book-detail-info { flex-grow: 1; }
        .book-detail-title { font-size: 1.7rem; font-weight: 700; color: var(--primary-light); margin-bottom: 5px; line-height: 1.3; }
        .book-detail-author { font-size: 1rem; color: var(--text-dark); margin-bottom: 8px; font-weight: 500; }
        .book-detail-category { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 15px; display: inline-block; background: rgba(255,255,255,0.05); padding: 4px 10px; border-radius: 15px; }
        .book-detail-meta { display: flex; gap: 20px; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
        .book-detail-meta span { display: flex; align-items: center; gap: 6px; }
        .book-detail-meta i { color: var(--primary-color); font-size: 1rem; }
        .book-detail-description { margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.04); border-radius: var(--border-radius-sm); line-height: 1.7; font-size: 0.95rem; max-height: 150px; overflow-y: auto; color: var(--text-light); border-left: 3px solid var(--primary-color); word-break: break-word; }
        .book-detail-actions { display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        .detail-download-btn { flex-grow: 1; }
        .feedback-separator { height: 1px; background: rgba(255,255,255,0.1); margin: 30px 0; }
        .feedback-section { margin-top: 25px; }
        .feedback-title { font-size: 1.3rem; color: var(--primary-light); margin-bottom: 20px; font-weight: 600; border-bottom: 2px solid var(--primary-color); padding-bottom: 8px; display: inline-block; }
        .rating-stars { margin-bottom: 15px; }
        .rating-stars label { font-size: 1rem; color: var(--text-dark); margin-right: 10px; }
        .rating-stars .stars { display: inline-block; }
        .rating-stars .stars > i { font-size: 1.6rem; color: var(--text-muted); cursor: pointer; transition: color 0.2s ease, transform 0.2s ease; margin: 0 3px; }
        .rating-stars .stars:hover > i { color: var(--star-color); }
        .rating-stars .stars > i:hover ~ i { color: var(--text-muted); }
        .rating-stars .stars > i.selected, .rating-stars .stars > i.hovered { color: var(--star-color); transform: scale(1.1); }
        #feedbackComment { margin-bottom: 15px; }
        #submitFeedbackBtn { width: auto; padding: 10px 25px; }
        .comments-list { margin-top: 25px; max-height: 250px; overflow-y: auto; padding-right: 10px; display: flex; flex-direction: column; gap: 15px; }
        .comment-item { background-color: rgba(255, 255, 255, 0.04); padding: 15px; border-radius: var(--border-radius-sm); border-left: 3px solid var(--secondary-light); }
        .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .comment-author { font-weight: 600; color: var(--text-dark); font-size: 0.95rem; }
        .comment-rating i { color: var(--star-color); font-size: 0.8rem; margin-left: 2px; }
        .comment-body { font-size: 0.9rem; color: var(--text-light); line-height: 1.6; word-break: break-word; }
        .comment-date { font-size: 0.75rem; color: var(--text-muted); margin-top: 10px; text-align: right; }
        .no-comments { text-align: center; color: var(--text-muted); padding: 20px 0; }
        @media (max-width: 680px) { .book-detail-layout { flex-direction: column; align-items: center; } .book-detail-image { width: 180px; height: 250px; margin-bottom: 15px; } .book-detail-info { text-align: center; } .book-detail-meta { justify-content: center; } .book-detail-actions { justify-content: center; } }

        #toastContainer { position: fixed; top: 25px; right: 25px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 15px 25px; border-radius: var(--border-radius-sm); background-color: var(--secondary-light); color: white; box-shadow: var(--shadow-xl); transform: translateX(calc(100% + 30px)); transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); display: flex; align-items: center; max-width: 380px; border-left: 5px solid var(--primary-color); }
        .toast.show { transform: translateX(0); }
        .toast.success { background-color: #27ae60; border-left-color: #2ecc71; }
        .toast.error { background-color: #e74c3c; border-left-color: #ff4757; }
        .toast.warning { background-color: #f39c12; border-left-color: #f1c40f; }
        .toast.info { background-color: #3498db; border-left-color: #2980b9; }
        .toast i { margin-right: 12px; font-size: 1.3rem; }
        .toast span:not(.toast-close) { flex-grow: 1; word-break: break-word; }
        .toast-close { margin-left: 15px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s ease; font-size: 1.2rem; background: none; border: none; color: white; padding: 5px; }
        .toast-close:hover { opacity: 1; }

        .spinner { display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 50px 20px; color: var(--text-muted); width: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; grid-column: 1 / -1; }
        .empty-state i { font-size: 3.5rem; margin-bottom: 20px; color: var(--primary-color); opacity: 0.5; animation: bounce 2s infinite cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        @keyframes bounce { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-15px) scale(1.05); } }
        .empty-state h3 { margin-bottom: 12px; color: var(--text-light); font-size: 1.3rem; font-weight: 600; }
        .empty-state p { font-size: 0.95rem; max-width: 350px; margin: 0 auto; color: var(--text-muted); }

        /* Profile Picture Upload styles */
        .profile-picture-upload-area { text-align: center; margin-bottom: 15px; }
        .profile-picture-preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-color); margin: 0 auto 10px; display: block; background-color: var(--secondary-light); }
        .profile-picture-preview.empty { display: flex; align-items: center; justify-content: center; font-size: 2rem; color: var(--text-muted); }
        #profilePictureInput { display: none; }
        .upload-picture-label { display: inline-block; padding: 8px 15px; background-color: var(--secondary-light); color: var(--text-light); border-radius: var(--border-radius-sm); cursor: pointer; transition: background-color 0.3s; }
        .upload-picture-label:hover { background-color: #333; }

        /* Add Book Modal Image Upload Tabs */
        .image-upload-tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .image-upload-tab {
            flex: 1; padding: 10px; text-align: center; cursor: pointer;
            color: var(--text-muted); font-weight: 500;
            border-bottom: 3px solid transparent; transition: all 0.3s ease;
        }
        .image-upload-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .image-upload-tab-content { display: none; }
        .image-upload-tab-content.active { display: block; }
        .book-cover-preview { max-width: 150px; max-height: 200px; margin: 10px auto; display: block; border-radius: var(--border-radius-sm); border: 1px solid rgba(255,255,255,0.1); }
        #bookCoverImageInput { display: none; }

        /* Book Submission Progress Bar */
        .upload-progress-container {
            margin-top: 15px;
            background-color: rgba(255,255,255,0.05);
            border-radius: var(--border-radius-xs);
            padding: 10px;
            display: none; /* Hidden by default */
        }
        .progress-bar-wrapper {
            width: 100%;
            height: 12px;
            background-color: var(--skeleton-bg);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        .progress-bar {
            width: 0%;
            height: 100%;
            background: var(--gradient);
            border-radius: 6px;
            transition: width 0.3s ease;
        }
        .upload-progress-text {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: center;
        }
        /* End Book Submission Progress Bar */


        /* Telegram Popup Styles */
        #telegramPopupModal .modal-content { max-width: 420px; text-align: center; }
        #telegramPopupModal .popup-icon { font-size: 3.5rem; color: #0088cc; margin-bottom: 20px; }
        #telegramPopupModal .popup-title { font-size: 1.5rem; color: var(--text-light); margin-bottom: 10px; }
        #telegramPopupModal .popup-message { color: var(--text-muted); margin-bottom: 25px; line-height: 1.6; }
        #telegramPopupModal .popup-actions { display: flex; flex-direction: column; gap: 10px; }
        #telegramPopupModal .join-telegram-btn { background-color: #0088cc; color: white; }
        #telegramPopupModal .join-telegram-btn:hover { background-color: #0077b5; }
        #telegramPopupModal .ignore-telegram-btn { background-color: var(--secondary-light); }
        #telegramPopupModal .ignore-telegram-btn:hover { background-color: #333; }

        /* Email Verification Modal Styles */
        #emailVerificationModal .modal-content { max-width: 450px; text-align: center; }
        .verification-icon {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            display: block;
            animation: mailPulse 2s infinite ease-in-out;
        }
        @keyframes mailPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        #emailVerificationModal .modal-title { font-size: 1.5rem; }
        .verification-message {
            color: var(--text-light);
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        .verification-message strong { color: var(--primary-light); }
        .verification-instructions {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 25px;
        }
        .verification-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        #resendVerificationEmailBtn.disabled-cooldown {
            background-color: var(--secondary-light) !important;
            opacity: 0.7;
            cursor: not-allowed;
        }
        /* End Email Verification Modal Styles */

        @media (max-width: 992px) { .container { padding: 20px 15px; } .books-grid, #profileBooksContainer { grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 20px; } .popular-book-card { width: 150px; } .popular-book-img-container { height: 180px; } .profile-dashboard { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { :root { --header-height: 65px; --nav-height: 65px; } body { padding-top: var(--header-height); padding-bottom: var(--nav-height); } .header { padding: 0 15px; } .logo { font-size: 1.6rem; } .logo i { font-size: 1.4rem; } .user-avatar { width: 38px; height: 38px; font-size: 0.9rem;} .profile-avatar-lg { width: 110px; height: 110px; font-size: 2.8rem; } #profileNameLarge { font-size: 2rem; } .points-amount-large { font-size: 3rem; } .stat-value { font-size: 1.8rem; } .books-grid, #profileBooksContainer { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; } .popular-book-card { width: 140px; } .popular-book-img-container { height: 170px; } .nav-item { width: 45px; height: 45px; font-size: 1.2rem; } .add-btn { width: 55px; height: 55px; font-size: 1.6rem; } .withdrawal-item { flex-direction: column; align-items: flex-start; gap: 8px; } .withdrawal-status { align-self: flex-start; } .profile-action-btn { min-width: 150px; } .category-filter-item { padding: 7px 15px; font-size: 0.85rem;} .notifications-tabs { padding: 0 5px;} .notification-tab-btn { font-size: 0.9rem; padding: 10px 8px;} }
        @media (max-width: 576px) { :root { --header-height: 60px; --nav-height: 60px; } .header { padding: 0 10px; } .logo { font-size: 1.5rem; } .logo i { font-size: 1.3rem; margin-right: 8px;} .user-avatar { width: 35px; height: 35px; font-size: 0.8rem;} .container { padding: 15px 10px; } .popular-books-section { padding: 20px 10px; } .section-title { font-size: 1.5rem; margin-bottom: 20px; } .popular-book-card { width: 130px; } .popular-book-img-container { height: 160px; } .page-title { font-size: 1.8rem; } .books-grid, #profileBooksContainer { grid-template-columns: repeat(2, 1fr); gap: 12px; } .book-card:hover { transform: translateY(-5px) scale(1.01); } .book-card-main .book-img-container { height: 180px; } .profile-page-content { padding: 10px; padding-top: var(--header-height); padding-bottom: calc(var(--nav-height) + 15px); } .profile-main-header { padding: 30px 15px 20px; } .profile-avatar-lg { width: 90px; height: 90px; font-size: 2.2rem; } #profileNameLarge { font-size: 1.6rem; } #profileUsernameLarge { font-size: 1rem; } #profileEmailLarge, #profileJoinedLarge { font-size: 0.9rem; } .profile-bio-box { padding: 15px; font-size: 0.9rem; } .points-amount-large { font-size: 2.5rem; } .withdraw-btn-large { font-size: 0.9rem; padding: 10px 15px; } .stat-value { font-size: 1.6rem; } .profile-actions-footer { flex-direction: column; gap: 12px; align-items: center; } .profile-action-btn { max-width: 300px; width: 100%; min-width: unset; } .modal-content { padding: 20px; width: 95%; max-height: 85vh; } .modal-title { font-size: 1.4rem; } .amount-selection { grid-template-columns: 1fr 1fr; } .category-filter-item { padding: 6px 12px; font-size: 0.8rem; } .book-detail-title { font-size: 1.5rem; } .book-detail-author { font-size: 0.9rem; } .rating-stars .stars > i { font-size: 1.4rem; } .notifications-header { height: var(--header-height); padding: 0 10px;} .page-back-btn { width: 35px; height: 35px; font-size: 1.2rem; top: calc(12.5px + (var(--header-height) - 60px) / 2); } .notification-item { padding: 12px; } .notification-icon { width: 32px; height: 32px; font-size: 1.2rem; margin-right: 12px; } .notification-title { font-size: 0.95rem; } .notification-message { font-size: 0.85rem; } .notification-timestamp { font-size: 0.7rem; } .notifications-tabs {overflow-x: auto; justify-content: flex-start;} .notification-tab-btn { flex: 0 0 auto; padding: 10px 15px;} .nav-item-dot { top: 8px; right: 5px; } }
        @media (max-width: 400px) { .books-grid, #profileBooksContainer { grid-template-columns: 1fr; } .popular-book-card { width: 120px; } .popular-book-img-container { height: 150px; } .book-card-main .book-img-container { height: 220px; } .profile-avatar-lg { width: 80px; height: 80px; font-size: 2rem; } #profileNameLarge { font-size: 1.4rem; } .amount-selection { grid-template-columns: 1fr; } .category-filter-container { gap: 8px; } .category-filter-item { padding: 5px 10px; } .book-detail-image { width: 150px; height: 210px; } }
        * { -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body data-theme="dark">

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-logo-container"> <i class="fas fa-book-reader loading-logo-icon"></i> <span class="loading-logo-text">EduSparK</span> </div>
        <div class="loading-dots"> <span></span><span></span><span></span> </div>
        <p class="loading-message" id="loadingMessage">Loading EduSparK Library...</p>
    </div>

    <header class="header">
        <div class="logo-container"> <a href="#" class="logo" id="logoLink"> <i class="fas fa-book-reader"></i> <span class="logo-text">EduSparK</span> </a> </div>
        <div class="search-container" id="searchContainer"> <i class="fas fa-search search-icon"></i> <input type="text" class="search-input" id="searchInput" placeholder="Search books, authors..."> <div class="search-results" id="searchResults"></div> </div>
        <div class="header-actions"> <button class="search-toggle-btn" id="searchToggleBtn" aria-label="Toggle Search"> <i class="fas fa-search"></i> </button> <div class="header-credits" id="headerCreditsContainer" style="display: none;" title="Your Credits"> <i class="fas fa-coins"></i> <span id="headerCreditsAmount">0</span> </div> <div class="user-avatar" id="userAvatar"> <span id="avatarInitials">U</span> </div> </div>
    </header>

    <section class="popular-books-section" data-aos="fade-in" data-aos-delay="100">
        <h2 class="section-title">🔥 Popular Now</h2>
        <div class="popular-books-carousel" id="popularBooksCarousel"></div>
    </section>

    <div class="container">
        <h1 class="page-title" data-aos="fade-right" data-aos-delay="200">Discover Books</h1>
        <div class="category-filter-container" id="categoryFilterContainer" data-aos="fade-up" data-aos-delay="250"></div>
        <div class="books-grid" id="booksContainer"></div>
        <div id="booksGridLoadingIndicator"> <span class="spinner"></span> Loading more books... </div>
        <div class="empty-state" id="emptyStateBooks"> <i class="fas fa-ghost"></i> <h3>No Books Found Yet</h3> <p>Looks a bit empty here. Try another category or check back later!</p> </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item" id="notificationsBtn" data-tooltip="Notifications"> <i class="fas fa-bell"></i> <span class="unread-badge" id="unreadNotificationsBadge" style="display: none;">0</span> </div>
        <div class="nav-item active" id="homeBtn" data-tooltip="Home"> <i class="fas fa-home"></i> </div>
        <button class="add-btn" id="addBookBtn" aria-label="Add Book"> <i class="fas fa-plus"></i> </button>
        <div class="nav-item" id="referralBtn" data-tooltip="Refer & Earn"> <i class="fas fa-users"></i> </div> <!-- Changed from Discover -->
        <div class="nav-item" id="profileBtn" data-tooltip="Profile"> <i class="fas fa-user"></i> </div>
    </nav>

    <div class="profile-page" id="profilePage">
        <div class="profile-page-content">
            <button class="page-back-btn" id="profileBackBtn" aria-label="Go Back"> <i class="fas fa-arrow-left"></i> </button>
            <div class="profile-main-header" data-aos="fade-down">
                <div class="profile-avatar-lg" id="profileAvatarLarge"> <span id="profileAvatarInitialsLarge">U</span> </div>
                <h1 id="profileNameLarge">User Loading...</h1>
                <p id="profileUsernameLarge" class="profile-username-lg">@loading</p>
                <p id="profileEmailLarge" class="profile-email-lg"><i class="fas fa-envelope"></i> loading...</p>
                <p id="profileJoinedLarge" class="profile-joined-lg"><i class="fas fa-calendar-alt"></i> Joined: -</p>
                <div class="profile-bio-box" id="profileBioLarge" data-aos="fade-up" data-aos-delay="100"> Loading bio... </div>
                <div id="telegramUsernamePrompt" class="profile-info-prompt" style="display: none;"> <i class="fab fa-telegram-plane"></i> Add your Telegram Username for better community interaction! </div>
                <div id="recoveryEmailPrompt" class="profile-info-prompt" style="display: none;"> <i class="fas fa-envelope-open-text"></i> Secure your account! Add a Recovery Email. </div>
                <div id="setupPinPrompt" class="profile-info-prompt" style="display: none;"> <i class="fas fa-shield-alt"></i> Enhance withdrawal security! Set up your Secret PIN. </div>
            </div>
            <div class="profile-dashboard" data-aos="fade-up" data-aos-delay="200">
                <div class="profile-dashboard-item points-dashboard">
                    <h3><i class="fas fa-coins"></i> Your Points</h3>
                    <div class="points-amount-large" id="userPointsLarge">0</div>
                    <p>Redeem points for exciting rewards or cash! (Requires Secret PIN)</p>
                    <button class="withdraw-btn-large action-btn" id="withdrawBtnLarge" disabled> <span class="button-text-content"><i class="fas fa-hand-holding-usd"></i> Withdraw Points</span> </button>
                </div>
                <div class="profile-dashboard-item stats-dashboard">
                    <h3><i class="fas fa-chart-line"></i> Your Activity</h3>
                    <div class="stat-grid">
                        <div class="stat-card"> <span class="stat-value" id="booksSharedLarge">0</span> <span class="stat-label-card">Books Submitted</span> </div>
                        <div class="stat-card"> <span class="stat-value" id="booksDownloadedLarge">0</span> <span class="stat-label-card">Your Downloads</span> </div>
                        <div class="stat-card"> <span class="stat-value" id="totalBookDownloadsLarge">0</span> <span class="stat-label-card">Shared Book Downloads</span> </div>
                        <div class="stat-card"> <span class="stat-value" id="totalFeedbackLarge">0</span> <span class="stat-label-card">Feedback Given</span> </div>
                    </div>
                </div>
            </div>
            <div class="profile-tabs" data-aos="fade-up" data-aos-delay="300">
                <button class="profile-tab-btn active" data-tab="shared-books">My Submissions</button>
                <button class="profile-tab-btn" data-tab="withdrawal-history">Withdrawal History</button>
                <button class="profile-tab-btn" data-tab="point-system">Point System</button>
                <button class="profile-tab-btn" data-tab="security">Security</button>
            </div>
            <div class="profile-tab-content active" id="tab-shared-books" data-aos="fade-up" data-aos-delay="350">
                <h3 class="profile-section-title">Your Submissions (Pending/Rejected)</h3>
                <div id="profileBooksContainer" class="books-grid"> <div class="empty-state" id="emptyProfileBooks" style="display: none;"> <i class="fas fa-book-medical"></i> <h3>No Submissions Yet</h3> <p>Share your knowledge! Your pending/rejected submissions will appear here.</p> </div> </div>
                <div class="load-more-container" id="loadMoreContainer"> <button class="load-more-btn" id="loadMoreBooksBtn" style="display: none;"> <span class="spinner" style="display: none;"></span> <span class="button-text-content"><i class="fas fa-chevron-down"></i> Load More</span> </button> </div>
            </div>
            <div class="profile-tab-content" id="tab-withdrawal-history">
                <h3 class="profile-section-title">Withdrawal History</h3>
                <div id="withdrawalHistoryContainer"> <div class="empty-state" id="emptyWithdrawalHistory" style="display: none;"> <i class="fas fa-history"></i> <h3>No Withdrawals Yet</h3> <p>Your withdrawal history will appear here.</p> </div> </div>
            </div>
            <div class="profile-tab-content" id="tab-point-system">
                <h3 class="profile-section-title">Point System Guide</h3>
                <div class="point-system-info-tabbed">
                    <div class="point-item"><span class="point-action">Share Approved Book</span><span class="point-value">+10 Points</span></div>
                    <div class="point-item"><span class="point-action">Book Downloaded (by others)</span><span class="point-value">+1 Point</span></div>
                    <div class="point-item"><span class="point-action">Refer a Friend (they share a book)</span><span class="point-value">+2 Points (15% of 10)</span></div>
                    <hr style="border-color: rgba(255,255,255,0.1); margin: 10px 0;">
                    <div class="point-item"><span class="point-action">Min. Withdrawal (500 Points)</span><span class="point-value">₹50</span></div>
                    <div class="point-item"><span class="point-action">1000 Points</span><span class="point-value">₹100</span></div>
                    <hr style="border-color: rgba(255,255,255,0.1); margin: 10px 0;">
                    <div class="point-item"><span class="point-action">Daily Login Bonus</span><span class="point-value">+20 Credits</span></div>
                    <div class="point-item"><span class="point-action">Download a Book</span><span class="point-value">-30 Credits</span></div>
                    <div class="point-item"><span class="point-action">Complete Credit Boost</span><span class="point-value">+50 Credits</span></div>
                    <p style="font-size: 0.8rem; color: var(--text-muted); text-align: center; margin-top: 20px;"> <b>Points</b> are for cash withdrawal. <b>Credits</b> are for downloading books. </p>
                </div>
            </div>
            <div class="profile-tab-content" id="tab-security">
                <h3 class="profile-section-title">Security Settings</h3>
                <div class="point-system-info-tabbed" style="max-width: 500px; margin: 20px auto;">
                    <div class="point-item"> <span class="point-action"><i class="fas fa-key"></i> Change Password</span> <button class="tutorial-btn" id="changePasswordBtnTab" style="width:auto;padding:8px 15px;font-size:0.85rem;"> <span class="button-text-content">Send Reset Email</span> </button> </div>
                    <div class="point-item"> <span class="point-action"><i class="fas fa-shield-alt"></i> Withdrawal PIN</span> <button class="tutorial-btn" id="managePinBtnTab" style="width:auto;padding:8px 15px;font-size:0.85rem;"> <span class="button-text-content" id="managePinBtnTabText">Set/Change PIN</span> </button> </div>
                    <p style="font-size: 0.8rem; color: var(--text-muted); text-align: left; margin-top: 20px; padding: 10px; background-color: rgba(0,0,0,0.1); border-radius: var(--border-radius-xs);"> <strong>Password Recovery:</strong> Uses your main account email. Click "Send Reset Email" to receive instructions. <br><br> <strong>Withdrawal PIN:</strong> A 4-6 digit PIN required for all point withdrawals. <br> <strong>PIN Recovery:</strong> If you forget your PIN, you can reset it using your registered <strong>Recovery Email</strong>. Ensure your recovery email is up-to-date in "Edit Profile". Your PIN is not used for account password recovery. </p>
                </div>
            </div>
            <div class="profile-actions-footer" data-aos="fade-up" data-aos-delay="400">
                <button class="profile-action-btn edit-profile" id="editProfileBtn"> <span class="button-text-content"><i class="fas fa-user-edit"></i> Edit Profile</span> </button>
                <button class="profile-action-btn security-settings-btn" id="securitySettingsBtnFooter"> <span class="button-text-content"><i class="fas fa-user-shield"></i> Security</span> </button>
                <button class="profile-action-btn logout-btn" id="logoutBtn"> <span class="button-text-content"><i class="fas fa-sign-out-alt"></i> Logout</span> </button>
            </div>
        </div>
    </div>

    <div class="notifications-page" id="notificationsPage">
        <div class="notifications-header"> <button class="page-back-btn" id="notificationsBackBtn" aria-label="Go Back"> <i class="fas fa-arrow-left"></i> </button> <div class="notifications-actions"> <button class="mark-all-read-btn" id="markAllNotificationsReadBtn" disabled> <i class="fas fa-check-double"></i> Mark All Read </button> </div> </div>
        <div class="notifications-tabs"> <button class="notification-tab-btn active" data-tab="personal">Personal</button> <button class="notification-tab-btn" data-tab="announcements"> Announcements <span class="nav-item-dot" id="announcementUnreadDot" style="display: none;"></span> </button> </div>
        <div class="notifications-content-area">
            <div class="notifications-list-container active" id="personalNotificationsListContainer"> <div class="empty-state" id="emptyPersonalNotificationsState" style="display: none;"> <i class="fas fa-bell-slash"></i> <h3>No Personal Notifications</h3> <p>Important updates and alerts related to your activity will appear here.</p> </div> </div>
            <div class="notifications-list-container" id="adminAnnouncementsListContainer"> <div class="empty-state" id="emptyAdminAnnouncementsState" style="display: none;"> <i class="fas fa-bullhorn"></i> <h3>No Announcements Yet</h3> <p>Check back later for updates from the EduSparK team.</p> </div> </div>
        </div>
    </div>

    <div class="modal" id="addBookModal">
        <div class="modal-content">
            <button class="close-modal" id="closeAddBookModal" aria-label="Close">&times;</button>
            <h2 class="modal-title">Share a New Book</h2>
            <form id="addBookForm">
                <div class="form-group"> <label for="bookName" class="form-label">Book Title *</label> <input type="text" id="bookName" class="form-input" placeholder="e.g., Introduction to Algorithms" required> </div>
                <div class="form-group"> <label for="authorName" class="form-label">Author(s) *</label> <input type="text" id="authorName" class="form-input" placeholder="e.g., Thomas H. Cormen" required> </div>
                <div class="form-group"> <label for="bookCategory" class="form-label">Category *</label> <input type="text" id="bookCategory" class="form-input" placeholder="e.g., Computer Science, 12th, NEET" required> <small style="color: var(--text-muted); font-size: 0.75rem; margin-top: 5px; display: block;"> Use relevant keywords like 'JEE', '10th', 'Fiction', etc. </small> </div>

                <div class="form-group">
                    <label class="form-label">Cover Image *</label>
                    <div class="image-upload-tabs">
                        <div class="image-upload-tab active" data-tab="uploadImage">Upload Image</div>
                        <div class="image-upload-tab" data-tab="imageUrl">Use Image URL</div>
                    </div>
                    <div id="uploadImageContent" class="image-upload-tab-content active">
                        <input type="file" id="bookCoverImageInput" accept="image/*">
                        <label for="bookCoverImageInput" class="tutorial-btn" style="width: auto; padding: 10px 15px; margin-top: 0;">
                            <span class="button-text-content"><i class="fas fa-upload"></i> Choose from Gallery</span>
                        </label>
                        <img id="bookCoverPreview" class="book-cover-preview" src="#" alt="Cover Preview" style="display:none;">
                        <small style="color: var(--text-muted); font-size: 0.75rem; margin-top: 5px; display: block;">Max 2MB. Recommended: JPG, PNG.</small>
                    </div>
                    <div id="imageUrlContent" class="image-upload-tab-content">
                        <input type="url" id="bookImageUrl" class="form-input" placeholder="Paste direct image link (e.g., https://example.com/image.jpg)">
                    </div>
                </div>

                 <!-- Upload Progress Bar Container -->
                <div class="upload-progress-container" id="uploadProgressBarContainer">
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" id="uploadProgressBar"></div>
                    </div>
                    <div class="upload-progress-text" id="uploadProgressText">Initializing upload...</div>
                </div>
                <!-- End Upload Progress Bar Container -->

                <div class="form-group"> <label for="driveLink" class="form-label">Google Drive Link *</label> <input type="url" id="driveLink" class="form-input" placeholder="Ensure link sharing is 'Anyone with the link'" required> <small style="color: var(--text-muted); font-size: 0.75rem; margin-top: 5px; display: block;"> Right-click file in Drive > Share > Set 'Anyone with the link' > Copy link. </small> </div>
                <div class="form-group"> <label for="bookDescription" class="form-label">Description (Optional)</label> <textarea id="bookDescription" class="form-textarea" placeholder="Briefly describe the book..." rows="3"></textarea> </div>
                <button type="submit" class="submit-btn" id="submitBookBtn"> <span class="button-text-content">Submit for Approval</span> </button>
                <button type="button" class="tutorial-btn" onclick="window.open('https://t.me/official_learnhub/140', '_blank')"> <span class="button-text-content"><i class="fas fa-question-circle"></i> How to Get Drive Link?</span> </button>
            </form>
        </div>
    </div>

    <div class="modal" id="loginModal">
        <div class="modal-content">
            <button class="close-modal" id="closeLoginModal" aria-label="Close">&times;</button> <h2 class="modal-title">Welcome Back!</h2>
            <form id="loginForm">
                <div class="form-group"> <label for="loginEmail" class="form-label">Email</label> <input type="email" id="loginEmail" class="form-input" placeholder="your.email@example.com" required> </div>
                <div class="form-group"> <label for="loginPassword" class="form-label">Password</label> <input type="password" id="loginPassword" class="form-input" placeholder="••••••••" required> </div>
                <button type="submit" class="submit-btn" id="loginBtn"> <span class="button-text-content">Login</span> </button>
            </form>
            <div class="auth-separator"><span>OR</span></div>
            <button type="button" class="submit-btn google-btn" id="googleLoginBtn"> <span class="button-text-content"><i class="fab fa-google"></i> Continue with Google</span> </button>
            <div class="auth-switch"> <a id="forgotPasswordLink" style="display:block; margin-bottom:10px;">Forgot Password?</a> Don't have an account? <a id="switchToSignup">Sign up here</a> </div>
        </div>
    </div>

    <div class="modal" id="signupModal">
        <div class="modal-content">
            <button class="close-modal" id="closeSignupModal" aria-label="Close">&times;</button> <h2 class="modal-title">Join EduSparK</h2>
            <form id="signupForm">
                <div class="form-group"> <label for="signupName" class="form-label">Full Name</label> <input type="text" id="signupName" class="form-input" placeholder="e.g., Ada Lovelace" required> </div>
                <div class="form-group"> <label for="signupUsername" class="form-label">Username</label> <input type="text" id="signupUsername" class="form-input" placeholder="Choose a unique username" required> <small style="color: var(--text-muted); font-size: 0.75rem; margin-top: 5px; display: block;"> 3-15 chars, lowercase, numbers, _, . </small> </div>
                <div class="form-group"> <label for="signupEmail" class="form-label">Email</label> <input type="email" id="signupEmail" class="form-input" placeholder="your.email@example.com" required> </div>
                <div class="form-group"> <label for="signupPassword" class="form-label">Password</label> <input type="password" id="signupPassword" class="form-input" placeholder="Choose a strong password" required> </div>
                <div class="form-group"> <label for="signupReferralCode" class="form-label">Referral Code (Optional)</label> <input type="text" id="signupReferralCode" class="form-input" placeholder="Enter referral code if you have one"> </div>
                <div class="form-group"> <label for="signupTelegram" class="form-label">Telegram Username (Optional)</label> <input type="text" id="signupTelegram" class="form-input" placeholder="e.g., @yourusername"> </div>
                <div class="form-group"> <label for="signupRecoveryEmail" class="form-label">Recovery Email (Optional, for PIN recovery)</label> <input type="email" id="signupRecoveryEmail" class="form-input" placeholder="secure.recovery@example.com"> </div>
                <div class="form-group"> <label for="signupBio" class="form-label">Bio (Optional)</label> <textarea id="signupBio" class="form-textarea" placeholder="Share something about yourself..." rows="2"></textarea> </div>
                <button type="submit" class="submit-btn" id="signupBtn"> <span class="button-text-content">Create Account</span> </button>
            </form>
            <div class="auth-separator"><span>OR</span></div>
            <button type="button" class="submit-btn google-btn" id="googleSignupBtn"> <span class="button-text-content"><i class="fab fa-google"></i> Sign up with Google</span> </button>
            <div class="auth-switch"> Already have an account? <a id="switchToLogin">Login here</a> </div>
        </div>
    </div>
    
    <div class="modal" id="emailVerificationModal">
        <div class="modal-content">
            <button class="close-modal" id="closeEmailVerificationModal" aria-label="Close">&times;</button>
            <i class="fas fa-envelope-open-text verification-icon"></i>
            <h2 class="modal-title">Verify Your Email</h2>
            <p class="verification-message">A verification email has been sent to <strong id="verificationEmailSentTo">your.email@example.com</strong>.</p>
            <p class="verification-instructions">Please check your inbox (and spam folder) and click the verification link to complete your registration.</p>
            <div class="verification-actions">
                <button class="submit-btn" id="checkVerificationStatusBtn"> <span class="button-text-content"><i class="fas fa-check-circle"></i> I've Verified My Email</span> </button>
                <button class="tutorial-btn" id="resendVerificationEmailBtn"> <span class="button-text-content"><i class="fas fa-paper-plane"></i> Resend Verification Email</span> </button>
            </div>
             <div class="auth-switch" style="margin-top: 25px;">Changed your mind? <a id="cancelVerificationAndLogoutBtn">Logout</a></div>
        </div>
    </div>

    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <button class="close-modal" id="closeEditProfileModal" aria-label="Close">&times;</button> <h2 class="modal-title">Edit Your Profile</h2>
            <form id="editProfileForm">
                <div class="profile-picture-upload-area">
                    <img src="#" alt="Profile Preview" id="profilePicturePreview" class="profile-picture-preview empty">
                    <input type="file" id="profilePictureInput" accept="image/*">
                    <label for="profilePictureInput" class="upload-picture-label"><i class="fas fa-camera"></i> Change Picture</label>
                </div>
                <div class="form-group"> <label for="editProfileName" class="form-label">Full Name</label> <input type="text" id="editProfileName" class="form-input" placeholder="Enter your full name" required> </div>
                <div class="form-group"> <label for="editProfileUsername" class="form-label">Username</label> <input type="text" id="editProfileUsername" class="form-input" placeholder="Choose a username" required> <small style="color: var(--text-muted); font-size: 0.75rem; margin-top: 5px; display: block;"> 3-15 chars, lowercase, numbers, _, . </small> </div>
                <div class="form-group"> <label for="editProfileTelegram" class="form-label">Telegram Username</label> <input type="text" id="editProfileTelegram" class="form-input" placeholder="e.g., @yourusername"> </div>
                <div class="form-group"> <label for="editProfileRecoveryEmail" class="form-label">Recovery Email (for PIN recovery)</label> <input type="email" id="editProfileRecoveryEmail" class="form-input" placeholder="secure.recovery@example.com"> <small style="color: var(--text-muted); font-size: 0.75rem; margin-top: 5px; display: block;"> This email is kept private and used for PIN recovery only. </small> </div>
                <div class="form-group"> <label for="editProfileBio" class="form-label">Bio</label> <textarea id="editProfileBio" class="form-textarea" placeholder="Tell the community about yourself" rows="3"></textarea> </div>
                <button type="submit" class="submit-btn" id="saveProfileBtn"> <span class="button-text-content">Save Changes</span> </button>
            </form>
        </div>
    </div>

    <div class="modal" id="referralModal"> <!-- Changed from discoverModal -->
        <div class="modal-content">
            <button class="close-modal" id="closeReferralModal" aria-label="Close">&times;</button>
            <h2 class="modal-title"><i class="fas fa-users" style="margin-right: 10px;"></i>Refer & Earn</h2>
            <div class="referral-content">
                <p>Invite friends to EduSparK and earn points!</p>
                <div class="referral-code-box">
                    <p>Your Unique Referral Code:</p>
                    <div class="referral-code" id="userReferralCode">LOADING...</div>
                    <button class="copy-referral-btn" id="copyReferralCodeBtn"><i class="fas fa-copy"></i> Copy Code</button>
                    <button class="copy-referral-btn" id="copyReferralLinkBtn" style="margin-top: 10px;"><i class="fas fa-link"></i> Copy Link</button>
                </div>
                <div class="referral-stats">
                    <div class="referral-stat-item">
                        <span class="value" id="referralCount">0</span>
                        <span class="label">Friends Referred</span>
                    </div>
                    <div class="referral-stat-item">
                        <span class="value" id="referralEarnings">0 <small>pts</small></span>
                        <span class="label">Points Earned</span>
                    </div>
                </div>
                <div class="referral-info">
                    When your friend signs up using your code and their first shared book gets approved (they earn 10 points), you get <strong>2 bonus points</strong> (15% of 10, rounded up)!
                </div>
                 <button type="button" class="tutorial-btn" onclick="window.open('https://t.me/+gFZ2guUewss3Nzc1', '_blank')" style="margin-top:20px;"> <span class="button-text-content"><i class="fab fa-telegram-plane"></i> Join EduSparK Telegram</span> </button>
            </div>
        </div>
    </div>

    <div class="modal" id="withdrawalModal">
        <div class="modal-content">
            <button class="close-modal" id="closeWithdrawalModal" aria-label="Close">&times;</button> <h2 class="modal-title">Withdraw Points</h2>
            <p style="text-align: center; color: var(--text-muted); margin-top: -15px; margin-bottom: 20px;"> Your current balance: <strong id="withdrawalModalPoints" style="color: var(--primary-color);">0</strong> points </p>
            <form id="withdrawalForm">
                <div class="form-group"> <label class="form-label">1. Select Withdrawal Method:</label> <div class="withdrawal-options"></div> </div>
                <div class="form-group"> <label class="form-label">2. Select Amount:</label> <div class="amount-selection"></div> </div>
                <div class="payment-details" id="paymentDetails">
                    <div class="form-group"> <label for="paymentId" class="form-label" id="paymentMethodLabel">Identifier *</label> <input type="text" id="paymentId" class="form-input" placeholder="Enter details" required> </div>
                    <div class="form-group" id="accountNameGroup" style="display: block;"> <label for="accountName" class="form-label">Account Holder Name *</label> <input type="text" id="accountName" class="form-input" placeholder="Name as per account" required> </div>
                    <button type="submit" class="submit-btn" id="submitWithdrawalBtn"> <span class="button-text-content">Proceed to PIN</span> </button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="creditModal">
        <div class="modal-content">
            <button class="close-modal" id="closeCreditModal" aria-label="Close">&times;</button> <h2 class="modal-title">Earn Credits</h2>
            <p style="text-align: center; color: var(--text-muted); margin-top: -15px; margin-bottom: 25px;"> Your current balance: <strong id="creditModalUserCredits">0</strong> <i class="fas fa-coins" style="color: var(--credit-color);"></i> </p>
            <div class="credit-options-list">
                <button class="tutorial-btn" id="conductSurveyBtn" style="margin-top:15px;"> <span class="button-text-content"><i class="fas fa-poll"></i></span> ‎ Earn Credit ‎ <span class="button-text-content"><i class="fas fa-poll"></i></span></button>
                <p style="font-size: 0.8rem; color: var(--text-muted); text-align: center; margin-top: 20px;"> Tip: Use credits to download books (30 <i class="fas fa-coins" style="color:var(--credit-color);font-size:0.8em;"></i> per book). Share books to earn points for withdrawal! <br><br> Earn Credit By Attempting Simple Maths Quiz 🌸 (Earn 50‎ <i class="fas fa-coins" style="color:var(--credit-color);font-size:0.8em;"></i>‎ By attempting Quiz Each Time ⚡ ) </p>
            </div>
        </div>
    </div>

    <div class="modal" id="bookDetailModal">
        <div class="modal-content">
            <button class="close-modal" id="closeBookDetailModal" aria-label="Close">&times;</button>
            <div id="bookDetailContent"> <div style="text-align:center; padding: 50px 0;"> <div class="spinner" style="width: 30px; height: 30px; border-width: 4px;"></div> <p style="margin-top: 15px; color: var(--text-muted);">Loading details...</p> </div> </div>
        </div>
    </div>

    <div class="modal" id="forgotPasswordModal">
        <div class="modal-content">
            <button class="close-modal" id="closeForgotPasswordModal">&times;</button> <h2 class="modal-title">Forgot Password</h2>
            <form id="forgotPasswordForm">
                <div class="form-group"> <label for="forgotPasswordEmail" class="form-label">Enter your account email:</label> <input type="email" id="forgotPasswordEmail" class="form-input" required placeholder="your.email@example.com"> </div>
                <button type="submit" class="submit-btn" id="sendResetEmailBtn"> <span class="button-text-content">Send Reset Link</span> </button>
            </form>
        </div>
    </div>

    <div class="modal" id="pinManagementModal">
        <div class="modal-content">
            <button class="close-modal" id="closePinManagementModal">&times;</button> <h2 class="modal-title" id="pinModalTitle">Set Your Withdrawal PIN</h2>
            <form id="pinManagementForm">
                <div id="pinSetupFields">
                    <div class="form-group"> <label for="newPin" class="form-label">New PIN (4-6 digits):</label> <input type="password" id="newPin" class="form-input" required maxlength="6" pattern="\d{4,6}" inputmode="numeric"> </div>
                    <div class="form-group"> <label for="confirmNewPin" class="form-label">Confirm New PIN:</label> <input type="password" id="confirmNewPin" class="form-input" required maxlength="6" pattern="\d{4,6}" inputmode="numeric"> </div>
                </div>
                <div id="pinEntryField" style="display:none;">
                    <div class="form-group"> <label for="currentPin" class="form-label">Enter your Withdrawal PIN:</label> <input type="password" id="currentPin" class="form-input" required maxlength="6" pattern="\d{4,6}" inputmode="numeric"> </div>
                </div>
                <button type="submit" class="submit-btn" id="submitPinManagementBtn"> <span class="button-text-content" id="submitPinManagementBtnText">Set PIN</span> </button>
            </form>
            <div class="auth-switch" id="forgotPinLinkContainer" style="display:none;"> <a id="forgotPinLink">Forgot PIN?</a> </div>
            <p class="pin-info-text">Your PIN is used to secure withdrawals. Keep it secret!</p>
        </div>
    </div>

    <div class="modal" id="forgotPinModal">
        <div class="modal-content">
            <button class="close-modal" id="closeForgotPinModal">&times;</button> <h2 class="modal-title">Forgot Withdrawal PIN</h2>
            <form id="forgotPinForm">
                <div class="form-group"> <label for="forgotPinRecoveryEmail" class="form-label">Enter your Recovery Email:</label> <input type="email" id="forgotPinRecoveryEmail" class="form-input" required placeholder="your.recovery.email@example.com"> <small style="color: var(--text-muted); font-size: 0.75rem; margin-top: 5px; display: block;"> This is the recovery email you set up in your profile. </small> </div>
                <button type="submit" class="submit-btn" id="verifyRecoveryEmailBtn"> <span class="button-text-content">Verify Email & Reset PIN</span> </button>
            </form>
        </div>
    </div>

    <div class="modal" id="telegramPopupModal">
        <div class="modal-content">
            <button class="close-modal" id="closeTelegramPopupModal" aria-label="Close">&times;</button>
            <i class="fab fa-telegram popup-icon"></i>
            <h2 class="popup-title">Join Our Community!</h2>
            <p class="popup-message">Stay updated with the latest books, announcements, and connect with fellow learners on our Telegram channel.</p>
            <div class="popup-actions">
                <a href="https://t.me/+gFZ2guUewss3Nzc1" target="_blank" rel="noopener noreferrer" class="submit-btn join-telegram-btn" id="joinTelegramPopupBtn">
                    <span class="button-text-content"><i class="fab fa-telegram-plane"></i> Join Telegram Channel</span>
                </a>
                <button class="tutorial-btn ignore-telegram-btn" id="ignoreTelegramPopupBtn">
                    <span class="button-text-content">Ignore for Today</span>
                </button>
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
        
        <script>

 
AOS.init({
    duration: 600,
    easing: 'ease-out-cubic',
    once: true,
    offset: 50,
});

const firebaseConfig = {
    // TODO: CRITICAL - Replace with your actual Firebase config object.
    // Example:
    // apiKey: "YOUR_API_KEY",
    // authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    // projectId: "YOUR_PROJECT_ID",
    // storageBucket: "YOUR_PROJECT_ID.appspot.com",
    // messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    // appId: "YOUR_APP_ID",
    // measurementId: "YOUR_MEASUREMENT_ID" // Optional
    apiKey: "AIzaSyBNi6BHTKNd62VAY7q1oHQmxjZ3r0MUA9U", // <<-- YAHAN APNA ACTUAL FIREBASE API KEY DAALEIN
    authDomain: "edusparkk.xyz", // Ya project-id.firebaseapp.com
    projectId: "eduspark-new",
    storageBucket: "eduspark-new.firebasestorage.app", // Agar default hai toh "eduspark-new.appspot.com" hoga. Verify kar lein.
    messagingSenderId: "564501033350",
    appId: "1:564501033350:web:70c0f9873f96e9bd74fc07",
    measurementId: "G-NM2SE3DE7J"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
const appCheck = firebase.appCheck();

try {
    // IMPORTANT: This is the reCAPTCHA v3 Site Key from your Google Cloud Console screenshot
    const reCAPTCHAv3SiteKey = '6LcRC14rAAAAAIAAKHF3YCuIVB3Ygsu77vwQZQuK';

    if (reCAPTCHAv3SiteKey && reCAPTCHAv3SiteKey.startsWith('6L')) { // Basic check for Site Key format
        appCheck.activate(
            reCAPTCHAv3SiteKey,
            true // isTokenAutoRefreshEnabled
        );
        console.log("Firebase App Check activated with reCAPTCHA v3.");
    } else {
        console.warn("App Check NOT activated: reCAPTCHA v3 Site Key is missing or seems invalid.");
    }
} catch (error) {
    console.error("Error initializing Firebase App Check:", error);
}

// TODO: Ensure your Firebase Storage Rules are set up correctly in the Firebase Console.
// Example:
/*
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Profile pictures: Only authenticated owner can write, anyone can read.
    match /profile_picture/{userId}/{fileName} {
      allow read: if true; // Or restrict to request.auth != null
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    // Book cover images: Authenticated users can write, anyone can read.
    match /book_image/{fileName} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    // Deny all other access by default for security
    // match /{allPaths=**} {
    //   allow read, write: if false;
    // }
  }
}
*/
    // ... baki sara JavaScript code (const $ = ... se lekar end tak) waise hi rahega ...
    const $ = (selector) => document.querySelector(selector);
const $$ = (selector) => document.querySelectorAll(selector);

const elements = {
    loadingOverlay: $('#loadingOverlay'), loadingMessage: $('#loadingMessage'),
    body: document.body, header: $('.header'), logoLink: $('#logoLink'),
    userAvatar: $('#userAvatar'), avatarInitials: $('#avatarInitials'),
    searchContainer: $('#searchContainer'), searchInput: $('#searchInput'),
    searchResults: $('#searchResults'), searchToggleBtn: $('#searchToggleBtn'),
    addBookBtn: $('#addBookBtn'), booksContainer: $('#booksContainer'),
    booksGridLoadingIndicator: $('#booksGridLoadingIndicator'),
    emptyStateBooks: $('#emptyStateBooks'),
    categoryFilterContainer: $('#categoryFilterContainer'),
    bottomNavItems: $$('.bottom-nav .nav-item'), popularBooksCarousel: $('#popularBooksCarousel'),
    headerCreditsContainer: $('#headerCreditsContainer'), headerCreditsAmount: $('#headerCreditsAmount'),
    
    addBookModal: $('#addBookModal'), closeAddBookModal: $('#closeAddBookModal'), addBookForm: $('#addBookForm'),
    bookCoverImageInput: $('#bookCoverImageInput'), bookCoverPreview: $('#bookCoverPreview'),
    bookImageUrlInput: $('#bookImageUrl'),
    imageUploadTabs: $$('.image-upload-tab'),
    uploadImageContent: $('#uploadImageContent'), imageUrlContent: $('#imageUrlContent'),
    uploadProgressBarContainer: $('#uploadProgressBarContainer'),
    uploadProgressBar: $('#uploadProgressBar'), uploadProgressText: $('#uploadProgressText'),
    
    loginModal: $('#loginModal'), signupModal: $('#signupModal'),
    closeLoginModal: $('#closeLoginModal'), closeSignupModal: $('#closeSignupModal'),
    loginForm: $('#loginForm'), signupForm: $('#signupForm'),
    switchToSignup: $('#switchToSignup'), switchToLogin: $('#switchToLogin'),
    
    emailVerificationModal: $('#emailVerificationModal'),
    closeEmailVerificationModal: $('#closeEmailVerificationModal'),
    verificationEmailSentTo: $('#verificationEmailSentTo'),
    checkVerificationStatusBtn: $('#checkVerificationStatusBtn'),
    resendVerificationEmailBtn: $('#resendVerificationEmailBtn'),
    cancelVerificationAndLogoutBtn: $('#cancelVerificationAndLogoutBtn'),

    editProfileModal: $('#editProfileModal'), closeEditProfileModal: $('#closeEditProfileModal'), editProfileForm: $('#editProfileForm'),
    profilePictureInput: $('#profilePictureInput'), profilePicturePreview: $('#profilePicturePreview'),
    referralModal: $('#referralModal'), closeReferralModal: $('#closeReferralModal'),
    userReferralCode: $('#userReferralCode'), copyReferralCodeBtn: $('#copyReferralCodeBtn'), copyReferralLinkBtn: $('#copyReferralLinkBtn'),
    referralCount: $('#referralCount'), referralEarnings: $('#referralEarnings'),
    withdrawalModal: $('#withdrawalModal'), closeWithdrawalModal: $('#closeWithdrawalModal'), withdrawalForm: $('#withdrawalForm'),
    creditModal: $('#creditModal'), closeCreditModal: $('#closeCreditModal'),
    creditModalUserCredits: $('#creditModalUserCredits'), claimDailyCreditBtn: $('#claimDailyCreditBtn'), conductSurveyBtn: $('#conductSurveyBtn'),
    profileBtn: $('#profileBtn'), profilePage: $('#profilePage'), profileBackBtn: $('#profileBackBtn'),
    profileAvatarLarge: $('#profileAvatarLarge'), profileAvatarInitialsLarge: $('#profileAvatarInitialsLarge'),
    profileNameLarge: $('#profileNameLarge'), profileUsernameLarge: $('#profileUsernameLarge'),
    profileEmailLarge: $('#profileEmailLarge'), profileJoinedLarge: $('#profileJoinedLarge'),
    profileBioLarge: $('#profileBioLarge'),
    telegramUsernamePrompt: $('#telegramUsernamePrompt'),
    recoveryEmailPrompt: $('#recoveryEmailPrompt'),
    setupPinPrompt: $('#setupPinPrompt'),
    userPointsLarge: $('#userPointsLarge'), withdrawBtnLarge: $('#withdrawBtnLarge'),
    booksSharedLarge: $('#booksSharedLarge'), booksDownloadedLarge: $('#booksDownloadedLarge'),
    totalBookDownloadsLarge: $('#totalBookDownloadsLarge'), totalFeedbackLarge: $('#totalFeedbackLarge'),
    profileTabs: $('.profile-tabs'), profileTabBtns: $$('.profile-tab-btn'), profileTabContents: $$('.profile-tab-content'),
    profileBooksContainer: $('#profileBooksContainer'), emptyProfileBooks: $('#emptyProfileBooks'),
    loadMoreBooksBtn: $('#loadMoreBooksBtn'), loadMoreContainer: $('#loadMoreContainer'),
    withdrawalHistoryContainer: $('#withdrawalHistoryContainer'), emptyWithdrawalHistory: $('#emptyWithdrawalHistory'),
    editProfileBtn: $('#editProfileBtn'), logoutBtn: $('#logoutBtn'),
    withdrawalOptionsContainer: $('#withdrawalModal .withdrawal-options'),
    amountOptionsContainer: $('#withdrawalModal .amount-selection'),
    paymentDetails: $('#paymentDetails'), paymentMethodLabel: $('#paymentMethodLabel'),
    paymentIdInput: $('#paymentId'),
    accountNameInput: $('#accountName'),
    accountNameGroup: $('#accountNameGroup'),
    submitWithdrawalBtn: $('#submitWithdrawalBtn'), withdrawalModalPoints: $('#withdrawalModalPoints'),
    homeBtn: $('#homeBtn'), referralBtn: $('#referralBtn'),
    notificationsBtn: $('#notificationsBtn'), notificationsPage: $('#notificationsPage'),
    notificationsBackBtn: $('#notificationsBackBtn'),
    personalNotificationsListContainer: $('#personalNotificationsListContainer'),
    adminAnnouncementsListContainer: $('#adminAnnouncementsListContainer'),
    notificationTabsContainer: $('.notifications-tabs'),
    notificationTabBtns: $$('.notification-tab-btn'),
    emptyPersonalNotificationsState: $('#emptyPersonalNotificationsState'),
    emptyAdminAnnouncementsState: $('#emptyAdminAnnouncementsState'),
    unreadNotificationsBadge: $('#unreadNotificationsBadge'),
    announcementUnreadDot: $('#announcementUnreadDot'),
    markAllNotificationsReadBtn: $('#markAllNotificationsReadBtn'),
    bookDetailModal: $('#bookDetailModal'), closeBookDetailModal: $('#closeBookDetailModal'), bookDetailContent: $('#bookDetailContent'),
    toastContainer: $('#toastContainer'),
    forgotPasswordLink: $('#forgotPasswordLink'),
    forgotPasswordModal: $('#forgotPasswordModal'), closeForgotPasswordModal: $('#closeForgotPasswordModal'), forgotPasswordForm: $('#forgotPasswordForm'),
    pinManagementModal: $('#pinManagementModal'), closePinManagementModal: $('#closePinManagementModal'), pinManagementForm: $('#pinManagementForm'),
    pinModalTitle: $('#pinModalTitle'), pinSetupFields: $('#pinSetupFields'), newPinInput: $('#newPin'), confirmNewPinInput: $('#confirmNewPin'),
    pinEntryField: $('#pinEntryField'), currentPinInput: $('#currentPin'), submitPinManagementBtn: $('#submitPinManagementBtn'),
    submitPinManagementBtnText: $('#submitPinManagementBtnText'), forgotPinLinkContainer: $('#forgotPinLinkContainer'), forgotPinLink: $('#forgotPinLink'),
    forgotPinModal: $('#forgotPinModal'), closeForgotPinModal: $('#closeForgotPinModal'), forgotPinForm: $('#forgotPinForm'),
    forgotPinRecoveryEmailInput: $('#forgotPinRecoveryEmail'), verifyRecoveryEmailBtn: $('#verifyRecoveryEmailBtn'),
    securitySettingsBtnFooter: $('#securitySettingsBtnFooter'),
    changePasswordBtnTab: $('#changePasswordBtnTab'), managePinBtnTab: $('#managePinBtnTab'), managePinBtnTabText: $('#managePinBtnTabText'),
    googleLoginBtn: $('#googleLoginBtn'),
    googleSignupBtn: $('#googleSignupBtn'),
    telegramPopupModal: $('#telegramPopupModal'),
    closeTelegramPopupModal: $('#closeTelegramPopupModal'),
    joinTelegramPopupBtn: $('#joinTelegramPopupBtn'),
    ignoreTelegramPopupBtn: $('#ignoreTelegramPopupBtn'),
};

let currentUser = null, userData = null, isUserDataLoading = true, allBooksCache = [],
    displayedBooksMain = [],
    popularBooksData = [], currentCategory = 'All',
    lastUserBookSnapshot = null, hasMoreUserBooks = true,
    selectedWithdrawalMethod = null, selectedWithdrawalAmount = null, selectedWithdrawalRs = null,
    isFetchingMoreUserBooks = false, currentBookDetailId = null,
    unreadNotificationsCount = 0,
    unreadAdminAnnouncementsCount = 0,
    lastVisibleBookMain = null,
    isLoadingBooksMain = false,
    hasMoreBooksMain = true,
    currentPinManagementContext = null,
    withdrawalDataForPinEntry = null,
    tempSignupDataStore = null, // For storing signup data before email verification
    emailVerificationInterval = null, // Interval for checking email verification status
    resendEmailCooldownActive = false, // Cooldown for resend verification email
    resendEmailTimerInterval = null; // Interval for cooldown timer display


let tempProfilePicFile = null;
let tempBookCoverFile = null;

let listeners = {
    user: null, withdrawals: null, popularBooks: null, userBooks: null,
    bookApproval: null, bookRejection: null,
    userNotifications: null, adminAnnouncements: null, allBooksSearch: null,
    referralStats: null,
};

const BOOK_DOWNLOAD_COST = 30;
const REFERRAL_COMMISSION_RATE = 0.15; // 15%
const POINTS_FOR_BOOK_APPROVAL = 10;
const BOOKS_PER_PAGE_MAIN = 12; 
const USER_SUBMISSIONS_PER_PAGE = 6;
const PIN_SALT = "EduSparkSuperSecretClientSaltForPINHashing"; 
const RESEND_EMAIL_COOLDOWN_SECONDS = 60;


const bookCategories = ['All', '9th', '10th', '11th', '12th', 'NEET', 'JEE', 'UPSC', 'Coding', 'Computer Science', 'Fiction', 'Non-Fiction', 'Other'];
const loadingMessages = [
    "Loading EduSparK Library...", "Unpacking Knowledge...", "Igniting Minds...",
    "Connecting to the Grid...", "Brewing Fresh Ideas...", "Preparing Your Journey..."
];
const TELEGRAM_CHANNEL_LINK = 'https://t.me/+gFZ2guUewss3Nzc1'; 

function escapeHTML(str) {
    if (str === null || str === undefined) return '';
    return String(str).replace(/[&<>"']/g, function (match) {
        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match];
    });
}

function showToast(message, type = "info", duration = 3500) {
    if (!elements.toastContainer) {
        console.warn("Toast container not found. Toast not shown:", message);
        return;
    }
    const toastId = 'toast-' + Date.now();
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.id = toastId;
    let iconClass = 'fas fa-info-circle';
    if (type === 'success') iconClass = 'fas fa-check-circle';
    else if (type === 'error') iconClass = 'fas fa-times-circle';
    else if (type === 'warning') iconClass = 'fas fa-exclamation-triangle';

    toast.innerHTML = `<i class="${iconClass}"></i><span>${escapeHTML(message)}</span><button class="toast-close" aria-label="Close toast">&times;</button>`;
    elements.toastContainer.appendChild(toast);
    requestAnimationFrame(() => toast.classList.add('show'));

    const closeBtn = toast.querySelector('.toast-close');
    closeBtn.onclick = () => {
        toast.classList.remove('show');
        setTimeout(() => { if (toast.parentElement) toast.remove(); }, 500);
    };

    setTimeout(() => {
        if (document.getElementById(toastId)) {
            toast.classList.remove('show');
            setTimeout(() => { if (toast.parentElement) toast.remove(); }, 500);
        }
    }, duration);
}

function openModal(modalElement) {
    if (!modalElement) return;
    modalElement.classList.add('active');
    elements.body.style.overflow = 'hidden';
    AOS.refresh();
}
function closeModal(modalElement) {
    if (!modalElement) return;
    modalElement.classList.remove('active');
    const anyModalActive = $$('.modal.active').length > 0;
    const anyPageActive = $$('.profile-page.active, .notifications-page.active').length > 0;
    if (!anyModalActive && !anyPageActive && (!elements.emailVerificationModal || !elements.emailVerificationModal.classList.contains('active'))) { // Ensure verification modal doesn't re-enable scroll
        elements.body.style.overflow = 'auto';
    }
}
function getInitials(name) {
    if (!name || typeof name !== 'string') return 'U';
    const parts = name.trim().split(' ').filter(p => p.length > 0);
    if (parts.length === 0) return 'U';
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
}

function formatDate(ts, format = { year: 'numeric', month: 'short', day: 'numeric' }) {
    if (!ts) return 'N/A';
    const date = ts.toDate ? ts.toDate() : new Date(ts);
    try {
        return date.toLocaleDateString(undefined, format);
    } catch (e) {
        console.warn("Error formatting date:", ts, e);
        return 'Invalid Date';
    }
}
function formatTime(ts) {
    if (!ts) return '';
    const date = ts.toDate ? ts.toDate() : new Date(ts);
    try {
        return date.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit', hour12: true });
    } catch (e) {
        console.warn("Error formatting time:", ts, e);
        return 'Invalid Time';
    }
}

function toggleSpinner(btn, show, loadingText = "Loading") {
    if (!btn) return;
    const textSpan = btn.querySelector('.button-text-content'); // The span holding the icon and actual text
    let loadingDotsContainer = btn.querySelector('.btn-loading-dots-container'); // Specific to new loading effect
    const simpleSpinner = btn.querySelector('.spinner'); // For buttons like "Load More" that use the old spinner

    if (show) {
        btn.classList.add('loading', 'button-is-loading'); // Add shimmer class
        btn.disabled = true;
        
        // Handle "Load More" type buttons with simple spinner
        if (simpleSpinner && btn.classList.contains('load-more-btn')) {
            if (textSpan) textSpan.style.opacity = '0';
            simpleSpinner.style.display = 'inline-block';
        } 
        // Handle new loading dots for other buttons
        else if (textSpan) {
            if(!textSpan.dataset.originalText) { // Store original text only if not already stored
                textSpan.dataset.originalText = textSpan.innerHTML;
            }
            textSpan.innerHTML = `${loadingText}`; // Update text, removing icon
            
            if (!loadingDotsContainer) {
                loadingDotsContainer = document.createElement('span');
                loadingDotsContainer.className = 'btn-loading-dots-container';
                loadingDotsContainer.innerHTML = '<span></span><span></span><span></span>';
                textSpan.appendChild(loadingDotsContainer);
            }
            loadingDotsContainer.style.display = 'inline-flex';
        }
    } else {
        btn.classList.remove('loading', 'button-is-loading');
        btn.disabled = false;
        
        if (simpleSpinner && btn.classList.contains('load-more-btn')) {
            if (textSpan) textSpan.style.opacity = '1';
            simpleSpinner.style.display = 'none';
        }
        else if (textSpan) {
            if (textSpan.dataset.originalText) {
                textSpan.innerHTML = textSpan.dataset.originalText; // Restore original
                delete textSpan.dataset.originalText; // Clean up
            }
            // Remove or hide dots container
            if (loadingDotsContainer) {
                loadingDotsContainer.remove(); // More robust to remove it
            }
        }
    }
}



function cleanupListeners() {
    for (const key in listeners) {
        if (listeners[key]) {
            try { listeners[key](); } catch (e) { console.warn(`Error cleaning listener ${key}:`, e); }
            listeners[key] = null;
        }
    }
    if (emailVerificationInterval) clearInterval(emailVerificationInterval);
    emailVerificationInterval = null;
    if (resendEmailTimerInterval) clearInterval(resendEmailTimerInterval);
    resendEmailTimerInterval = null;
}
function formatRelativeDate(ts) {
    if (!ts) return '';
    const date = ts.toDate ? ts.toDate() : new Date(ts);
    const today = new Date(); today.setHours(0, 0, 0, 0);
    const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
    const inputDate = new Date(date); inputDate.setHours(0, 0, 0, 0);

    if (inputDate.getTime() === today.getTime()) return 'Today';
    if (inputDate.getTime() === yesterday.getTime()) return 'Yesterday';
    return formatDate(ts, { month: 'long', day: 'numeric', year: 'numeric' });
}

function hideLoadingOverlay() {
    elements.loadingOverlay.classList.add('hidden');
}
function showRandomLoadingMessage() {
    const randomIndex = Math.floor(Math.random() * loadingMessages.length);
    elements.loadingMessage.textContent = loadingMessages[randomIndex];
}

auth.onAuthStateChanged(async (user) => {
    console.log("onAuthStateChanged. User:", user ? user.uid : 'null', user ? `Email Verified: ${user.emailVerified}` : '');
    cleanupListeners();
    currentUser = user;

    if (user) {
        // Check if user is authenticated via email/password but email is not verified
        const isEmailPasswordUser = user.providerData.some(p => p.providerId === 'password');
        if (isEmailPasswordUser && !user.emailVerified) {
            console.log("User session exists, but email not verified. UID:", user.uid);
            // Close any other modals that might be open
            [elements.loginModal, elements.signupModal].forEach(m => {
                if (m && m.classList.contains('active')) closeModal(m);
            });
            
            // If verification modal is not already active (e.g. on page refresh with unverified user)
            if (!elements.emailVerificationModal || !elements.emailVerificationModal.classList.contains('active')) {
                openEmailVerificationModal(user.email);
            }
            if (!elements.loadingOverlay.classList.contains('hidden')) hideLoadingOverlay();
            return; // Stop further processing until email is verified or modal interaction occurs
        }

        isUserDataLoading = true;
        updateProfileUI(); updateAvatar(); updateHeaderCredits(); // Show initial loading states
        elements.body.classList.add('logged-in');
        elements.body.classList.remove('logged-out');
        elements.headerCreditsContainer.style.display = 'flex';
        
        const userDocRef = db.collection('users').doc(user.uid);
        listeners.user = userDocRef.onSnapshot(async (doc) => {
            console.log("User document snapshot. Exists:", doc.exists, "UID:", user.uid);
            if (doc.exists) {
                userData = { id: doc.id, ...doc.data() };
                isUserDataLoading = false;
                
                // If verification modal was open and now user data is loaded (implies doc created after verification)
                if (elements.emailVerificationModal && elements.emailVerificationModal.classList.contains('active') && user.emailVerified) {
                    closeModal(elements.emailVerificationModal);
                    showToast("Email verified successfully! Welcome to EduSparK!", "success");
                }

                updateProfileUI(); updateAvatar(); updateHeaderCredits();
                enableWithdrawalIfQualified();
                setupBookApprovalListeners(); setupUserNotificationsListener(); setupAdminAnnouncementsListener();
                setupReferralStatsListener(); 
                if(elements.managePinBtnTabText) elements.managePinBtnTabText.textContent = userData.hasSetPin ? 'Change PIN' : 'Set PIN';
                if (!elements.loadingOverlay.classList.contains('hidden')) hideLoadingOverlay();
            } else { 
                 // Document does NOT exist for this Firebase Auth user.
                 // This will primarily be hit for Google Sign-In users on their first login,
                 // or for email/password users *after* their email has been verified and onAuthStateChanged re-triggers.
                console.log("User document doesn't exist. Attempting to create. UID:", user.uid);
                try {
                    const sData = tempSignupDataStore || JSON.parse(sessionStorage.getItem('tempSignupDataForVerifiedUser') || '{}');
                    sessionStorage.removeItem('tempSignupDataForVerifiedUser');
                    tempSignupDataStore = null;
                    
                    await createUserDocument(user,
                        sData.name || user.displayName, sData.username, sData.bio,
                        sData.telegram, sData.recoveryEmail, sData.referralCode
                    );
                    // The onSnapshot listener above will re-trigger with doc.exists=true and populate userData, then close modals etc.
                } catch (error) {
                    console.error("Fatal error creating user document:", error);
                    showToast("Critical error setting up your profile. Please contact support.", "error", 10000);
                    auth.signOut().catch(e => console.error("Error signing out after profile creation failure", e));
                    isUserDataLoading = false;
                    if (!elements.loadingOverlay.classList.contains('hidden')) hideLoadingOverlay();
                }
            }
        }, (error) => {
            console.error("Error listening to user data:", error);
            showToast("Could not load your profile data. Please refresh.", "error");
            userData = null; isUserDataLoading = false;
            updateProfileUI(); updateAvatar(); updateHeaderCredits();
            if (!elements.loadingOverlay.classList.contains('hidden')) hideLoadingOverlay();
        });

        try { await userDocRef.update({ lastActive: firebase.firestore.FieldValue.serverTimestamp() }).catch(err => {
                if (err.code !== 'not-found') console.error("Error updating lastActive:", err);
            });
        } catch (warn) { /* Handled */ }

        initializeDataFetching();
    } else { // User is logged out
        console.log("User is logged out.");
        userData = null; currentUser = null; isUserDataLoading = false; tempSignupDataStore = null;
        elements.body.classList.remove('logged-in'); elements.body.classList.add('logged-out');
        elements.headerCreditsContainer.style.display = 'none';
        updateProfileUI(); updateAvatar(); updateHeaderCredits();
        updateUnreadBadge(0); updateAdminAnnouncementDot(0);
        showLoginPromptInsteadOfContent(); closeAllPagesAndModals(); resetNavigation();
        ['popularBooksCarousel', 'profileBooksContainer', 'withdrawalHistoryContainer', 'personalNotificationsListContainer', 'adminAnnouncementsListContainer', 'booksContainer'].forEach(elKey => {
            if (elements[elKey]) elements[elKey].innerHTML = '';
        });
        if (elements.categoryFilterContainer) elements.categoryFilterContainer.innerHTML = '';
        allBooksCache = []; displayedBooksMain = []; popularBooksData = [];
        lastVisibleBookMain = null; hasMoreBooksMain = true; isLoadingBooksMain = false;
        lastUserBookSnapshot = null; hasMoreUserBooks = true; isFetchingMoreUserBooks = false;
        currentCategory = 'All';
        if (listeners.allBooksSearch) listeners.allBooksSearch(); listeners.allBooksSearch = null;
        if (!elements.loadingOverlay.classList.contains('hidden')) hideLoadingOverlay();
    }
});


function generateReferralCode(length = 8) {
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * characters.length));
    }
    return result;
}

async function generateAndSaveReferralCode(userId) {
    const newReferralCode = generateReferralCode();
    try {
        await db.collection('users').doc(userId).update({
            referralCode: newReferralCode
        });
        // Update local userData if available
        if (userData && userData.id === userId) {
            userData.referralCode = newReferralCode;
        }
        console.log(`Generated and saved new referral code ${newReferralCode} for user ${userId}`);
        return newReferralCode;
    } catch (error) {
        console.error(`Error generating/saving referral code for user ${userId}:`, error);
        return null;
    }
}

async function createUserDocument(firebaseUser, nameOverride, usernameOverride, bioOverride, telegramOverride, recoveryEmailOverride, referralCodeUsed) {
    if (!firebaseUser) {
        console.error("createUserDocument called with no firebaseUser.");
        showToast("Account creation error: User session missing.", "error");
        return;
    }
    const name = nameOverride || firebaseUser.displayName || "Anonymous User";
    let username = usernameOverride;
    if (!username && firebaseUser.email) {
        username = firebaseUser.email.split('@')[0].replace(/[^a-z0-9_.]/gi, '').toLowerCase();
        if (username.length > 15) username = username.substring(0, 15);
    }
    if (!username || username.length < 3) {
      username = `user${Date.now().toString().slice(-7)}`;
    }

    try {
        const usernameSnapshot = await db.collection('users').where('username', '==', username).get();
        if (!usernameSnapshot.empty && usernameSnapshot.docs[0].id !== firebaseUser.uid) { // Username taken by someone else
            username = `${username.substring(0,10)}${Date.now().toString().slice(-5)}`; // Make it unique
        }
    } catch (e) { console.warn("Error checking username uniqueness during doc creation:", e); }

    const bio = bioOverride || "EduSparK enthusiast!";
    const userRef = db.collection('users').doc(firebaseUser.uid);

    let referredByData = {};
    if (referralCodeUsed) {
        const referrerQuery = await db.collection('users').where('referralCode', '==', referralCodeUsed).limit(1).get();
        if (!referrerQuery.empty) {
            const referrerDoc = referrerQuery.docs[0];
            if (referrerDoc.id !== firebaseUser.uid) { // Cannot refer self
                referredByData = {
                    referredBy: referrerDoc.id,
                    referredByCode: referralCodeUsed
                };
                await db.collection('users').doc(referrerDoc.id).update({
                    totalReferrals: firebase.firestore.FieldValue.increment(1)
                }).catch(err => console.error("Error updating referrer's totalReferrals:", err));
                console.log(`User ${firebaseUser.uid} referred by ${referrerDoc.id} using code ${referralCodeUsed}`);
            } else {
                 console.warn(`User ${firebaseUser.uid} attempted to use their own referral code ${referralCodeUsed}.`);
            }
        } else {
            console.warn(`Referral code ${referralCodeUsed} not found.`);
        }
    }
    
    // Determine if it's an email/password signup; Google signups are considered 'verified' by provider
    const isEmailPasswordSignup = firebaseUser.providerData.some(p => p.providerId === 'password');

    const initialUserData = {
        uid: firebaseUser.uid,
        email: firebaseUser.email,
        name: name,
        username: username,
        bio: bio,
        profilePictureURL: firebaseUser.photoURL || null,
        points: 0, credits: 50, 
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        lastActive: firebase.firestore.FieldValue.serverTimestamp(),
        booksSharedCount: 0, booksDownloadedCount: 0, lastDailyCreditClaim: null,
        totalBookDownloads: 0, totalFeedbackGiven: 0,
        processedBookActions: {},
        lastCreditBoostClaim: null, creditsEarnedViaBoosts: 0,
        lastViewedAnnouncementsAt: null,
        telegramUsername: telegramOverride || '',
        recoveryEmail: recoveryEmailOverride || '',
        hasSetPin: false,
        secretPinHash: null,
        referralCode: generateReferralCode(), 
        totalReferrals: 0,
        pointsFromReferrals: 0,
        isEmailVerifiedUser: isEmailPasswordSignup ? firebaseUser.emailVerified : true,
        ...referredByData
    };
    try {
        await userRef.set(initialUserData, { merge: true });
        console.log("User document created/merged for:", firebaseUser.uid);
    } catch (error) {
        console.error("Critical error creating user document in Firestore: ", error);
        showToast("Major error setting up your account. Please contact support.", "error", 10000);
        throw error; 
    }
}


function showLoginPromptInsteadOfContent() {
    if (elements.booksContainer) {
        elements.booksContainer.innerHTML = '';
        elements.emptyStateBooks.innerHTML = `<i class="fas fa-sign-in-alt"></i><h3>Login to Discover Books</h3><p>Join EduSparK to share, download, and engage!</p><button class="submit-btn" style="margin-top:20px;max-width:200px;" id="loginPromptBtnMain"><span class="button-text-content">Login / Sign Up</span></button>`;
        elements.emptyStateBooks.style.display = 'flex';
        const loginPromptBtn = $('#loginPromptBtnMain');
        if (loginPromptBtn) loginPromptBtn.onclick = () => openModal(elements.loginModal);
    }
    if (elements.popularBooksCarousel) {
        elements.popularBooksCarousel.innerHTML = `<div class="empty-state" style="padding:20px 0;min-height:150px;width:100%;text-align:center;"><i class="fas fa-lock"></i><p style="font-size:0.9rem;">Login to see popular books.</p></div>`;
    }

    if(elements.emptyProfileBooks) elements.emptyProfileBooks.style.display = 'flex';
    if(elements.emptyWithdrawalHistory) elements.emptyWithdrawalHistory.style.display = 'flex';
    if(elements.emptyPersonalNotificationsState) elements.emptyPersonalNotificationsState.style.display = 'flex';
    if(elements.emptyAdminAnnouncementsState) elements.emptyAdminAnnouncementsState.style.display = 'flex';
    renderCategoryFilters();
}

elements.loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = $('#loginEmail').value;
    const password = $('#loginPassword').value;
    const btn = $('#loginBtn');
    toggleSpinner(btn, true, "Logging In");
    try {
        await auth.signInWithEmailAndPassword(email, password);
        // onAuthStateChanged handles UI changes & modal closure for success.
    } catch (error) {
        console.error("Login error:", error);
        showToast(error.message, "error");
        toggleSpinner(btn, false); // Ensure spinner stops on error
    }
});

elements.signupForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = $('#signupName').value;
    const username = $('#signupUsername').value.trim().toLowerCase();
    const email = $('#signupEmail').value;
    const password = $('#signupPassword').value;
    const bio = $('#signupBio').value;
    const telegram = $('#signupTelegram').value.trim();
    const recoveryEmail = $('#signupRecoveryEmail').value.trim();
    const referralCode = $('#signupReferralCode').value.trim();

    if (!/^[a-z0-9_.]{3,15}$/.test(username)) {
        showToast("Username: 3-15 chars, lowercase, numbers, '_', '.'", "error", 5000); return;
    }
    if (password.length < 6) { showToast("Password must be at least 6 characters.", "error"); return; }
    if (recoveryEmail && recoveryEmail === email) { showToast("Recovery email cannot be the same as your account email.", "error"); return; }

    const btn = $('#signupBtn');
    toggleSpinner(btn, true, "Creating Account");

    try {
        const usernameSnapshot = await db.collection('users').where('username', '==', username).get();
        if (!usernameSnapshot.empty) {
            showToast("Username already taken. Please choose another.", "error");
            toggleSpinner(btn, false); return;
        }
        const methods = await auth.fetchSignInMethodsForEmail(email);
        if (methods.length > 0) {
            showToast("This email address is already in use.", "error");
            toggleSpinner(btn, false); return;
        }
        
        // Store data temporarily before Firebase Auth call
        tempSignupDataStore = { name, username, email, bio, telegram, recoveryEmail, referralCode };
        sessionStorage.setItem('tempSignupDataForVerifiedUser', JSON.stringify(tempSignupDataStore));


        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        
        if (userCredential.user && !userCredential.user.emailVerified) {
             await userCredential.user.sendEmailVerification();
             console.log("Verification email sent from signup form submission.");
             closeModal(elements.signupModal); 
             openEmailVerificationModal(email); 
        } else if (userCredential.user && userCredential.user.emailVerified) {
            // This case should ideally not happen if email verification is mandatory first.
            // But if it does (e.g., config change), proceed to doc creation.
             console.log("User already verified (or non-email signup type during createUser). Triggering onAuthStateChanged flow.");
             // onAuthStateChanged will pick this up.
        }
    } catch (error) {
        console.error("Signup error:", error);
        showToast(error.message, "error");
        tempSignupDataStore = null; 
        sessionStorage.removeItem('tempSignupDataForVerifiedUser');
        toggleSpinner(btn, false);
    }
});

function openEmailVerificationModal(emailToVerify) {
    if (elements.verificationEmailSentTo) elements.verificationEmailSentTo.textContent = escapeHTML(emailToVerify || "your email");
    if (elements.resendVerificationEmailBtn) { // Reset resend button state
        elements.resendVerificationEmailBtn.classList.remove('disabled-cooldown');
        if (elements.resendVerificationEmailBtn.querySelector('.button-text-content')) {
            elements.resendVerificationEmailBtn.querySelector('.button-text-content').innerHTML = '<i class="fas fa-paper-plane"></i> Resend Verification Email';
        }
        resendEmailCooldownActive = false;
        if(resendEmailTimerInterval) clearInterval(resendEmailTimerInterval);
    }
    openModal(elements.emailVerificationModal);
    startEmailVerificationCheck();
}

function startEmailVerificationCheck() {
    if (emailVerificationInterval) clearInterval(emailVerificationInterval);
    if (!elements.emailVerificationModal || !elements.emailVerificationModal.classList.contains('active')) return;

    console.log("Starting email verification check interval.");
    emailVerificationInterval = setInterval(async () => {
        const user = auth.currentUser;
        if (user) {
            await user.reload(); 
            console.log("Verification check interval: User reloaded. Verified status:", user.emailVerified);
            if (user.emailVerified) {
                console.log("Email verified (checked by interval). Stopping interval.");
                clearInterval(emailVerificationInterval);
                emailVerificationInterval = null;
                
                // Data stored from signup form for document creation
                let sData = tempSignupDataStore || JSON.parse(sessionStorage.getItem('tempSignupDataForVerifiedUser') || '{}');
                sessionStorage.removeItem('tempSignupDataForVerifiedUser'); // Clean up session storage
                tempSignupDataStore = null; // Clean up global temp store

                if (Object.keys(sData).length === 0) {
                    console.warn("No temporary signup data found after email verification. User might need to re-enter info or contact support if profile isn't complete.");
                }
                
                // Create the user document now that email is verified.
                // onAuthStateChanged will then detect the new document via its snapshot listener.
                try {
                     await createUserDocument(user, sData.name, sData.username, sData.bio, sData.telegram, sData.recoveryEmail, sData.referralCode);
                } catch (docError) {
                    console.error("Error creating user document post-verification:", docError);
                    showToast("Error finalizing account setup. Please try logging in, or contact support.", "error");
                }
                // onAuthStateChanged will naturally handle UI updates and modal closing once the document exists.
            } else {
                console.log("Email not yet verified (checked by interval).");
            }
        } else {
            console.log("User session lost during verification check. Stopping interval.");
            clearInterval(emailVerificationInterval);
            emailVerificationInterval = null;
            if(elements.emailVerificationModal && elements.emailVerificationModal.classList.contains('active')) {
                closeModal(elements.emailVerificationModal);
            }
            openModal(elements.loginModal); 
        }
    }, 7000); // Check every 7 seconds
}


if (elements.closeEmailVerificationModal) elements.closeEmailVerificationModal.onclick = () => {
    closeModal(elements.emailVerificationModal);
    if (emailVerificationInterval) clearInterval(emailVerificationInterval); emailVerificationInterval = null;
    if(resendEmailTimerInterval) clearInterval(resendEmailTimerInterval);
};

if(elements.checkVerificationStatusBtn) elements.checkVerificationStatusBtn.onclick = async () => {
    const user = auth.currentUser;
    const btn = elements.checkVerificationStatusBtn;
    if (user) {
        toggleSpinner(btn, true, "Checking");
        await user.reload();
        if (user.emailVerified) {
            console.log("Email verified (manual check).");
            clearInterval(emailVerificationInterval); emailVerificationInterval = null;
            let sData = tempSignupDataStore || JSON.parse(sessionStorage.getItem('tempSignupDataForVerifiedUser') || '{}');
            sessionStorage.removeItem('tempSignupDataForVerifiedUser');
            tempSignupDataStore = null;
            
            try {
                 await createUserDocument(user, sData.name, sData.username, sData.bio, sData.telegram, sData.recoveryEmail, sData.referralCode);
            } catch (docError) {
                 console.error("Error creating user document post-manual-verification:", docError);
            }
             // onAuthStateChanged will handle UI and close verification modal
        } else {
            showToast("Email not yet verified. Please check your inbox or resend the email.", "warning");
        }
        toggleSpinner(btn, false);
    } else {
        showToast("Session lost. Please try logging in or signing up again.", "error");
        closeModal(elements.emailVerificationModal);
        openModal(elements.loginModal);
    }
};

if(elements.resendVerificationEmailBtn) elements.resendVerificationEmailBtn.onclick = async () => {
    const user = auth.currentUser;
    const btn = elements.resendVerificationEmailBtn;
    if (resendEmailCooldownActive) {
        return; // Toast already shown by interval timer if clicked too soon
    }
    if (user) {
        toggleSpinner(btn, true, "Resending");
        try {
            await user.sendEmailVerification();
            showToast("Verification email resent! Please check your inbox.", "success");
            resendEmailCooldownActive = true;
            btn.classList.add('disabled-cooldown');
            
            const originalButtonTextSpan = btn.querySelector('.button-text-content');
            const originalHTML = originalButtonTextSpan ? originalButtonTextSpan.innerHTML : 'Resend Email'; // fallback

            let countdown = RESEND_EMAIL_COOLDOWN_SECONDS;
            if (originalButtonTextSpan) originalButtonTextSpan.innerHTML = `Resend Again in ${countdown}s`;

            if(resendEmailTimerInterval) clearInterval(resendEmailTimerInterval); // Clear any existing timer
            resendEmailTimerInterval = setInterval(() => {
                countdown--;
                if (originalButtonTextSpan) {
                    if (countdown > 0) {
                        originalButtonTextSpan.innerHTML = `Resend Again in ${countdown}s`;
                    } else {
                        clearInterval(resendEmailTimerInterval);
                        resendEmailCooldownActive = false;
                        btn.classList.remove('disabled-cooldown');
                        originalButtonTextSpan.innerHTML = originalHTML; // Restore original icon + text
                    }
                } else { // Failsafe if span not found
                     clearInterval(resendEmailTimerInterval);
                }
            }, 1000);

        } catch (error) {
            console.error("Error resending verification email:", error);
            showToast("Failed to resend email: " + error.message, "error");
        } finally {
             // Important: toggleSpinner modifies the button-text-content's innerHTML.
             // So, ensure the originalHTML for cooldown text is based on default content if needed,
             // or this toggle happens *after* cooldown logic restores the text.
             // Better: let cooldown text be handled solely by interval.
             toggleSpinner(btn, false); // Turn off loading dots, shimmer
        }
    } else {
         showToast("No active user session to resend email for.", "error");
    }
};
if (elements.cancelVerificationAndLogoutBtn) elements.cancelVerificationAndLogoutBtn.onclick = async () => {
    if (emailVerificationInterval) clearInterval(emailVerificationInterval); emailVerificationInterval = null;
    if (resendEmailTimerInterval) clearInterval(resendEmailTimerInterval); resendEmailTimerInterval = null;

    closeModal(elements.emailVerificationModal);
    const btn = elements.cancelVerificationAndLogoutBtn; // Could make this a button for spinner
    // toggleSpinner(btn, true, "Logging out");
    try {
        await auth.signOut(); 
        showToast("Signup process cancelled.", "info");
    } catch (error) {
        console.error("Error signing out during verification cancel:", error);
        showToast("Error during logout: " + error.message, "error");
    } finally {
        // toggleSpinner(btn, false);
    }
};

async function handleGoogleSignIn(btnElement) {
    const provider = new firebase.auth.GoogleAuthProvider();
    toggleSpinner(btnElement, true, "Connecting");
    try {
        const result = await auth.signInWithPopup(provider);
        console.log("Google Sign-In successful via popup, user:", result.user.uid);
        showToast(`Signed in with Google as ${result.user.displayName || result.user.email}!`, "success", 3000);
        // onAuthStateChanged handles UI changes, modal closures, and document creation if new user.
    } catch (error) {
        console.error("Google Sign-In Error:", error);
        if (error.code === 'auth/account-exists-with-different-credential') {
            showToast("An account already exists with this email using a different sign-in method.", "error", 8000);
        } else if (error.code === 'auth/popup-closed-by-user' || error.code === 'auth/cancelled-popup-request') {
            showToast("Google Sign-In cancelled.", "info");
        } else {
            showToast("Google Sign-In failed: " + error.message, "error");
        }
        toggleSpinner(btnElement, false); // Stop spinner only on error
    }
    // For success, onAuthStateChanged flow should handle the UI including button state
}

if(elements.googleLoginBtn) elements.googleLoginBtn.onclick = () => handleGoogleSignIn(elements.googleLoginBtn);
if(elements.googleSignupBtn) elements.googleSignupBtn.onclick = () => handleGoogleSignIn(elements.googleSignupBtn);


elements.logoutBtn.addEventListener('click', async () => {
    toggleSpinner(elements.logoutBtn, true, "Logging Out");
    try {
        await auth.signOut();
        // onAuthStateChanged will handle resetting the UI
    } catch (error) {
        console.error("Logout error:", error);
        showToast("Error logging out. Please try again.", "error");
        toggleSpinner(elements.logoutBtn, false); // Stop spinner on error
    }
});

function updateProfileUI() {
    if (isUserDataLoading && currentUser) { 
        elements.profileAvatarLarge.innerHTML = `<span id="profileAvatarInitialsLarge">L</span>`;
        elements.profileNameLarge.textContent = 'Loading Profile...';
        elements.profileUsernameLarge.textContent = '@loading...';
        elements.profileEmailLarge.innerHTML = `<i class="fas fa-envelope"></i> ...`;
        elements.profileJoinedLarge.innerHTML = `<i class="fas fa-calendar-alt"></i> Joined: ...`;
        elements.profileBioLarge.textContent = 'Loading bio...';
        ['userPointsLarge', 'booksSharedLarge', 'booksDownloadedLarge', 'totalBookDownloadsLarge', 'totalFeedbackLarge'].forEach(elId => {
            if (elements[elId]) elements[elId].textContent = '...';
        });
    } else if (userData) { 
        if (userData.profilePictureURL) {
            elements.profileAvatarLarge.innerHTML = `<img src="${escapeHTML(userData.profilePictureURL)}" alt="${escapeHTML(userData.name)}">`;
        } else {
            elements.profileAvatarLarge.innerHTML = `<span id="profileAvatarInitialsLarge">${getInitials(userData.name)}</span>`;
        }
        elements.profileNameLarge.textContent = escapeHTML(userData.name || 'User');
        elements.profileUsernameLarge.textContent = `@${escapeHTML(userData.username || 'username')}`;
        elements.profileEmailLarge.innerHTML = `<i class="fas fa-envelope"></i> ${escapeHTML(userData.email || 'No email')}`;
        elements.profileJoinedLarge.innerHTML = `<i class="fas fa-calendar-alt"></i> Joined: ${userData.createdAt ? formatDate(userData.createdAt) : '-'}`;
        elements.profileBioLarge.textContent = escapeHTML(userData.bio || 'No bio set. Click Edit Profile to add one!');

        elements.userPointsLarge.textContent = userData.points || 0;
        elements.booksSharedLarge.textContent = userData.booksSharedCount || 0;
        elements.booksDownloadedLarge.textContent = userData.booksDownloadedCount || 0;
        elements.totalBookDownloadsLarge.textContent = userData.totalBookDownloads || 0;
        elements.totalFeedbackLarge.textContent = userData.totalFeedbackGiven || 0;
    } else { 
        elements.profileAvatarLarge.innerHTML = `<span id="profileAvatarInitialsLarge">U</span>`;
        elements.profileNameLarge.textContent = 'User Loading...';
        elements.profileUsernameLarge.textContent = '@loading';
        elements.profileEmailLarge.innerHTML = `<i class="fas fa-envelope"></i> loading...`;
        elements.profileJoinedLarge.innerHTML = `<i class="fas fa-calendar-alt"></i> Joined: -`;
        elements.profileBioLarge.textContent = 'Loading bio...';
        ['userPointsLarge', 'booksSharedLarge', 'booksDownloadedLarge', 'totalBookDownloadsLarge', 'totalFeedbackLarge'].forEach(elId => {
            if (elements[elId]) elements[elId].textContent = '0';
        });
        if (elements.emptyProfileBooks) {
            elements.profileBooksContainer.innerHTML = '';
            elements.emptyProfileBooks.style.display = 'flex';
        }
        if (elements.emptyWithdrawalHistory) {
            elements.withdrawalHistoryContainer.innerHTML = '';
            elements.emptyWithdrawalHistory.style.display = 'flex';
        }
    }
    checkAndShowProfilePrompts();
}
function updateAvatar() {
    if (isUserDataLoading && currentUser) {
         elements.userAvatar.innerHTML = `<span id="avatarInitials">L</span>`;
    } else if (userData && userData.profilePictureURL) {
        elements.userAvatar.innerHTML = `<img src="${escapeHTML(userData.profilePictureURL)}" alt="${escapeHTML(userData.name)}">`;
    } else {
        elements.userAvatar.innerHTML = `<span id="avatarInitials">${(userData && userData.name) ? getInitials(userData.name) : 'U'}</span>`;
    }
}
function updateHeaderCredits() {
     if (isUserDataLoading && currentUser) {
        elements.headerCreditsAmount.textContent = '...';
     } else {
        elements.headerCreditsAmount.textContent = userData ? (userData.credits || 0) : '0';
     }
}

function checkAndShowProfilePrompts() {
    if (!currentUser || !userData || !elements.profilePage.classList.contains('active') || isUserDataLoading) {
        if (elements.telegramUsernamePrompt) elements.telegramUsernamePrompt.style.display = 'none';
        if (elements.recoveryEmailPrompt) elements.recoveryEmailPrompt.style.display = 'none';
        if (elements.setupPinPrompt) elements.setupPinPrompt.style.display = 'none';
        return;
    }

    if (elements.telegramUsernamePrompt) {
        elements.telegramUsernamePrompt.style.display = !userData.telegramUsername ? 'block' : 'none';
        elements.telegramUsernamePrompt.onclick = () => { elements.editProfileBtn.click(); };
    }
    if (elements.recoveryEmailPrompt) {
        elements.recoveryEmailPrompt.style.display = !userData.recoveryEmail ? 'block' : 'none';
        elements.recoveryEmailPrompt.onclick = () => { elements.editProfileBtn.click(); };
    }
    if (elements.setupPinPrompt) {
        elements.setupPinPrompt.style.display = !userData.hasSetPin ? 'block' : 'none';
        elements.setupPinPrompt.onclick = () => openPinManagementModal('setup');
    }
}


elements.editProfileBtn.addEventListener('click', () => {
    if (userData && currentUser && !isUserDataLoading) {
        if (userData.profilePictureURL) {
            elements.profilePicturePreview.src = userData.profilePictureURL;
            elements.profilePicturePreview.classList.remove('empty');
            elements.profilePicturePreview.innerHTML = '';
        } else {
            elements.profilePicturePreview.src = '#'; 
            elements.profilePicturePreview.classList.add('empty');
            elements.profilePicturePreview.innerHTML = `<i class="fas fa-user" style="font-size:2rem; color: var(--text-muted);"></i>`;
        }
        tempProfilePicFile = null;

        $('#editProfileName').value = userData.name || '';
        $('#editProfileUsername').value = userData.username || '';
        $('#editProfileBio').value = userData.bio || '';
        $('#editProfileTelegram').value = userData.telegramUsername || '';
        $('#editProfileRecoveryEmail').value = userData.recoveryEmail || '';
        openModal(elements.editProfileModal);
    } else {
        showToast("Please login to edit your profile.", "warning");
        openModal(elements.loginModal);
    }
});
if (elements.closeEditProfileModal) elements.closeEditProfileModal.onclick = () => closeModal(elements.editProfileModal);

if (elements.profilePictureInput) {
    elements.profilePictureInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            if (file.size > 2 * 1024 * 1024) { 
                showToast("Image too large. Max 2MB allowed.", "error");
                elements.profilePictureInput.value = '';
                return;
            }
            tempProfilePicFile = file;
            const reader = new FileReader();
            reader.onload = (event) => {
                elements.profilePicturePreview.src = event.target.result;
                elements.profilePicturePreview.classList.remove('empty');
                elements.profilePicturePreview.innerHTML = '';
            }
            reader.readAsDataURL(file);
        }
    });
}

elements.editProfileForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser || !userData || isUserDataLoading) { showToast("Not logged in or data still loading.", "error"); return; }
    const newName = $('#editProfileName').value;
    const newUsername = $('#editProfileUsername').value.trim().toLowerCase();
    const newBio = $('#editProfileBio').value;
    const newTelegram = $('#editProfileTelegram').value.trim();
    const newRecoveryEmail = $('#editProfileRecoveryEmail').value.trim();

    if (!/^[a-z0-9_.]{3,15}$/.test(newUsername)) {
        showToast("Username: 3-15 chars, lowercase, numbers, '_', '.'", "error", 5000); return;
    }
    if (newRecoveryEmail && newRecoveryEmail === userData.email) {
        showToast("Recovery email cannot be the same as your account email.", "error"); return;
    }

    const btn = $('#saveProfileBtn');
    toggleSpinner(btn, true, "Saving");

    try {
        if (newUsername !== userData.username) {
            const usernameSnapshot = await db.collection('users').where('username', '==', newUsername).get();
            if (!usernameSnapshot.empty) {
                showToast("Username already taken. Please choose another.", "error");
                toggleSpinner(btn, false); return;
            }
        }

        let profilePictureURL = userData.profilePictureURL;
        if (tempProfilePicFile) {
            const storageRef = storage.ref(`profile_picture/${currentUser.uid}/${Date.now()}_${tempProfilePicFile.name}`);
            const uploadTask = await storageRef.put(tempProfilePicFile);
            profilePictureURL = await uploadTask.ref.getDownloadURL();
            tempProfilePicFile = null; 
        }

        await db.collection('users').doc(currentUser.uid).update({
            name: newName, username: newUsername, bio: newBio,
            telegramUsername: newTelegram,
            recoveryEmail: newRecoveryEmail,
            profilePictureURL: profilePictureURL 
        });
        await createNotification(currentUser.uid, "Profile Updated", "Your profile details have been successfully changed.", "info", null, "fas fa-user-check");
        showToast("Profile updated successfully!", "success");
        closeModal(elements.editProfileModal);
    } catch (error) {
        console.error("Error updating profile:", error, error.code); 
        showToast("Failed to update profile: " + error.message + (error.code ? ` (Code: ${error.code}). Check Firebase Storage rules.` : ''), "error", 7000);
    } finally {
        toggleSpinner(btn, false);
    }
});

if (elements.profileTabs) {
    elements.profileTabs.addEventListener('click', (e) => {
        const targetTabBtn = e.target.closest('.profile-tab-btn');
        if (!targetTabBtn) return;
        elements.profileTabBtns.forEach(btn => btn.classList.remove('active'));
        targetTabBtn.classList.add('active');
        const tabId = targetTabBtn.dataset.tab;
        elements.profileTabContents.forEach(content => {
            content.classList.toggle('active', content.id === `tab-${tabId}`);
        });
        AOS.refresh();
    });
}

function initializeDataFetching() {
    if (!currentUser || isUserDataLoading || (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified) ) {
         // Don't fetch main content if email user is not verified yet.
        console.log("Data fetching skipped: User not fully ready (logged out, loading, or email not verified).");
        return;
    }
    console.log("Initializing data fetching...");
    fetchBooksMain(false);
    fetchPopularBooks();
    renderCategoryFilters();
    setupAllBooksListenerForSearch();
    if (userData && elements.referralBtn.classList.contains('active')) {
        fetchReferralStats();
    }
}

function renderSkeletonLoaders(container, count, type = 'book') {
    if (!container) return;
    if (container !== elements.booksGridLoadingIndicator) { 
        container.innerHTML = '';
    }
    let skeletonHTML = '';
    for (let i = 0; i < count; i++) {
        if (type === 'book') { 
             skeletonHTML += `<div class="skeleton-book-card"><div class="skeleton-img"></div><div class="skeleton-info"><div class="skeleton-text title"></div><div class="skeleton-text author"></div><div class="skeleton-text meta"></div><div class="skeleton-btn"></div></div></div>`;
        } else if (type === 'book-main') { 
             skeletonHTML += `<div class="skeleton-book-card main-compact"><div class="skeleton-img"></div><div class="skeleton-info"><div class="skeleton-text title"></div><div class="skeleton-text meta"></div><div class="skeleton-btn"></div></div></div>`;
        } else if (type === 'popular') {
            skeletonHTML += `<div class="skeleton-popular-book"><div class="skeleton-img"></div><div class="skeleton-info"><div class="skeleton-text title"></div><div class="skeleton-text meta"></div></div></div>`;
        } else if (type === 'history') {
            skeletonHTML += `<div class="skeleton-history-item"></div>`;
        } else if (type === 'notification') {
            skeletonHTML += `<div class="skeleton-notification-item"><div class="skeleton-icon"></div><div class="skeleton-content"><div class="skeleton-text title"></div><div class="skeleton-text message"></div><div class="skeleton-text timestamp"></div></div></div>`;
        }
    }
    if (container !== elements.booksGridLoadingIndicator) {
        container.innerHTML = skeletonHTML;
    }
}


function createBookCardHTML(book, target = 'main') {
    const defaultImage = 'https://via.placeholder.com/300x220/333/888?text=No+Cover';
    const imageUrl = book.imageUrl || defaultImage;
    
    if (target === 'main') { 
        return `
           <div class="book-card book-card-main" data-id="${book.id}" style="animation-delay: ${Math.random() * 0.2}s" data-aos="fade-up">
               <div class="book-img-container" data-action="view" data-book-id="${book.id}" data-source="books">
                   <img src="${escapeHTML(imageUrl)}" alt="${escapeHTML(book.bookName)}" class="book-img" loading="lazy" onerror="this.onerror=null;this.src='${defaultImage}';">
               </div>
               <div class="book-info">
                   <h3 class="book-title" title="${escapeHTML(book.bookName)}">${escapeHTML(book.bookName)}</h3>
                   <div class="book-meta book-meta-main-page">
                       <span><i class="fas fa-download"></i> ${book.downloads || 0}</span>
                   </div>
                   <button class="action-btn view-btn" data-action="view" data-book-id="${book.id}" data-source="books">
                       <span class="button-text-content"><i class="fas fa-eye"></i> View</span>
                   </button>
               </div>
           </div>`;
    } else { 
        let statusBadge = '';
        if (target === 'profile') { 
            if (book.status === 'pending') statusBadge = '<span class="status-badge status-pending">Pending</span>';
            else if (book.status === 'rejected') statusBadge = '<span class="status-badge status-rejected">Rejected</span>';
        }
        
        const dataSourceForButton = target === 'profile' ? 'pending_books' : 'books';

        return `
           <div class="book-card book-card-profile" data-id="${book.id}" style="animation-delay: ${Math.random() * 0.2}s" data-aos="fade-up">
               <div class="book-img-container" data-action="view" data-book-id="${book.id}" data-source="${dataSourceForButton}">
                   <img src="${escapeHTML(imageUrl)}" alt="${escapeHTML(book.bookName)}" class="book-img" loading="lazy" onerror="this.onerror=null;this.src='${defaultImage}';">
                   ${statusBadge}
               </div>
               <div class="book-info">
                   <h3 class="book-title">${escapeHTML(book.bookName)}</h3>
                   <p class="book-author">By ${escapeHTML(book.authorName)}</p>
                   <div class="book-meta">
                       <span><i class="fas fa-user"></i> ${escapeHTML(book.submittedByName || 'Anon')}</span>
                       <span><i class="fas fa-calendar-alt"></i> ${formatDate(book.submittedAt)}</span>
                   </div>
                   ${target === 'profile' && (book.status === 'pending' || book.status === 'rejected') ? `<div class="book-admin-info" style="font-style: italic; color: ${book.status === 'pending' ? 'var(--status-pending-bg, #f39c12)' : 'var(--status-rejected-bg, #e74c3c)'};"><i class="fas ${book.status === 'pending' ? 'fa-hourglass-half' : 'fa-times-circle'}"></i> Status: ${book.status.toUpperCase()}${book.status === 'rejected' && book.rejectionReason ? `<br>Reason: ${escapeHTML(book.rejectionReason)}` : ''}</div>` : ''}
                   <button class="action-btn view-btn" data-action="view" data-book-id="${book.id}" data-source="${dataSourceForButton}">
                       <span class="button-text-content"><i class="fas fa-eye"></i> View Details</span>
                   </button>
               </div>
           </div>`;
    }
}


function createPopularBookCardHTML(book) {
    const defaultImage = 'https://via.placeholder.com/160x200/333/888?text=No+Cover';
    const imageUrl = book.imageUrl || defaultImage;
    return `
       <div class="popular-book-card" data-action="view" data-book-id="${book.id}" data-source="books" data-aos="fade-left" style="animation-delay: ${Math.random() * 0.3}s">
           <div class="popular-book-img-container">
               <img src="${escapeHTML(imageUrl)}" alt="${escapeHTML(book.bookName)}" class="popular-book-img" loading="lazy" onerror="this.onerror=null;this.src='${defaultImage}';">
           </div>
           <div class="popular-book-info">
               <h4 class="popular-book-title">${escapeHTML(book.bookName)}</h4>
               <p class="popular-book-meta"><i class="fas fa-download"></i> ${book.downloads || 0}</p>
           </div>
       </div>`;
}

async function fetchBooksMain(loadMore = false) {
    if (!currentUser || isLoadingBooksMain || isUserDataLoading || (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified)) return;

    isLoadingBooksMain = true;
    if (loadMore) {
        if (elements.booksGridLoadingIndicator) elements.booksGridLoadingIndicator.style.display = 'block';
    } else {
        lastVisibleBookMain = null;
        hasMoreBooksMain = true;
        displayedBooksMain = [];
        if (elements.booksContainer) elements.booksContainer.innerHTML = '';
        renderSkeletonLoaders(elements.booksContainer, BOOKS_PER_PAGE_MAIN, 'book-main'); 
        if (elements.emptyStateBooks) elements.emptyStateBooks.style.display = 'none';
    }

    let query = db.collection('books').where('status', '==', 'approved');
    if (currentCategory !== 'All') {
        query = query.where('category', '==', currentCategory);
    }
    query = query.orderBy('approvedAt', 'desc').limit(BOOKS_PER_PAGE_MAIN);

    if (loadMore && lastVisibleBookMain) {
        query = query.startAfter(lastVisibleBookMain);
    }

    try {
        const snapshot = await query.get();
        if (!loadMore && elements.booksContainer) elements.booksContainer.innerHTML = ''; 

        const newBooks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        if (newBooks.length > 0) {
            newBooks.forEach(book => {
                displayedBooksMain.push(book);
                if (elements.booksContainer) elements.booksContainer.innerHTML += createBookCardHTML(book, 'main');
            });
            lastVisibleBookMain = snapshot.docs[snapshot.docs.length - 1];
        }

        hasMoreBooksMain = newBooks.length === BOOKS_PER_PAGE_MAIN;

        if (displayedBooksMain.length === 0 && !loadMore && elements.emptyStateBooks) {
            elements.emptyStateBooks.innerHTML = `<i class="fas fa-search-minus"></i><h3>No Books Found</h3><p>No books match the category '${escapeHTML(currentCategory)}'. Try 'All' or another category.</p>`;
            elements.emptyStateBooks.style.display = 'flex';
        } else if (elements.emptyStateBooks) {
            elements.emptyStateBooks.style.display = 'none';
        }
        AOS.refreshHard();

    } catch (error) {
        console.error(`Error fetching books for main grid (currentCategory: ${currentCategory}):`, error);
        if (error.code === 'failed-precondition') {
            console.error("Firestore 'failed-precondition' error. This often means a composite index is required. Check the Firebase console for a link to create it. Query details: status='approved', category='" + currentCategory + "', orderBy='approvedAt'.");
            showToast("Error loading books: A database configuration (index) might be missing. Please check server logs or contact support if you are an admin.", "error", 10000);
        } else {
            showToast("Could not load books. Please check your connection or try again later.", "error");
        }
        if (!loadMore && elements.emptyStateBooks) { 
            if (elements.booksContainer) elements.booksContainer.innerHTML = '';
            elements.emptyStateBooks.innerHTML = `<i class="fas fa-exclamation-triangle"></i><h3>Error Loading Books</h3><p>Please refresh or try again later.</p>`;
            elements.emptyStateBooks.style.display = 'flex';
        }
    } finally {
        isLoadingBooksMain = false;
        if (elements.booksGridLoadingIndicator) elements.booksGridLoadingIndicator.style.display = 'none';
    }
}

function setupAllBooksListenerForSearch() {
    if (!currentUser || isUserDataLoading || (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified)) {
        allBooksCache = [];
        if (listeners.allBooksSearch) listeners.allBooksSearch();
        listeners.allBooksSearch = null;
        return;
    }
    if (listeners.allBooksSearch) return;

    listeners.allBooksSearch = db.collection('books').where('status', '==', 'approved')
        .onSnapshot(snapshot => {
            allBooksCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            console.log("Search cache updated with approved books:", allBooksCache.length);
        }, error => {
            console.error("Error listening to all books for search:", error);
            showToast("Search functionality might be limited due to a network error.", "warning");
        });
}


function fetchPopularBooks() {
    if (!currentUser || isUserDataLoading || (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified)) {
        if (elements.popularBooksCarousel) elements.popularBooksCarousel.innerHTML = `<div class="empty-state" style="padding:20px 0;min-height:150px;width:100%;text-align:center;"><i class="fas fa-lock"></i><p style="font-size:0.9rem;">Login to see popular books.</p></div>`;
        return;
    }
    if (listeners.popularBooks) listeners.popularBooks();
    renderSkeletonLoaders(elements.popularBooksCarousel, 5, 'popular');

    listeners.popularBooks = db.collection('books').where('status', '==', 'approved')
        .orderBy('downloads', 'desc').orderBy('approvedAt', 'desc').limit(10)
        .onSnapshot(snapshot => {
            popularBooksData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (elements.popularBooksCarousel) elements.popularBooksCarousel.innerHTML = '';

            if (popularBooksData.length === 0) {
                if (elements.popularBooksCarousel) elements.popularBooksCarousel.innerHTML = `<div class="empty-state" style="padding:20px 0;min-height:150px;width:100%;text-align:center;"><i class="fas fa-sad-tear"></i><p style="font-size:0.9rem;">No popular books yet.</p></div>`;
            } else {
                popularBooksData.forEach(book => {
                    if (elements.popularBooksCarousel) elements.popularBooksCarousel.innerHTML += createPopularBookCardHTML(book);
                });
            }
            AOS.refreshHard();
        }, error => {
            console.error("Error fetching popular books:", error);
            showToast("Could not load popular books.", "error");
            if (elements.popularBooksCarousel) elements.popularBooksCarousel.innerHTML = `<div class="empty-state" style="padding:20px 0;min-height:150px;width:100%;text-align:center;"><i class="fas fa-exclamation-triangle"></i><p style="font-size:0.9rem;">Error loading.</p></div>`;
        });
}

function renderCategoryFilters() {
    if (!elements.categoryFilterContainer) return;
    elements.categoryFilterContainer.innerHTML = bookCategories.map(cat => `
       <button class="category-filter-item ${cat === currentCategory ? 'active' : ''}" data-category="${escapeHTML(cat)}">
           ${escapeHTML(cat)}
       </button>
   `).join('');
}

if (elements.categoryFilterContainer) {
    elements.categoryFilterContainer.addEventListener('click', (e) => {
        const target = e.target.closest('.category-filter-item');
        if (target && currentUser && !isUserDataLoading && ( (currentUser.providerData.some(p => p.providerId !== 'password')) || currentUser.emailVerified ) ) {
            currentCategory = target.dataset.category;
            $$('#categoryFilterContainer .category-filter-item').forEach(i => i.classList.remove('active'));
            target.classList.add('active');
            fetchBooksMain(false);
        } else if (!currentUser || isUserDataLoading || (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified)) {
            showToast("Please login and verify your email to browse categories.", "info");
            if(!currentUser) openModal(elements.loginModal);
            else if(!currentUser.emailVerified) openEmailVerificationModal(currentUser.email);
        }
    });
}

if (elements.imageUploadTabs) {
    elements.imageUploadTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            elements.imageUploadTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            const tabName = tab.dataset.tab;
            if (elements.uploadImageContent) elements.uploadImageContent.classList.toggle('active', tabName === 'uploadImage');
            if (elements.imageUrlContent) elements.imageUrlContent.classList.toggle('active', tabName === 'imageUrl');

            if (tabName === 'uploadImage') {
                if (elements.bookImageUrlInput) elements.bookImageUrlInput.value = '';
            } else {
                if (elements.bookCoverImageInput) elements.bookCoverImageInput.value = '';
                if (elements.bookCoverPreview) {
                    elements.bookCoverPreview.style.display = 'none';
                    elements.bookCoverPreview.src = '#';
                }
                tempBookCoverFile = null;
            }
        });
    });
}
if (elements.bookCoverImageInput) {
    elements.bookCoverImageInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            if (file.size > 2 * 1024 * 1024) { 
                showToast("Image too large. Max 2MB allowed.", "error");
                elements.bookCoverImageInput.value = '';
                return;
            }
            tempBookCoverFile = file;
            const reader = new FileReader();
            reader.onload = (event) => {
                if (elements.bookCoverPreview) {
                    elements.bookCoverPreview.src = event.target.result;
                    elements.bookCoverPreview.style.display = 'block';
                }
            }
            reader.readAsDataURL(file);
        }
    });
}

async function completeBookSubmissionAfterUpload(bookDataToSubmit, finalImageUrl, btn) {
    try {
        // This check is now mostly redundant due to changes in the submit handler, but good for safety.
        if (!finalImageUrl && bookDataToSubmit.isUploadTabActive) { 
             showToast("Cover image URL is missing after an attempt to upload. Please try again or provide a URL.", "error");
             if (elements.uploadProgressBarContainer) elements.uploadProgressBarContainer.style.display = 'none';
             toggleSpinner(btn, false); // Ensure spinner stops on this specific error path
             return;
        }
        
        const submissionData = { ...bookDataToSubmit, imageUrl: finalImageUrl };
        delete submissionData.isUploadTabActive;

        await db.collection('pending_books').add(submissionData);
        await db.collection('users').doc(currentUser.uid).update({
            booksSharedCount: firebase.firestore.FieldValue.increment(1)
        });
        await createNotification(currentUser.uid, "Book Submitted", `Your book "${escapeHTML(submissionData.bookName)}" has been submitted for approval.`, "info", null, "fas fa-upload");
        
        showToast("Book submitted for approval! You'll be notified.", "success");
        elements.addBookForm.reset();
        if (elements.bookCoverPreview) {
             elements.bookCoverPreview.style.display = 'none';
             elements.bookCoverPreview.src = '#';
        }
        tempBookCoverFile = null;
        if(elements.imageUploadTabs.length > 0) {
            elements.imageUploadTabs.forEach(t => t.classList.remove('active'));
            elements.imageUploadTabs[0].classList.add('active');
            if (elements.uploadImageContent) elements.uploadImageContent.classList.add('active');
            if (elements.imageUrlContent) elements.imageUrlContent.classList.remove('active');
        }
        closeModal(elements.addBookModal);
    } catch (error) {
        console.error("Error in completeBookSubmissionAfterUpload:", error);
        showToast("Failed to finalize book submission: " + error.message, "error", 7000);
    } finally {
        toggleSpinner(btn, false); // Final spinner stop
        if (elements.uploadProgressBarContainer) elements.uploadProgressBarContainer.style.display = 'none';
    }
}


elements.addBookForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser || !userData || isUserDataLoading) { showToast("Login to share books.", "error"); openModal(elements.loginModal); return; }
    if (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified) {
        showToast("Please verify your email before submitting a book.", "warning");
        openEmailVerificationModal(currentUser.email);
        return;
    }

    const bookName = $('#bookName').value.trim();
    const authorName = $('#authorName').value.trim();
    const category = $('#bookCategory').value.trim();
    const driveLink = $('#driveLink').value.trim();
    const description = $('#bookDescription').value.trim();
    let imageUrlFromInput = elements.bookImageUrlInput.value.trim();
    const isUploadTabActive = elements.uploadImageContent && elements.uploadImageContent.classList.contains('active');

    if (!bookName || !authorName || !category || !driveLink) {
        showToast("Please fill all required fields (Title, Author, Category, Drive Link).", "warning"); return;
    }
    if (isUploadTabActive && !tempBookCoverFile) {
        showToast("Please upload a cover image or switch to provide a URL.", "warning"); return;
    }
    if (!isUploadTabActive && !imageUrlFromInput) {
        showToast("Please provide a cover image URL or switch to upload an image.", "warning"); return;
    }
    if (!isUploadTabActive && imageUrlFromInput) {
        try { new URL(imageUrlFromInput); } catch (_) { showToast("Image URL must be a valid link.", "warning"); return; }
    }
    try { new URL(driveLink); } catch (_) { showToast("Drive link must be a valid link.", "warning"); return; }

    const btn = $('#submitBookBtn');
    toggleSpinner(btn, true, "Submitting");

    const bookDataToSubmit = {
        bookName, authorName, category, driveLink, description,
        submittedBy: currentUser.uid, submittedByName: userData.name || "Anonymous",
        submittedByUsername: userData.username || "anon_username",
        submittedAt: firebase.firestore.FieldValue.serverTimestamp(), status: "pending",
        downloads: 0, avgRating: 0, ratingCount: 0, approvedAt: null,
        reviewedAt: null, reviewedBy: null, reviewedByName: null, rejectionReason: '', adminNotes: '',
        isUploadTabActive: isUploadTabActive 
    };

    if (isUploadTabActive && tempBookCoverFile) {
        const coverStorageRef = storage.ref(`book_image/${Date.now()}_${tempBookCoverFile.name}`);
        const uploadTask = coverStorageRef.put(tempBookCoverFile);

        if (elements.uploadProgressBarContainer) elements.uploadProgressBarContainer.style.display = 'block';
        if (elements.uploadProgressBar) elements.uploadProgressBar.style.width = '0%';
        if (elements.uploadProgressText) elements.uploadProgressText.textContent = 'Initializing upload...';
        let startTime = Date.now();

        uploadTask.on('state_changed',
            (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                if(elements.uploadProgressBar) elements.uploadProgressBar.style.width = progress + '%';

                const elapsedTime = Math.max(0.1, (Date.now() - startTime) / 1000); // Ensure not zero, min 0.1s
                const uploadSpeed = snapshot.bytesTransferred / elapsedTime; // bytes/sec
                const remainingBytes = snapshot.totalBytes - snapshot.bytesTransferred;
                let estimatedTimeRemaining = "calculating...";
                
                if (uploadSpeed > 0 && remainingBytes > 0) {
                     estimatedTimeRemaining = `${Math.max(0, Math.round(remainingBytes / uploadSpeed))}s left`;
                } else if (remainingBytes === 0 && progress >= 99) { // Use >= 99 for almost complete
                    estimatedTimeRemaining = "finalizing...";
                }
                
                if(elements.uploadProgressText) {
                    elements.uploadProgressText.textContent = `Uploading Cover: ${progress.toFixed(0)}% (${estimatedTimeRemaining})`;
                }
            },
            (error) => {
                console.error("Upload failed:", error);
                if (elements.uploadProgressBarContainer) elements.uploadProgressBarContainer.style.display = 'none';
                showToast("Cover image upload failed: " + error.message, "error");
                toggleSpinner(btn, false); // Ensure spinner stops
            },
            async () => { // On successful completion
                try {
                    const finalImageUrl = await uploadTask.snapshot.ref.getDownloadURL();
                    if(elements.uploadProgressText) elements.uploadProgressText.textContent = 'Cover uploaded! Submitting book details...';
                    await completeBookSubmissionAfterUpload(bookDataToSubmit, finalImageUrl, btn); // btn passed here for spinner management
                } catch (completionError) {
                     console.error("Error after upload completion (getting URL or submitting):", completionError);
                     showToast("Error processing upload: " + completionError.message, "error");
                     if (elements.uploadProgressBarContainer) elements.uploadProgressBarContainer.style.display = 'none';
                     toggleSpinner(btn, false); // Ensure spinner stops
                }
            }
        );
    } else { // No image file to upload (using URL or no image at all if logic allows)
        await completeBookSubmissionAfterUpload(bookDataToSubmit, imageUrlFromInput || null, btn);
    }
});


function setupBookApprovalListeners() {
    if (!currentUser || isUserDataLoading) return;

    if (listeners.bookRejection) listeners.bookRejection();
    listeners.bookRejection = db.collection('pending_books')
        .where('submittedBy', '==', currentUser.uid)
        .onSnapshot(async (snapshot) => {
            for (const change of snapshot.docChanges()) {
                if (change.type === 'modified') {
                    const book = { id: change.doc.id, ...change.doc.data() };
                    const userRef = db.collection('users').doc(currentUser.uid);
                    try {
                        const userDoc = await userRef.get();
                        if (!userDoc.exists) continue;
                        const currentLocalUserData = userDoc.data();
                        const processedActions = currentLocalUserData.processedBookActions || {};

                        if (book.status === 'rejected' && (!processedActions[book.id] || !processedActions[book.id].rejection)) {
                            showToast(`Your submission "${escapeHTML(book.bookName)}" was rejected. Reason: ${escapeHTML(book.rejectionReason || 'Not specified')}.`, "warning", 7000);
                            await userRef.update({
                                [`processedBookActions.${book.id}.rejection`]: true
                            });
                            await createNotification(currentUser.uid, "Book Submission Update", `Your submission "${escapeHTML(book.bookName)}" was rejected. Reason: ${escapeHTML(book.rejectionReason || 'Not specified')}.`, "warning", null, "fas fa-times-circle");
                        }
                    } catch (e) {
                        console.error("Error processing book rejection for user:", currentUser.uid, "pending_book_id:", book.id, e);
                    }
                }
            }
        }, error => {
            console.error("Error in book rejection listener (pending_books):", error);
        });

    if (listeners.bookApproval) listeners.bookApproval();
    listeners.bookApproval = db.collection('books')
        .where('submittedBy', '==', currentUser.uid)
        .where('status', '==', 'approved')
        .onSnapshot(async (snapshot) => {
            for (const change of snapshot.docChanges()) {
                if (change.type === 'added' || (change.type === 'modified' && change.doc.data().status === 'approved')) { 
                    const book = { id: change.doc.id, ...change.doc.data() };
                    const userRef = db.collection('users').doc(currentUser.uid);
                    const approvalActionKey = book.id; 

                    try {
                        const userDoc = await userRef.get();
                        if (!userDoc.exists) continue;
                        const currentLocalUserData = userDoc.data(); 
                        const processedActions = currentLocalUserData.processedBookActions || {};

                        if (!processedActions[approvalActionKey] || !processedActions[approvalActionKey].approval) {
                            showToast(`Your book "${escapeHTML(book.bookName)}" has been approved! +${POINTS_FOR_BOOK_APPROVAL} points.`, "success", 7000);

                            const updates = {
                                points: firebase.firestore.FieldValue.increment(POINTS_FOR_BOOK_APPROVAL),
                                [`processedBookActions.${approvalActionKey}.approval`]: true
                            };
                            await userRef.update(updates);

                            await createNotification(currentUser.uid, "Book Approved!", `Your book "${escapeHTML(book.bookName)}" is now live.`, "success", `/#bookDetail/${book.id}`, "fas fa-book-reader");
                            await createNotification(currentUser.uid, "Points Awarded!", `You received +${POINTS_FOR_BOOK_APPROVAL} points for sharing "${escapeHTML(book.bookName)}".`, "success", null, "fas fa-coins");

                            if (currentLocalUserData.referredBy && currentLocalUserData.referredByCode) {
                                const referrerRef = db.collection('users').doc(currentLocalUserData.referredBy);
                                const commissionPoints = Math.ceil(POINTS_FOR_BOOK_APPROVAL * REFERRAL_COMMISSION_RATE);
                                if (commissionPoints > 0) {
                                    try {
                                        await referrerRef.update({
                                            points: firebase.firestore.FieldValue.increment(commissionPoints),
                                            pointsFromReferrals: firebase.firestore.FieldValue.increment(commissionPoints)
                                        });
                                        await createNotification(currentLocalUserData.referredBy, "Referral Bonus!", `You earned +${commissionPoints} points because your referral ${currentLocalUserData.name || currentLocalUserData.username} shared a book!`, "success", null, "fas fa-user-friends");
                                        console.log(`Awarded ${commissionPoints} commission points to referrer ${currentLocalUserData.referredBy}`);
                                    } catch (commissionError) {
                                        console.error("Error awarding commission points to referrer:", currentLocalUserData.referredBy, commissionError);
                                    }
                                }
                            }

                            if (elements.profilePage.classList.contains('active') && elements.profileBooksContainer) {
                                const activeTabBtn = elements.profileTabs.querySelector('.profile-tab-btn.active');
                                if (activeTabBtn && activeTabBtn.dataset.tab === 'shared-books') {
                                    fetchUserBooks(false, true); 
                                }
                            }
                        }
                    } catch (e) {
                        console.error("Error processing book approval for user:", currentUser.uid, "book_id:", book.id, e);
                    }
                }
            }
        }, error => {
            console.error("Error in book approval listener (books):", error);
        });
}


[elements.booksContainer, elements.profileBooksContainer, elements.popularBooksCarousel].forEach(container => {
    if (container) {
        container.addEventListener('click', async (e) => {
            const targetButton = e.target.closest('.action-btn[data-action="view"], .popular-book-card[data-action="view"], .book-img-container[data-action="view"]');
            if (!targetButton) return;

            if (!currentUser || !userData || isUserDataLoading || (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified)) { 
                showToast("Please login and verify email to view book details.", "info");
                if(!currentUser) openModal(elements.loginModal);
                else if(!currentUser.emailVerified) openEmailVerificationModal(currentUser.email);
                return;
             }

            const bookId = targetButton.dataset.bookId;
            const dataSource = targetButton.dataset.source || 'books';

            if (!bookId) { console.warn("Action requires bookId, but not found on target:", targetButton); return; }
            openBookDetailModal(bookId, dataSource);
        });
    }
});

function shouldShowTelegramPopup() {
    const ignoredDate = localStorage.getItem('ignoreTelegramPopupDate');
    const today = new Date().toISOString().split('T')[0];
    return ignoredDate !== today;
}

function showTelegramPopupIfEligible() {
    if (sessionStorage.getItem('justDownloadedBook') === 'true' && shouldShowTelegramPopup() && elements.telegramPopupModal) {
        openModal(elements.telegramPopupModal);
        sessionStorage.removeItem('justDownloadedBook'); 
    }
}
window.addEventListener('focus', showTelegramPopupIfEligible); 

if (elements.closeTelegramPopupModal) elements.closeTelegramPopupModal.onclick = () => closeModal(elements.telegramPopupModal);
if (elements.joinTelegramPopupBtn) elements.joinTelegramPopupBtn.onclick = () => {
    localStorage.setItem('ignoreTelegramPopupDate', new Date().toISOString().split('T')[0]); 
    closeModal(elements.telegramPopupModal);
};
if (elements.ignoreTelegramPopupBtn) elements.ignoreTelegramPopupBtn.onclick = () => {
    localStorage.setItem('ignoreTelegramPopupDate', new Date().toISOString().split('T')[0]);
    closeModal(elements.telegramPopupModal);
    showToast("Okay, we won't show this again today.", "info");
};


async function handleBookDownload(bookId, link, dataSource = 'books', fromModal = false, buttonElement = null) {
    if (!currentUser || !userData || isUserDataLoading || (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified) ) { 
        showToast("Please login and verify email to download.", "info");
        if(!currentUser) openModal(elements.loginModal);
        else if(!currentUser.emailVerified) openEmailVerificationModal(currentUser.email);
        return;
     }

    const btn = buttonElement || (fromModal ? $(`#bookDetailModal [data-action="download"][data-book-id="${bookId}"]`) : null);
    if (btn) toggleSpinner(btn, true, "Preparing");

    let bookOwnerIdForNotification = null;
    let bookNameForNotification = null;
    let bookDataForDownload = null;

    try {
        const userDocFresh = await db.collection('users').doc(currentUser.uid).get();
        if (!userDocFresh.exists) {
            throw new Error("User data not found. Please try again.");
        }
        const freshUserData = userDocFresh.data();

        const bookRef = db.collection(dataSource).doc(bookId);
        const bookDocSnapshot = await bookRef.get();
        if (!bookDocSnapshot.exists) throw new Error("Book details not found.");
        bookDataForDownload = bookDocSnapshot.data();

        bookOwnerIdForNotification = bookDataForDownload.submittedBy;
        bookNameForNotification = bookDataForDownload.bookName;

        const shouldChargeCredits = dataSource === 'books' && bookDataForDownload.submittedBy !== currentUser.uid;

        if (shouldChargeCredits && freshUserData.credits < BOOK_DOWNLOAD_COST) {
            showToast(`Need ${BOOK_DOWNLOAD_COST} credits. You have ${freshUserData.credits}. Earn more or claim daily bonus!`, "warning", 5000);
            openModal(elements.creditModal);
            if (btn) toggleSpinner(btn, false);
            return;
        }

        const userRef = db.collection('users').doc(currentUser.uid);

        await db.runTransaction(async (transaction) => {
            const userDoc = await transaction.get(userRef);
            const bookDocFromTransaction = await transaction.get(bookRef);
            let submitterDoc = null;

            if (dataSource === 'books' && bookOwnerIdForNotification && bookOwnerIdForNotification !== currentUser.uid) {
                const submitterRef = db.collection('users').doc(bookOwnerIdForNotification);
                submitterDoc = await transaction.get(submitterRef);
            }

            if (!userDoc.exists) throw new Error("User not found during transaction.");
            if (!bookDocFromTransaction.exists) throw new Error("Book not found during transaction.");

            if (shouldChargeCredits) {
                const currentCredits = userDoc.data().credits || 0;
                if (currentCredits < BOOK_DOWNLOAD_COST) {
                    throw new Error(`Insufficient credits. Need ${BOOK_DOWNLOAD_COST}, have ${currentCredits}. Please refresh.`);
                }
                transaction.update(userRef, {
                    credits: firebase.firestore.FieldValue.increment(-BOOK_DOWNLOAD_COST),
                    booksDownloadedCount: firebase.firestore.FieldValue.increment(1)
                });
            } else {
                 transaction.update(userRef, {
                    booksDownloadedCount: firebase.firestore.FieldValue.increment(1)
                });
            }


            if (dataSource === 'books') { 
                transaction.update(bookRef, { downloads: firebase.firestore.FieldValue.increment(1) });
            }

            if (dataSource === 'books' && bookOwnerIdForNotification && bookOwnerIdForNotification !== currentUser.uid) {
                if (submitterDoc && submitterDoc.exists) {
                    transaction.update(submitterDoc.ref, {
                        points: firebase.firestore.FieldValue.increment(1),
                        totalBookDownloads: firebase.firestore.FieldValue.increment(1)
                    });
                } else {
                    console.warn(`Submitter user document ${bookOwnerIdForNotification} not found for points. (Transaction)`);
                }
            }
        });

        window.open(link, '_blank');
        sessionStorage.setItem('justDownloadedBook', 'true');

        if (shouldChargeCredits) {
            showToast(`-${BOOK_DOWNLOAD_COST} credits. Opening download...`, "info", 3000);
        } else {
            showToast(`Opening download... ${dataSource === 'books' && bookDataForDownload.submittedBy === currentUser.uid ? '(This is your approved book, no credits deducted)' : (dataSource === 'pending_books' ? '(This is your pending submission, no credits deducted for test)' : '') }`, "info", 3000);
        }

        if (userData && shouldChargeCredits) {
            userData.credits = (userData.credits || 0) - BOOK_DOWNLOAD_COST;
            updateHeaderCredits();
        }

        if (dataSource === 'books' && bookOwnerIdForNotification && bookOwnerIdForNotification !== currentUser.uid && bookNameForNotification) {
            const ownerExists = (await db.collection('users').doc(bookOwnerIdForNotification).get()).exists;
            if (ownerExists) {
                await createNotification(bookOwnerIdForNotification, "Book Downloaded", `Your book "${escapeHTML(bookNameForNotification)}" was downloaded! +1 point.`, "info", `/#bookDetail/${bookId}`, "fas fa-arrow-down");
            } else {
                console.warn(`Submitter user document ${bookOwnerIdForNotification} not found for notification.`);
            }
        }
        
        setTimeout(showTelegramPopupIfEligible, 1000);

    } catch (error) {
        console.error("Error during download process:", error);
        showToast(`Download failed: ${error.message || 'Please try again.'}`, "error");
    } finally {
        if (btn) toggleSpinner(btn, false);
    }
}

function fetchUserBooks(loadMore = false, forceRefresh = false) {
    if (!currentUser || (isFetchingMoreUserBooks && !forceRefresh) || isUserDataLoading) return;
    if (forceRefresh) {
        lastUserBookSnapshot = null; hasMoreUserBooks = true;
        if (elements.profileBooksContainer) elements.profileBooksContainer.innerHTML = '';
        if (elements.emptyProfileBooks) elements.emptyProfileBooks.style.display = 'none';
    }
    if (!hasMoreUserBooks && loadMore) {
        const loadMoreBtnEl = elements.loadMoreBooksBtn;
        if (loadMoreBtnEl && loadMoreBtnEl.classList.contains('loading')) toggleSpinner(loadMoreBtnEl, false); // Use new spinner toggle for Load More
        return;
    }

    isFetchingMoreUserBooks = true;
    if (loadMore && elements.loadMoreBooksBtn) {
         toggleSpinner(elements.loadMoreBooksBtn, true, "Loading More"); // Use new spinner toggle
    } else if (!forceRefresh && elements.profileBooksContainer && !elements.profileBooksContainer.querySelector('.book-card')) {
        renderSkeletonLoaders(elements.profileBooksContainer, USER_SUBMISSIONS_PER_PAGE, 'book');
    }

    let query = db.collection('pending_books').where('submittedBy', '==', currentUser.uid)
        .orderBy('submittedAt', 'desc').limit(USER_SUBMISSIONS_PER_PAGE);
    if (loadMore && lastUserBookSnapshot) { query = query.startAfter(lastUserBookSnapshot); }

    if (listeners.userBooks) listeners.userBooks();
    listeners.userBooks = query.onSnapshot(snapshot => {
        if (!loadMore && !forceRefresh && snapshot.metadata.hasPendingWrites && !snapshot.empty) return;

        if (!loadMore && elements.profileBooksContainer) elements.profileBooksContainer.innerHTML = ''; 

        if (snapshot.empty && (!elements.profileBooksContainer || elements.profileBooksContainer.innerHTML === '')) {
            if (elements.emptyProfileBooks) elements.emptyProfileBooks.style.display = 'flex';
            hasMoreUserBooks = false;
        } else {
            if (elements.emptyProfileBooks) elements.emptyProfileBooks.style.display = 'none';
            snapshot.docs.forEach(doc => {
                const existingCard = elements.profileBooksContainer ? elements.profileBooksContainer.querySelector(`.book-card[data-id="${doc.id}"]`) : null;
                if (!existingCard && elements.profileBooksContainer) {
                    elements.profileBooksContainer.innerHTML += createBookCardHTML({ id: doc.id, ...doc.data() }, 'profile');
                } else if (existingCard && elements.profileBooksContainer) { 
                    existingCard.outerHTML = createBookCardHTML({ id: doc.id, ...doc.data() }, 'profile');
                }
            });
            lastUserBookSnapshot = snapshot.docs.length > 0 ? snapshot.docs[snapshot.docs.length - 1] : null;
            hasMoreUserBooks = snapshot.docs.length === USER_SUBMISSIONS_PER_PAGE;
        }

        if (elements.loadMoreBooksBtn) {
            elements.loadMoreBooksBtn.style.display = hasMoreUserBooks ? 'inline-flex' : 'none';
             if(elements.loadMoreBooksBtn.classList.contains('loading')) { // Check if loading spinner needs to be stopped
                 toggleSpinner(elements.loadMoreBooksBtn, false); // Stop new spinner for Load More
             }
        }
        isFetchingMoreUserBooks = false;
        AOS.refreshHard();
    }, error => {
        console.error("Error fetching user submissions (from pending_books):", error);
        showToast("Could not load your submissions.", "error");
        if (loadMore && elements.loadMoreBooksBtn && elements.loadMoreBooksBtn.classList.contains('loading')) {
            toggleSpinner(elements.loadMoreBooksBtn, false); // Stop new spinner
        }
        isFetchingMoreUserBooks = false;
        if (elements.emptyProfileBooks && elements.profileBooksContainer) {
            elements.profileBooksContainer.innerHTML = '';
            elements.emptyProfileBooks.style.display = 'flex';
        }
    });
}


if (elements.loadMoreBooksBtn) elements.loadMoreBooksBtn.addEventListener('click', () => fetchUserBooks(true));

function enableWithdrawalIfQualified() {
    const btn = elements.withdrawBtnLarge;
    if (btn && userData && !isUserDataLoading) { btn.disabled = !(userData.points >= 500); }
    else if(btn) { btn.disabled = true; }
}

if (elements.withdrawBtnLarge) {
    elements.withdrawBtnLarge.onclick = () => {
        if (userData && !isUserDataLoading && userData.points >= 500 && currentUser.emailVerified) {
            if (!userData.hasSetPin) {
                showToast("Please set up your Withdrawal PIN first.", "info");
                openPinManagementModal('setup');
                return;
            }
            elements.withdrawalModalPoints.textContent = userData.points || 0;
            selectedWithdrawalMethod = null; selectedWithdrawalAmount = null; selectedWithdrawalRs = null;
            $$('#withdrawalModal .withdrawal-option, #withdrawalModal .amount-option').forEach(o => o.classList.remove('active'));
            if (elements.paymentDetails) elements.paymentDetails.classList.remove('active');
            if (elements.withdrawalForm) elements.withdrawalForm.reset();
            updatePaymentDetailsUI();
            openModal(elements.withdrawalModal);
        } else if (userData && !isUserDataLoading && !currentUser.emailVerified) {
            showToast("Please verify your email to use the withdrawal feature.", "warning");
            openEmailVerificationModal(currentUser.email);
        } else if (userData && !isUserDataLoading) {
            showToast(`You need at least 500 points to withdraw. Your balance: ${userData?.points || 0}`, "warning");
        } else {
             showToast("Please login or wait for data to load.", "info");
             if (!currentUser) openModal(elements.loginModal);
        }
    };
}
if (elements.closeWithdrawalModal) elements.closeWithdrawalModal.onclick = () => closeModal(elements.withdrawalModal);

function setupWithdrawalListeners() {
    if (elements.withdrawalOptionsContainer) {
        elements.withdrawalOptionsContainer.addEventListener('click', (e) => {
            const option = e.target.closest('.withdrawal-option');
            if (!option) return;
            $$('#withdrawalModal .withdrawal-option').forEach(o => o.classList.remove('active'));
            option.classList.add('active');
            selectedWithdrawalMethod = option.dataset.method;
            updatePaymentDetailsUI();
            if (selectedWithdrawalAmount && elements.paymentDetails) elements.paymentDetails.classList.add('active');
        });
    }
    if (elements.amountOptionsContainer) {
        elements.amountOptionsContainer.addEventListener('click', (e) => {
            const option = e.target.closest('.amount-option');
            if (!option) return;
            const amt = parseInt(option.dataset.amount);
            if (userData && !isUserDataLoading && userData.points >= amt) {
                $$('#withdrawalModal .amount-option').forEach(o => o.classList.remove('active'));
                option.classList.add('active');
                selectedWithdrawalAmount = amt;
                selectedWithdrawalRs = parseInt(option.dataset.rs);
                if (selectedWithdrawalMethod && elements.paymentDetails) elements.paymentDetails.classList.add('active');
            } else if (userData && !isUserDataLoading) { showToast(`Need ${amt} pts. Your balance: ${userData?.points || 0}`, "warning");
            } else {
                 showToast("Please login or wait for data to load.", "info");
            }
        });
    }
}
function updatePaymentDetailsUI() {
    if (!selectedWithdrawalMethod || !elements.paymentDetails) { if (elements.paymentDetails) elements.paymentDetails.classList.remove('active'); return; }
    const paymentIdLabel = elements.paymentMethodLabel;
    const paymentIdField = elements.paymentIdInput;
    const accountNameFieldGroup = elements.accountNameGroup;
    const accountNameField = elements.accountNameInput;

    if (!paymentIdLabel || !paymentIdField || !accountNameFieldGroup || !accountNameField) return;

    paymentIdField.placeholder = "Enter details";
    accountNameFieldGroup.style.display = 'none';
    accountNameField.required = false;

    if (selectedWithdrawalMethod === 'upi') { paymentIdLabel.textContent = 'UPI ID *'; paymentIdField.placeholder = 'yourname@okbank'; }
    else if (selectedWithdrawalMethod === 'redeem') { paymentIdLabel.textContent = 'Email for Redeem Code *'; paymentIdField.placeholder = 'your.email@example.com'; }
    else if (selectedWithdrawalMethod === 'bank') { paymentIdLabel.textContent = 'Account Number *'; paymentIdField.placeholder = 'Enter Account Number'; accountNameFieldGroup.style.display = 'block'; accountNameField.required = true; }
    else if (selectedWithdrawalMethod === 'paytm' || selectedWithdrawalMethod === 'phonepe') { paymentIdLabel.textContent = `${selectedWithdrawalMethod.charAt(0).toUpperCase() + selectedWithdrawalMethod.slice(1)} Number *`; paymentIdField.placeholder = 'Enter registered mobile number'; }
}

if (elements.withdrawalForm) {
    elements.withdrawalForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentUser || !userData || !selectedWithdrawalMethod || !selectedWithdrawalAmount || isUserDataLoading) { showToast("Please select method and amount or wait for data to load.", "warning"); return; }
        if (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified) {
            showToast("Please verify your email before proceeding with withdrawal.", "warning");
            openEmailVerificationModal(currentUser.email);
            return;
        }
        if (userData.points < selectedWithdrawalAmount) { showToast("Insufficient points for selected amount.", "error"); return; }

        const paymentIdValue = elements.paymentIdInput.value.trim();
        const accountNameValue = elements.accountNameInput.value.trim();

        if (!paymentIdValue || (elements.accountNameGroup.style.display === 'block' && !accountNameValue)) { showToast("Please fill all required payment details.", "warning"); return; }

        withdrawalDataForPinEntry = {
            userId: currentUser.uid, userName: userData.name || "N/A", userEmail: userData.email,
            pointsWithdrawn: selectedWithdrawalAmount, amountRs: selectedWithdrawalRs, method: selectedWithdrawalMethod,
            paymentIdentifier: paymentIdValue, accountHolderName: (selectedWithdrawalMethod === 'bank' && accountNameValue) ? accountNameValue : null,
            status: 'pending', requestedAt: firebase.firestore.FieldValue.serverTimestamp(),
            processedAt: null, adminNotes: ''
        };

        closeModal(elements.withdrawalModal);
        openPinManagementModal('entry');
    });
}

async function submitWithdrawalRequestWithPin() {
    if (!withdrawalDataForPinEntry || isUserDataLoading) {
        showToast("Withdrawal data missing or user data loading. Please try again.", "error");
        return;
    }
    const btn = elements.submitPinManagementBtn;
    toggleSpinner(btn, true, "Processing");
    try {
        const userRef = db.collection('users').doc(currentUser.uid);
        await db.runTransaction(async (transaction) => {
            const userDoc = await transaction.get(userRef);
            if (!userDoc.exists) throw new Error("User not found.");
            const currentPoints = userDoc.data().points || 0;
            if (currentPoints < withdrawalDataForPinEntry.pointsWithdrawn) { throw new Error("Insufficient points. Please refresh."); }
            transaction.update(userRef, { points: firebase.firestore.FieldValue.increment(-withdrawalDataForPinEntry.pointsWithdrawn) });
            const withdrawalRef = db.collection('withdrawals').doc();
            transaction.set(withdrawalRef, withdrawalDataForPinEntry);
        });
        await createNotification(currentUser.uid, "Withdrawal Request Submitted", `Your request to withdraw ${withdrawalDataForPinEntry.pointsWithdrawn} points (₹${withdrawalDataForPinEntry.amountRs}) is pending.`, "info", null, "fas fa-hourglass-half");
        showToast("Withdrawal request submitted successfully!", "success");
        if(elements.withdrawalForm) elements.withdrawalForm.reset();
    } catch (error) {
        console.error("Error submitting withdrawal:", error);
        showToast(`Failed to submit request: ${error.message}`, "error");
    } finally {
        toggleSpinner(btn, false);
        closeModal(elements.pinManagementModal);
        withdrawalDataForPinEntry = null;
    }
}


function fetchWithdrawalHistory() {
    if (!currentUser || listeners.withdrawals || isUserDataLoading) return;
    if (!elements.withdrawalHistoryContainer || !elements.emptyWithdrawalHistory) return;

    renderSkeletonLoaders(elements.withdrawalHistoryContainer, 3, 'history');
    elements.emptyWithdrawalHistory.style.display = 'none';

    listeners.withdrawals = db.collection('withdrawals').where('userId', '==', currentUser.uid)
        .orderBy('requestedAt', 'desc').limit(10)
        .onSnapshot(snapshot => {
            elements.withdrawalHistoryContainer.innerHTML = '';
            if (snapshot.empty) { elements.emptyWithdrawalHistory.style.display = 'flex'; }
            else {
                elements.emptyWithdrawalHistory.style.display = 'none';
                snapshot.forEach(doc => {
                    const item = doc.data();
                    elements.withdrawalHistoryContainer.innerHTML += `
                       <div class="withdrawal-item" data-aos="fade-up" style="animation-delay: ${Math.random() * 0.2}s">
                           <div class="withdrawal-info">
                               <div class="withdrawal-amount">${item.pointsWithdrawn} pts (₹${item.amountRs})</div>
                               <div class="withdrawal-method">Method: ${escapeHTML(item.method.toUpperCase())} | ID: ${escapeHTML(item.paymentIdentifier)}</div>
                               <div class="withdrawal-date">Requested: ${formatDate(item.requestedAt)} ${formatTime(item.requestedAt)}</div>
                               ${item.status !== 'pending' && item.processedAt ? `<div class="withdrawal-date" style="font-style:italic;">Processed: ${formatDate(item.processedAt)} ${formatTime(item.processedAt)}</div>` : ''}
                               ${item.adminNotes ? `<div class="withdrawal-date" style="color:var(--primary-light);">Note: ${escapeHTML(item.adminNotes)}</div>` : ''}
                           </div>
                           <div class="withdrawal-status status-${item.status.toLowerCase()}">${escapeHTML(item.status)}</div>
                       </div>`;
                });
            }
            AOS.refreshHard();
        }, error => {
            console.error("Error fetching withdrawal history:", error);
            showToast("Could not load withdrawal history.", "error");
            elements.withdrawalHistoryContainer.innerHTML = '';
            elements.emptyWithdrawalHistory.style.display = 'flex';
        });
}

async function handleDailyCreditClaim() {
    if (!currentUser || !userData || isUserDataLoading) { showToast("Please login to claim credits.", "info"); openModal(elements.loginModal); return; }
    const btn = elements.claimDailyCreditBtn;
    if (btn) toggleSpinner(btn, true, "Claiming");

    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (!userDoc.exists) throw new Error("User data not found.");
        const freshUserData = userDoc.data();

        const today = new Date().toISOString().split('T')[0];
        if (freshUserData.lastDailyCreditClaim === today) {
            showToast("You've already claimed your daily bonus today!", "warning");
            if (btn) toggleSpinner(btn, false); return;
        }

        const creditsToAward = 20;
        await db.collection('users').doc(currentUser.uid).update({
            credits: firebase.firestore.FieldValue.increment(creditsToAward),
            lastDailyCreditClaim: today
        });
        await createNotification(currentUser.uid, "Daily Bonus Claimed!", `You received +${creditsToAward} daily credits. Come back tomorrow!`, "success", null, "fas fa-gift");
        showToast(`+${creditsToAward} daily credits claimed! Come back tomorrow.`, "success");
    } catch (error) {
        console.error("Error claiming daily credit:", error);
        showToast("Failed to claim daily credit. " + error.message, "error");
    } finally {
        if (btn) toggleSpinner(btn, false);
    }
}

if (elements.headerCreditsContainer) elements.headerCreditsContainer.onclick = () => {
    if (!currentUser || isUserDataLoading || (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified)) { 
        showToast("Please login and verify email to manage credits.", "info");
        if(!currentUser) openModal(elements.loginModal);
        else if(!currentUser.emailVerified) openEmailVerificationModal(currentUser.email);
        return;
     }
    if (elements.creditModalUserCredits) elements.creditModalUserCredits.innerHTML = `${userData?.credits || 0} <i class="fas fa-coins" style="color: var(--credit-color);"></i>`;
    openModal(elements.creditModal);
};
if (elements.closeCreditModal) elements.closeCreditModal.onclick = () => closeModal(elements.creditModal);

if (elements.conductSurveyBtn) elements.conductSurveyBtn.onclick = () => {
    if (!currentUser || isUserDataLoading || (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified) ) {
        showToast("Please login and verify email to earn credits.", "info");
        if(!currentUser) openModal(elements.loginModal);
        else if(!currentUser.emailVerified) openEmailVerificationModal(currentUser.email);
        return;
     }
    showToast("Redirecting to earn credits...", "info");
    window.location.href = '/advertisement'; 
    createNotification(currentUser.uid, "Attempted Credit Boost", "You clicked the link to earn credits. Checking eligibility...", "info", null, "fas fa-external-link-alt");
    closeModal(elements.creditModal);
};

async function openBookDetailModal(bookId, dataSource = 'books') {
    if (!bookId) { console.warn("openBookDetailModal called without bookId"); return; }
    if (!currentUser || isUserDataLoading || (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified)) { 
        showToast("Please login and verify email to view details.", "info");
        if(!currentUser) openModal(elements.loginModal);
        else if(!currentUser.emailVerified) openEmailVerificationModal(currentUser.email);
        return;
    }

    currentBookDetailId = bookId;
    openModal(elements.bookDetailModal);
    if (elements.bookDetailContent) elements.bookDetailContent.innerHTML = `<div style="text-align:center; padding: 50px 0;"><div class="spinner" style="width: 30px; height: 30px; border-width: 4px;"></div><p style="margin-top: 15px; color: var(--text-muted);">Loading details...</p></div>`;

    try {
        const bookDoc = await db.collection(dataSource).doc(bookId).get();
        if (!bookDoc.exists) {
            showToast("Book details not found.", "error");
            closeModal(elements.bookDetailModal);
            currentBookDetailId = null;
            return;
        }

        const bookData = { id: bookDoc.id, ...bookDoc.data() };
        const isOwnedByCurrentUser = bookData.submittedBy === currentUser?.uid;

        if (dataSource === 'pending_books' && !isOwnedByCurrentUser) {
            showToast("This submission is not yet available.", "error");
            closeModal(elements.bookDetailModal);
            currentBookDetailId = null;
            return;
        }
        if (dataSource === 'books' && bookData.status !== 'approved') {
            showToast("This book is not yet approved or available.", "error");
            closeModal(elements.bookDetailModal);
            currentBookDetailId = null;
            return;
        }

        renderBookDetailContent(bookData, dataSource);
        if (dataSource === 'books' && bookData.status === 'approved') {
            loadFeedbackComments(bookId);
        }
    } catch (error) {
        console.error("Error fetching book details:", error);
        showToast("Failed to load book details.", "error");
        if (elements.bookDetailContent) elements.bookDetailContent.innerHTML = `<p style="color: var(--text-muted); text-align: center; padding: 30px;">Could not load details. Please try again.</p>`;
    }
}

function renderBookDetailContent(book, dataSource = 'books') {
    if (!elements.bookDetailContent) return;
    const defaultImage = 'https://via.placeholder.com/200x280/333/888?text=No+Cover';
    const imageUrl = book.imageUrl || defaultImage;
    const isOwner = book.submittedBy === currentUser?.uid;
    const isApproved = book.status === 'approved' && dataSource === 'books';

    let statusDisplayHTML = '';
    if (isOwner && dataSource === 'pending_books' && (book.status === 'pending' || book.status === 'rejected')) {
        statusDisplayHTML = `<p style="text-align:center; padding:10px; background-color: var(--card-bg-dark); border-radius: var(--border-radius-sm); margin-bottom:15px; color: ${book.status === 'pending' ? 'var(--status-pending-bg, #f39c12)' : 'var(--status-rejected-bg, #e74c3c)'};">This submission is currently: <strong>${book.status.toUpperCase()}</strong>${book.status === 'rejected' && book.rejectionReason ? `<br>Reason: ${escapeHTML(book.rejectionReason)}` : ''}</p>`;
    }

    const downloadButtonText = isApproved
        ? (isOwner ? 'Free - Your Book' : `${BOOK_DOWNLOAD_COST} <i class="fas fa-coins" style="color:var(--credit-color);font-size:0.8em;"></i>`)
        : 'Unavailable';

    elements.bookDetailContent.innerHTML = `
       <div class="book-detail-layout">
           <div class="book-detail-image">
               <img src="${escapeHTML(imageUrl)}" alt="${escapeHTML(book.bookName)}" onerror="this.onerror=null;this.src='${defaultImage}';">
           </div>
           <div class="book-detail-info">
               ${statusDisplayHTML}
               <h2 class="book-detail-title">${escapeHTML(book.bookName)}</h2>
               <p class="book-detail-author">By ${escapeHTML(book.authorName)}</p>
               <span class="book-detail-category">${escapeHTML(book.category || 'Uncategorized')}</span>
               <div class="book-detail-meta">
                   <span><i class="fas fa-download"></i> <span id="detailDownloadCount">${book.downloads || 0}</span> Downloads</span>
                   <span><i class="fas fa-user"></i> Shared by ${escapeHTML(book.submittedByName || 'Anon')}</span>
                   ${book.avgRating > 0 && isApproved ? `<span><i class="fas fa-star" style="color:var(--star-color);"></i> ${book.avgRating.toFixed(1)} (${book.ratingCount || 0} ratings)</span>` : (isApproved ? '<span><i class="far fa-star" style="color:var(--star-color);"></i> No ratings yet</span>' : '')}
               </div>
               ${book.description ? `<div class="book-detail-description">${escapeHTML(book.description)}</div>` : '<p class="book-detail-description">No description available for this book.</p>'}
               <div class="book-detail-actions">
                   ${(dataSource === 'books' && isApproved) || (dataSource === 'pending_books' && isOwner && book.status === 'pending') ? `
                   <button class="action-btn detail-download-btn" data-action="download" data-link="${escapeHTML(book.driveLink)}" data-book-id="${book.id}" data-source="${dataSource}">
                       <span class="button-text-content"><i class="fas fa-download"></i>
                           ${dataSource === 'books' && isApproved ? `Download (${downloadButtonText})` : (isOwner && dataSource === 'pending_books' ? 'Test Download Link (Free)' : 'Unavailable')}
                       </span>
                   </button>
                   ` : (isOwner && dataSource === 'pending_books' && book.status === 'rejected' ? `<p style="font-style:italic; color:var(--text-muted);">Download unavailable for rejected submission.</p>` : `<p style="font-style:italic; color:var(--text-muted);">Download will be available once approved.</p>`)}
               </div>
           </div>
       </div>
       ${isApproved ? `
       <div class="feedback-separator"></div>
       <div class="feedback-section">
           <h3 class="feedback-title">Rate this Book</h3>
           <form id="feedbackForm">
               <div class="rating-stars">
                   <label>Your Rating:</label>
                   <div class="stars" id="feedbackStars">
                       <i class="far fa-star" data-value="1" title="Terrible"></i><i class="far fa-star" data-value="2" title="Poor"></i><i class="far fa-star" data-value="3" title="Average"></i><i class="far fa-star" data-value="4" title="Good"></i><i class="far fa-star" data-value="5" title="Excellent"></i>
                   </div>
                   <input type="hidden" id="feedbackRating" value="0">
               </div>
               <div class="form-group">
                   <label for="feedbackComment" class="form-label">Your Feedback (Optional):</label>
                   <textarea id="feedbackComment" class="form-textarea" placeholder="Share your thoughts..." rows="3"></textarea>
               </div>
               <button type="submit" class="submit-btn" id="submitFeedbackBtn"><span class="button-text-content">Submit Feedback</span></button>
           </form>
           <h3 class="feedback-title" style="margin-top: 30px;">Comments</h3>
           <div class="comments-list" id="commentsList"><div class="no-comments">Loading comments...</div></div>
       </div>
       ` : (isOwner && dataSource === 'pending_books' ? `<div class="feedback-separator"></div><p style="text-align:center; color:var(--text-muted); margin-top:20px;">Feedback section will be available once approved.</p>` : '')}
   `;
    if (isApproved) {
        addDetailModalListeners(book.id, dataSource);
    } else if (dataSource === 'pending_books' && isOwner) { // For pending submissions by the current user
        const downloadBtn = elements.bookDetailContent.querySelector('.detail-download-btn');
        if (downloadBtn) {
            downloadBtn.addEventListener('click', () => {
                 if (!currentUser || !userData || isUserDataLoading) { openModal(elements.loginModal); return; }
                handleBookDownload(book.id, downloadBtn.dataset.link, dataSource, true, downloadBtn);
            });
        }
    }
}

function addDetailModalListeners(bookId, dataSource = 'books') {
    const downloadBtn = elements.bookDetailContent.querySelector('.detail-download-btn');
    if (downloadBtn && dataSource === 'books') { // Only allow download for approved books from 'books' collection
        downloadBtn.addEventListener('click', () => {
            if (!currentUser || !userData || isUserDataLoading) { openModal(elements.loginModal); return; }
            handleBookDownload(bookId, downloadBtn.dataset.link, dataSource, true, downloadBtn);
        });
    }
    const starsContainer = $('#feedbackStars');
    const ratingInput = $('#feedbackRating');
    if (starsContainer && ratingInput) {
        const stars = starsContainer.querySelectorAll('i');
        stars.forEach(star => {
            star.addEventListener('mouseover', () => highlightStars(stars, parseInt(star.dataset.value), true));
            star.addEventListener('mouseout', () => highlightStars(stars, parseInt(ratingInput.value), false));
            star.addEventListener('click', () => { ratingInput.value = star.dataset.value; highlightStars(stars, parseInt(ratingInput.value), false); });
        });
    }
    const feedbackForm = $('#feedbackForm');
    if (feedbackForm) feedbackForm.addEventListener('submit', (e) => handleFeedbackSubmit(e, bookId));
}

function highlightStars(starsNodeList, rating, isHovering) {
    starsNodeList.forEach(s => {
        const starValue = parseInt(s.dataset.value);
        s.classList.remove('fas', 'far', 'selected', 'hovered');
        if (starValue <= rating) {
            s.classList.add('fas');
            if (!isHovering) s.classList.add('selected');
            if (isHovering) s.classList.add('hovered');
        } else {
            s.classList.add('far');
        }
    });
}

async function handleFeedbackSubmit(event, bookId) {
    event.preventDefault();
    if (!currentUser || !userData || !bookId || isUserDataLoading) { 
        showToast("Please login to submit feedback.", "info"); 
        if (!currentUser) openModal(elements.loginModal); return; 
    }
    if (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified) {
        showToast("Please verify your email before submitting feedback.", "warning");
        openEmailVerificationModal(currentUser.email);
        return;
    }

    const rating = parseInt($('#feedbackRating').value);
    const comment = $('#feedbackComment').value.trim();

    if (rating === 0) { showToast("Please select a star rating to submit feedback.", "warning"); return; }

    const btn = $('#submitFeedbackBtn');
    toggleSpinner(btn, true, "Submitting");

    const feedbackData = {
        userId: currentUser.uid,
        userName: userData.name || "Anonymous",
        userAvatarInitials: getInitials(userData.name || "Anonymous"),
        profilePictureURL: userData.profilePictureURL || null,
        rating: rating,
        comment: comment,
        submittedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        await db.collection('books').doc(bookId).collection('feedback').add(feedbackData);
        const bookRef = db.collection('books').doc(bookId);
        const userRef = db.collection('users').doc(currentUser.uid);

        await db.runTransaction(async (transaction) => {
            const bookDoc = await transaction.get(bookRef);
            const userDoc = await transaction.get(userRef);
            if (!bookDoc.exists) throw new Error("Book not found for rating update.");
            if (!userDoc.exists) throw new Error("User data not found for stat update.");

            const currentRatingCount = bookDoc.data().ratingCount || 0;
            const currentAvgRating = bookDoc.data().avgRating || 0;
            const newRatingCount = currentRatingCount + 1;
            const newAvgRating = ((currentAvgRating * currentRatingCount) + rating) / newRatingCount;

            transaction.update(bookRef, { ratingCount: newRatingCount, avgRating: newAvgRating });
            transaction.update(userRef, { totalFeedbackGiven: firebase.firestore.FieldValue.increment(1) });
        });

        const bookSnapshot = await bookRef.get();
        const bookNameForNotif = bookSnapshot.exists ? bookSnapshot.data().bookName : "this book";
        await createNotification(currentUser.uid, "Feedback Submitted", `Your feedback for "${escapeHTML(bookNameForNotif)}" has been recorded.`, "success", `/#bookDetail/${bookId}`, "fas fa-comment-dots");

        showToast("Thank you! Your feedback has been submitted.", "success");
        if ($('#feedbackForm')) $('#feedbackForm').reset();
        if ($('#feedbackRating')) $('#feedbackRating').value = 0;
        if ($$('#feedbackStars i').length > 0) highlightStars($$('#feedbackStars i'), 0, false);
        loadFeedbackComments(bookId);

        const bookDocAfterRating = await db.collection('books').doc(bookId).get();
        if (bookDocAfterRating.exists && elements.bookDetailContent) {
            const updatedBookData = bookDocAfterRating.data();
            const avgRatingSpan = elements.bookDetailContent.querySelector('.book-detail-meta span:nth-child(3)');
            if (avgRatingSpan && avgRatingSpan.querySelector('.fa-star, .far.fa-star')) {
                avgRatingSpan.innerHTML = `<i class="fas fa-star" style="color:var(--star-color);"></i> ${updatedBookData.avgRating.toFixed(1)} (${updatedBookData.ratingCount || 0} ratings)`;
            }
            const downloadCountSpan = elements.bookDetailContent.querySelector('#detailDownloadCount');
            if (downloadCountSpan) downloadCountSpan.textContent = updatedBookData.downloads || 0;
        }

    } catch (error) {
        console.error("Error submitting feedback:", error);
        showToast("Failed to submit feedback. " + error.message, "error");
    } finally {
        toggleSpinner(btn, false);
    }
}

async function loadFeedbackComments(bookId) {
    const commentsList = $('#commentsList');
    if (!commentsList) return;
    commentsList.innerHTML = '<div class="no-comments" style="padding: 20px 0;">Loading comments...</div>';

    try {
        const snapshot = await db.collection('books').doc(bookId).collection('feedback')
            .orderBy('submittedAt', 'desc').limit(15).get();
        if (snapshot.empty) { commentsList.innerHTML = '<div class="no-comments" style="padding: 20px 0;">Be the first to leave feedback for this book!</div>'; return; }

        commentsList.innerHTML = '';
        snapshot.forEach(doc => {
            const data = doc.data();
            let starsHTML = '';
            for (let i = 1; i <= 5; i++) { starsHTML += `<i class="${i <= data.rating ? 'fas' : 'far'} fa-star"></i>`; }
            commentsList.innerHTML += `
               <div class="comment-item">
                   <div class="comment-header">
                       <span class="comment-author">${escapeHTML(data.userName || 'User')}</span>
                       <span class="comment-rating">${starsHTML}</span>
                   </div>
                   ${data.comment ? `<p class="comment-body">${escapeHTML(data.comment)}</p>` : '<p class="comment-body" style="opacity:0.7;"><em>No comment text.</em></p>'}
                   <p class="comment-date">${formatDate(data.submittedAt)} at ${formatTime(data.submittedAt)}</p>
               </div>`;
        });
    } catch (error) {
        console.error("Error loading comments:", error);
        commentsList.innerHTML = '<div class="no-comments" style="padding: 20px 0;">Could not load comments at this time.</div>';
    }
}

async function createNotification(userId, title, message, type = 'info', actionLink = null, icon = null) {
    if (!userId) { console.warn("createNotification called without userId"); return; }
    try {
        await db.collection('users').doc(userId).collection('notifications').add({
            title: title, message: message, type: type,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            read: false, actionLink: actionLink,
            icon: icon || getDefaultIconForType(type)
        });
    } catch (error) { console.error("Error creating notification:", error); }
}
function getDefaultIconForType(type) {
    switch (type) {
        case 'success': return 'fas fa-check-circle';
        case 'error': return 'fas fa-times-circle';
        case 'warning': return 'fas fa-exclamation-triangle';
        case 'announcement': return 'fas fa-bullhorn';
        default: return 'fas fa-info-circle';
    }
}
function updateUnreadBadge(count) {
    unreadNotificationsCount = count;
    if (elements.unreadNotificationsBadge) {
        if (count > 0) {
            elements.unreadNotificationsBadge.textContent = count > 9 ? '9+' : count;
            elements.unreadNotificationsBadge.style.display = 'flex';
        } else {
            elements.unreadNotificationsBadge.style.display = 'none';
        }
    }
    if (elements.notificationTabsContainer && elements.markAllNotificationsReadBtn) {
        const activeTabBtn = elements.notificationTabsContainer.querySelector('.notification-tab-btn.active');
        if (activeTabBtn) {
            const activeTab = activeTabBtn.dataset.tab;
            if (activeTab === 'personal') {
                elements.markAllNotificationsReadBtn.disabled = (unreadNotificationsCount === 0);
            } else {
                elements.markAllNotificationsReadBtn.disabled = true;
            }
        } else {
            elements.markAllNotificationsReadBtn.disabled = true;
        }
    }
}

function updateAdminAnnouncementDot(count) {
    unreadAdminAnnouncementsCount = count;
    if (elements.announcementUnreadDot) {
        elements.announcementUnreadDot.style.display = count > 0 ? 'block' : 'none';
    }
}


function setupUserNotificationsListener() {
    if (!currentUser || listeners.userNotifications || isUserDataLoading || (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified)) return;
    if (!elements.personalNotificationsListContainer || !elements.emptyPersonalNotificationsState) return;

    renderSkeletonLoaders(elements.personalNotificationsListContainer, 5, 'notification');

    listeners.userNotifications = db.collection('users').doc(currentUser.uid).collection('notifications')
        .orderBy('timestamp', 'desc')
        .limit(50)
        .onSnapshot(snapshot => {
            let unreadCount = 0;
            const notificationsByDate = {};

            snapshot.forEach(doc => {
                const notification = { id: doc.id, ...doc.data() };
                if (!notification.read) unreadCount++;
                const dateStr = formatRelativeDate(notification.timestamp);
                if (!notificationsByDate[dateStr]) notificationsByDate[dateStr] = [];
                notificationsByDate[dateStr].push(notification);
            });

            updateUnreadBadge(unreadCount);
            elements.personalNotificationsListContainer.innerHTML = '';

            if (snapshot.empty) {
                elements.emptyPersonalNotificationsState.style.display = 'flex';
            } else {
                elements.emptyPersonalNotificationsState.style.display = 'none';
                const sortedDateGroups = Object.keys(notificationsByDate).sort((a, b) => {
                    const dateA = a === "Today" ? new Date() : (a === "Yesterday" ? new Date(Date.now() - 86400000) : new Date(a));
                    const dateB = b === "Today" ? new Date() : (b === "Yesterday" ? new Date(Date.now() - 86400000) : new Date(b));
                    return dateB - dateA;
                });

                sortedDateGroups.forEach(dateGroup => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'notification-group';
                    groupDiv.innerHTML = `<h3 class="notification-group-date">${escapeHTML(dateGroup)}</h3>`;
                    notificationsByDate[dateGroup].forEach(notif => {
                        groupDiv.innerHTML += createNotificationItemHTML(notif);
                    });
                    elements.personalNotificationsListContainer.appendChild(groupDiv);
                });
            }
            AOS.refreshHard();
        }, error => {
            console.error("Error fetching notifications:", error);
            showToast("Could not load notifications.", "error");
            elements.personalNotificationsListContainer.innerHTML = '';
            elements.emptyPersonalNotificationsState.style.display = 'flex';
        });
}

function setupAdminAnnouncementsListener() {
    if (listeners.adminAnnouncements) listeners.adminAnnouncements();
    if (!elements.adminAnnouncementsListContainer || !elements.emptyAdminAnnouncementsState) return;

    renderSkeletonLoaders(elements.adminAnnouncementsListContainer, 3, 'notification');

    listeners.adminAnnouncements = db.collection('broadcast_notifications')
        .orderBy('sentAt', 'desc')
        .limit(20)
        .onSnapshot(async snapshot => {
            const announcementsByDate = {};
            let newAnnouncementsCount = 0;
            const lastViewedTimestamp = (userData && !isUserDataLoading) ? userData.lastViewedAnnouncementsAt : null;
            const lastViewed = lastViewedTimestamp ? lastViewedTimestamp.toDate() : new Date(0);

            for (const doc of snapshot.docs) {
                const announcement = { id: doc.id, ...doc.data(), type: doc.data().type || 'announcement' };
                const dateStr = formatRelativeDate(announcement.sentAt);
                if (!announcementsByDate[dateStr]) announcementsByDate[dateStr] = [];
                announcementsByDate[dateStr].push(announcement);

                if (announcement.sentAt.toDate() > lastViewed) {
                    newAnnouncementsCount++;
                }
            }
            updateAdminAnnouncementDot(newAnnouncementsCount);

            elements.adminAnnouncementsListContainer.innerHTML = '';
            if (snapshot.empty) {
                elements.emptyAdminAnnouncementsState.style.display = 'flex';
            } else {
                elements.emptyAdminAnnouncementsState.style.display = 'none';
                const sortedDateGroups = Object.keys(announcementsByDate).sort((a, b) => {
                    const dateA = a === "Today" ? new Date() : (a === "Yesterday" ? new Date(Date.now() - 86400000) : new Date(a));
                    const dateB = b === "Today" ? new Date() : (b === "Yesterday" ? new Date(Date.now() - 86400000) : new Date(b));
                    return dateB - dateA;
                });
                sortedDateGroups.forEach(dateGroup => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'notification-group';
                    groupDiv.innerHTML = `<h3 class="notification-group-date">${escapeHTML(dateGroup)}</h3>`;
                    announcementsByDate[dateGroup].forEach(notif => {
                        groupDiv.innerHTML += createNotificationItemHTML(notif);
                    });
                    elements.adminAnnouncementsListContainer.appendChild(groupDiv);
                });
            }
            AOS.refreshHard();
        }, error => {
            console.error("Error fetching admin announcements:", error);
            showToast("Could not load admin announcements.", "error");
            elements.adminAnnouncementsListContainer.innerHTML = '';
            elements.emptyAdminAnnouncementsState.style.display = 'flex';
        });
}


function createNotificationItemHTML(notification) {
    let fullActionLink = '';
    if (notification.actionLink) {
        if (notification.actionLink.startsWith('/#')) {
            fullActionLink = window.location.origin + window.location.pathname + notification.actionLink.substring(1);
        } else if (notification.actionLink.startsWith('http')) {
            fullActionLink = notification.actionLink;
        }
    }
    const timestampToUse = notification.sentAt || notification.timestamp;
    const iconToUse = notification.icon || getDefaultIconForType(notification.type || 'announcement');


    return `
       <div class="notification-item ${notification.read ? '' : 'unread'} type-${notification.type}"
            data-id="${notification.id}"
            data-action-link="${escapeHTML(fullActionLink || '')}"
            data-internal-route="${escapeHTML(notification.actionLink && notification.actionLink.startsWith('/#') ? notification.actionLink : '')}">
           <div class="notification-icon"><i class="${escapeHTML(iconToUse)}"></i></div>
           <div class="notification-content">
               <h4 class="notification-title">${escapeHTML(notification.title)}</h4>
               <p class="notification-message">${escapeHTML(notification.message)}</p>
               <p class="notification-timestamp">${formatTime(timestampToUse)}</p>
           </div>
       </div>`;
}

[elements.personalNotificationsListContainer, elements.adminAnnouncementsListContainer].forEach(container => {
    if (container) {
        container.addEventListener('click', async (e) => {
            const item = e.target.closest('.notification-item');
            if (!item || !item.dataset.id) return;
            if (!currentUser || isUserDataLoading || (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified)) {
                showToast("Please login and verify email to interact with notifications.", "info");
                if(!currentUser) openModal(elements.loginModal);
                else if(!currentUser.emailVerified) openEmailVerificationModal(currentUser.email);
                return;
            }

            const notifId = item.dataset.id;
            const actionLink = item.dataset.actionLink;
            const internalRoute = item.dataset.internalRoute;

            if (container === elements.personalNotificationsListContainer && item.classList.contains('unread')) {
                try {
                    await db.collection('users').doc(currentUser.uid).collection('notifications').doc(notifId).update({ read: true });
                } catch (error) { console.error("Error marking notification as read:", error); }
            }

            if (internalRoute && internalRoute.startsWith('/#bookDetail/')) {
                const bookId = internalRoute.split('/')[2];
                closePage(elements.notificationsPage);
                activateNavItem(elements.homeBtn);
                openBookDetailModal(bookId, 'books');
            } else if (actionLink && actionLink.startsWith('http')) {
                window.open(actionLink, '_blank');
            }
        });
    }
});


if (elements.markAllNotificationsReadBtn) {
    elements.markAllNotificationsReadBtn.addEventListener('click', async () => {
        if (!currentUser || unreadNotificationsCount === 0 || isUserDataLoading || (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified)) return;
        
        const activeTabBtn = elements.notificationTabsContainer.querySelector('.notification-tab-btn.active');
        if (!activeTabBtn || activeTabBtn.dataset.tab !== 'personal') return;

        toggleSpinner(elements.markAllNotificationsReadBtn, true, "Marking All Read");
        try {
            const batch = db.batch();
            const unreadNotifsSnapshot = await db.collection('users').doc(currentUser.uid).collection('notifications').where('read', '==', false).get();
            unreadNotifsSnapshot.forEach(doc => {
                batch.update(doc.ref, { read: true });
            });
            await batch.commit();
            showToast("All personal notifications marked as read.", "success");
        } catch (error) {
            console.error("Error marking all notifications as read:", error);
            showToast("Failed to mark all as read.", "error");
        } finally {
            toggleSpinner(elements.markAllNotificationsReadBtn, false);
        }
    });
}

if (elements.notificationTabsContainer) {
    elements.notificationTabsContainer.addEventListener('click', async (e) => {
        const targetTabBtn = e.target.closest('.notification-tab-btn');
        if (!targetTabBtn) return;
        elements.notificationTabBtns.forEach(btn => btn.classList.remove('active'));
        targetTabBtn.classList.add('active');
        const tabId = targetTabBtn.dataset.tab;

        if (elements.personalNotificationsListContainer) elements.personalNotificationsListContainer.classList.toggle('active', tabId === 'personal');
        if (elements.adminAnnouncementsListContainer) elements.adminAnnouncementsListContainer.classList.toggle('active', tabId === 'announcements');

        if (tabId === 'personal') {
            if (elements.markAllNotificationsReadBtn) elements.markAllNotificationsReadBtn.disabled = (unreadNotificationsCount === 0);
        } else {
            if (elements.markAllNotificationsReadBtn) elements.markAllNotificationsReadBtn.disabled = true;
            if (unreadAdminAnnouncementsCount > 0 && currentUser && userData && !isUserDataLoading) {
                try {
                    await db.collection('users').doc(currentUser.uid).update({
                        lastViewedAnnouncementsAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    updateAdminAnnouncementDot(0); // Visually clear it immediately
                } catch (error) {
                    console.error("Error updating lastViewedAnnouncementsAt:", error);
                }
            }
        }
        AOS.refresh();
    });
}

window.addEventListener('scroll', () => {
    if (window.scrollY > 50 && elements.header) elements.header.classList.add('scrolled');
    else if (elements.header) elements.header.classList.remove('scrolled');

    if (elements.homeBtn && elements.homeBtn.classList.contains('active') &&
        (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 300) &&
        !isLoadingBooksMain && hasMoreBooksMain && currentUser && !isUserDataLoading &&
        (!currentUser.providerData.some(p => p.providerId === 'password') || currentUser.emailVerified ) // Ensure user is ready
    ) {
        fetchBooksMain(true);
    }
});

if (elements.searchToggleBtn) {
    elements.searchToggleBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (elements.searchContainer) elements.searchContainer.classList.toggle('active');
        if (elements.searchContainer && elements.searchContainer.classList.contains('active') && elements.searchInput) elements.searchInput.focus();
    });
}

function handleSearchInput() {
    if (!elements.searchInput || !elements.searchResults) return;
    const query = elements.searchInput.value.toLowerCase().trim();
    if (query.length < 2) { elements.searchResults.style.display = 'none'; return; }
    if (!currentUser || isUserDataLoading || (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified)) {
         showToast("Please login and verify your email to search.", "info");
         elements.searchResults.style.display = 'none'; return;
    }

    const results = allBooksCache.filter(book =>
        book.bookName.toLowerCase().includes(query) ||
        book.authorName.toLowerCase().includes(query) ||
        (book.category && book.category.toLowerCase().includes(query))
    ).slice(0, 10);
    renderSearchResults(results, elements.searchResults);
}
let searchTimeoutGlobal;
if (elements.searchInput) {
    elements.searchInput.addEventListener('input', () => { clearTimeout(searchTimeoutGlobal); searchTimeoutGlobal = setTimeout(handleSearchInput, 300); });
    elements.searchInput.addEventListener('focus', handleSearchInput);
}


function renderSearchResults(results, resCont) {
    if (!resCont) return;
    if (results.length === 0) { resCont.innerHTML = '<div class="no-results">No books found.</div>'; resCont.style.display = 'block'; return; }
    resCont.innerHTML = results.map(book => `
       <div class="search-result-item" data-book-id="${book.id}">
           <h4>${escapeHTML(book.bookName)}</h4>
           <p>By ${escapeHTML(book.authorName)} | Category: ${escapeHTML(book.category || 'N/A')}</p>
       </div>`).join('');
    resCont.style.display = 'block';
}

if (elements.searchResults) {
    elements.searchResults.addEventListener('click', (e) => {
        const item = e.target.closest('.search-result-item');
        if (item && item.dataset.bookId) {
            if (!currentUser || isUserDataLoading || (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified)) { 
                showToast("Please login and verify email to view details.", "info");
                return;
            }
            openBookDetailModal(item.dataset.bookId, 'books');
            elements.searchResults.style.display = 'none';
            if (elements.searchInput) elements.searchInput.value = '';
            if (elements.searchContainer && elements.searchContainer.classList.contains('active') && window.innerWidth <= 768) {
                elements.searchContainer.classList.remove('active');
            }
        }
    });
}

document.addEventListener('click', (e) => {
    if (elements.searchContainer && elements.searchContainer.classList.contains('active') && window.innerWidth <= 768 && !elements.searchContainer.contains(e.target) && e.target !== elements.searchToggleBtn) {
        elements.searchContainer.classList.remove('active');
    }
    if (elements.searchContainer && !elements.searchContainer.contains(e.target) && elements.searchResults) {
        elements.searchResults.style.display = 'none';
    }
});

function openPage(pageEl) {
    if (!pageEl) return;
    if (!currentUser || (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified)) {
        showToast("Please login and verify your email to access this page.", "info");
        if (!currentUser) openModal(elements.loginModal);
        else if (!currentUser.emailVerified) openEmailVerificationModal(currentUser.email);
        return;
    }

    pageEl.classList.add('active');
    elements.body.style.overflow = 'hidden';
    AOS.refresh();

    if (pageEl === elements.profilePage) {
        if (currentUser && !isUserDataLoading && ( (currentUser.providerData.some(p => p.providerId !== 'password')) || currentUser.emailVerified ) ) {
            fetchUserBooks(false, true);
            fetchWithdrawalHistory();
            checkAndShowProfilePrompts();
            if (elements.profileTabs) {
                let activeTab = elements.profileTabs.querySelector('.profile-tab-btn.active');
                if (!activeTab || activeTab.dataset.tab === 'security') {
                    activeTab = elements.profileTabs.querySelector('.profile-tab-btn[data-tab="shared-books"]') || elements.profileTabs.querySelector('.profile-tab-btn');
                }
                if (activeTab) {
                   const tabId = activeTab.dataset.tab;
                   elements.profileTabBtns.forEach(btn => btn.classList.remove('active'));
                   activeTab.classList.add('active');
                   elements.profileTabContents.forEach(content => {
                       content.classList.toggle('active', content.id === `tab-${tabId}`);
                   });
                }
            }
        } else if (!currentUser || (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified) ) {
            closePage(elements.profilePage); // Ensure it's closed if user is not ready
            if(!currentUser) openModal(elements.loginModal);
            else openEmailVerificationModal(currentUser.email);
        } 
    } else if (pageEl === elements.notificationsPage) {
        if (currentUser && !isUserDataLoading && ( (currentUser.providerData.some(p => p.providerId !== 'password')) || currentUser.emailVerified )) {
            if (elements.notificationTabsContainer && elements.personalNotificationsListContainer && elements.adminAnnouncementsListContainer) {
                elements.notificationTabBtns.forEach(btn => btn.classList.remove('active'));
                elements.personalNotificationsListContainer.classList.remove('active');
                elements.adminAnnouncementsListContainer.classList.remove('active');

                const personalTabBtn = elements.notificationTabsContainer.querySelector('[data-tab="personal"]');
                if (personalTabBtn) personalTabBtn.classList.add('active');
                elements.personalNotificationsListContainer.classList.add('active');
                if (elements.markAllNotificationsReadBtn) elements.markAllNotificationsReadBtn.disabled = (unreadNotificationsCount === 0);
            }
        } else if (!currentUser || (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified)) {
            closePage(elements.notificationsPage);
            if(!currentUser) openModal(elements.loginModal);
            else openEmailVerificationModal(currentUser.email);
        }
    }
}
function closePage(pageEl) {
    if (!pageEl) return;
    pageEl.classList.remove('active');
    const anyModalActive = $$('.modal.active').length > 0;
    const anyPageActive = $$('.profile-page.active, .notifications-page.active').length > 0;
     if (!anyModalActive && !anyPageActive && (!elements.emailVerificationModal || !elements.emailVerificationModal.classList.contains('active'))) {
        elements.body.style.overflow = 'auto';
    }
}

function openProfilePage() { openPage(elements.profilePage); if (elements.profileBtn) activateNavItem(elements.profileBtn); }
function closeProfilePage() { if (elements.profilePage) closePage(elements.profilePage); if (elements.homeBtn) activateNavItem(elements.homeBtn); }
function openNotificationsPage() { openPage(elements.notificationsPage); if (elements.notificationsBtn) activateNavItem(elements.notificationsBtn); }
function closeNotificationsPage() { if (elements.notificationsPage) closePage(elements.notificationsPage); if (elements.homeBtn) activateNavItem(elements.homeBtn); }

async function openReferralModal() {
    if (currentUser && !isUserDataLoading && ( (currentUser.providerData.some(p => p.providerId !== 'password')) || currentUser.emailVerified ) ) {
        activateNavItem(elements.referralBtn);
        if (!userData.referralCode) { 
            if (elements.userReferralCode) elements.userReferralCode.textContent = 'Generating...';
            const newCode = await generateAndSaveReferralCode(currentUser.uid);
            if (newCode && elements.userReferralCode) {
                elements.userReferralCode.textContent = newCode;
            } else if (elements.userReferralCode) {
                elements.userReferralCode.textContent = 'Error Generating';
            }
        } else {
            if (elements.userReferralCode) elements.userReferralCode.textContent = userData.referralCode;
        }
        fetchReferralStats(); 
        openModal(elements.referralModal);
    } else if (!currentUser) {
        openModal(elements.loginModal);
    } else if(currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified){
         showToast("Please verify your email to access referrals.", "warning");
         openEmailVerificationModal(currentUser.email);
    } else { 
        showToast("Profile data is loading, please wait...", "info");
    }
}

function closeReferralModal() { if (elements.referralModal) closeModal(elements.referralModal); if (elements.homeBtn) activateNavItem(elements.homeBtn); }


function activateNavItem(targetBtn) {
    if (!targetBtn) return;
    elements.bottomNavItems.forEach(item => item.classList.remove('active'));
    targetBtn.classList.add('active');
}
function resetNavigation() { if (elements.homeBtn) activateNavItem(elements.homeBtn); }
function closeAllPagesAndModals() {
    if (elements.profilePage) closePage(elements.profilePage);
    if (elements.notificationsPage) closePage(elements.notificationsPage);
    if (elements.emailVerificationModal && elements.emailVerificationModal.classList.contains('active')) {
        // Don't close email verification modal automatically if user is not verified, they need to interact with it.
    } else {
        $$('.modal.active').forEach(m => closeModal(m));
    }
    
    const anyModalActive = $$('.modal.active').length > 0;
    const anyPageActive = $$('.profile-page.active, .notifications-page.active').length > 0;
    if (!anyModalActive && !anyPageActive && (!elements.emailVerificationModal || !elements.emailVerificationModal.classList.contains('active')) ) {
        elements.body.style.overflow = 'auto';
    }
    currentBookDetailId = null;
}

if (elements.forgotPasswordLink) {
    elements.forgotPasswordLink.onclick = () => {
        closeModal(elements.loginModal);
        openModal(elements.forgotPasswordModal);
        if (elements.forgotPasswordForm) elements.forgotPasswordForm.reset();
    };
}
if (elements.closeForgotPasswordModal) elements.closeForgotPasswordModal.onclick = () => closeModal(elements.forgotPasswordModal);
if (elements.forgotPasswordForm) {
    elements.forgotPasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const emailInput = elements.forgotPasswordForm.querySelector('#forgotPasswordEmail');
        const email = emailInput ? emailInput.value : '';
        const btn = elements.forgotPasswordForm.querySelector('#sendResetEmailBtn');
        toggleSpinner(btn, true, "Sending");
        try {
            await auth.sendPasswordResetEmail(email);
            showToast("Password reset email sent! Check your inbox (and spam folder).", "success", 6000);
            closeModal(elements.forgotPasswordModal);
        } catch (error) {
            console.error("Error sending password reset email:", error);
            showToast("Failed to send reset email: " + error.message, "error");
        } finally {
            toggleSpinner(btn, false);
        }
    });
}
if (elements.changePasswordBtnTab) {
    elements.changePasswordBtnTab.onclick = () => {
        if (!currentUser || isUserDataLoading) { showToast("Please login.", "error"); return; }
        openModal(elements.forgotPasswordModal);
        if (elements.forgotPasswordForm) elements.forgotPasswordForm.reset();
        const emailInput = elements.forgotPasswordForm.querySelector('#forgotPasswordEmail');
        if (emailInput) emailInput.value = currentUser.email;
    };
}

function obfuscatePin(pin) { return btoa(pin + PIN_SALT); }
function deobfuscateAndVerifyPin(enteredPin, storedHash) {
    try { return btoa(enteredPin + PIN_SALT) === storedHash; }
    catch (e) { console.error("Error in PIN verification:", e); return false; }
}

function openPinManagementModal(context) {
    if (!currentUser || !userData || isUserDataLoading || (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified)) { 
        showToast("Please login and verify email to manage PIN.", "error"); 
        if(!currentUser) openModal(elements.loginModal);
        else if (!currentUser.emailVerified) openEmailVerificationModal(currentUser.email);
        return; 
    }
    currentPinManagementContext = context;
    elements.pinManagementForm.reset();

    elements.newPinInput.required = false;
    elements.confirmNewPinInput.required = false;
    elements.currentPinInput.required = false;

    if (context === 'setup' || context === 'change') {
        elements.pinModalTitle.textContent = (context === 'setup' ? 'Set Up' : 'Change') + ' Withdrawal PIN';
        elements.pinSetupFields.style.display = 'block';
        elements.pinEntryField.style.display = 'none';
        elements.newPinInput.required = true;
        elements.confirmNewPinInput.required = true;
        elements.submitPinManagementBtnText.textContent = (context === 'setup' ? 'Set' : 'Change') + ' PIN';
        elements.forgotPinLinkContainer.style.display = (context === 'change' && userData.hasSetPin) ? 'block' : 'none';
    } else if (context === 'entry') {
        elements.pinModalTitle.textContent = 'Enter Withdrawal PIN';
        elements.pinSetupFields.style.display = 'none';
        elements.pinEntryField.style.display = 'block';
        elements.currentPinInput.required = true;
        elements.submitPinManagementBtnText.textContent = 'Verify PIN & Withdraw';
        elements.forgotPinLinkContainer.style.display = userData.hasSetPin ? 'block' : 'none';
    }
    openModal(elements.pinManagementModal);
}

if (elements.pinManagementForm) {
    elements.pinManagementForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (isUserDataLoading) { showToast("User data is still loading. Please wait.", "info"); return; }
        const btn = elements.submitPinManagementBtn;
        toggleSpinner(btn, true, currentPinManagementContext === 'entry' ? "Verifying" : "Saving");

        try {
            if (currentPinManagementContext === 'setup' || currentPinManagementContext === 'change') {
                const newPin = elements.newPinInput.value;
                const confirmPin = elements.confirmNewPinInput.value;

                if (!/^\d{4,6}$/.test(newPin)) {
                    showToast("PIN must be 4 to 6 digits.", "error");
                    toggleSpinner(btn, false); return;
                }
                if (newPin !== confirmPin) {
                    showToast("PINs do not match.", "error");
                    toggleSpinner(btn, false); return;
                }

                const pinHash = obfuscatePin(newPin);
                await db.collection('users').doc(currentUser.uid).update({
                    secretPinHash: pinHash,
                    hasSetPin: true
                });
                showToast(`PIN successfully ${currentPinManagementContext === 'setup' ? 'set' : 'changed'}!`, "success");
                closeModal(elements.pinManagementModal);
                if(elements.managePinBtnTabText) elements.managePinBtnTabText.textContent = 'Change PIN';
                checkAndShowProfilePrompts();
            } else if (currentPinManagementContext === 'entry') {
                const enteredPin = elements.currentPinInput.value;
                if (!userData.hasSetPin || !userData.secretPinHash) {
                    showToast("PIN not set up. Please set a PIN first.", "error");
                    toggleSpinner(btn, false);
                    closeModal(elements.pinManagementModal);
                    openPinManagementModal('setup');
                    return;
                }
                if (deobfuscateAndVerifyPin(enteredPin, userData.secretPinHash)) {
                    showToast("PIN Verified!", "success", 1500);
                    await submitWithdrawalRequestWithPin(); // This will close modal if successful
                    return; // submitWithdrawal will handle its own spinner and modal closing
                } else {
                    showToast("Incorrect PIN. Please try again.", "error");
                }
            }
        } catch (error) {
            console.error("Error in PIN management:", error);
            showToast("PIN operation failed: " + error.message, "error");
        }
        // If not an early return (like successful entry), stop spinner
        if (btn.classList.contains('loading')) {
           toggleSpinner(btn, false);
        }
    });
}

if (elements.forgotPinLink) {
    elements.forgotPinLink.onclick = () => {
        if (isUserDataLoading || !userData) { showToast("User data loading, please wait.", "info"); return; }
        if (!userData.recoveryEmail) {
            showToast("No recovery email set. Please set one in Edit Profile to recover your PIN.", "warning", 5000);
            return;
        }
        closeModal(elements.pinManagementModal);
        openModal(elements.forgotPinModal);
        elements.forgotPinRecoveryEmailInput.value = '';
    };
}

if (elements.forgotPinForm) {
    elements.forgotPinForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (isUserDataLoading || !userData || !userData.recoveryEmail) {
            showToast("Recovery email not configured or data loading.", "error");
            return;
        }
        const enteredRecoveryEmail = elements.forgotPinRecoveryEmailInput.value.trim();
        const btn = elements.verifyRecoveryEmailBtn;
        toggleSpinner(btn, true, "Verifying");

        if (enteredRecoveryEmail.toLowerCase() === userData.recoveryEmail.toLowerCase()) {
            showToast("Recovery email verified. You can now reset your PIN.", "success");
            closeModal(elements.forgotPinModal);
            openPinManagementModal('change');
        } else {
            showToast("Recovery email does not match our records.", "error");
        }
        toggleSpinner(btn, false);
    });
}

if(elements.managePinBtnTab) elements.managePinBtnTab.onclick = () => {
    if (isUserDataLoading || !userData) { showToast("User data loading, please wait.", "info"); return; }
    if (currentUser && currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified) {
         showToast("Please verify your email to manage PIN.", "warning");
         openEmailVerificationModal(currentUser.email);
         return;
    }
    openPinManagementModal(userData.hasSetPin ? 'change' : 'setup');
}
if(elements.securitySettingsBtnFooter) elements.securitySettingsBtnFooter.onclick = () => {
    if (!currentUser || (currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified)) {
        showToast("Please login and verify email to access security settings.", "info");
        if(!currentUser) openModal(elements.loginModal);
        else if (!currentUser.emailVerified) openEmailVerificationModal(currentUser.email);
        return;
    }
    const securityTabBtn = elements.profileTabs.querySelector('[data-tab="security"]');
    if (securityTabBtn) {
       securityTabBtn.click();
       const securityTabContent = $('#tab-security');
       if (securityTabContent) securityTabContent.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
};
if(elements.closePinManagementModal) elements.closePinManagementModal.onclick = () => closeModal(elements.pinManagementModal);
if(elements.closeForgotPinModal) elements.closeForgotPinModal.onclick = () => closeModal(elements.forgotPinModal);


function setupReferralStatsListener() { // Also called by onAuthStateChanged to ensure data freshness
    if (!currentUser || isUserDataLoading) return;
    if (!elements.referralCount || !elements.referralEarnings) return;

    if (userData) {
        elements.referralCount.textContent = userData.totalReferrals || 0;
        elements.referralEarnings.innerHTML = `${userData.pointsFromReferrals || 0} <small>pts</small>`;
        if (elements.userReferralCode) {
            elements.userReferralCode.textContent = userData.referralCode || 'N/A';
        }
    }
}

if (elements.copyReferralCodeBtn) {
    elements.copyReferralCodeBtn.onclick = () => {
        if (userData && userData.referralCode) {
            navigator.clipboard.writeText(userData.referralCode)
                .then(() => showToast("Referral code copied!", "success"))
                .catch(err => { console.error('Failed to copy code: ', err); showToast("Failed to copy code.", "error"); });
        }
    };
}
if (elements.copyReferralLinkBtn) {
    elements.copyReferralLinkBtn.onclick = () => {
        if (userData && userData.referralCode) {
            const referralLink = `${window.location.origin}${window.location.pathname}?ref=${userData.referralCode}`;
            navigator.clipboard.writeText(referralLink)
                .then(() => showToast("Referral link copied!", "success"))
                .catch(err => { console.error('Failed to copy link: ', err); showToast("Failed to copy link.", "error"); });
        }
    };
}
function applyReferralCodeFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const refCode = urlParams.get('ref');
    if (refCode && elements.signupModal && $('#signupReferralCode')) {
        $('#signupReferralCode').value = refCode;
         // Remove ref from URL to avoid re-applying on refresh if signup fails and user retries
        const newUrl = window.location.pathname + window.location.hash;
        window.history.replaceState({}, document.title, newUrl);
    }
}


// --- General Event Listeners ---
if (elements.homeBtn) elements.homeBtn.onclick = () => { closeAllPagesAndModals(); activateNavItem(elements.homeBtn); window.scrollTo({ top: 0, behavior: 'smooth' }); };
if (elements.logoLink) elements.logoLink.onclick = (e) => { e.preventDefault(); if (elements.homeBtn) elements.homeBtn.click(); };
if (elements.notificationsBtn) elements.notificationsBtn.onclick = openNotificationsPage;
if (elements.notificationsBackBtn) elements.notificationsBackBtn.onclick = closeNotificationsPage;
if (elements.profileBtn) elements.profileBtn.onclick = openProfilePage;
if (elements.userAvatar) elements.userAvatar.onclick = openProfilePage;
if (elements.profileBackBtn) elements.profileBackBtn.onclick = closeProfilePage;
if (elements.addBookBtn) {
    elements.addBookBtn.onclick = () => {
        if (currentUser && !isUserDataLoading && ( (currentUser.providerData.some(p => p.providerId !== 'password')) || currentUser.emailVerified )) {
            openModal(elements.addBookModal);
        } else if (currentUser && currentUser.providerData.some(p => p.providerId === 'password') && !currentUser.emailVerified) {
            showToast("Please verify your email to share books.", "warning");
            openEmailVerificationModal(currentUser.email);
        } else {
            openModal(elements.loginModal);
        }
    };
}
if (elements.closeAddBookModal) elements.closeAddBookModal.onclick = () => closeModal(elements.addBookModal);
if (elements.referralBtn) elements.referralBtn.onclick = openReferralModal;
if (elements.closeReferralModal) elements.closeReferralModal.onclick = closeReferralModal;
if (elements.switchToSignup) elements.switchToSignup.onclick = () => { closeModal(elements.loginModal); openModal(elements.signupModal); };
if (elements.switchToLogin) elements.switchToLogin.onclick = () => { closeModal(elements.signupModal); openModal(elements.loginModal); };
if (elements.closeLoginModal) elements.closeLoginModal.onclick = () => closeModal(elements.loginModal);
if (elements.closeSignupModal) elements.closeSignupModal.onclick = () => closeModal(elements.signupModal);
if (elements.closeBookDetailModal) elements.closeBookDetailModal.onclick = () => { closeModal(elements.bookDetailModal); currentBookDetailId = null; }
$$('.modal').forEach(m => { m.addEventListener('click', (e) => { if (e.target === m && m !== elements.emailVerificationModal) closeModal(m); }); }); // Don't close email verification modal on overlay click.


// --- Initial Setup ---
document.addEventListener('DOMContentLoaded', () => {
    isUserDataLoading = true; 
    showRandomLoadingMessage();
    renderSkeletonLoaders(elements.booksContainer, BOOKS_PER_PAGE_MAIN, 'book-main'); 
    renderSkeletonLoaders(elements.popularBooksCarousel, 5, 'popular');
    renderCategoryFilters();
    resetNavigation();
    setupWithdrawalListeners();
    applyReferralCodeFromURL(); 

    const withdrawalOptsHTML = `<div class="withdrawal-option" data-method="upi"><div class="withdrawal-icon"><i class="fas fa-mobile-alt"></i></div><div class="withdrawal-details"><div class="withdrawal-title">UPI</div><div class="withdrawal-description">Fast transfer via UPI ID</div></div></div><div class="withdrawal-option" data-method="redeem"><div class="withdrawal-icon"><i class="fab fa-google-play"></i></div><div class="withdrawal-details"><div class="withdrawal-title">Redeem Code</div><div class="withdrawal-description">Google Play Gift Card</div></div></div><div class="withdrawal-option" data-method="bank"><div class="withdrawal-icon"><i class="fas fa-university"></i></div><div class="withdrawal-details"><div class="withdrawal-title">Bank Account</div><div class="withdrawal-description">Direct bank transfer (slower)</div></div></div><div class="withdrawal-option" data-method="paytm"><div class="withdrawal-icon"><i class="fas fa-wallet"></i></div><div class="withdrawal-details"><div class="withdrawal-title">Paytm Wallet</div><div class="withdrawal-description">Transfer to Paytm</div></div></div><div class="withdrawal-option" data-method="phonepe"><div class="withdrawal-icon"><i class="fas fa-rupee-sign"></i></div><div class="withdrawal-details"><div class="withdrawal-title">PhonePe</div><div class="withdrawal-description">Transfer to PhonePe</div></div></div>`;
    if (elements.withdrawalOptionsContainer) elements.withdrawalOptionsContainer.innerHTML = withdrawalOptsHTML;
    const amountOptsHTML = `<div class="amount-option" data-amount="500" data-rs="50">500 pts = ₹50</div><div class="amount-option" data-amount="1000" data-rs="100">1000 pts = ₹100</div><div class="amount-option" data-amount="2000" data-rs="200">2000 pts = ₹200</div><div class="amount-option" data-amount="5000" data-rs="500">5000 pts = ₹500</div>`;
    if (elements.amountOptionsContainer) elements.amountOptionsContainer.innerHTML = amountOptsHTML;

    const loadingFallbackTimeout = setTimeout(() => {
        if (elements.loadingOverlay && !elements.loadingOverlay.classList.contains('hidden')) {
            console.warn("Loading overlay fallback timeout triggered.");
            hideLoadingOverlay();
        }
    }, 7000); 

    auth.onAuthStateChanged(user => { 
        clearTimeout(loadingFallbackTimeout); 
        if (!user && elements.loadingOverlay && !elements.loadingOverlay.classList.contains('hidden')) {
            // If no user and overlay still visible (e.g., Firebase failed to init), hide it.
            hideLoadingOverlay();
        }
        // If user is present but not verified, onAuthStateChanged logic will open email verification.
        // Overlay hiding for verified users or first-time page load for logged-out state
        // is handled within the main onAuthStateChanged body.
    });
});

function fetchReferralStats() { // This is called by openReferralModal and user data snapshot listener
    if (userData && elements.referralModal.classList.contains('active')) {
        if (elements.userReferralCode) elements.userReferralCode.textContent = userData.referralCode || 'N/A';
        if (elements.referralCount) elements.referralCount.textContent = userData.totalReferrals || 0;
        if (elements.referralEarnings) elements.referralEarnings.innerHTML = `${userData.pointsFromReferrals || 0} <small>pts</small>`;
    } else if (userData) { // Update even if modal not active, for consistency if user data changes
        if (elements.userReferralCode) elements.userReferralCode.textContent = userData.referralCode || 'N/A';
        if (elements.referralCount) elements.referralCount.textContent = userData.totalReferrals || 0;
        if (elements.referralEarnings) elements.referralEarnings.innerHTML = `${userData.pointsFromReferrals || 0} <small>pts</small>`;
    }
}
</script>
</body>
</html>
