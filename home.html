<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduSparK - Dashboard</title>
    <meta name="description" content="Your personal EduSparK dashboard. Track your progress, explore content, and continue your learning journey.">

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        :root {
            --primary-color: #ff3333;
            --primary-light: #ff6666;
            --primary-dark: #cc0000;
            --secondary-color: #000000;
            --secondary-light: #2a2a2a;
            --text-light: #f1f2f6;
            --text-dark: #dfe4ea;
            --text-muted: #a4b0be;
            --bg-dark: #121212;
            --bg-light: #1e1e1e;
            --card-bg: #212121;
            --gradient: linear-gradient(135deg, #ff3333, #cc0000);
            --credit-color: #ffd700;
            --shadow-md: 0 6px 12px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.45);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --header-height: 70px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-dark);
            line-height: 1.7;
            overflow-x: hidden;
            opacity: 0; /* Initially hide body */
            animation: fadeInBody 0.5s 0.5s ease-out forwards;
        }
        @keyframes fadeInBody { to { opacity: 1; } }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-dark);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        .loading-overlay.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .spinner-large { width: 48px; height: 48px; border: 5px solid rgba(255, 255, 255, 0.2); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        .loading-message { margin-top: 20px; color: var(--text-muted); font-size: 1.1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Header --- */
        .header {
            background-color: rgba(18, 18, 18, 0.85); backdrop-filter: blur(15px);
            height: var(--header-height); display: flex; justify-content: space-between; align-items: center;
            padding: 0 25px; position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
            transition: var(--transition); border-bottom: 1px solid rgba(255, 51, 51, 0.1);
        }
        .header.scrolled { background-color: rgba(18, 18, 18, 0.95); box-shadow: var(--shadow-md); }
        .logo { font-size: 1.8rem; font-weight: 800; color: var(--primary-color); text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .logo i { transition: transform 0.3s ease; }
        .logo:hover i { transform: rotate(-10deg) scale(1.1); }
        .main-nav { display: flex; gap: 30px; }
        .main-nav a { color: var(--text-muted); text-decoration: none; font-weight: 500; position: relative; padding: 5px 0; transition: color 0.3s ease; }
        .main-nav a::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: var(--primary-color); transform: scaleX(0); transition: transform 0.4s ease; }
        .main-nav a:hover { color: var(--text-light); }
        .main-nav a:hover::after { transform: scaleX(1); }
        
        .header-actions { display: flex; align-items: center; gap: 15px; }
        .header-credits { display: flex; align-items: center; gap: 8px; font-weight: 600; padding: 6px 12px; border-radius: 25px; background-color: rgba(255, 255, 255, 0.07); transition: var(--transition); border: 1px solid rgba(255, 255, 255, 0.1); }
        .header-credits i { font-size: 1.1rem; color: var(--credit-color); }
        .user-menu { position: relative; }
        .user-avatar { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); cursor: pointer; transition: transform 0.3s ease; display: flex; align-items: center; justify-content: center; background: var(--gradient); color: white; font-weight: 600; overflow: hidden; }
        .user-avatar img { width: 100%; height: 100%; }
        .user-avatar:hover { transform: scale(1.1); }
        #user-menu-dropdown {
            display: none; position: absolute; top: calc(100% + 12px); right: 0;
            background-color: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow-lg);
            width: 220px; z-index: 1001; border: 1px solid rgba(255,255,255,0.1);
            padding: 10px 0; animation: dropdown-fade-in 0.3s ease forwards;
        }
        #user-menu-dropdown.active { display: block; }
        @keyframes dropdown-fade-in { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); }}
        .dropdown-header { padding: 10px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 5px; }
        .dropdown-header h4 { font-size: 1rem; color: var(--text-light); margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .dropdown-header p { font-size: 0.8rem; color: var(--text-muted); margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .dropdown-item { display: flex; align-items: center; gap: 12px; padding: 10px 15px; color: var(--text-dark); text-decoration: none; transition: background-color 0.2s ease; }
        .dropdown-item i { width: 18px; text-align: center; color: var(--primary-light); }
        .dropdown-item:hover { background-color: var(--secondary-light); color: var(--text-light); }
        #logoutBtn { color: var(--primary-light); }

        /* --- Hero Section --- */
        .hero {
            padding-top: calc(var(--header-height) + 60px); padding-bottom: 60px;
            display: flex; flex-direction: column; align-items: center;
            text-align: center; background: linear-gradient(160deg, #1a1a1a 0%, #121212 100%);
        }
        .welcome-title {
            font-family: 'Montserrat', sans-serif; font-size: 3.5rem; color: var(--text-light); font-weight: 800; margin-bottom: 15px;
        }
        .welcome-title .char { display: inline-block; opacity: 0; transform: translateY(25px) rotate(10deg); animation: slide-in-char 0.6s forwards cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes slide-in-char { to { opacity: 1; transform: translateY(0) rotate(0); } }
        #welcome-user-name { color: var(--primary-light); }
        .hero p { font-size: 1.2rem; color: var(--text-muted); margin-bottom: 40px; max-width: 600px; }
        .quick-actions-container { display: flex; gap: 20px; }
        .quick-actions-container .btn { font-size: 1.1rem; padding: 14px 35px; border-radius: 50px; }
        .btn-primary { background: var(--gradient); color: white; border:none; transition: var(--transition);}
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 4px 15px rgba(255,51,51,0.4); }
        .btn-secondary { background-color: transparent; color: var(--primary-light); border: 2px solid var(--primary-light); transition: var(--transition);}
        .btn-secondary:hover { background-color: var(--primary-light); color: white; transform: translateY(-3px); }

        /* --- Main Content --- */
        .container { padding: 80px 25px; max-width: 1300px; margin: 0 auto; }
        .section-title { text-align: center; font-size: 2.5rem; margin-bottom: 50px; font-weight: 700; color: var(--text-light); position: relative; padding-bottom: 15px;}
        .section-title::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 80px; height: 4px; background: var(--gradient); border-radius: 2px;}

        /* --- At a Glance Section --- */
        #overview { background-color: var(--bg-light); }
        .overview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; }
        .overview-card { background: var(--card-bg); padding: 25px; border-radius: var(--border-radius); border-left: 4px solid var(--primary-color); transition: var(--transition); position: relative; overflow: hidden; }
        .overview-card:hover { transform: translateY(-5px) scale(1.02); box-shadow: var(--shadow-md); border-left-color: var(--primary-light); }
        .overview-card::before { content: ''; position: absolute; top:0; right: 0; font-family: "Font Awesome 6 Free"; font-weight: 900; font-size: 4rem; color: rgba(255,255,255,0.03); transform: translateY(10px) rotate(-15deg); }
        .overview-card.points-card::before { content: '\f005'; } /* star */
        .overview-card.credits-card::before { content: '\f51e'; } /* coins */
        .overview-card.books-shared-card::before { content: '\f093'; } /* upload */
        .overview-card.books-dl-card::before { content: '\f019'; } /* download */
        .overview-card.batches-card::before { content: '\f51c'; } /* graduation-cap */
        .overview-card.progress-card::before { content: '\f201'; } /* chart-pie */
        .overview-card.time-card::before { content: '\f2f2'; } /* hourglass-half */
        .overview-card.backlog-card::before { content: '\f071'; } /* exclamation-triangle */
        
        .overview-card .value { font-size: 2.8rem; font-weight: 700; color: var(--text-light); line-height: 1.1; margin-bottom: 5px; }
        .overview-card .label { font-size: 1rem; color: var(--text-muted); }
        .overview-card .value.coming-soon { font-size: 1.5rem; color: var(--text-muted); }
        .overview-card .label.coming-soon-label { color: var(--primary-light); font-weight: 500; }

        /* --- Recent Activity Section --- */
        .recent-activity-list { list-style: none; padding: 0; max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; }
        .activity-item { background: var(--card-bg); padding: 15px 20px; border-radius: var(--border-radius); display: flex; align-items: center; gap: 20px; transition: var(--transition); border: 1px solid transparent; }
        .activity-item:hover { background-color: var(--secondary-light); border-color: var(--primary-color); transform: translateX(10px); }
        .activity-icon { font-size: 1.8rem; color: var(--primary-color); width: 40px; text-align: center; }
        .activity-details { flex-grow: 1; }
        .activity-title { font-size: 1.1rem; font-weight: 600; color: var(--text-light); text-decoration: none; }
        .activity-meta { font-size: 0.85rem; color: var(--text-muted); }
        
        /* --- Footer --- */
        .footer { background-color: #0c0c0c; padding: 40px 25px; text-align: center; color: var(--text-muted); border-top: 1px solid rgba(255,255,255,0.05); }

        /* --- Responsive --- */
        @media (max-width: 992px) {
            .main-nav { display: none; } /* Hide for simpler header on mobile */
        }
        @media (max-width: 768px) {
            .welcome-title { font-size: 2.5rem; }
            .hero p { font-size: 1rem; }
            .quick-actions-container { flex-direction: column; }
            .header { padding: 0 15px; }
            .container { padding: 60px 15px; }
            .section-title { font-size: 2rem; }
            .overview-card .value { font-size: 2.2rem; }
        }
    </style>
</head>
<body>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-large"></div>
        <p class="loading-message">Authenticating...</p>
    </div>

    <header class="header" id="header">
        <a href="home.html" class="logo">
            <i class="fas fa-brain"></i>
            <span>EduSparK</span>
        </a>
        <nav class="main-nav">
            <a href="books.html">Books</a>
            <a href="batches.html">Batches</a>
        </nav>
        <div class="header-actions">
            <div class="header-credits" id="headerCreditsContainer">
                <i class="fas fa-coins"></i>
                <span id="headerCreditsAmount">0</span>
            </div>
            <div class="user-menu">
                <div class="user-avatar" id="userAvatar">
                    <!-- Dynamic content will be loaded here by JS -->
                </div>
                <div class="user-menu-dropdown" id="userMenuDropdown">
                    <div class="dropdown-header">
                        <h4 id="dropdownUserName">Loading...</h4>
                        <p id="dropdownUserEmail">...</p>
                    </div>
                    <a href="books.html" class="dropdown-item">
                        <i class="fas fa-book"></i>
                        <span>Books & Profile</span>
                    </a>
                    <a href="batches.html" class="dropdown-item">
                        <i class="fas fa-chalkboard"></i>
                        <span>Batches Dashboard</span>
                    </a>
                    <a href="#" class="dropdown-item" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main>
        <section class="hero">
            <div class="hero-content">
                <h1 class="welcome-title" id="welcomeTitle">
                    <!-- Animated text will be injected by JS -->
                </h1>
                <p data-aos="fade-up" data-aos-delay="0.6">Your learning dashboard is ready. Let's make today productive.</p>
                <div class="quick-actions-container" data-aos="fade-up" data-aos-delay="0.8">
                    <a href="books.html" class="btn btn-primary">Explore Books</a>
                    <a href="batches.html" class="btn btn-secondary">Find a Batch</a>
                </div>
            </div>
        </section>

        <div class="container" id="overview">
            <h2 class="section-title" data-aos="fade-up">At a Glance</h2>
            <div class="overview-grid">
                <div class="overview-card points-card" data-aos="fade-up" data-aos-delay="100">
                    <div class="value" id="statPoints">0</div>
                    <div class="label">Total Points</div>
                </div>
                <div class="overview-card credits-card" data-aos="fade-up" data-aos-delay="150">
                    <div class="value" id="statCredits">0</div>
                    <div class="label">Available Credits</div>
                </div>
                <div class="overview-card books-shared-card" data-aos="fade-up" data-aos-delay="200">
                    <div class="value" id="statBooksShared">0</div>
                    <div class="label">Books Shared</div>
                </div>
                <div class="overview-card books-dl-card" data-aos="fade-up" data-aos-delay="250">
                    <div class="value" id="statBooksDownloaded">0</div>
                    <div class="label">Books Downloaded</div>
                </div>
                <div class="overview-card batches-card" data-aos="fade-up" data-aos-delay="300">
                    <div class="value" id="statBatchesEnrolled">0</div>
                    <div class="label">Batches Enrolled</div>
                </div>
                <div class="overview-card progress-card" data-aos="fade-up" data-aos-delay="350">
                    <div class="value coming-soon">N/A</div>
                    <div class="label label.coming-soon-label">Course Completion</div>
                </div>
                 <div class="overview-card time-card" data-aos="fade-up" data-aos-delay="400">
                    <div class="value coming-soon">N/A</div>
                    <div class="label label.coming-soon-label">Active Learning Time</div>
                </div>
                 <div class="overview-card backlog-card" data-aos="fade-up" data-aos-delay="450">
                    <div class="value coming-soon">N/A</div>
                    <div class="label label.coming-soon-label">Backlog Tracking</div>
                </div>
            </div>
        </div>

        <section id="recent-activity" class="container">
            <h2 class="section-title" data-aos="fade-up">Recent Activity</h2>
            <ul class="recent-activity-list" id="recentActivityContainer" data-aos="fade-up" data-aos-delay="200">
                <!-- Recent activity items will be loaded here -->
                <li class="empty-state" id="emptyStateRecentActivity" style="display: flex;">
                    <i class="fas fa-history"></i>
                    <h3>No Recent Activity</h3>
                    <p>Your recently visited books and batches will appear here.</p>
                </li>
            </ul>
        </section>
    </main>

    <footer class="footer">
        <p>Â© <span id="copyright-year">2024</span> EduSparK. All Rights Reserved.</p>
    </footer>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            AOS.init({
                duration: 800,
                easing: 'ease-in-out',
                once: true,
                offset: 50,
            });

            const firebaseConfig = {
                apiKey: "AIzaSyBNi6BHTKNd62VAY7q1oHQmxjZ3r0MUA9U", 
                authDomain: "eduspark-new.firebaseapp.com",
                projectId: "eduspark-new",
                storageBucket: "eduspark-new.appspot.com",
                messagingSenderId: "564501033350",
                appId: "1:564501033350:web:70c0f9873f96e9bd74fc07"
            };
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            const $ = (s) => document.querySelector(s);
            
            const elements = {
                loadingOverlay: $('#loadingOverlay'),
                header: $('#header'),
                headerCreditsAmount: $('#headerCreditsAmount'),
                userAvatar: $('#userAvatar'),
                userMenuDropdown: $('#userMenuDropdown'),
                dropdownUserName: $('#dropdownUserName'),
                dropdownUserEmail: $('#dropdownUserEmail'),
                logoutBtn: $('#logoutBtn'),
                welcomeTitle: $('#welcomeTitle'),
                recentActivityContainer: $('#recentActivityContainer'),
                emptyStateRecentActivity: $('#emptyStateRecentActivity'),
                statPoints: $('#statPoints'),
                statCredits: $('#statCredits'),
                statBooksShared: $('#statBooksShared'),
                statBooksDownloaded: $('#statBooksDownloaded'),
                statBatchesEnrolled: $('#statBatchesEnrolled'),
            };

            let userListener = null;

            // --- Authentication Guard ---
            auth.onAuthStateChanged(user => {
                if (user) {
                    initializePage(user);
                } else {
                    window.location.replace('index.html');
                }
            });

            function initializePage(user) {
                if (userListener) userListener(); 
                userListener = db.collection('users').doc(user.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        const userData = { id: doc.id, ...doc.data() };
                        updateUI(userData);
                        fetchRecentActivity(user.uid);
                    } else {
                        console.error("Authenticated user has no Firestore document.");
                        auth.signOut();
                    }
                    elements.loadingOverlay.classList.add('hidden');
                }, err => {
                    console.error("Error fetching user data:", err);
                    elements.loadingOverlay.classList.add('hidden');
                });
            }

            function updateUI(userData) {
                updateHeader(userData);
                animateWelcomeMessage(userData.name);
                updateStats(userData);
            }

            function updateHeader(userData) {
                if (userData.profilePictureURL) {
                    elements.userAvatar.innerHTML = `<img src="${userData.profilePictureURL}" alt="User Avatar">`;
                } else {
                    const initials = (userData.name || 'U').charAt(0).toUpperCase();
                    elements.userAvatar.innerHTML = `<span>${initials}</span>`;
                }
                elements.headerCreditsAmount.textContent = userData.credits || 0;
                elements.dropdownUserName.textContent = userData.name || 'User';
                elements.dropdownUserEmail.textContent = userData.email || '';
            }
            
            function animateWelcomeMessage(name) {
                const welcomeText = `Welcome back, <span id="welcome-user-name">${name || 'Explorer'}</span>!`;
                elements.welcomeTitle.innerHTML = '';
                
                let fullString = `Welcome back, ${name || 'Explorer'}!`;
                let charIndex = 0;
                for(const char of fullString){
                    const span = document.createElement('span');
                    span.className = 'char';
                    span.textContent = char === ' ' ? '\u00A0' : char;
                    span.style.animationDelay = `${charIndex * 0.04}s`;
                    if (charIndex >= 13 && charIndex < 13 + (name || 'Explorer').length) {
                        span.id = 'welcome-user-name';
                    }
                    elements.welcomeTitle.appendChild(span);
                    charIndex++;
                }
            }

            function updateStats(userData) {
                elements.statPoints.textContent = userData.points || 0;
                elements.statCredits.textContent = userData.credits || 0;
                elements.statBooksShared.textContent = userData.booksSharedCount || 0;
                elements.statBooksDownloaded.textContent = userData.booksDownloadedCount || 0;
                elements.statBatchesEnrolled.textContent = userData.enrolledBatches ? userData.enrolledBatches.length : 0;
            }

            async function fetchRecentActivity(userId) {
                try {
                    // This assumes you have a subcollection for recent activity on the user document.
                    // This would need to be populated by `books.html` and `batches.html` when an item is viewed.
                    // Example: db.collection('users').doc(uid).collection('recentActivity').doc(bookId).set({ ... });
                    const snapshot = await db.collection('users').doc(userId).collection('recentActivity')
                        .orderBy('lastVisited', 'desc')
                        .limit(5)
                        .get();
                    
                    if (snapshot.empty) {
                        elements.emptyStateRecentActivity.style.display = 'flex';
                        elements.recentActivityContainer.innerHTML = ''; // Clear any old items
                        elements.recentActivityContainer.appendChild(elements.emptyStateRecentActivity);
                        return;
                    }

                    elements.emptyStateRecentActivity.style.display = 'none';
                    elements.recentActivityContainer.innerHTML = ''; // Clear before adding new items
                    snapshot.forEach(doc => {
                        elements.recentActivityContainer.appendChild(createActivityItemHTML(doc.data()));
                    });
                    AOS.refresh();
                } catch (error) {
                    console.error("Error fetching recent activity:", error);
                    elements.emptyStateRecentActivity.innerHTML = '<p>Could not load recent activity.</p>';
                    elements.emptyStateRecentActivity.style.display = 'flex';
                }
            }
            
            function createActivityItemHTML(activity) {
                const item = document.createElement('li');
                item.className = 'activity-item';
                item.setAttribute('data-aos', 'fade-up');
                
                const isBook = activity.type === 'book';
                const iconClass = isBook ? 'fa-book' : 'fa-chalkboard-teacher';
                const link = isBook ? `books.html#book/${activity.id}` : `batches.html#batch/${activity.id}`;
                
                item.innerHTML = `
                    <div class="activity-icon"><i class="fas ${iconClass}"></i></div>
                    <div class="activity-details">
                        <a href="${link}" class="activity-title">${activity.title || 'Untitled'}</a>
                        <div class="activity-meta">
                            Last visited: ${activity.lastVisited ? new Date(activity.lastVisited.seconds * 1000).toLocaleString() : 'N/A'}
                        </div>
                    </div>
                `;
                return item;
            }

            // --- Event Listeners ---
            window.addEventListener('scroll', () => {
                elements.header.classList.toggle('scrolled', window.scrollY > 20);
            });

            elements.userAvatar.addEventListener('click', (e) => {
                e.stopPropagation();
                elements.userMenuDropdown.classList.toggle('active');
            });

            elements.logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                auth.signOut();
            });

            document.addEventListener('click', () => {
                if (elements.userMenuDropdown.classList.contains('active')) {
                    elements.userMenuDropdown.classList.remove('active');
                }
            });
            
            $('#copyright-year').textContent = new Date().getFullYear();
        });
    </script>
</body>
</html>
