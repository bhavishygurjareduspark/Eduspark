<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Add Content Security Policy Meta Tag - Customize as needed -->
    <meta http-equiv="Content-Security-Policy"
      content="default-src 'self' https://*.firebaseio.com https://*.firebasedatabase.app https://*.googleapis.com https://*.gstatic.com https://cdnjs.cloudflare.com https://unpkg.com https://cdn.jsdelivr.net;
               script-src 'self' 'unsafe-inline' https://www.gstatic.com/firebasejs/ https://unpkg.com https://cdn.jsdelivr.net https://www.google.com/recaptcha/api.js https://*.google.com https://www.gstatic.com/recaptcha/;
               style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com https://unpkg.com;
               font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com;
               img-src 'self' data: https: http://via.placeholder.com;
               connect-src 'self' wss://*.firebaseio.com https://*.googleapis.com https://*.firebaseio.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://firestore.googleapis.com https://firebaseinstallations.googleapis.com https://firebasestorage.googleapis.com https://firebaseappcheck.googleapis.com;
               object-src 'none';
               base-uri 'self';
               form-action 'self';
               frame-src 'self' https://www.google.com/recaptcha/ https://*.google.com;">
    <title>EduSparK - Share Knowledge</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app-check.js"></script> <!-- Firebase App Check SDK -->


    <style>
        :root {
            --primary-color: #ff3333;
            --primary-light: #ff6666;
            --primary-dark: #cc0000; /* Darker primary */
            --secondary-color: #000000;
            --secondary-light: #2a2a2a; /* Lighter secondary */
            --secondary-dark: #000000;
            --text-light: #f1f2f6;
            --text-dark: #dfe4ea;
            --text-muted: #a4b0be;
            --bg-light: #1e1e1e; /* Slightly lighter dark bg */
            --bg-dark: #121212; /* Very dark bg */
            --card-bg: #212121; /* Darker card bg */
            --card-bg-dark: #1a1a1a; /* Darker modal bg */
            --gradient: linear-gradient(135deg, #ff3333, #cc0000);
            --gradient-light: linear-gradient(135deg, #ff6666, #ff3333);
            --gradient-dark: linear-gradient(135deg, #ff0000, #990000);
            --shadow-sm: 0 2px 5px rgba(0, 0, 0, 0.35);
            --shadow-md: 0 6px 12px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.45);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.5);
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --border-radius-xs: 6px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.15s ease-out;
            --header-height: 70px;
            --nav-height: 70px;
            --max-width: 1200px;
            --skeleton-bg: #303030;
            --skeleton-highlight: #404040;
            --credit-color: #ffd700; /* Gold color for credits */
            --star-color: #f1c40f; /* Yellow for stars */
            --profile-header-bg: linear-gradient(135deg, rgba(30, 30, 30, 0.9), rgba(18, 18, 18, 0.98));
            --notification-unread-dot: #3498db;
            --notification-bg-success: rgba(39, 174, 96, 0.15);
            --notification-border-success: #27ae60;
            --notification-bg-info: rgba(52, 152, 219, 0.15);
            --notification-border-info: #3498db;
            --notification-bg-warning: rgba(243, 156, 18, 0.15);
            --notification-border-warning: #f39c12;
            --notification-bg-error: rgba(231, 76, 60, 0.15);
            --notification-border-error: #e74c3c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
             scroll-behavior: smooth;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-dark);
            min-height: 100vh;
            padding-top: var(--header-height);
            padding-bottom: var(--nav-height);
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Enhanced Loading Overlay */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-dark);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 9999;
            transition: opacity 0.7s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.7s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 1; visibility: visible;
        }
        .loading-overlay.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        .loading-logo-container { display: flex; align-items: center; margin-bottom: 25px; animation: logoPulse 2s infinite ease-in-out; }
        .loading-logo-icon { font-size: 3.5rem; color: var(--primary-color); margin-right: 15px; }
        .loading-logo-text { font-size: 2.2rem; font-weight: 700; color: var(--primary-light); letter-spacing: 1px; }

        .loading-dots { display: flex; justify-content: center; align-items: center; margin-bottom: 30px; }
        .loading-dots span {
            width: 12px; height: 12px; margin: 0 6px;
            background-color: var(--primary-color);
            border-radius: 50%;
            animation: loadingBounce 1.4s infinite ease-in-out both;
        }
        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

        .loading-message { color: var(--text-muted); font-size: 1rem; font-style: italic; max-width: 80%; text-align: center; animation: fadeInText 1.5s ease-out forwards; opacity: 0; animation-delay: 0.5s;}


        @keyframes logoPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes loadingBounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        @keyframes fadeInText { to { opacity: 1; } }


        /* Enhanced Header with Glass Morphism */
        .header {
            background-color: rgba(18, 18, 18, 0.85);
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            color: var(--text-light);
            height: var(--header-height);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-md);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 0 20px;
            transition: height 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
            border-bottom: 1px solid rgba(255, 51, 51, 0.1);
        }

        .header.scrolled {
            height: 65px;
            background-color: rgba(18, 18, 18, 0.95);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.25);
        }

        .logo-container { display: flex; align-items: center; flex-shrink: 0; }
        .logo { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); display: flex; align-items: center; text-decoration: none; transition: transform 0.3s ease; position: relative; padding: 5px 0; }
        .logo:hover { transform: scale(1.05); }
        .logo i { margin-right: 10px; font-size: 1.6rem; color: var(--primary-color); transition: transform 0.3s ease; }
        .logo:hover i { transform: rotate(-10deg); }
        .logo-text { display: inline-block; position: relative; transition: opacity 0.3s ease; }

        @media (max-width: 420px) { .logo-text { font-size: 1.5rem; } .logo i { margin-right: 5px; } }

        .header-actions { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }

        /* --- Header Credits --- */
        .header-credits { display: flex; align-items: center; gap: 8px; color: var(--text-light); font-weight: 600; font-size: 0.9rem; cursor: pointer; padding: 6px 12px; border-radius: 25px; background-color: rgba(255, 255, 255, 0.07); transition: background-color 0.3s ease, transform 0.2s ease; border: 1px solid rgba(255, 255, 255, 0.1); }
        .header-credits:hover { background-color: rgba(255, 255, 255, 0.15); transform: scale(1.05); }
        .header-credits i { font-size: 1.1rem; color: var(--credit-color); }
        #headerCreditsAmount { min-width: 20px; text-align: right; }


        /* --- Single Search Bar --- */
        .search-container { position: relative; width: 250px; transition: all 0.3s ease; margin-left: auto; margin-right: 10px; }
        .search-input { width: 100%; padding: 10px 15px 10px 40px; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 30px; background-color: rgba(255, 255, 255, 0.05); color: var(--text-light); font-family: 'Poppins', sans-serif; transition: all 0.3s ease; font-size: 0.9rem; }
        .search-input::placeholder { color: rgba(255, 255, 255, 0.5); }
        .search-input:focus { outline: none; background-color: rgba(255, 255, 255, 0.1); box-shadow: 0 0 0 2px var(--primary-light); border-color: var(--primary-light); }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-light); opacity: 0.6; font-size: 1rem; pointer-events: none; }
        .search-results { position: absolute; top: calc(100% + 8px); left: 0; right: 0; background-color: var(--card-bg); border-radius: var(--border-radius-sm); box-shadow: var(--shadow-xl); max-height: 350px; overflow-y: auto; z-index: 1001; display: none; animation: fadeInDown 0.3s ease forwards; border: 1px solid rgba(255, 255, 255, 0.1); }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .search-result-item { padding: 12px 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); cursor: pointer; transition: background-color 0.2s ease; }
        .search-result-item:hover { background-color: rgba(255, 255, 255, 0.08); }
        .search-result-item h4 { font-size: 0.95rem; color: var(--text-dark); margin-bottom: 5px; font-weight: 500; }
        .search-result-item p { font-size: 0.8rem; color: var(--text-muted); }
        .no-results { padding: 20px; text-align: center; color: var(--text-muted); font-size: 0.9rem; }

        /* Mobile Search Handling */
        .search-toggle-btn { background: none; border: none; color: var(--text-light); font-size: 1.2rem; cursor: pointer; padding: 5px; display: none; }
        @media (max-width: 768px) {
            .search-container { position: absolute; top: calc(var(--header-height) + 10px); left: 10px; right: 10px; width: auto; z-index: 999; background-color: var(--bg-light); padding: 10px; border-radius: var(--border-radius-sm); box-shadow: var(--shadow-lg); opacity: 0; visibility: hidden; transform: translateY(-10px); transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease; }
            .search-container.active { opacity: 1; visibility: visible; transform: translateY(0); }
            .search-toggle-btn { display: block; order: -1; margin-right: 5px; }
            .search-results { top: calc(100% + 5px); left: 0; right: 0; width: 100%; }
            .search-container.active ~ .header-actions .header-credits { display: none; }
        }
        @media (max-width: 576px) { .search-container { top: calc(var(--header-height) + 5px); } .header-actions { gap: 8px; } .header-credits { padding: 5px 8px; font-size: 0.8rem; } .header-credits i { font-size: 1rem; } }
        @media (max-width: 420px) { .header-credits { display: none; } .header-actions .search-toggle-btn { margin-right: 0;} }


        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; display: flex; align-items: center; justify-content: center; background: var(--gradient); color: white; font-weight: 600; font-size: 1rem; position: relative; overflow: hidden; flex-shrink: 0; }
        .user-avatar::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 70%); opacity: 0; transition: opacity 0.4s ease; }
        .user-avatar:hover { transform: scale(1.1); box-shadow: 0 0 15px rgba(255, 51, 51, 0.5); }
        .user-avatar:hover::after { opacity: 1; }


        /* --- Popular Books Section --- */
        .popular-books-section { padding: 30px 20px; background: linear-gradient(180deg, rgba(18, 18, 18, 0.9) 0%, rgba(18, 18, 18, 0) 100%), var(--bg-dark); margin-bottom: 20px; }
        .section-title { font-size: 1.8rem; margin-bottom: 25px; color: var(--primary-light); position: relative; display: inline-block; font-weight: 600; padding-bottom: 10px; text-align: center; width: 100%; }
        .section-title::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 70px; height: 4px; background: var(--gradient); border-radius: 4px; animation: scaleIn 0.6s ease-out forwards; }
        @keyframes scaleIn { from { transform: translateX(-50%) scaleX(0); } to { transform: translateX(-50%) scaleX(1); } }
        .popular-books-carousel { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 20px; -ms-overflow-style: none; scrollbar-width: none; }
        .popular-books-carousel::-webkit-scrollbar { display: none; }
        .popular-book-card { flex: 0 0 auto; width: 160px; background-color: var(--card-bg); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow-md); transition: var(--transition); border: 1px solid rgba(255, 255, 255, 0.08); position: relative; cursor: pointer; }
        .popular-book-card:hover { transform: translateY(-8px) scale(1.03); box-shadow: var(--shadow-lg); }
        .popular-book-img-container { height: 200px; overflow: hidden; position: relative; background-color: rgba(255, 255, 255, 0.05); display: flex; align-items: center; justify-content: center; }
        .popular-book-img { width: auto; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
        .popular-book-card:hover .popular-book-img { transform: scale(1.1); }
        .popular-book-info { padding: 12px; }
        .popular-book-title { font-size: 0.9rem; font-weight: 600; color: var(--text-dark); margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .popular-book-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px; }
        .popular-book-meta i { color: var(--primary-color); font-size: 0.8rem; }


        /* --- Main Content & Book Grid --- */
        .container { padding: 20px; max-width: var(--max-width); margin: 0 auto; }
        .page-title { font-size: 2rem; margin-bottom: 25px; color: var(--primary-color); position: relative; display: inline-block; font-weight: 600; padding-bottom: 10px; }
        .page-title::after { content: ''; position: absolute; bottom: 0; left: 0; width: 60px; height: 4px; background: var(--gradient); border-radius: 4px; transform-origin: left; animation: scaleInMain 0.6s ease-out forwards; }
        @keyframes scaleInMain { from { transform: scaleX(0); } to { transform: scaleX(1); } }

        /* Category Filters */
        .category-filter-container {
            margin-bottom: 25px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;
            padding: 10px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .category-filter-item {
            padding: 8px 18px; border-radius: 20px; background-color: var(--card-bg);
            color: var(--text-muted); font-size: 0.9rem; font-weight: 500; cursor: pointer;
            transition: all 0.3s ease; border: 1px solid transparent;
        }
        .category-filter-item:hover { background-color: var(--secondary-light); color: var(--text-light); transform: translateY(-2px); }
        .category-filter-item.active {
            background: var(--gradient); color: white; font-weight: 600;
            box-shadow: 0 4px 10px rgba(255, 51, 51, 0.3); border-color: var(--primary-dark);
        }

        .books-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); gap: 25px; margin-top: 20px; }
        #booksGridLoadingIndicator {
            grid-column: 1 / -1; /* Span all columns */
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 1rem;
            display: none; /* Initially hidden */
        }
        #booksGridLoadingIndicator .spinner {
            width: 24px; height: 24px;
            border-color: var(--text-muted);
            border-top-color: var(--primary-color);
            margin-right: 10px;
            vertical-align: middle;
        }


        /* Skeleton Loader Base Styles */
        .skeleton { background-color: var(--skeleton-bg); animation: pulse-bg 1.5s infinite ease-in-out; border-radius: 4px; }
        .skeleton-img { height: 220px; border-radius: var(--border-radius-sm) var(--border-radius-sm) 0 0; }
        .skeleton-text { height: 1em; margin-bottom: 10px; }
        .skeleton-btn { height: 38px; border-radius: var(--border-radius-sm); margin-top: 15px; }
        /* Skeleton Loader for Books */
        .skeleton-book-card { background-color: var(--card-bg); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow-md); border: 1px solid rgba(255, 255, 255, 0.08); height: 390px; display: flex; flex-direction: column; }
        .skeleton-book-card .skeleton-img { flex-shrink: 0; background-color: var(--skeleton-bg); animation: pulse-bg 1.5s infinite ease-in-out; }
        .skeleton-book-card .skeleton-info { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .skeleton-book-card .skeleton-text.title { width: 85%; height: 1.2em; margin-top: 5px; }
        .skeleton-book-card .skeleton-text.author { width: 60%; height: 0.9em; margin-top: 8px; }
        .skeleton-book-card .skeleton-text.meta { width: 40%; height: 0.8em; margin-top: 15px; }
        .skeleton-book-card .skeleton-btn { margin-top: auto; background-color: var(--skeleton-bg); animation: pulse-bg 1.5s infinite ease-in-out; }
        /* Skeleton Loader for Popular Books */
        .skeleton-popular-book { flex: 0 0 auto; width: 160px; }
        .skeleton-popular-book .skeleton-img { height: 200px; border-radius: var(--border-radius-sm) var(--border-radius-sm) 0 0; background-color: var(--skeleton-bg); animation: pulse-bg 1.5s infinite ease-in-out; }
        .skeleton-popular-book .skeleton-info { padding: 12px; }
        .skeleton-popular-book .skeleton-text.title { width: 80%; height: 1em; margin-bottom: 8px; }
        .skeleton-popular-book .skeleton-text.meta { width: 50%; height: 0.8em; margin-top: 8px; }
        /* Skeleton Loader for Withdrawal History */
        .skeleton-history-item { height: 80px; background-color: var(--skeleton-bg); border-radius: var(--border-radius-sm); animation: pulse-bg 1.5s infinite ease-in-out; margin-bottom: 15px; }
        /* Skeleton for Notification Items */
        .skeleton-notification-item {
            display: flex; align-items: flex-start; padding: 15px;
            background-color: var(--skeleton-bg); border-radius: var(--border-radius-sm);
            margin-bottom: 12px; animation: pulse-bg 1.5s infinite ease-in-out;
        }
        .skeleton-notification-item .skeleton-icon { width: 36px; height: 36px; border-radius: 50%; background-color: var(--skeleton-highlight); margin-right: 15px; }
        .skeleton-notification-item .skeleton-content { flex: 1; }
        .skeleton-notification-item .skeleton-text.title { width: 60%; height: 1.1em; margin-bottom: 8px; background-color: var(--skeleton-highlight); }
        .skeleton-notification-item .skeleton-text.message { width: 90%; height: 0.9em; margin-bottom: 10px; background-color: var(--skeleton-highlight); }
        .skeleton-notification-item .skeleton-text.timestamp { width: 30%; height: 0.7em; background-color: var(--skeleton-highlight); }

        @keyframes pulse-bg { 0% { background-color: var(--skeleton-bg); } 50% { background-color: var(--skeleton-highlight); } 100% { background-color: var(--skeleton-bg); } }


        .book-card { background-color: var(--card-bg); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow-md); transition: transform 0.3s ease, box-shadow 0.3s ease; position: relative; border: 1px solid rgba(255, 255, 255, 0.08); display: flex; flex-direction: column; height: 100%; opacity: 0; transform: translateY(20px); animation: cardFadeInUp 0.5s ease forwards; }
        @keyframes cardFadeInUp { to { opacity: 1; transform: translateY(0); } }
        .books-grid .book-card:nth-child(1), #profileBooksContainer .book-card:nth-child(1) { animation-delay: 0.05s; }
        .books-grid .book-card:nth-child(2), #profileBooksContainer .book-card:nth-child(2) { animation-delay: 0.1s; }
        .books-grid .book-card:nth-child(3), #profileBooksContainer .book-card:nth-child(3) { animation-delay: 0.15s; }
        .book-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: var(--shadow-lg); }

        .book-img-container { height: 220px; overflow: hidden; position: relative; background-color: rgba(255, 255, 255, 0.05); display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .book-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
        .book-card:hover .book-img { transform: scale(1.08); }

        .book-info { padding: 15px; flex: 1; display: flex; flex-direction: column; background-color: var(--card-bg); }
        .book-title { font-size: 1rem; font-weight: 600; margin-bottom: 8px; color: var(--text-dark); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; min-height: 2.4em; }
        .book-author { font-size: 0.85rem; color: var(--primary-light); margin-bottom: 12px; font-weight: 500; }
        .book-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 0.75rem; color: var(--text-muted); }
        .book-meta span { display: flex; align-items: center; gap: 5px; }
        .book-meta i { color: var(--primary-color); font-size: 0.8rem; }
        .book-admin-info { font-size: 0.7rem; color: var(--text-muted); margin-top: auto; padding-top: 10px; border-top: 1px dashed rgba(255, 255, 255, 0.15); display: flex; align-items: center; gap: 5px; }
        .book-admin-info i { color: var(--primary-color); font-size: 0.8rem; }

        .action-btn { /* Generalized button style */
            background: var(--gradient); color: white; border: none; padding: 10px 14px; border-radius: var(--border-radius-sm); display: flex; align-items: center; justify-content: center; width: 100%; cursor: pointer; transition: var(--transition); font-weight: 500; font-size: 0.9rem; position: relative; overflow: hidden; box-shadow: var(--shadow-sm); margin-top: auto; gap: 8px;
        }
        .action-btn::after { /* Shimmer effect */
            content: ''; position: absolute; top: -50%; left: -75%; width: 50%; height: 200%; background: linear-gradient(to right, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0) 100%); transform: skewX(-25deg); transition: left 0.7s ease; pointer-events: none;
        }
        .action-btn:hover::after { left: 125%; }
        .action-btn i { font-size: 0.9rem; }
        .action-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 8px 18px rgba(255, 51, 51, 0.4); background: var(--gradient-light); }
        .action-btn:disabled { background: var(--secondary-light) !important; opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; }


        /* Status Badges */
        .status-badge { position: absolute; top: 10px; right: 10px; padding: 4px 9px; border-radius: var(--border-radius-xs); font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; z-index: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.3); backdrop-filter: blur(3px); }
        .status-badge.status-approved { background-color: rgba(39, 174, 96, 0.85); color: white; } /* Added .status-badge */
        .status-badge.status-pending { background-color: rgba(243, 156, 18, 0.85); color: white; } /* Added .status-badge */
        .status-badge.status-rejected { background-color: rgba(231, 76, 60, 0.85); color: white; } /* Added .status-badge */


        /* --- Bottom Navigation --- */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: rgba(26, 26, 26, 0.9); backdrop-filter: blur(12px) saturate(180%); -webkit-backdrop-filter: blur(12px) saturate(180%); display: flex; justify-content: space-around; align-items: center; height: var(--nav-height); z-index: 1000; box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.2); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .nav-item { color: var(--text-muted); font-size: 1.3rem; padding: 10px; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.3s ease, color 0.3s ease; position: relative; }
        .nav-item:hover { color: var(--primary-light); transform: translateY(-4px); }
        .nav-item.active { color: var(--primary-color); transform: translateY(-4px); }
        .nav-item.active::after { content: ''; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; background-color: var(--primary-color); border-radius: 50%; box-shadow: 0 0 10px var(--primary-color); animation: fadeIn 0.3s ease; }
        .nav-item .unread-badge {
            position: absolute; top: 8px; right: 8px;
            background-color: var(--notification-unread-dot);
            color: white; font-size: 0.6rem; font-weight: bold;
            width: 16px; height: 16px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 0 2px var(--bg-light); /* To make it stand out from nav item */
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .add-btn { background: var(--gradient); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.7rem; transform: translateY(-20px); box-shadow: 0 8px 25px rgba(255, 51, 51, 0.45); transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease; cursor: pointer; border: none; outline: none; z-index: 1001; position: relative; overflow: hidden; }
        .add-btn::before { content: ''; position: absolute; inset: 0; border-radius: 50%; background: var(--gradient); opacity: 0.6; z-index: -1; animation: pulse-glow 2s infinite ease-out; }
        .add-btn:hover { transform: translateY(-25px) scale(1.1); box-shadow: 0 12px 30px rgba(255, 51, 51, 0.6); background: var(--gradient-light); }
        .add-btn:hover::before { animation-play-state: paused; }
        @keyframes pulse-glow { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 51, 51, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 51, 51, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 51, 51, 0); } }


        /* --- Redesigned Profile Page --- */
        .profile-page { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-dark); z-index: 2000; transform: translateX(100%); transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); overflow-y: auto; padding: 0; opacity: 0; visibility: hidden; }
        .profile-page.active { transform: translateX(0); opacity: 1; visibility: visible; }
        .profile-page-content { padding: 20px; padding-top: var(--header-height); padding-bottom: calc(var(--nav-height) + 40px); max-width: var(--max-width); margin: 0 auto;}

        .page-back-btn { /* Generalized for profile and notifications */
            background: rgba(0, 0, 0, 0.4); border: none; color: var(--primary-light); font-size: 1.3rem;
            position: absolute; left: 15px; top: calc(15px + (var(--header-height) - 60px) / 2); /* Adjusted top for consistency */
            cursor: pointer; transition: transform 0.3s ease, background-color 0.3s ease;
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; backdrop-filter: blur(5px); z-index: 5;
        }
        .page-back-btn:hover { transform: scale(1.1); background-color: rgba(255, 51, 51, 0.3); color: white; }


        .profile-main-header {
            display: flex; flex-direction: column; align-items: center; text-align: center;
            background: var(--profile-header-bg);
            padding: 40px 20px 30px; border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg); margin-bottom: 30px; position: relative;
        }
        .profile-main-header::before { /* Subtle pattern overlay */
            content: ''; position: absolute; top:0; left:0; right:0; bottom:0;
            background-image: url("data:image/svg+xml,%3Csvg width='52' height='26' viewBox='0 0 52 26' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23ff3333' fill-opacity='0.04'%3E%3Cpath d='M10 10c0-2.21-1.79-4-4-4-3.314 0-6-2.686-6-6h2c0 2.21 1.79 4 4 4 3.314 0 6 2.686 6 6 0 2.21 1.79 4 4 4 3.314 0 6 2.686 6 6 0 2.21 1.79 4 4 4v2c-3.314 0-6-2.686-6-6 0-2.21-1.79-4-4-4-3.314 0-6-2.686-6-6zm25.464-1.95l8.486 8.486-1.414 1.414-8.486-8.486 1.414-1.414z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.5; z-index: 0; border-radius: var(--border-radius);
        }
        .profile-avatar-lg {
            width: 130px; height: 130px; border-radius: 50%; object-fit: cover;
            border: 5px solid var(--primary-color); margin-bottom: 20px;
            background: var(--gradient); color: white; font-size: 3.2rem;
            display: flex; align-items: center; justify-content: center; font-weight: 700;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.5);
            position: relative; z-index: 1; transition: transform 0.4s ease, box-shadow 0.4s ease;
        }
        .profile-avatar-lg:hover { transform: scale(1.08) translateY(-5px); box-shadow: 0 0 35px rgba(255, 51, 51, 0.6); }
        #profileNameLarge { font-size: 2.2rem; margin-bottom: 5px; color: var(--text-light); font-weight: 700; text-shadow: 0 3px 8px rgba(0,0,0,0.6); z-index: 1;}
        #profileUsernameLarge { color: var(--primary-light); margin-bottom: 10px; font-size: 1.2rem; font-weight: 500; display: inline-block; padding: 5px 15px; background: rgba(0,0,0,0.4); border-radius: 25px; z-index: 1;}
        #profileEmailLarge, #profileJoinedLarge { color: var(--text-muted); margin-bottom: 8px; font-size: 0.95rem; display: inline-flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.25); padding: 6px 12px; border-radius: 20px; z-index: 1;}
        #profileEmailLarge i, #profileJoinedLarge i { color: var(--primary-color); }
        .profile-bio-box {
            margin-top: 20px; color: var(--text-light); line-height: 1.7; font-size: 0.95rem;
            padding: 20px 25px; background-color: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius-sm); border-left: 4px solid var(--primary-color);
            text-align: left; position: relative; box-shadow: var(--shadow-sm); max-width: 600px; width:100%;
            z-index: 1;
        }
        .profile-bio-box::before { content: '\f10d'; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; top: 15px; right: 20px; font-size: 1.8rem; color: var(--primary-color); opacity: 0.1; }

        .profile-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .profile-dashboard-item { background-color: var(--card-bg); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow-md); transition: transform 0.3s ease, box-shadow 0.3s ease; border: 1px solid rgba(255,255,255,0.08);}
        .profile-dashboard-item:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .profile-dashboard-item h3 { font-size: 1.3rem; color: var(--primary-light); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .points-amount-large { font-size: 3.5rem; font-weight: 700; color: var(--primary-color); margin-bottom: 10px; line-height: 1.1; text-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .profile-dashboard-item p { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px; }
        .withdraw-btn-large { width: 100%; font-size: 1rem; padding: 12px 20px; } /* Relies on .action-btn */

        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }
        .stat-card { background-color: rgba(255,255,255,0.05); padding: 15px; border-radius: var(--border-radius-sm); text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .stat-value { display: block; font-size: 2rem; font-weight: 700; color: var(--primary-color); margin-bottom: 5px; }
        .stat-label-card { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

        .profile-tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; overflow-x: auto; }
        .profile-tab-btn { background: none; border: none; color: var(--text-muted); font-size: 1rem; font-weight: 500; padding: 10px 18px; cursor: pointer; transition: color 0.3s ease, border-bottom-color 0.3s ease; border-bottom: 3px solid transparent; white-space: nowrap; }
        .profile-tab-btn:hover { color: var(--primary-light); }
        .profile-tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: 600; }

        .profile-tab-content { display: none; animation: tabFadeIn 0.5s ease forwards; }
        .profile-tab-content.active { display: block; }
        @keyframes tabFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .profile-section-title { font-size: 1.6rem; margin-bottom: 20px; color: var(--primary-light); font-weight: 600; position: relative; padding-bottom: 10px; text-align: center; }
        .profile-section-title::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 70px; height: 3px; background: var(--gradient); border-radius: 3px; }

        #profileBooksContainer { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-top: 20px; min-height: 200px; }
        #profileBooksContainer .book-card { opacity: 0; transform: translateY(20px); animation: cardFadeInUp 0.5s ease forwards; }

        .load-more-container { text-align: center; margin: 30px 0; }
        .load-more-btn { background: var(--gradient); color: white; border: none; padding: 12px 25px; border-radius: var(--border-radius-sm); font-size: 1rem; cursor: pointer; transition: var(--transition); font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 10px; box-shadow: var(--shadow-md); }
        .load-more-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(255, 51, 51, 0.5); background: var(--gradient-light); }
        .load-more-btn:disabled { background: var(--secondary-light); opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none; }

        #withdrawalHistoryContainer { display: flex; flex-direction: column; gap: 15px; min-height: 100px; flex-wrap: wrap; margin-top: 20px; }
        .withdrawal-item { padding: 15px 20px; border-radius: var(--border-radius-sm); background-color: rgba(255, 255, 255, 0.04); display: flex; justify-content: space-between; align-items: center; transition: var(--transition); border-left: 4px solid var(--primary-color); opacity: 0; transform: scale(0.95); animation: itemFadeInScale 0.4s ease forwards; width: 100%; word-break: break-word; }
        #withdrawalHistoryContainer .withdrawal-item:nth-child(1) { animation-delay: 0.1s; }
        #withdrawalHistoryContainer .withdrawal-item:nth-child(2) { animation-delay: 0.15s; }
        #withdrawalHistoryContainer .withdrawal-item:nth-child(3) { animation-delay: 0.2s; }
        @keyframes itemFadeInScale { to { opacity: 1; transform: scale(1); } }
        .withdrawal-item:hover { transform: translateX(5px) scale(1.01); box-shadow: var(--shadow-sm); border-left-color: var(--primary-light); }
        .withdrawal-info { flex: 1; margin-right: 15px; }
        .withdrawal-amount { font-weight: 600; color: var(--primary-color); margin-bottom: 5px; font-size: 1.05rem; }
        .withdrawal-method { font-size: 0.85rem; color: var(--text-light); margin-bottom: 5px; word-break: break-all; }
        .withdrawal-date { font-size: 0.8rem; color: var(--text-muted); }
        .withdrawal-status { padding: 6px 12px; border-radius: var(--border-radius-xs); font-size: 0.8rem; font-weight: 600; text-transform: uppercase; flex-shrink: 0; text-align: center; min-width: 80px; }
        /* Using CSS variables for withdrawal statuses for consistency */
        .withdrawal-status.status-pending { background-color: var(--status-pending-bg, #f39c12); color: white; }
        .withdrawal-status.status-completed { background-color: var(--status-completed-bg, #27ae60); color: white; }
        .withdrawal-status.status-rejected { background-color: var(--status-rejected-bg, #e74c3c); color: white; }


        .point-system-info-tabbed { background-color: rgba(255, 255, 255, 0.04); border-radius: var(--border-radius); padding: 25px; margin-top:20px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .point-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed rgba(255, 255, 255, 0.15); }
        .point-item:last-child { border-bottom: none; }
        .point-action { font-weight: 500; color: var(--text-light); font-size: 0.9rem; }
        .point-value { color: var(--primary-color); font-weight: 600; font-size: 1rem; }

        .profile-actions-footer { display: flex; gap: 15px; margin-top: 40px; justify-content: center; padding-bottom: 20px; flex-wrap: wrap; border-top: 1px solid rgba(255,255,255,0.1); padding-top:30px;}
        .profile-action-btn { color: white; border: none; padding: 12px 25px; border-radius: var(--border-radius-sm); font-size: 1rem; cursor: pointer; transition: var(--transition); font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 10px; box-shadow: var(--shadow-md); position: relative; overflow: hidden; flex: 1; min-width: 180px; max-width: 220px; }
        .profile-action-btn::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.1); opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .profile-action-btn:hover:not(:disabled) { transform: translateY(-3px); } /* :not(:disabled) added */
        .profile-action-btn:hover:not(:disabled)::after { opacity: 1; } /* :not(:disabled) added */
        .edit-profile { background: var(--gradient); }
        .edit-profile:hover:not(:disabled) { background: var(--gradient-light); box-shadow: 0 8px 20px rgba(255, 51, 51, 0.5); } /* :not(:disabled) added */
        .logout-btn { background: var(--secondary-light); }
        .logout-btn:hover:not(:disabled) { background: #333; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); } /* :not(:disabled) added */
        /* End of Profile Redesign */


        /* --- Full Page Notifications --- */
        .notifications-page {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--bg-dark);
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0; visibility: hidden;
            display: flex; flex-direction: column;
        }
        .notifications-page.active {
            transform: translateX(0);
            opacity: 1; visibility: visible;
        }
        .notifications-header {
            padding: 0 15px;
            background: var(--card-bg-dark);
            color: white;
            display: flex; align-items: center; justify-content: space-between;
            height: var(--header-height);
            box-shadow: var(--shadow-md);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0; position: relative;
        }
        /* .notifications-title removed as per previous notes, handled by tabs or implied */
        .notifications-actions {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
        }
        .mark-all-read-btn {
            background: none; border: none; color: var(--primary-light);
            font-size: 0.85rem; font-weight: 500; cursor: pointer;
            padding: 8px 12px; border-radius: var(--border-radius-sm);
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .mark-all-read-btn:hover:not(:disabled) { background-color: rgba(255,255,255,0.1); color: white; }
        .mark-all-read-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .mark-all-read-btn i { margin-right: 6px; }

        .notifications-tabs {
            display: flex;
            background-color: var(--card-bg);
            padding: 0 10px;
            flex-shrink: 0;
        }
        .notification-tab-btn {
            flex: 1; text-align: center;
            background: none; border: none;
            color: var(--text-muted);
            font-size: 0.95rem; font-weight: 500;
            padding: 12px 10px;
            cursor: pointer;
            transition: color 0.3s ease, border-bottom-color 0.3s ease;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }
        .notification-tab-btn:hover { color: var(--primary-light); }
        .notification-tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }
        .notifications-content-area {
            flex: 1; overflow-y: hidden; /* Parent handles scroll if needed, individual lists scroll */
            position: relative;
        }
        .notifications-list-container {
            position: absolute; top: 0; left:0; width: 100%; height: 100%;
            overflow-y: auto; padding: 15px;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .notifications-list-container.active {
            opacity: 1; visibility: visible;
        }


        .notification-group { margin-bottom: 20px; }
        .notification-group-date {
            font-size: 0.9rem; font-weight: 600; color: var(--text-muted);
            margin-bottom: 10px; padding-bottom: 5px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .notification-item {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-sm);
            padding: 15px; margin-bottom: 12px;
            display: flex; align-items: flex-start;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid transparent;
            transition: background-color 0.3s ease, transform 0.2s ease;
            cursor: pointer;
            opacity: 0; animation: itemFadeInScale 0.4s ease forwards;
        }
        .notification-item:hover {
            background-color: var(--secondary-light);
            transform: translateX(3px);
        }
        .notification-item.unread {
             background-color: rgba(52, 152, 219, 0.08); /* Subtle blue for unread */
             border-left-color: var(--notification-unread-dot);
        }
        .notification-item.unread .notification-title { color: var(--primary-light); }

        .notification-item.type-success { border-left-color: var(--notification-border-success); }
        .notification-item.type-success.unread { background-color: var(--notification-bg-success); }
        .notification-item.type-info { border-left-color: var(--notification-border-info); }
        .notification-item.type-info.unread { background-color: var(--notification-bg-info); }
        .notification-item.type-warning { border-left-color: var(--notification-border-warning); }
        .notification-item.type-warning.unread { background-color: var(--notification-bg-warning); }
        .notification-item.type-error { border-left-color: var(--notification-border-error); }
        .notification-item.type-error.unread { background-color: var(--notification-bg-error); }
        /* Admin Announcement specific style if needed */
        .notification-item.type-announcement { border-left-color: var(--primary-color); /* Or a distinct color */ }
        .notification-item.type-announcement .notification-icon { color: var(--primary-color); }


        .notification-icon {
            font-size: 1.4rem; width: 40px; height: 40px;
            flex-shrink: 0; margin-right: 15px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; background-color: rgba(255,255,255,0.05);
        }
        .notification-item.type-success .notification-icon { color: var(--notification-border-success); }
        .notification-item.type-info .notification-icon { color: var(--notification-border-info); }
        .notification-item.type-warning .notification-icon { color: var(--notification-border-warning); }
        .notification-item.type-error .notification-icon { color: var(--notification-border-error); }

        .notification-content { flex: 1; }
        .notification-title {
            font-size: 1rem; font-weight: 600; color: var(--text-light);
            margin-bottom: 5px;
        }
        .notification-message {
            font-size: 0.9rem; color: var(--text-muted);
            line-height: 1.5; margin-bottom: 8px;
            word-break: break-word; /* Added for long messages */
        }
        .notification-timestamp {
            font-size: 0.75rem; color: var(--text-muted); opacity: 0.8;
        }
        /* End of Full Page Notifications */


        /* --- Modals --- */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.85); z-index: 2500; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); padding: 20px 0; /* Padding for scroll */ }
        .modal.active { display: flex; opacity: 1; }
        .modal-content { background-color: var(--card-bg-dark); border-radius: var(--border-radius); width: 90%; max-width: 480px; padding: 30px; box-shadow: var(--shadow-xl); transform: translateY(-20px) scale(0.95); transition: transform 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease; position: relative; max-height: 90vh; overflow-y: auto; border: 1px solid rgba(255, 255, 255, 0.1); }
        .modal.active .modal-content { transform: translateY(0) scale(1); }
        .modal-content::-webkit-scrollbar { width: 6px; }
        .modal-content::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 6px; }
        .modal-content::-webkit-scrollbar-track { background-color: rgba(255,255,255,0.05); }

        .close-modal { position: absolute; top: 10px; right: 10px; font-size: 1.8rem; color: var(--text-muted); cursor: pointer; background: none; border: none; transition: transform 0.3s ease, color 0.3s ease; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; line-height: 1; z-index: 10; }
        .close-modal:hover { color: var(--primary-color); transform: rotate(90deg) scale(1.1); }

        .modal-title { font-size: 1.6rem; margin-bottom: 25px; color: var(--primary-light); text-align: center; position: relative; padding-bottom: 12px; font-weight: 600; }
        .modal-title::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 60px; height: 4px; background: var(--gradient); border-radius: 4px; }
        .form-group { margin-bottom: 20px; position: relative; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-dark); font-size: 0.9rem; }
        .form-input, .form-textarea { width: 100%; padding: 12px 15px; border: 1px solid rgba(255, 255, 255, 0.15); border-radius: var(--border-radius-sm); font-family: 'Poppins', sans-serif; background-color: var(--bg-light); color: var(--text-dark); transition: var(--transition); font-size: 0.95rem; }
        .form-textarea { resize: vertical; min-height: 80px; }
        .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(255, 51, 51, 0.3); }

        .submit-btn, .tutorial-btn, .profile-action-btn, .load-more-btn, .withdraw-btn, .book-overlay-btn, .download-btn, .action-btn { position: relative; }
        .submit-btn .spinner, .tutorial-btn .spinner, .profile-action-btn .spinner, .load-more-btn .spinner, .withdraw-btn .spinner, .withdraw-btn-large .spinner, .action-btn .spinner {
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
        }
        .submit-btn > span:not(.spinner), .tutorial-btn > span:not(.spinner), .profile-action-btn > span:not(.spinner), .load-more-btn > span:not(.spinner), .withdraw-btn > span:not(.spinner), .withdraw-btn-large > span:not(.spinner), .action-btn > span:not(.spinner) {
            transition: opacity 0.2s ease;
            display: inline-flex; /* To allow gap with icon */
            align-items: center;
            gap: 8px; /* Consistent gap */
        }
        .submit-btn.loading > span:not(.spinner), .tutorial-btn.loading > span:not(.spinner), .profile-action-btn.loading > span:not(.spinner), .load-more-btn.loading > span:not(.spinner), .withdraw-btn.loading > span:not(.spinner), .withdraw-btn-large.loading > span:not(.spinner), .action-btn.loading > span:not(.spinner) {
            opacity: 0;
        }


        .submit-btn, .tutorial-btn { color: white; border: none; padding: 12px 18px; border-radius: var(--border-radius-sm); font-size: 1rem; font-weight: 500; cursor: pointer; width: 100%; transition: var(--transition); margin-top: 10px; display: flex; align-items: center; justify-content: center; /* gap: 8px; already handled by child span */ box-shadow: var(--shadow-sm); position: relative; overflow: hidden; }
        .submit-btn { background: var(--gradient); }
        .tutorial-btn { background: var(--secondary-light); }
        .submit-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(255, 51, 51, 0.5); background: var(--gradient-light); }
        .tutorial-btn:hover:not(:disabled) { background: #333; transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .submit-btn:disabled, .tutorial-btn:disabled { background: var(--secondary-light) !important; opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; }

        .submit-btn::after { content: ''; position: absolute; top: -50%; left: -75%; width: 50%; height: 200%; background: linear-gradient(to right, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0) 100%); transform: skewX(-25deg); transition: left 0.7s ease; pointer-events: none; }
        .submit-btn:hover:not(:disabled)::after { left: 125%; }

        .auth-switch { text-align: center; margin-top: 20px; color: var(--text-muted); font-size: 0.9rem; }
        .auth-switch a { color: var(--primary-color); font-weight: 500; cursor: pointer; transition: color 0.3s ease; text-decoration: none; }
        .auth-switch a:hover { color: var(--primary-light); text-decoration: underline; }

        /* Withdrawal Modal Specifics */
        .withdrawal-options { display: flex; flex-direction: column; gap: 12px; margin: 25px 0; }
        .withdrawal-option { display: flex; align-items: center; padding: 15px; border-radius: var(--border-radius-sm); background-color: rgba(255, 255, 255, 0.05); cursor: pointer; transition: var(--transition); border: 2px solid transparent; }
        .withdrawal-option:hover { background-color: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.2); transform: scale(1.02); }
        .withdrawal-option.active { border: 2px solid var(--primary-color); background-color: rgba(255, 51, 51, 0.1); transform: scale(1.02); }
        .withdrawal-icon { width: 40px; height: 40px; border-radius: 50%; background: var(--gradient); color: white; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0; font-size: 1.1rem; box-shadow: var(--shadow-sm); }
        .withdrawal-details { flex: 1; }
        .withdrawal-title { font-size: 1rem; font-weight: 600; margin-bottom: 3px; color: var(--text-dark); }
        .withdrawal-description { font-size: 0.85rem; color: var(--text-muted); }

        .amount-selection { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin: 25px 0; }
        .amount-option { padding: 12px; text-align: center; border-radius: var(--border-radius-sm); background-color: rgba(255, 255, 255, 0.05); cursor: pointer; transition: var(--transition); font-weight: 500; border: 2px solid transparent; font-size: 0.9rem; }
        .amount-option:hover { background-color: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.2); transform: scale(1.03); }
        .amount-option.active { background: var(--gradient); color: white; border-color: var(--primary-dark); transform: scale(1.03); }

        .payment-details { margin-top: 20px; display: none; animation: fadeIn 0.5s ease forwards; }
        .payment-details.active { display: block; }


        /* Discover Modal Specifics */
        .discover-list { max-height: 60vh; overflow-y: auto; padding-right: 10px; margin: 15px 0; }
        .discover-item { display: flex; padding: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.08); transition: all 0.3s ease; align-items: center; cursor: pointer; border-radius: var(--border-radius-sm); margin-bottom: 10px; background-color: rgba(255, 255, 255, 0.03); }
        .discover-item:last-child { border-bottom: none; margin-bottom: 0; }
        .discover-item:hover { background-color: rgba(255, 255, 255, 0.08); transform: translateX(5px) scale(1.01); }
        .discover-icon { width: 40px; height: 40px; border-radius: 50%; background: var(--gradient); color: white; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0; font-size: 1.1rem; box-shadow: var(--shadow-sm); }
        .discover-content { flex: 1; }
        .discover-title { font-size: 1rem; color: var(--text-dark); margin-bottom: 5px; font-weight: 600; }
        .discover-description { font-size: 0.85rem; color: var(--text-muted); line-height: 1.5; }

        /* Credit Modal Specifics */
        .credit-options-list { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        #creditModalUserCredits { color: var(--credit-color); font-weight: 700; }


        /* --- Book Detail Modal --- */
        #bookDetailModal .modal-content { max-width: 650px; }
        .book-detail-layout { display: flex; gap: 25px; }
        .book-detail-image { flex-shrink: 0; width: 200px; height: 280px; }
        .book-detail-image img { width: 100%; height: 100%; object-fit: cover; border-radius: var(--border-radius-sm); box-shadow: var(--shadow-md); }
        .book-detail-info { flex-grow: 1; }
        .book-detail-title { font-size: 1.7rem; font-weight: 700; color: var(--primary-light); margin-bottom: 5px; line-height: 1.3; }
        .book-detail-author { font-size: 1rem; color: var(--text-dark); margin-bottom: 8px; font-weight: 500; }
        .book-detail-category { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 15px; display: inline-block; background: rgba(255,255,255,0.05); padding: 4px 10px; border-radius: 15px; }
        .book-detail-meta { display: flex; gap: 20px; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
        .book-detail-meta span { display: flex; align-items: center; gap: 6px; }
        .book-detail-meta i { color: var(--primary-color); font-size: 1rem; }
        .book-detail-description { margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.04); border-radius: var(--border-radius-sm); line-height: 1.7; font-size: 0.95rem; max-height: 150px; overflow-y: auto; color: var(--text-light); border-left: 3px solid var(--primary-color); word-break: break-word; } /* Added word-break */
        .book-detail-actions { display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        .detail-download-btn { flex-grow: 1; } /* Relies on .action-btn */
        .feedback-separator { height: 1px; background: rgba(255,255,255,0.1); margin: 30px 0; }

        .feedback-section { margin-top: 25px; }
        .feedback-title { font-size: 1.3rem; color: var(--primary-light); margin-bottom: 20px; font-weight: 600; border-bottom: 2px solid var(--primary-color); padding-bottom: 8px; display: inline-block; }
        .rating-stars { margin-bottom: 15px; }
        .rating-stars label { font-size: 1rem; color: var(--text-dark); margin-right: 10px; }
        .rating-stars .stars { display: inline-block; }
        .rating-stars .stars > i { font-size: 1.6rem; color: var(--text-muted); cursor: pointer; transition: color 0.2s ease, transform 0.2s ease; margin: 0 3px; }
        .rating-stars .stars:hover > i { color: var(--star-color); }
        .rating-stars .stars > i:hover ~ i { color: var(--text-muted); }
        .rating-stars .stars > i.selected,
        .rating-stars .stars > i.hovered { color: var(--star-color); transform: scale(1.1); }

        #feedbackComment { margin-bottom: 15px; }
        #submitFeedbackBtn { width: auto; padding: 10px 25px; } /* Relies on .submit-btn */

        .comments-list { margin-top: 25px; max-height: 250px; overflow-y: auto; padding-right: 10px; display: flex; flex-direction: column; gap: 15px; }
        .comment-item { background-color: rgba(255, 255, 255, 0.04); padding: 15px; border-radius: var(--border-radius-sm); border-left: 3px solid var(--secondary-light); }
        .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .comment-author { font-weight: 600; color: var(--text-dark); font-size: 0.95rem; }
        .comment-rating i { color: var(--star-color); font-size: 0.8rem; margin-left: 2px; }
        .comment-body { font-size: 0.9rem; color: var(--text-light); line-height: 1.6; word-break: break-word; }
        .comment-date { font-size: 0.75rem; color: var(--text-muted); margin-top: 10px; text-align: right; }
        .no-comments { text-align: center; color: var(--text-muted); padding: 20px 0; }

        @media (max-width: 680px) {
            .book-detail-layout { flex-direction: column; align-items: center; }
            .book-detail-image { width: 180px; height: 250px; margin-bottom: 15px; }
            .book-detail-info { text-align: center; }
            .book-detail-meta { justify-content: center; }
            .book-detail-actions { justify-content: center; }
        }


        /* Toast Notifications */
        #toastContainer { position: fixed; top: 25px; right: 25px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
        .toast { /* position, top, right moved to #toastContainer */ padding: 15px 25px; border-radius: var(--border-radius-sm); background-color: var(--secondary-light); color: white; box-shadow: var(--shadow-xl); transform: translateX(calc(100% + 30px)); transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); display: flex; align-items: center; max-width: 380px; border-left: 5px solid var(--primary-color); }
        .toast.show { transform: translateX(0); }
        .toast.success { background-color: #27ae60; border-left-color: #2ecc71; }
        .toast.error { background-color: #e74c3c; border-left-color: #ff4757; }
        .toast.warning { background-color: #f39c12; border-left-color: #f1c40f; }
        .toast.info { background-color: #3498db; border-left-color: #2980b9; }
        .toast i { margin-right: 12px; font-size: 1.3rem; }
        .toast span:not(.toast-close) { flex-grow: 1; word-break: break-word; }
        .toast-close { margin-left: 15px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s ease; font-size: 1.2rem; background: none; border: none; color: white; padding: 5px; }
        .toast-close:hover { opacity: 1; }

        /* Loading Spinner */
        .spinner { display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Empty State */
        .empty-state { text-align: center; padding: 50px 20px; color: var(--text-muted); width: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; grid-column: 1 / -1; /* Ensure it spans grid if parent is grid */ }
        .empty-state i { font-size: 3.5rem; margin-bottom: 20px; color: var(--primary-color); opacity: 0.5; animation: bounce 2s infinite cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        @keyframes bounce { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-15px) scale(1.05); } }
        .empty-state h3 { margin-bottom: 12px; color: var(--text-light); font-size: 1.3rem; font-weight: 600; }
        .empty-state p { font-size: 0.95rem; max-width: 350px; margin: 0 auto; color: var(--text-muted); }


        /* Responsive Styles */
        @media (max-width: 992px) {
            .container { padding: 20px 15px; }
            .books-grid, #profileBooksContainer { grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 20px; }
            .popular-book-card { width: 150px; }
            .popular-book-img-container { height: 180px; }
            .profile-dashboard { grid-template-columns: 1fr; } /* Stack dashboard items */
        }

        @media (max-width: 768px) {
            :root { --header-height: 65px; --nav-height: 65px; }
            body { padding-top: var(--header-height); padding-bottom: var(--nav-height); }
            .header { padding: 0 15px; }
            .logo { font-size: 1.6rem; } .logo i { font-size: 1.4rem; }
            .user-avatar { width: 38px; height: 38px; font-size: 0.9rem;}
            .profile-avatar-lg { width: 110px; height: 110px; font-size: 2.8rem; }
            #profileNameLarge { font-size: 2rem; }
            .points-amount-large { font-size: 3rem; }
            .stat-value { font-size: 1.8rem; }
            .books-grid, #profileBooksContainer { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
            .popular-book-card { width: 140px; }
            .popular-book-img-container { height: 170px; }
            .nav-item { width: 45px; height: 45px; font-size: 1.2rem; }
            .add-btn { width: 55px; height: 55px; font-size: 1.6rem; }
            .withdrawal-item { flex-direction: column; align-items: flex-start; gap: 8px; }
            .withdrawal-status { align-self: flex-start; }
            .profile-action-btn { min-width: 150px; }
            .category-filter-item { padding: 7px 15px; font-size: 0.85rem;}
            /* .notifications-title { font-size: 1.1rem; } */
            .notifications-tabs { padding: 0 5px;}
            .notification-tab-btn { font-size: 0.9rem; padding: 10px 8px;}
        }

        @media (max-width: 576px) {
            :root { --header-height: 60px; --nav-height: 60px; }
            .header { padding: 0 10px; }
            .logo { font-size: 1.5rem; } .logo i { font-size: 1.3rem; margin-right: 8px;}
            .user-avatar { width: 35px; height: 35px; font-size: 0.8rem;}
            .container { padding: 15px 10px; }
            .popular-books-section { padding: 20px 10px; }
            .section-title { font-size: 1.5rem; margin-bottom: 20px; }
            .popular-book-card { width: 130px; }
            .popular-book-img-container { height: 160px; }
            .page-title { font-size: 1.8rem; }
            .books-grid, #profileBooksContainer { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .book-card:hover { transform: translateY(-5px) scale(1.01); }
            .book-img-container { height: 180px; }
            .profile-page-content { padding: 10px; padding-top: var(--header-height); padding-bottom: calc(var(--nav-height) + 15px); }
            .profile-main-header { padding: 30px 15px 20px; }
            .profile-avatar-lg { width: 90px; height: 90px; font-size: 2.2rem; }
            #profileNameLarge { font-size: 1.6rem; }
            #profileUsernameLarge { font-size: 1rem; }
            #profileEmailLarge, #profileJoinedLarge { font-size: 0.9rem; }
            .profile-bio-box { padding: 15px; font-size: 0.9rem; }
            .points-amount-large { font-size: 2.5rem; }
            .withdraw-btn-large { font-size: 0.9rem; padding: 10px 15px; }
            .stat-value { font-size: 1.6rem; }
            .profile-actions-footer { flex-direction: column; gap: 12px; align-items: center; }
            .profile-action-btn { max-width: 300px; width: 100%; min-width: unset; }
            .modal-content { padding: 20px; width: 95%; max-height: 85vh; }
            .modal-title { font-size: 1.4rem; }
            .amount-selection { grid-template-columns: 1fr 1fr; }
            .category-filter-item { padding: 6px 12px; font-size: 0.8rem; }
            .book-detail-title { font-size: 1.5rem; }
            .book-detail-author { font-size: 0.9rem; }
            .rating-stars .stars > i { font-size: 1.4rem; }
            .notifications-header { height: var(--header-height); padding: 0 10px;}
            /* .notifications-title { font-size: 1rem; } */
            .page-back-btn { width: 35px; height: 35px; font-size: 1.2rem; top: calc(12.5px + (var(--header-height) - 60px) / 2); } /* For profile and notifications */
            .notification-item { padding: 12px; }
            .notification-icon { width: 32px; height: 32px; font-size: 1.2rem; margin-right: 12px; }
            .notification-title { font-size: 0.95rem; }
            .notification-message { font-size: 0.85rem; }
            .notification-timestamp { font-size: 0.7rem; }
            .notifications-tabs {overflow-x: auto; justify-content: flex-start;}
            .notification-tab-btn { flex: 0 0 auto; padding: 10px 15px;} /* Ensure tabs are scrollable if they overflow */
        }

        @media (max-width: 400px) {
            .books-grid, #profileBooksContainer { grid-template-columns: 1fr; }
            .popular-book-card { width: 120px; }
            .popular-book-img-container { height: 150px; }
            .book-img-container { height: 220px; }
            .profile-avatar-lg { width: 80px; height: 80px; font-size: 2rem; }
            #profileNameLarge { font-size: 1.4rem; }
            .amount-selection { grid-template-columns: 1fr; }
            .category-filter-container { gap: 8px; }
            .category-filter-item { padding: 5px 10px; }
            .book-detail-image { width: 150px; height: 210px; }
        }
        * {
          -webkit-user-select: none; /* Safari and Chrome */
          user-select: none;         /* Standard */
          -webkit-tap-highlight-color: transparent; /* Removes tap highlight */
        }

    </style>
</head>
<body data-theme="dark">

    <!-- Enhanced Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-logo-container">
            <i class="fas fa-book-reader loading-logo-icon"></i>
            <span class="loading-logo-text">EduSparK</span>
        </div>
        <div class="loading-dots">
            <span></span><span></span><span></span>
        </div>
        <p class="loading-message" id="loadingMessage">Loading EduSparK Library...</p>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="logo-container">
            <a href="#" class="logo" id="logoLink">
                <i class="fas fa-book-reader"></i>
                <span class="logo-text">EduSparK</span>
            </a>
        </div>

        <div class="search-container" id="searchContainer">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" id="searchInput" placeholder="Search books, authors...">
            <div class="search-results" id="searchResults"></div>
        </div>

        <div class="header-actions">
            <button class="search-toggle-btn" id="searchToggleBtn" aria-label="Toggle Search">
                <i class="fas fa-search"></i>
            </button>
            <div class="header-credits" id="headerCreditsContainer" style="display: none;" title="Your Credits">
                <i class="fas fa-coins"></i>
                <span id="headerCreditsAmount">0</span>
            </div>
            <div class="user-avatar" id="userAvatar">
                <span id="avatarInitials">U</span>
            </div>
        </div>
    </header>

    <!-- Popular Books Section -->
    <section class="popular-books-section" data-aos="fade-in" data-aos-delay="100">
        <h2 class="section-title"> Popular Now</h2>
        <div class="popular-books-carousel" id="popularBooksCarousel">
            <!-- Skeletons initially, then popular books -->
        </div>
    </section>

    <!-- Main Content -->
    <div class="container">
        <h1 class="page-title" data-aos="fade-right" data-aos-delay="200">Discover Books</h1>

        <!-- Category Filters -->
        <div class="category-filter-container" id="categoryFilterContainer" data-aos="fade-up" data-aos-delay="250">
            <!-- Categories will be loaded here by JS -->
        </div>

        <div class="books-grid" id="booksContainer">
            <!-- Skeletons initially, then books -->
        </div>
        <div id="booksGridLoadingIndicator">
            <span class="spinner"></span> Loading more books...
        </div>
         <div class="empty-state" id="emptyStateBooks"> <!-- Renamed for clarity -->
             <i class="fas fa-ghost"></i>
             <h3>No Books Found Yet</h3>
             <p>Looks a bit empty here. Try another category or check back later!</p>
         </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="nav-item" id="notificationsBtn" data-tooltip="Notifications">
            <i class="fas fa-bell"></i>
            <span class="unread-badge" id="unreadNotificationsBadge" style="display: none;">0</span>
        </div>
        <div class="nav-item active" id="homeBtn" data-tooltip="Home">
            <i class="fas fa-home"></i>
        </div>
        <button class="add-btn" id="addBookBtn" aria-label="Add Book">
            <i class="fas fa-plus"></i>
        </button>
        <div class="nav-item" id="discoverBtn" data-tooltip="Discover">
            <i class="fas fa-compass"></i>
        </div>
        <div class="nav-item" id="profileBtn" data-tooltip="Profile">
            <i class="fas fa-user"></i>
        </div>
    </nav>

    <!-- Redesigned Full Page Profile -->
    <div class="profile-page" id="profilePage">
         <div class="profile-page-content">
            <button class="page-back-btn" id="profileBackBtn" aria-label="Go Back">
                <i class="fas fa-arrow-left"></i>
            </button>

            <div class="profile-main-header" data-aos="fade-down">
                <div class="profile-avatar-lg" id="profileAvatarLarge">
                    <span id="profileAvatarInitialsLarge">U</span>
                </div>
                <h1 id="profileNameLarge">User Loading...</h1>
                <p id="profileUsernameLarge" class="profile-username-lg">@loading</p>
                <p id="profileEmailLarge" class="profile-email-lg"><i class="fas fa-envelope"></i> loading...</p>
                <p id="profileJoinedLarge" class="profile-joined-lg"><i class="fas fa-calendar-alt"></i> Joined: -</p>
                <div class="profile-bio-box" id="profileBioLarge" data-aos="fade-up" data-aos-delay="100">
                    Loading bio...
                </div>
            </div>

            <div class="profile-dashboard" data-aos="fade-up" data-aos-delay="200">
                <div class="profile-dashboard-item points-dashboard">
                    <h3><i class="fas fa-coins"></i> Your Points</h3>
                    <div class="points-amount-large" id="userPointsLarge">0</div>
                    <p>Redeem points for exciting rewards or cash!</p>
                    <button class="withdraw-btn-large action-btn" id="withdrawBtnLarge" disabled>
                        <span class="spinner" style="display: none;"></span>
                        <span><i class="fas fa-hand-holding-usd"></i> Withdraw Points</span>
                    </button>
                </div>
                <div class="profile-dashboard-item stats-dashboard">
                    <h3><i class="fas fa-chart-line"></i> Your Activity</h3>
                    <div class="stat-grid">
                        <div class="stat-card">
                            <span class="stat-value" id="booksSharedLarge">0</span>
                            <span class="stat-label-card">Books Shared</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value" id="booksDownloadedLarge">0</span>
                            <span class="stat-label-card">Your Downloads</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value" id="totalBookDownloadsLarge">0</span>
                            <span class="stat-label-card">Shared Book Downloads</span>
                        </div>
                         <div class="stat-card">
                            <span class="stat-value" id="totalFeedbackLarge">0</span>
                            <span class="stat-label-card">Feedback Given</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="profile-tabs" data-aos="fade-up" data-aos-delay="300">
                <button class="profile-tab-btn active" data-tab="shared-books">My Shared Books</button>
                <button class="profile-tab-btn" data-tab="withdrawal-history">Withdrawal History</button>
                <button class="profile-tab-btn" data-tab="point-system">Point System</button>
            </div>

            <div class="profile-tab-content active" id="tab-shared-books" data-aos="fade-up" data-aos-delay="350">
                <h3 class="profile-section-title">Your Shared Books</h3>
                <div id="profileBooksContainer" class="books-grid">
                     <div class="empty-state" id="emptyProfileBooks" style="display: none;">
                         <i class="fas fa-book-medical"></i>
                         <h3>No Books Shared Yet</h3>
                         <p>Share your knowledge with the community!</p>
                     </div>
                </div>
                 <div class="load-more-container" id="loadMoreContainer">
                    <button class="load-more-btn" id="loadMoreBooksBtn" style="display: none;">
                        <span class="spinner" style="display: none;"></span>
                        <span><i class="fas fa-chevron-down"></i> Load More</span>
                    </button>
                </div>
            </div>

            <div class="profile-tab-content" id="tab-withdrawal-history">
                <h3 class="profile-section-title">Withdrawal History</h3>
                <div id="withdrawalHistoryContainer">
                    <div class="empty-state" id="emptyWithdrawalHistory" style="display: none;">
                        <i class="fas fa-history"></i>
                        <h3>No Withdrawals Yet</h3>
                        <p>Your withdrawal history will appear here.</p>
                    </div>
                 </div>
            </div>

             <div class="profile-tab-content" id="tab-point-system">
                 <h3 class="profile-section-title">Point System Guide</h3>
                 <div class="point-system-info-tabbed">
                    <div class="point-item"><span class="point-action">Share Approved Book</span><span class="point-value">+10 Points</span></div>
                    <div class="point-item"><span class="point-action">Book Downloaded (by others)</span><span class="point-value">+1 Point</span></div>
                    <div class="point-item"><span class="point-action">Min. Withdrawal (500 Points)</span><span class="point-value">50</span></div>
                    <div class="point-item"><span class="point-action">1000 Points</span><span class="point-value">100</span></div>
                    <hr style="border-color: rgba(255,255,255,0.1); margin: 10px 0;">
                    <div class="point-item"><span class="point-action">Daily Login Bonus</span><span class="point-value">+20 Credits</span></div>
                    <div class="point-item"><span class="point-action">Download a Book</span><span class="point-value">-30 Credits</span></div>
                    <p style="font-size: 0.8rem; color: var(--text-muted); text-align: center; margin-top: 20px;">
                        <b>Points</b> are for cash withdrawal. <b>Credits</b> are for downloading books.
                    </p>
                 </div>
            </div>

            <div class="profile-actions-footer" data-aos="fade-up" data-aos-delay="400">
                <button class="profile-action-btn edit-profile" id="editProfileBtn">
                    <span class="spinner" style="display: none;"></span>
                    <span><i class="fas fa-user-edit"></i> Edit Profile</span>
                </button>
                <button class="profile-action-btn logout-btn" id="logoutBtn">
                     <span class="spinner" style="display: none;"></span>
                     <span><i class="fas fa-sign-out-alt"></i> Logout</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Full Page Notifications -->
    <div class="notifications-page" id="notificationsPage">
        <div class="notifications-header">
            <button class="page-back-btn" id="notificationsBackBtn" aria-label="Go Back">
                <i class="fas fa-arrow-left"></i>
            </button>
            <!-- <div class="notifications-title">Notifications</div> -->
            <div class="notifications-actions">
                <button class="mark-all-read-btn" id="markAllNotificationsReadBtn" disabled>
                    <i class="fas fa-check-double"></i> Mark All Read
                </button>
            </div>
        </div>
        <div class="notifications-tabs">
            <button class="notification-tab-btn active" data-tab="personal">Personal</button>
            <button class="notification-tab-btn" data-tab="announcements">Announcements</button>
        </div>
        <div class="notifications-content-area">
            <div class="notifications-list-container active" id="personalNotificationsListContainer">
                <div class="empty-state" id="emptyPersonalNotificationsState" style="display: none;">
                    <i class="fas fa-bell-slash"></i>
                    <h3>No Personal Notifications</h3>
                    <p>Important updates and alerts related to your activity will appear here.</p>
                </div>
                <!-- Personal notifications will be loaded here -->
            </div>
            <div class="notifications-list-container" id="adminAnnouncementsListContainer">
                <div class="empty-state" id="emptyAdminAnnouncementsState" style="display: none;">
                    <i class="fas fa-bullhorn"></i>
                    <h3>No Announcements Yet</h3>
                    <p>Check back later for updates from the EduSparK team.</p>
                </div>
                <!-- Admin announcements will be loaded here -->
            </div>
        </div>
    </div>


    <!-- Modals -->
    <div class="modal" id="addBookModal">
        <div class="modal-content">
            <button class="close-modal" id="closeAddBookModal" aria-label="Close">&times;</button>
            <h2 class="modal-title">Share a New Book</h2>
            <form id="addBookForm">
                <div class="form-group">
                    <label for="bookName" class="form-label">Book Title *</label>
                    <input type="text" id="bookName" class="form-input" placeholder="e.g., Introduction to Algorithms" required>
                </div>
                <div class="form-group">
                    <label for="authorName" class="form-label">Author(s) *</label>
                    <input type="text" id="authorName" class="form-input" placeholder="e.g., Thomas H. Cormen" required>
                </div>
                <div class="form-group">
                    <label for="bookCategory" class="form-label">Category *</label>
                    <input type="text" id="bookCategory" class="form-input" placeholder="e.g., Computer Science, 12th, NEET" required>
                     <small style="color: var(--text-muted); font-size: 0.75rem; margin-top: 5px; display: block;">
                         Use relevant keywords like 'JEE', '10th', 'Fiction', etc.
                     </small>
                </div>
                <div class="form-group">
                    <label for="bookImageUrl" class="form-label">Cover Image URL *</label>
                    <input type="url" id="bookImageUrl" class="form-input" placeholder="Paste direct image link" required>
                </div>
                <div class="form-group">
                    <label for="driveLink" class="form-label">Google Drive Link *</label>
                    <input type="url" id="driveLink" class="form-input" placeholder="Ensure link sharing is 'Anyone with the link'" required>
                     <small style="color: var(--text-muted); font-size: 0.75rem; margin-top: 5px; display: block;">
                         Right-click file in Drive > Share > Set 'Anyone with the link' > Copy link.
                     </small>
                </div>
                <div class="form-group">
                    <label for="bookDescription" class="form-label">Description (Optional)</label>
                    <textarea id="bookDescription" class="form-textarea" placeholder="Briefly describe the book..." rows="3"></textarea>
                </div>
                <button type="submit" class="submit-btn" id="submitBookBtn">
                    <span class="spinner" style="display: none;"></span>
                    <span>Submit for Approval</span>
                </button>
                 <button type="button" class="tutorial-btn" onclick="window.open('https://t.me/official_learnhub/140', '_blank')">
                     <span><i class="fas fa-question-circle"></i> How to Get Drive Link?</span>
                 </button>
            </form>
        </div>
    </div>

    <div class="modal" id="loginModal">
        <div class="modal-content">
            <button class="close-modal" id="closeLoginModal" aria-label="Close">&times;</button>
            <h2 class="modal-title">Welcome Back!</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail" class="form-label">Email</label>
                    <input type="email" id="loginEmail" class="form-input" placeholder="your.email@example.com" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword" class="form-label">Password</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="" required>
                </div>
                <button type="submit" class="submit-btn" id="loginBtn">
                    <span class="spinner" style="display: none;"></span>
                    <span>Login</span>
                </button>
            </form>
            <div class="auth-switch">
                Don't have an account? <a id="switchToSignup">Sign up here</a>
            </div>
        </div>
    </div>

    <div class="modal" id="signupModal">
        <div class="modal-content">
            <button class="close-modal" id="closeSignupModal" aria-label="Close">&times;</button>
            <h2 class="modal-title">Join EduSparK</h2>
            <form id="signupForm">
                 <div class="form-group">
                    <label for="signupName" class="form-label">Full Name</label>
                    <input type="text" id="signupName" class="form-input" placeholder="e.g., Ada Lovelace" required>
                </div>
                <div class="form-group">
                    <label for="signupUsername" class="form-label">Username</label>
                    <input type="text" id="signupUsername" class="form-input" placeholder="Choose a unique username" required>
                     <small style="color: var(--text-muted); font-size: 0.75rem; margin-top: 5px; display: block;">
                         3-15 chars, lowercase, numbers, _, .
                     </small>
                </div>
                <div class="form-group">
                    <label for="signupEmail" class="form-label">Email</label>
                    <input type="email" id="signupEmail" class="form-input" placeholder="your.email@example.com" required>
                </div>
                <div class="form-group">
                    <label for="signupPassword" class="form-label">Password</label>
                    <input type="password" id="signupPassword" class="form-input" placeholder="Choose a strong password" required>
                </div>
                <div class="form-group">
                    <label for="signupBio" class="form-label">Bio (Optional)</label>
                    <textarea id="signupBio" class="form-textarea" placeholder="Share something about yourself..." rows="2"></textarea>
                </div>
                <button type="submit" class="submit-btn" id="signupBtn">
                    <span class="spinner" style="display: none;"></span>
                    <span>Create Account</span>
                </button>
            </form>
            <div class="auth-switch">
                Already have an account? <a id="switchToLogin">Login here</a>
            </div>
        </div>
    </div>

    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <button class="close-modal" id="closeEditProfileModal" aria-label="Close">&times;</button>
            <h2 class="modal-title">Edit Your Profile</h2>
            <form id="editProfileForm">
                <div class="form-group">
                    <label for="editProfileName" class="form-label">Full Name</label>
                    <input type="text" id="editProfileName" class="form-input" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="editProfileUsername" class="form-label">Username</label>
                    <input type="text" id="editProfileUsername" class="form-input" placeholder="Choose a username" required>
                     <small style="color: var(--text-muted); font-size: 0.75rem; margin-top: 5px; display: block;">
                         3-15 chars, lowercase, numbers, _, .
                     </small>
                </div>
                <div class="form-group">
                    <label for="editProfileBio" class="form-label">Bio</label>
                    <textarea id="editProfileBio" class="form-textarea" placeholder="Tell the community about yourself" rows="3"></textarea>
                </div>
                <button type="submit" class="submit-btn" id="saveProfileBtn">
                    <span class="spinner" style="display: none;"></span>
                    <span>Save Changes</span>
                </button>
            </form>
        </div>
    </div>

    <div class="modal" id="discoverModal">
        <div class="modal-content">
            <button class="close-modal" id="closeDiscoverModal" aria-label="Close">&times;</button>
            <h2 class="modal-title">Discover More</h2>
            <div class="discover-list" id="discoverList">
                <!-- Static Example Items - Replace with dynamic content if needed -->
                 <div class="discover-item" onclick="showToast('Feature coming soon!', 'info')">
                    <div class="discover-icon"><i class="fas fa-trophy"></i></div>
                    <div class="discover-content">
                        <div class="discover-title">Top Contributors</div>
                        <div class="discover-description">See who's sharing the most knowledge! (Coming Soon)</div>
                    </div>
                </div>
                 <div class="discover-item" onclick="window.open('https://t.me/official_learnhub', '_blank')">
                    <div class="discover-icon"><i class="fab fa-telegram-plane"></i></div>
                    <div class="discover-content">
                        <div class="discover-title">Join Telegram</div>
                        <div class="discover-description">Connect with the community on Telegram for updates & discussions.</div>
                    </div>
                </div>
                 <div class="discover-item" onclick="showToast('Feature coming soon!', 'info')">
                    <div class="discover-icon"><i class="fas fa-tags"></i></div>
                    <div class="discover-content">
                        <div class="discover-title">Browse by Tags</div>
                        <div class="discover-description">Find books related to specific topics or tags. (Coming Soon)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="withdrawalModal">
        <div class="modal-content">
            <button class="close-modal" id="closeWithdrawalModal" aria-label="Close">&times;</button>
            <h2 class="modal-title">Withdraw Points</h2>
            <p style="text-align: center; color: var(--text-muted); margin-top: -15px; margin-bottom: 20px;">
                Your current balance: <strong id="withdrawalModalPoints" style="color: var(--primary-color);">0</strong> points
            </p>
            <form id="withdrawalForm">
                <div class="form-group">
                    <label class="form-label">1. Select Withdrawal Method:</label>
                    <div class="withdrawal-options">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">2. Select Amount:</label>
                    <div class="amount-selection">
                         <!-- Populated by JS -->
                    </div>
                </div>
                <div class="payment-details" id="paymentDetails">
                     <div class="form-group">
                        <label for="paymentId" class="form-label" id="paymentMethodLabel">Identifier *</label>
                        <input type="text" id="paymentId" class="form-input" placeholder="Enter details" required>
                    </div>
                     <div class="form-group" id="accountNameGroup" style="display: block;">
                        <label for="accountName" class="form-label">Account Holder Name *</label>
                        <input type="text" id="accountName" class="form-input" placeholder="Name as per account" required>
                    </div>
                    <button type="submit" class="submit-btn" id="submitWithdrawalBtn">
                         <span class="spinner" style="display: none;"></span>
                         <span>Submit Request</span>
                     </button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="creditModal">
        <div class="modal-content">
            <button class="close-modal" id="closeCreditModal" aria-label="Close">&times;</button>
            <h2 class="modal-title">Earn Credits</h2>
            <p style="text-align: center; color: var(--text-muted); margin-top: -15px; margin-bottom: 25px;">
                Your current balance: <strong id="creditModalUserCredits">0</strong> <i class="fas fa-coins" style="color: var(--credit-color);"></i>
            </p>
            <div class="credit-options-list">
                <button class="submit-btn" id="claimDailyCreditBtn" style="background: linear-gradient(135deg, #ffc107, #ff8f00); ">
                    <span class="spinner" style="display: none;"></span>
                    <span><i class="fas fa-calendar-check"></i> Claim Daily Bonus (+20)</span>
                </button>
                <button class="tutorial-btn" id="conductSurveyBtn" style="margin-top:15px;">
                     <span class="spinner" style="display: none;"></span>
                     <span><i class="fas fa-poll"></i> Conduct a Survey (Earn More!)</span>
                </button>
                 <p style="font-size: 0.8rem; color: var(--text-muted); text-align: center; margin-top: 20px;">
                    Tip: Use credits to download books (30 <i class="fas fa-coins" style="color:var(--credit-color);font-size:0.8em;"></i> per book). Share books to earn points for withdrawal!
                 </p>
            </div>
        </div>
    </div>

     <!-- Book Detail Modal -->
    <div class="modal" id="bookDetailModal">
        <div class="modal-content">
            <button class="close-modal" id="closeBookDetailModal" aria-label="Close">&times;</button>
            <div id="bookDetailContent">
                <!-- Loading state -->
                <div style="text-align:center; padding: 50px 0;">
                    <div class="spinner" style="width: 30px; height: 30px; border-width: 4px;"></div>
                    <p style="margin-top: 15px; color: var(--text-muted);">Loading details...</p>
                </div>
                <!-- Content will be loaded here by JS -->
            </div>
        </div>
    </div>


    <div id="toastContainer"></div>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        // --- Enhanced & Refactored JavaScript ---

        AOS.init({
            duration: 600,
            easing: 'ease-out-cubic',
            once: true,
            offset: 50,
        });
        
        const firebaseConfig = { // KEEP YOUR CONFIG HERE
            apiKey: "AIzaSyBNi6BHTKNd62VAY7q1oHQmxjZ3r0MUA9U",
            authDomain: "eduspark-new.firebaseapp.com",
            projectId: "eduspark-new",
            storageBucket: "eduspark-new.firebasestorage.app",
            messagingSenderId: "564501033350",
            appId: "1:564501033350:web:70c0f9873f96e9bd74fc07",
            measurementId: "G-NM2SE3DE7J"
        };
        
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const appCheck = firebase.appCheck();

        // Activate App Check
 
        // Also ensure you've registered your app in Firebase Console for App Check (reCAPTCHA v3 provider)
        // And enabled ENFORCEMENT for Firestore, Storage, and Auth in Firebase Console App Check settings.
        try {
            appCheck.activate(
                '6Lc9skArAAAAANQTNjr39EHkSZySQX3FTMqIUmu3', // REPLACE THIS
                true // Set to true to automatically get a token if none is present.
            );
            console.log("Firebase App Check activated.");
        } catch (error) {
            console.error("Error activating Firebase App Check:", error);
            // Handle error appropriately, maybe show a message to the user
            // For example, the app might not work correctly if App Check fails to activate
            // and enforcement is turned on in the Firebase console.
        }


        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        const elements = {
            loadingOverlay: $('#loadingOverlay'), loadingMessage: $('#loadingMessage'),
            body: document.body, header: $('.header'), logoLink: $('#logoLink'),
            userAvatar: $('#userAvatar'), avatarInitials: $('#avatarInitials'),
            searchContainer: $('#searchContainer'), searchInput: $('#searchInput'),
            searchResults: $('#searchResults'), searchToggleBtn: $('#searchToggleBtn'),
            addBookBtn: $('#addBookBtn'), booksContainer: $('#booksContainer'),
            booksGridLoadingIndicator: $('#booksGridLoadingIndicator'),
            emptyStateBooks: $('#emptyStateBooks'),
            categoryFilterContainer: $('#categoryFilterContainer'),
            bottomNavItems: $$('.bottom-nav .nav-item'), popularBooksCarousel: $('#popularBooksCarousel'),
            headerCreditsContainer: $('#headerCreditsContainer'), headerCreditsAmount: $('#headerCreditsAmount'),
            addBookModal: $('#addBookModal'), closeAddBookModal: $('#closeAddBookModal'), addBookForm: $('#addBookForm'),
            loginModal: $('#loginModal'), signupModal: $('#signupModal'),
            closeLoginModal: $('#closeLoginModal'), closeSignupModal: $('#closeSignupModal'),
            loginForm: $('#loginForm'), signupForm: $('#signupForm'),
            switchToSignup: $('#switchToSignup'), switchToLogin: $('#switchToLogin'),
            editProfileModal: $('#editProfileModal'), closeEditProfileModal: $('#closeEditProfileModal'), editProfileForm: $('#editProfileForm'),
            discoverModal: $('#discoverModal'), closeDiscoverModal: $('#closeDiscoverModal'),
            withdrawalModal: $('#withdrawalModal'), closeWithdrawalModal: $('#closeWithdrawalModal'), withdrawalForm: $('#withdrawalForm'),
            creditModal: $('#creditModal'), closeCreditModal: $('#closeCreditModal'),
            creditModalUserCredits: $('#creditModalUserCredits'), claimDailyCreditBtn: $('#claimDailyCreditBtn'), conductSurveyBtn: $('#conductSurveyBtn'),
            // Profile Page Elements
            profileBtn: $('#profileBtn'), profilePage: $('#profilePage'), profileBackBtn: $('#profileBackBtn'),
            profileAvatarLarge: $('#profileAvatarLarge'), profileAvatarInitialsLarge: $('#profileAvatarInitialsLarge'),
            profileNameLarge: $('#profileNameLarge'), profileUsernameLarge: $('#profileUsernameLarge'),
            profileEmailLarge: $('#profileEmailLarge'), profileJoinedLarge: $('#profileJoinedLarge'),
            profileBioLarge: $('#profileBioLarge'),
            userPointsLarge: $('#userPointsLarge'), withdrawBtnLarge: $('#withdrawBtnLarge'),
            booksSharedLarge: $('#booksSharedLarge'), booksDownloadedLarge: $('#booksDownloadedLarge'),
            totalBookDownloadsLarge: $('#totalBookDownloadsLarge'), totalFeedbackLarge: $('#totalFeedbackLarge'),
            profileTabs: $('.profile-tabs'), profileTabBtns: $$('.profile-tab-btn'), profileTabContents: $$('.profile-tab-content'),
            profileBooksContainer: $('#profileBooksContainer'), emptyProfileBooks: $('#emptyProfileBooks'),
            loadMoreBooksBtn: $('#loadMoreBooksBtn'), loadMoreContainer: $('#loadMoreContainer'),
            withdrawalHistoryContainer: $('#withdrawalHistoryContainer'), emptyWithdrawalHistory: $('#emptyWithdrawalHistory'),
            editProfileBtn: $('#editProfileBtn'), logoutBtn: $('#logoutBtn'),
            // pointSystemInfoTabbed: $('.point-system-info-tabbed'), // Not directly used in JS logic, but for completeness
            // Withdrawal Modal
            withdrawalOptionsContainer: $('#withdrawalModal .withdrawal-options'),
            amountOptionsContainer: $('#withdrawalModal .amount-selection'),
            paymentDetails: $('#paymentDetails'), paymentMethodLabel: $('#paymentMethodLabel'),
            paymentIdInput: $('#paymentId'),
            accountNameInput: $('#accountName'),
            accountNameGroup: $('#accountNameGroup'),
            submitWithdrawalBtn: $('#submitWithdrawalBtn'), withdrawalModalPoints: $('#withdrawalModalPoints'),
            // Navigation
            homeBtn: $('#homeBtn'), discoverBtn: $('#discoverBtn'),
            // Notifications
            notificationsBtn: $('#notificationsBtn'), notificationsPage: $('#notificationsPage'),
            notificationsBackBtn: $('#notificationsBackBtn'),
            personalNotificationsListContainer: $('#personalNotificationsListContainer'),
            adminAnnouncementsListContainer: $('#adminAnnouncementsListContainer'),
            notificationTabsContainer: $('.notifications-tabs'),
            notificationTabBtns: $$('.notification-tab-btn'),
            emptyPersonalNotificationsState: $('#emptyPersonalNotificationsState'),
            emptyAdminAnnouncementsState: $('#emptyAdminAnnouncementsState'),
            unreadNotificationsBadge: $('#unreadNotificationsBadge'),
            markAllNotificationsReadBtn: $('#markAllNotificationsReadBtn'),
            // Book Detail
            bookDetailModal: $('#bookDetailModal'), closeBookDetailModal: $('#closeBookDetailModal'), bookDetailContent: $('#bookDetailContent'),
            toastContainer: $('#toastContainer')
        };

        // State variables
        let currentUser = null, userData = null, allBooksCache = [],
            displayedBooksMain = [],
            popularBooksData = [], currentCategory = 'All',
            lastUserBookSnapshot = null, hasMoreUserBooks = true,
            selectedWithdrawalMethod = null, selectedWithdrawalAmount = null, selectedWithdrawalRs = null,
            isFetchingMoreUserBooks = false, currentBookDetailId = null,
            unreadNotificationsCount = 0,
            lastVisibleBookMain = null,
            isLoadingBooksMain = false,
            hasMoreBooksMain = true;


        // Firestore listeners object
        let listeners = { user: null, withdrawals: null, popularBooks: null, userBooks: null, bookApproval: null, userNotifications: null, adminAnnouncements: null };

        const BOOK_DOWNLOAD_COST = 30;
        const BOOKS_PER_PAGE_MAIN = 12;

        const bookCategories = ['All', '9th', '10th', '11th', '12th', 'NEET', 'JEE', 'UPSC', 'Coding', 'Computer Science', 'Fiction', 'Non-Fiction', 'Other'];
        const loadingMessages = [
            "Loading EduSparK Library...", "Unpacking Knowledge...", "Igniting Minds...",
            "Connecting to the Grid...", "Brewing Fresh Ideas...", "Preparing Your Journey..."
        ];

        // --- Utility Functions ---
        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            return String(str).replace(/[&<>"']/g, function (match) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match];
            });
        }

        function showToast(message, type = "info", duration = 3500) {
            if (!elements.toastContainer) {
                console.warn("Toast container not found. Toast not shown:", message);
                return;
            }
            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.id = toastId;
            let iconClass = 'fas fa-info-circle';
            if (type === 'success') iconClass = 'fas fa-check-circle';
            else if (type === 'error') iconClass = 'fas fa-times-circle';
            else if (type === 'warning') iconClass = 'fas fa-exclamation-triangle';

            toast.innerHTML = `<i class="${iconClass}"></i><span>${escapeHTML(message)}</span><button class="toast-close" aria-label="Close toast">&times;</button>`;
            elements.toastContainer.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));

            const closeBtn = toast.querySelector('.toast-close');
            closeBtn.onclick = () => {
                toast.classList.remove('show');
                setTimeout(() => { if (toast.parentElement) toast.remove(); }, 500);
            };

            setTimeout(() => {
                if(document.getElementById(toastId)){
                    toast.classList.remove('show');
                    setTimeout(() => { if (toast.parentElement) toast.remove(); }, 500);
                }
            }, duration);
        }

        function openModal(modalElement) {
            if (!modalElement) return;
            modalElement.classList.add('active');
            elements.body.style.overflow = 'hidden';
            AOS.refresh();
        }
        function closeModal(modalElement) {
            if (!modalElement) return;
            modalElement.classList.remove('active');
            const anyModalActive = $$('.modal.active').length > 0;
            const anyPageActive = $$('.profile-page.active, .notifications-page.active').length > 0;
            if (!anyModalActive && !anyPageActive) {
                 elements.body.style.overflow = 'auto';
            }
        }
        function getInitials(name) {
            if (!name || typeof name !== 'string') return 'U';
            const parts = name.trim().split(' ').filter(p => p.length > 0);
            if (parts.length === 0) return 'U';
            if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
            return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
        }

        function formatDate(ts, format = { year: 'numeric', month: 'short', day: 'numeric' }) {
            if (!ts) return 'N/A';
            const date = ts.toDate ? ts.toDate() : new Date(ts);
            try {
                return date.toLocaleDateString(undefined, format);
            } catch (e) {
                console.warn("Error formatting date:", ts, e);
                return 'Invalid Date';
            }
        }
        function formatTime(ts) {
            if (!ts) return '';
            const date = ts.toDate ? ts.toDate() : new Date(ts);
             try {
                return date.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit', hour12: true });
            } catch (e) {
                console.warn("Error formatting time:", ts, e);
                return 'Invalid Time';
            }
        }
        function toggleSpinner(btn, show) {
            if (!btn) return;
            const spinner = btn.querySelector('.spinner');
            // Query for direct child span that is not a spinner
            const textSpan = btn.querySelector(':scope > span:not(.spinner)');

            if (show) {
                btn.classList.add('loading');
                btn.disabled = true;
                if (spinner) spinner.style.display = 'inline-block';
                if (textSpan) textSpan.style.opacity = '0';
            } else {
                btn.classList.remove('loading');
                btn.disabled = false;
                if (spinner) spinner.style.display = 'none';
                if (textSpan) textSpan.style.opacity = '1';
            }
        }


        function cleanupListeners() {
            for (const key in listeners) {
                if (listeners[key]) {
                    try { listeners[key](); } catch (e) { console.warn(`Error cleaning listener ${key}:`, e); }
                    listeners[key] = null;
                }
            }
        }
         function formatRelativeDate(ts) {
            if (!ts) return '';
            const date = ts.toDate ? ts.toDate() : new Date(ts);
            const today = new Date(); today.setHours(0,0,0,0);
            const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
            const inputDate = new Date(date); inputDate.setHours(0,0,0,0);

            if (inputDate.getTime() === today.getTime()) return 'Today';
            if (inputDate.getTime() === yesterday.getTime()) return 'Yesterday';
            return formatDate(ts, { month: 'long', day: 'numeric', year: 'numeric' });
        }


        function hideLoadingOverlay() {
            elements.loadingOverlay.classList.add('hidden');
        }
        function showRandomLoadingMessage() {
            const randomIndex = Math.floor(Math.random() * loadingMessages.length);
            elements.loadingMessage.textContent = loadingMessages[randomIndex];
        }

        // --- Authentication & User Profile ---
        auth.onAuthStateChanged(async (user) => {
            cleanupListeners();
            currentUser = user;
            if (user) {
                elements.body.classList.add('logged-in');
                elements.body.classList.remove('logged-out');
                elements.headerCreditsContainer.style.display = 'flex';
                const userDocRef = db.collection('users').doc(user.uid);

                listeners.user = userDocRef.onSnapshot(async (doc) => {
                    if (doc.exists) {
                        userData = { id: doc.id, ...doc.data() };
                        updateProfileUI();
                        updateAvatar();
                        updateHeaderCredits();
                        enableWithdrawalIfQualified();
                        setupBookApprovalListener();
                        setupUserNotificationsListener();
                        setupAdminAnnouncementsListener();
                        if (!elements.loadingOverlay.classList.contains('hidden')) {
                           hideLoadingOverlay();
                        }
                    } else { // User exists in Auth, but not in Firestore (e.g., first signup)
                        const tempSignupData = JSON.parse(sessionStorage.getItem('tempSignupData') || '{}');
                        sessionStorage.removeItem('tempSignupData');
                        try {
                            console.log("User document doesn't exist, creating one...");
                            await createUserDocument(user, tempSignupData.name, tempSignupData.username, tempSignupData.bio);
                            // The onSnapshot listener will pick up the newly created document.
                        } catch (error) {
                            console.error("Fatal error creating user document:", error);
                            showToast("Critical error setting up your profile. Please contact support.", "error", 10000);
                            auth.signOut().catch(e => console.error("Error signing out after profile creation failure", e));
                            if (!elements.loadingOverlay.classList.contains('hidden')) {
                               hideLoadingOverlay();
                            }
                        }
                    }
                }, (error) => {
                    console.error("Error listening to user data:", error);
                    showToast("Could not load your profile data. Please refresh.", "error");
                    userData = null;
                    updateProfileUI(); updateAvatar(); updateHeaderCredits();
                    if (!elements.loadingOverlay.classList.contains('hidden')) {
                       hideLoadingOverlay();
                    }
                });

                try {
                    await userDocRef.update({ lastActive: firebase.firestore.FieldValue.serverTimestamp() });
                } catch (warn) { console.warn("Could not update last active time (might be new user):", warn.message); }

                initializeDataFetching();
            } else { // User is logged out
                userData = null;
                currentUser = null;
                elements.body.classList.remove('logged-in');
                elements.body.classList.add('logged-out');
                elements.headerCreditsContainer.style.display = 'none';
                updateProfileUI(); // Clears profile UI
                updateAvatar(); // Resets avatar
                updateHeaderCredits(); // Resets credits
                updateUnreadBadge(0); // Clears notification badge
                showLoginPromptInsteadOfContent(); // Shows login prompts
                closeAllPagesAndModals();
                resetNavigation();
                // Clear dynamic content areas
                ['popularBooksCarousel', 'profileBooksContainer', 'withdrawalHistoryContainer', 'personalNotificationsListContainer', 'adminAnnouncementsListContainer', 'booksContainer'].forEach(elKey => {
                    if (elements[elKey]) elements[elKey].innerHTML = '';
                });
                 if (elements.categoryFilterContainer) elements.categoryFilterContainer.innerHTML = '';
                // Reset caches and pagination states
                allBooksCache = []; displayedBooksMain = []; popularBooksData = [];
                lastVisibleBookMain = null; hasMoreBooksMain = true; isLoadingBooksMain = false;
                lastUserBookSnapshot = null; hasMoreUserBooks = true; isFetchingMoreUserBooks = false;
                currentCategory = 'All';

                if (!elements.loadingOverlay.classList.contains('hidden')) {
                    hideLoadingOverlay();
                }
            }
        });

        async function createUserDocument(user, nameFromSignup, usernameFromSignup, bioFromSignup) {
            const name = nameFromSignup || user.displayName || "Anonymous User";
            let username = usernameFromSignup || user.email.split('@')[0].replace(/[^a-z0-9_.]/gi, '').toLowerCase() || `user${Date.now().toString().slice(-5)}`;
            // Ensure username uniqueness again, just in case (though primarily handled at signup form)
            try {
                const usernameSnapshot = await db.collection('users').where('username', '==', username).get();
                if (!usernameSnapshot.empty) {
                    username = `user${Date.now().toString().slice(-5)}`; // Fallback to a more unique username
                }
            } catch (e) { console.warn("Error re-checking username during doc creation:", e); }

            const bio = bioFromSignup || "EduSparK enthusiast!";
            const userRef = db.collection('users').doc(user.uid);
            const initialUserData = {
                uid: user.uid, email: user.email, name: name, username: username, bio: bio,
                points: 0, credits: 50, // Initial credits
                createdAt: firebase.firestore.FieldValue.serverTimestamp(), lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                booksSharedCount: 0, booksDownloadedCount: 0, lastDailyCreditClaim: null,
                totalBookDownloads: 0, totalFeedbackGiven: 0,
                processedBookActions: {}, // To track points/notifications for book actions
            };
            try {
                await userRef.set(initialUserData);
                // Notification for welcome and starting credits
                await createNotification(user.uid, "Welcome to EduSparK!", `Your profile is set up. You've received ${initialUserData.credits} starting credits!`, "success", null, "fas fa-hand-sparkles");
                showToast("Welcome to EduSparK! Your profile is set up.", "success");
            } catch (error) {
                console.error("Critical error creating user document in Firestore: ", error);
                // This is a serious issue; the user might be authenticated but without a profile document.
                // Consider how to handle this - perhaps force logout or show a persistent error.
                showToast("Major error setting up your account. Please contact support.", "error", 10000);
                throw error; // Re-throw to be caught by the caller if needed
            }
        }

        function showLoginPromptInsteadOfContent() {
             if (elements.booksContainer) {
                elements.booksContainer.innerHTML = ''; // Clear any skeletons
                elements.emptyStateBooks.innerHTML = `<i class="fas fa-sign-in-alt"></i><h3>Login to Discover Books</h3><p>Join EduSparK to share, download, and engage!</p><button class="submit-btn" style="margin-top:20px;max-width:200px;" id="loginPromptBtnMain">Login / Sign Up</button>`;
                elements.emptyStateBooks.style.display = 'flex';
                const loginPromptBtn = $('#loginPromptBtnMain');
                if (loginPromptBtn) loginPromptBtn.onclick = () => openModal(elements.loginModal);
             }
             if (elements.popularBooksCarousel) {
                elements.popularBooksCarousel.innerHTML = `<div class="empty-state" style="padding:20px 0;min-height:150px;width:100%;text-align:center;"><i class="fas fa-lock"></i><p style="font-size:0.9rem;">Login to see popular books.</p></div>`;
             }

             if(elements.emptyProfileBooks) elements.emptyProfileBooks.style.display = 'flex';
             if(elements.emptyWithdrawalHistory) elements.emptyWithdrawalHistory.style.display = 'flex';
             if(elements.emptyPersonalNotificationsState) elements.emptyPersonalNotificationsState.style.display = 'flex';
             if(elements.emptyAdminAnnouncementsState) elements.emptyAdminAnnouncementsState.style.display = 'flex';
             renderCategoryFilters(); // Render categories even if logged out
        }

        elements.loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = $('#loginEmail').value;
            const password = $('#loginPassword').value;
            const btn = $('#loginBtn');
            toggleSpinner(btn, true);
            try {
                await auth.signInWithEmailAndPassword(email, password);
                closeModal(elements.loginModal);
                showToast("Logged in successfully!", "success");
            } catch (error) {
                console.error("Login error:", error);
                showToast(error.message, "error");
            } finally {
                toggleSpinner(btn, false);
                elements.loginForm.reset();
            }
        });

        elements.signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = $('#signupName').value;
            const username = $('#signupUsername').value.trim().toLowerCase();
            const email = $('#signupEmail').value;
            const password = $('#signupPassword').value;
            const bio = $('#signupBio').value;

            if (!/^[a-z0-9_.]{3,15}$/.test(username)) {
                showToast("Username: 3-15 chars, lowercase, numbers, '_', '.'", "error", 5000);
                return;
            }
            if (password.length < 6) {
                showToast("Password must be at least 6 characters.", "error");
                return;
            }

            const btn = $('#signupBtn');
            toggleSpinner(btn, true);

            try {
                const usernameSnapshot = await db.collection('users').where('username', '==', username).get();
                if (!usernameSnapshot.empty) {
                    showToast("Username already taken. Please choose another.", "error");
                    toggleSpinner(btn, false); return;
                }
                 // Check if email is already in use by Firebase Auth
                const methods = await auth.fetchSignInMethodsForEmail(email);
                if (methods.length > 0) {
                    showToast("This email address is already in use.", "error");
                    toggleSpinner(btn, false); return;
                }

                sessionStorage.setItem('tempSignupData', JSON.stringify({ name, username, bio }));
                await auth.createUserWithEmailAndPassword(email, password);
                // onAuthStateChanged will handle creating the user document and closing modal indirectly
                // closeModal(elements.signupModal); // This might be too soon if onAuthStateChanged is slow
            } catch (error) {
                console.error("Signup error:", error);
                showToast(error.message, "error");
                sessionStorage.removeItem('tempSignupData'); // Clean up if signup fails
            } finally {
                toggleSpinner(btn, false);
                // elements.signupForm.reset(); // Reset form only on success, or handled by onAuthStateChanged logic
            }
        });

        elements.logoutBtn.addEventListener('click', async () => {
            toggleSpinner(elements.logoutBtn, true);
            try {
                await auth.signOut();
                // onAuthStateChanged will handle UI reset, closing pages, etc.
                showToast("Logged out successfully.", "info");
            } catch (error) {
                console.error("Logout error:", error);
                showToast("Error logging out. Please try again.", "error");
            } finally {
                toggleSpinner(elements.logoutBtn, false);
            }
        });

        function updateProfileUI() {
            if (userData) {
                elements.profileAvatarInitialsLarge.textContent = getInitials(userData.name);
                elements.profileNameLarge.textContent = escapeHTML(userData.name || 'User');
                elements.profileUsernameLarge.textContent = `@${escapeHTML(userData.username || 'username')}`;
                elements.profileEmailLarge.innerHTML = `<i class="fas fa-envelope"></i> ${escapeHTML(userData.email || 'No email')}`;
                elements.profileJoinedLarge.innerHTML = `<i class="fas fa-calendar-alt"></i> Joined: ${userData.createdAt ? formatDate(userData.createdAt) : '-'}`;
                elements.profileBioLarge.textContent = escapeHTML(userData.bio || 'No bio set. Click Edit Profile to add one!');

                elements.userPointsLarge.textContent = userData.points || 0;
                elements.booksSharedLarge.textContent = userData.booksSharedCount || 0;
                elements.booksDownloadedLarge.textContent = userData.booksDownloadedCount || 0;
                elements.totalBookDownloadsLarge.textContent = userData.totalBookDownloads || 0;
                elements.totalFeedbackLarge.textContent = userData.totalFeedbackGiven || 0;
            } else { // Reset profile UI elements
                elements.profileAvatarInitialsLarge.textContent = 'U';
                elements.profileNameLarge.textContent = 'User Loading...';
                elements.profileUsernameLarge.textContent = '@loading';
                elements.profileEmailLarge.innerHTML = `<i class="fas fa-envelope"></i> loading...`;
                elements.profileJoinedLarge.innerHTML = `<i class="fas fa-calendar-alt"></i> Joined: -`;
                elements.profileBioLarge.textContent = 'Loading bio...';
                ['userPointsLarge', 'booksSharedLarge', 'booksDownloadedLarge', 'totalBookDownloadsLarge', 'totalFeedbackLarge'].forEach(elId => {
                    if (elements[elId]) elements[elId].textContent = '0';
                });
                if(elements.emptyProfileBooks) {
                    elements.profileBooksContainer.innerHTML = ''; // Clear books before showing empty state
                    elements.emptyProfileBooks.style.display = 'flex';
                }
                if(elements.emptyWithdrawalHistory) {
                    elements.withdrawalHistoryContainer.innerHTML = ''; // Clear history
                    elements.emptyWithdrawalHistory.style.display = 'flex';
                }
            }
        }
        function updateAvatar() {
            elements.avatarInitials.textContent = (userData && userData.name) ? getInitials(userData.name) : 'U';
        }
        function updateHeaderCredits() {
            elements.headerCreditsAmount.textContent = userData ? (userData.credits || 0) : '0';
        }

        elements.editProfileBtn.addEventListener('click', () => {
            if (userData && currentUser) {
                $('#editProfileName').value = userData.name || '';
                $('#editProfileUsername').value = userData.username || '';
                $('#editProfileBio').value = userData.bio || '';
                openModal(elements.editProfileModal);
            } else {
                showToast("Please login to edit your profile.", "warning");
                openModal(elements.loginModal);
            }
        });
        if(elements.closeEditProfileModal) elements.closeEditProfileModal.onclick = () => closeModal(elements.editProfileModal);

        elements.editProfileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser || !userData) { showToast("Not logged in.", "error"); return; }
            const newName = $('#editProfileName').value;
            const newUsername = $('#editProfileUsername').value.trim().toLowerCase();
            const newBio = $('#editProfileBio').value;

            if (!/^[a-z0-9_.]{3,15}$/.test(newUsername)) {
                showToast("Username: 3-15 chars, lowercase, numbers, '_', '.'", "error", 5000);
                return;
            }

            const btn = $('#saveProfileBtn');
            toggleSpinner(btn, true);

            try {
                if (newUsername !== userData.username) {
                    const usernameSnapshot = await db.collection('users').where('username', '==', newUsername).get();
                    if (!usernameSnapshot.empty) {
                        showToast("Username already taken. Please choose another.", "error");
                        toggleSpinner(btn, false); return;
                    }
                }

                await db.collection('users').doc(currentUser.uid).update({
                    name: newName, username: newUsername, bio: newBio
                });
                await createNotification(currentUser.uid, "Profile Updated", "Your profile details have been successfully changed.", "info", null, "fas fa-user-check");
                showToast("Profile updated successfully!", "success");
                closeModal(elements.editProfileModal);
            } catch (error) {
                console.error("Error updating profile:", error);
                showToast("Failed to update profile: " + error.message, "error");
            } finally {
                toggleSpinner(btn, false);
            }
        });

        if(elements.profileTabs) {
            elements.profileTabs.addEventListener('click', (e) => {
                const targetTabBtn = e.target.closest('.profile-tab-btn');
                if (!targetTabBtn) return;
                elements.profileTabBtns.forEach(btn => btn.classList.remove('active'));
                targetTabBtn.classList.add('active');
                const tabId = targetTabBtn.dataset.tab;
                elements.profileTabContents.forEach(content => {
                    content.classList.toggle('active', content.id === `tab-${tabId}`);
                });
                AOS.refresh(); // Refresh AOS for new tab content
            });
        }


        // --- Book Data Fetching & Display ---
        function initializeDataFetching() {
             if (!currentUser) return;
             fetchBooksMain(false); // Initial fetch for main grid
             fetchPopularBooks();
             renderCategoryFilters();
             fetchAllBooksForSearch();
        }

        function renderSkeletonLoaders(container, count, type = 'book') {
            if (!container) return;
            if (container !== elements.booksGridLoadingIndicator) {
                 container.innerHTML = ''; // Clear only if not the loading indicator itself
            }
            let skeletonHTML = '';
            for (let i = 0; i < count; i++) {
                if (type === 'book') {
                    skeletonHTML += `<div class="skeleton-book-card"><div class="skeleton-img"></div><div class="skeleton-info"><div class="skeleton-text title"></div><div class="skeleton-text author"></div><div class="skeleton-text meta"></div><div class="skeleton-btn"></div></div></div>`;
                } else if (type === 'popular') {
                    skeletonHTML += `<div class="skeleton-popular-book"><div class="skeleton-img"></div><div class="skeleton-info"><div class="skeleton-text title"></div><div class="skeleton-text meta"></div></div></div>`;
                } else if (type === 'history') {
                     skeletonHTML += `<div class="skeleton-history-item"></div>`;
                } else if (type === 'notification') {
                    skeletonHTML += `<div class="skeleton-notification-item"><div class="skeleton-icon"></div><div class="skeleton-content"><div class="skeleton-text title"></div><div class="skeleton-text message"></div><div class="skeleton-text timestamp"></div></div></div>`;
                }
            }
            if (container !== elements.booksGridLoadingIndicator) { // Append to loading indicator, replace for others
                container.innerHTML = skeletonHTML;
            }
        }

        function createBookCardHTML(book, target = 'main') {
             const isAdmin = target === 'profile'; // 'profile' implies it's user's own book list
             const defaultImage = 'https://via.placeholder.com/300x220/333/888?text=No+Cover';
             const imageUrl = book.imageUrl || defaultImage;
             let statusBadge = '';
             if (isAdmin) { // Only show status badges on the user's own profile book list
                 if (book.status === 'pending') statusBadge = '<span class="status-badge status-pending">Pending</span>';
                 else if (book.status === 'rejected') statusBadge = '<span class="status-badge status-rejected">Rejected</span>';
                 // Approved status can be inferred or subtly shown if needed, but often not as a prominent badge
             }

             return `
                <div class="book-card" data-id="${book.id}" style="animation-delay: ${Math.random() * 0.2}s" data-aos="fade-up">
                    <div class="book-img-container" data-action="view" data-book-id="${book.id}">
                        <img src="${escapeHTML(imageUrl)}" alt="${escapeHTML(book.bookName)}" class="book-img" loading="lazy" onerror="this.onerror=null;this.src='${defaultImage}';">
                        ${statusBadge}
                    </div>
                    <div class="book-info">
                        <h3 class="book-title">${escapeHTML(book.bookName)}</h3>
                        <p class="book-author">By ${escapeHTML(book.authorName)}</p>
                        <div class="book-meta">
                            <span><i class="fas fa-user"></i> ${escapeHTML(book.submittedByName || 'Anon')}</span>
                            <span><i class="fas fa-calendar-alt"></i> ${formatDate(book.submittedAt)}</span>
                        </div>
                         ${isAdmin && (book.status === 'approved' || book.status === 'rejected') ? `<div class="book-admin-info"><i class="fas fa-user-shield"></i> ${book.status === 'approved' ? `Approved ${book.reviewedBy ? `by ${escapeHTML(book.reviewedBy)}` : ''} on ${book.approvedAt ? formatDate(book.approvedAt) : '-'}` : `Rejected ${book.reviewedBy ? `by ${escapeHTML(book.reviewedBy)}` : ''} on ${book.reviewedAt ? formatDate(book.reviewedAt) : '-'}`}</div>` : ''}
                         ${isAdmin && book.status === 'rejected' && book.rejectionReason ? `<div class="book-admin-info" style="color:var(--primary-dark);border-color:var(--primary-dark);"><i class="fas fa-times-circle"></i> Reason: ${escapeHTML(book.rejectionReason)}</div>` : ''}
                        <button class="action-btn view-btn" data-action="view" data-book-id="${book.id}">
                            <span class="spinner" style="display: none;"></span>
                            <span><i class="fas fa-eye"></i> View Details</span>
                        </button>
                    </div>
                </div>`;
        }

        function createPopularBookCardHTML(book) {
            const defaultImage = 'https://via.placeholder.com/160x200/333/888?text=No+Cover';
            const imageUrl = book.imageUrl || defaultImage;
            return `
                <div class="popular-book-card" data-action="view" data-book-id="${book.id}" data-aos="fade-left" style="animation-delay: ${Math.random() * 0.3}s">
                    <div class="popular-book-img-container">
                        <img src="${escapeHTML(imageUrl)}" alt="${escapeHTML(book.bookName)}" class="popular-book-img" loading="lazy" onerror="this.onerror=null;this.src='${defaultImage}';">
                    </div>
                    <div class="popular-book-info">
                        <h4 class="popular-book-title">${escapeHTML(book.bookName)}</h4>
                        <p class="popular-book-meta"><i class="fas fa-download"></i> ${book.downloads || 0}</p>
                    </div>
                </div>`;
        }

        async function fetchBooksMain(loadMore = false) {
            if (!currentUser || isLoadingBooksMain) return;
            if (!hasMoreBooksMain && loadMore) {
                if(elements.booksGridLoadingIndicator) elements.booksGridLoadingIndicator.style.display = 'none';
                return;
            }

            isLoadingBooksMain = true;
            if (loadMore) {
                if(elements.booksGridLoadingIndicator) elements.booksGridLoadingIndicator.style.display = 'block';
            } else {
                lastVisibleBookMain = null;
                hasMoreBooksMain = true;
                displayedBooksMain = []; // Clear main displayed books array
                if(elements.booksContainer) elements.booksContainer.innerHTML = '';
                renderSkeletonLoaders(elements.booksContainer, BOOKS_PER_PAGE_MAIN, 'book');
                if(elements.emptyStateBooks) elements.emptyStateBooks.style.display = 'none';
            }

            let query = db.collection('books').where('status', '==', 'approved');
            if (currentCategory !== 'All') {
                // For more flexible category matching, consider array-contains if categories are stored as an array
                // or use multiple '==' queries if categories are single strings and you want to combine.
                // For this setup, it's an exact match.
                query = query.where('category', '==', currentCategory);
            }
            query = query.orderBy('approvedAt', 'desc').limit(BOOKS_PER_PAGE_MAIN);

            if (loadMore && lastVisibleBookMain) {
                query = query.startAfter(lastVisibleBookMain);
            }

            try {
                const snapshot = await query.get();
                if (!loadMore && elements.booksContainer) elements.booksContainer.innerHTML = ''; // Clear skeletons only if not loading more

                const newBooks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (newBooks.length > 0) {
                    newBooks.forEach(book => {
                        displayedBooksMain.push(book); // Add to main array
                        if(elements.booksContainer) elements.booksContainer.innerHTML += createBookCardHTML(book);
                    });
                    lastVisibleBookMain = snapshot.docs[snapshot.docs.length - 1];
                }

                hasMoreBooksMain = newBooks.length === BOOKS_PER_PAGE_MAIN;

                if (displayedBooksMain.length === 0 && !loadMore && elements.emptyStateBooks) {
                    elements.emptyStateBooks.innerHTML = `<i class="fas fa-search-minus"></i><h3>No Books Found</h3><p>No books match the category '${escapeHTML(currentCategory)}'. Try 'All' or another category.</p>`;
                    elements.emptyStateBooks.style.display = 'flex';
                } else if (elements.emptyStateBooks) {
                    elements.emptyStateBooks.style.display = 'none';
                }
                AOS.refreshHard(); // Use refreshHard as DOM structure changes

            } catch (error) {
                console.error("Error fetching books for main grid:", error);
                showToast("Could not load books. Please check your connection.", "error");
                if (!loadMore && elements.emptyStateBooks) {
                    if(elements.booksContainer) elements.booksContainer.innerHTML = ''; // Clear skeletons
                    elements.emptyStateBooks.innerHTML = `<i class="fas fa-exclamation-triangle"></i><h3>Error Loading Books</h3><p>Please refresh or try again later.</p>`;
                    elements.emptyStateBooks.style.display = 'flex';
                }
            } finally {
                isLoadingBooksMain = false;
                if(elements.booksGridLoadingIndicator) elements.booksGridLoadingIndicator.style.display = 'none';
            }
        }

        async function fetchAllBooksForSearch() {
            if (!currentUser) { allBooksCache = []; return; } // Clear cache if logged out
            try {
                const snapshot = await db.collection('books').where('status', '==', 'approved').get();
                allBooksCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error fetching all books for search:", error);
                showToast("Search functionality might be limited due to a network error.", "warning");
            }
        }


        function fetchPopularBooks() {
             if (!currentUser) {
                 if(elements.popularBooksCarousel) elements.popularBooksCarousel.innerHTML = `<div class="empty-state" style="padding:20px 0;min-height:150px;width:100%;text-align:center;"><i class="fas fa-lock"></i><p style="font-size:0.9rem;">Login to see popular books.</p></div>`;
                 return;
             }
             if (listeners.popularBooks) listeners.popularBooks(); // Detach previous listener
             renderSkeletonLoaders(elements.popularBooksCarousel, 5, 'popular');

             listeners.popularBooks = db.collection('books').where('status', '==', 'approved')
                                       .orderBy('downloads', 'desc').orderBy('approvedAt', 'desc').limit(10)
                                       .onSnapshot(snapshot => {
                 popularBooksData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 if (elements.popularBooksCarousel) elements.popularBooksCarousel.innerHTML = ''; // Clear skeletons
                 
                 if (popularBooksData.length === 0) {
                     if(elements.popularBooksCarousel) elements.popularBooksCarousel.innerHTML = `<div class="empty-state" style="padding:20px 0;min-height:150px;width:100%;text-align:center;"><i class="fas fa-sad-tear"></i><p style="font-size:0.9rem;">No popular books yet.</p></div>`;
                 } else {
                     popularBooksData.forEach(book => {
                         if(elements.popularBooksCarousel) elements.popularBooksCarousel.innerHTML += createPopularBookCardHTML(book);
                     });
                 }
                 AOS.refreshHard(); // Use refreshHard as DOM structure changes
             }, error => {
                 console.error("Error fetching popular books:", error);
                 showToast("Could not load popular books.", "error");
                 if(elements.popularBooksCarousel) elements.popularBooksCarousel.innerHTML = `<div class="empty-state" style="padding:20px 0;min-height:150px;width:100%;text-align:center;"><i class="fas fa-exclamation-triangle"></i><p style="font-size:0.9rem;">Error loading.</p></div>`;
             });
        }

        function renderCategoryFilters() {
             if (!elements.categoryFilterContainer) return;
             elements.categoryFilterContainer.innerHTML = bookCategories.map(cat => `
                <button class="category-filter-item ${cat === currentCategory ? 'active' : ''}" data-category="${escapeHTML(cat)}">
                    ${escapeHTML(cat)}
                </button>
            `).join('');
        }

        if(elements.categoryFilterContainer) {
            elements.categoryFilterContainer.addEventListener('click', (e) => {
                const target = e.target.closest('.category-filter-item');
                if (target && currentUser) { // Only allow filter change if logged in
                    currentCategory = target.dataset.category;
                    $$('#categoryFilterContainer .category-filter-item').forEach(i => i.classList.remove('active'));
                    target.classList.add('active');
                    fetchBooksMain(false);
                } else if (!currentUser) {
                    showToast("Please login to browse categories.", "info");
                    openModal(elements.loginModal);
                }
            });
        }


        elements.addBookForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser || !userData) { showToast("Login to share books.", "error"); openModal(elements.loginModal); return; }

            const bookName = $('#bookName').value.trim();
            const authorName = $('#authorName').value.trim();
            const category = $('#bookCategory').value.trim();
            const imageUrl = $('#bookImageUrl').value.trim();
            const driveLink = $('#driveLink').value.trim();
            const description = $('#bookDescription').value.trim();

            if (!bookName || !authorName || !category || !imageUrl || !driveLink) {
                showToast("Please fill all required fields.", "warning"); return;
            }
            try { new URL(imageUrl); } catch (_) { showToast("Image URL must be a valid link.", "warning"); return; }
            try { new URL(driveLink); } catch (_) { showToast("Drive link must be a valid link.", "warning"); return; }


            const btn = $('#submitBookBtn');
            toggleSpinner(btn, true);

            const bookData = {
                bookName, authorName, category, imageUrl, driveLink, description,
                submittedBy: currentUser.uid,
                submittedByName: userData.name || "Anonymous",
                submittedByUsername: userData.username || "anon_username", // Ensure username exists
                submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                status: "pending", downloads: 0, avgRating: 0, ratingCount: 0,
                approvedAt: null, reviewedAt: null, reviewedBy: null, rejectionReason: '', adminNotes: '',
            };

            try {
                await db.collection('books').add(bookData);
                // Increment shared count using a transaction or server-side update for reliability
                await db.collection('users').doc(currentUser.uid).update({
                    booksSharedCount: firebase.firestore.FieldValue.increment(1)
                });
                await createNotification(currentUser.uid, "Book Submitted", `Your book "${escapeHTML(bookName)}" has been submitted for approval.`, "info", null, "fas fa-upload");
                showToast("Book submitted for approval! You'll be notified.", "success");
                elements.addBookForm.reset();
                closeModal(elements.addBookModal);
            } catch (error) {
                console.error("Error submitting book:", error);
                showToast("Failed to submit book: " + error.message, "error");
            } finally {
                toggleSpinner(btn, false);
            }
        });

        function setupBookApprovalListener() {
            if (!currentUser || listeners.bookApproval) return;

            listeners.bookApproval = db.collection('books')
                .where('submittedBy', '==', currentUser.uid)
                .onSnapshot(async (snapshot) => { // Added async here
                    for (const change of snapshot.docChanges()) { // Use for...of for async operations inside loop
                        if (change.type === 'modified') {
                            const book = {id: change.doc.id, ...change.doc.data()};
                            const userRef = db.collection('users').doc(currentUser.uid);
                            
                            try {
                                const userDoc = await userRef.get(); // Get fresh user data
                                if (!userDoc.exists) {
                                    console.warn("User document not found during book approval processing for UID:", currentUser.uid);
                                    continue; // Skip if user doc is missing
                                }
                                const currentLocalUserData = userDoc.data();
                                const processedActions = currentLocalUserData.processedBookActions || {};

                                if (book.status === 'approved' && (!processedActions[book.id] || !processedActions[book.id].approval)) {
                                    showToast(`Your book "${escapeHTML(book.bookName)}" has been approved! +10 points.`, "success", 7000);
                                    await userRef.update({
                                        points: firebase.firestore.FieldValue.increment(10),
                                        [`processedBookActions.${book.id}.approval`]: true
                                    });
                                    await createNotification(currentUser.uid, "Book Approved!", `Your book "${escapeHTML(book.bookName)}" is now live.`, "success", `/#bookDetail/${book.id}`, "fas fa-book-reader");
                                    await createNotification(currentUser.uid, "Points Awarded!", `You received +10 points for sharing "${escapeHTML(book.bookName)}".`, "success", null, "fas fa-coins");
                                } else if (book.status === 'rejected' && (!processedActions[book.id] || !processedActions[book.id].rejection)) {
                                    showToast(`Your book "${escapeHTML(book.bookName)}" was rejected. Reason: ${escapeHTML(book.rejectionReason || 'Not specified')}.`, "warning", 7000);
                                    await userRef.update({
                                        [`processedBookActions.${book.id}.rejection`]: true
                                    });
                                    await createNotification(currentUser.uid, "Book Submission Update", `Your book "${escapeHTML(book.bookName)}" was rejected. Reason: ${escapeHTML(book.rejectionReason || 'Not specified')}.`, "warning", null, "fas fa-times-circle");
                                }
                            } catch (e) {
                                console.error("Error processing book approval/rejection for user:", currentUser.uid, "book:", book.id, e);
                            }
                        }
                    }
                }, error => {
                    console.error("Error in book approval listener:", error);
                });
        }


        [elements.booksContainer, elements.profileBooksContainer, elements.popularBooksCarousel].forEach(container => {
            if(container) {
                container.addEventListener('click', async (e) => {
                    const targetButton = e.target.closest('.action-btn[data-action="view"], .popular-book-card[data-action="view"], .book-img-container[data-action="view"]');
                    if (!targetButton) return;

                    if (!currentUser || !userData) { openModal(elements.loginModal); return; }
                    const action = targetButton.dataset.action;
                    const bookId = targetButton.dataset.bookId;

                    if (!bookId) { console.warn("Action requires bookId, but not found on target:", targetButton); return; }
                    if (action === 'view') { openBookDetailModal(bookId); }
                });
            }
        });


        async function handleBookDownload(bookId, link, fromModal = false, buttonElement = null) {
            if (!currentUser || !userData) { openModal(elements.loginModal); return; }

            const btn = buttonElement || (fromModal ? $(`#bookDetailModal [data-action="download"][data-book-id="${bookId}"]`) : null);
            if (btn) toggleSpinner(btn, true);

            try {
                 // Get fresh userData, especially credits, right before transaction
                const userDocFresh = await db.collection('users').doc(currentUser.uid).get();
                if (!userDocFresh.exists) {
                    throw new Error("User data not found. Please try again.");
                }
                const freshUserData = userDocFresh.data();

                if (freshUserData.credits < BOOK_DOWNLOAD_COST && bookId && (await db.collection('books').doc(bookId).get()).data().submittedBy !== currentUser.uid) { // Check if not owner
                    showToast(`Need ${BOOK_DOWNLOAD_COST} credits. You have ${freshUserData.credits}. Earn more or claim daily bonus!`, "warning", 5000);
                    openModal(elements.creditModal);
                    if (btn) toggleSpinner(btn, false);
                    return;
                }

                const userRef = db.collection('users').doc(currentUser.uid);
                const bookRef = db.collection('books').doc(bookId);

                let bookOwnerIdForNotification = null;
                let bookNameForNotification = null;
                let isOwner = false;

                await db.runTransaction(async (transaction) => {
                    const userDoc = await transaction.get(userRef); // Read within transaction
                    const bookDoc = await transaction.get(bookRef); // Read within transaction

                    if (!userDoc.exists) throw new Error("User not found during transaction.");
                    if (!bookDoc.exists) throw new Error("Book not found during transaction.");

                    const currentCredits = userDoc.data().credits || 0;
                    bookOwnerIdForNotification = bookDoc.data().submittedBy;
                    bookNameForNotification = bookDoc.data().bookName;
                    isOwner = currentUser.uid === bookOwnerIdForNotification;

                    if (!isOwner && currentCredits < BOOK_DOWNLOAD_COST) {
                        throw new Error(`Insufficient credits. Need ${BOOK_DOWNLOAD_COST}, have ${currentCredits}. Please refresh.`);
                    }

                    if (!isOwner) {
                        transaction.update(userRef, {
                            credits: firebase.firestore.FieldValue.increment(-BOOK_DOWNLOAD_COST),
                            booksDownloadedCount: firebase.firestore.FieldValue.increment(1)
                        });
                    }
                    transaction.update(bookRef, { downloads: firebase.firestore.FieldValue.increment(1) });

                    if (bookOwnerIdForNotification && !isOwner) {
                        const submitterRef = db.collection('users').doc(bookOwnerIdForNotification);
                        // Check if submitterRef exists before updating (optional, but good practice)
                        // const submitterDoc = await transaction.get(submitterRef);
                        // if (submitterDoc.exists) {
                        transaction.update(submitterRef, {
                            points: firebase.firestore.FieldValue.increment(1),
                            totalBookDownloads: firebase.firestore.FieldValue.increment(1)
                        });
                        // }
                    }
                });

                window.open(link, '_blank');
                if (!isOwner) {
                  showToast(`-${BOOK_DOWNLOAD_COST} credits. Opening download...`, "info", 3000);
                } else {
                  showToast(`Opening download... (This is your book, no credits deducted)`, "info", 3000);
                }


                // Update local userData immediately if credits were deducted for responsiveness
                if (!isOwner && userData) { // Check if userData exists
                    userData.credits = (userData.credits || 0) - BOOK_DOWNLOAD_COST;
                    updateHeaderCredits();
                }

                if (bookOwnerIdForNotification && !isOwner && bookNameForNotification) {
                    await createNotification(bookOwnerIdForNotification, "Book Downloaded", `Your book "${escapeHTML(bookNameForNotification)}" was downloaded! +1 point.`, "info", `/#bookDetail/${bookId}`, "fas fa-arrow-down");
                }
                // Optionally, notify downloader
                // await createNotification(currentUser.uid, "Download Started", `Downloading "${escapeHTML(bookNameForNotification)}"`, "info", `/#bookDetail/${bookId}`, "fas fa-download");


            } catch (error) {
                console.error("Error during download transaction:", error);
                showToast(`Download failed: ${error.message || 'Please try again.'}`, "error");
            } finally {
                if (btn) toggleSpinner(btn, false);
            }
        }


        // --- User Profile Books & Withdrawals ---
        function fetchUserBooks(loadMore = false, forceRefresh = false) {
            if (!currentUser || (isFetchingMoreUserBooks && !forceRefresh) ) return;
            if (forceRefresh) {
                lastUserBookSnapshot = null; hasMoreUserBooks = true;
                if(elements.profileBooksContainer) elements.profileBooksContainer.innerHTML = '';
                if(elements.emptyProfileBooks) elements.emptyProfileBooks.style.display = 'none';
            }
            if (!hasMoreUserBooks && loadMore) {
                if(elements.loadMoreBooksBtn) toggleSpinner(elements.loadMoreBooksBtn, false); // Ensure spinner stops
                return;
            }

            isFetchingMoreUserBooks = true;
            if (loadMore && elements.loadMoreBooksBtn) toggleSpinner(elements.loadMoreBooksBtn, true);
            else if (!forceRefresh && elements.profileBooksContainer && !elements.profileBooksContainer.querySelector('.book-card')) {
                renderSkeletonLoaders(elements.profileBooksContainer, 3);
            }

            let query = db.collection('books').where('submittedBy', '==', currentUser.uid)
                          .orderBy('submittedAt', 'desc').limit(6);
            if (loadMore && lastUserBookSnapshot) { query = query.startAfter(lastUserBookSnapshot); }

            if (listeners.userBooks) listeners.userBooks();
            listeners.userBooks = query.onSnapshot(snapshot => {
                // Avoid quick updates if it's just local pending writes on initial load/refresh
                if (!loadMore && !forceRefresh && snapshot.metadata.hasPendingWrites && !snapshot.empty) return;

                if (!loadMore && elements.profileBooksContainer) elements.profileBooksContainer.innerHTML = '';

                if (snapshot.empty && (!elements.profileBooksContainer || elements.profileBooksContainer.innerHTML === '')) {
                    if(elements.emptyProfileBooks) elements.emptyProfileBooks.style.display = 'flex';
                    hasMoreUserBooks = false;
                } else {
                    if(elements.emptyProfileBooks) elements.emptyProfileBooks.style.display = 'none';
                    snapshot.docs.forEach(doc => {
                        const existingCard = elements.profileBooksContainer ? elements.profileBooksContainer.querySelector(`.book-card[data-id="${doc.id}"]`) : null;
                        if(!existingCard && elements.profileBooksContainer) {
                           elements.profileBooksContainer.innerHTML += createBookCardHTML({ id: doc.id, ...doc.data() }, 'profile');
                        }
                    });
                    lastUserBookSnapshot = snapshot.docs.length > 0 ? snapshot.docs[snapshot.docs.length - 1] : null;
                    hasMoreUserBooks = snapshot.docs.length === 6;
                }

                if(elements.loadMoreBooksBtn) elements.loadMoreBooksBtn.style.display = hasMoreUserBooks ? 'inline-flex' : 'none';
                if (loadMore && elements.loadMoreBooksBtn) toggleSpinner(elements.loadMoreBooksBtn, false);
                isFetchingMoreUserBooks = false;
                AOS.refreshHard();
            }, error => {
                console.error("Error fetching user books:", error);
                showToast("Could not load your shared books.", "error");
                if (loadMore && elements.loadMoreBooksBtn) toggleSpinner(elements.loadMoreBooksBtn, false);
                isFetchingMoreUserBooks = false;
                if(elements.emptyProfileBooks && elements.profileBooksContainer) {
                    elements.profileBooksContainer.innerHTML = '';
                    elements.emptyProfileBooks.style.display = 'flex';
                }
            });
        }

        if(elements.loadMoreBooksBtn) elements.loadMoreBooksBtn.addEventListener('click', () => fetchUserBooks(true));

        function enableWithdrawalIfQualified() {
            const btn = elements.withdrawBtnLarge;
            if (btn) { btn.disabled = !(userData && userData.points >= 500); }
        }
        if(elements.withdrawBtnLarge) {
            elements.withdrawBtnLarge.onclick = () => {
                if (userData && userData.points >= 500) {
                    elements.withdrawalModalPoints.textContent = userData.points || 0;
                    selectedWithdrawalMethod = null; selectedWithdrawalAmount = null; selectedWithdrawalRs = null;
                    $$('#withdrawalModal .withdrawal-option, #withdrawalModal .amount-option').forEach(o => o.classList.remove('active'));
                    if(elements.paymentDetails) elements.paymentDetails.classList.remove('active');
                    if(elements.withdrawalForm) elements.withdrawalForm.reset();
                    updatePaymentDetailsUI();
                    openModal(elements.withdrawalModal);
                } else { showToast(`You need at least 500 points to withdraw. Your balance: ${userData?.points || 0}`, "warning"); }
            };
        }
        if(elements.closeWithdrawalModal) elements.closeWithdrawalModal.onclick = () => closeModal(elements.withdrawalModal);

        function setupWithdrawalListeners() {
            if(elements.withdrawalOptionsContainer) {
                elements.withdrawalOptionsContainer.addEventListener('click', (e) => {
                    const option = e.target.closest('.withdrawal-option');
                    if (!option) return;
                    $$('#withdrawalModal .withdrawal-option').forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    selectedWithdrawalMethod = option.dataset.method;
                    updatePaymentDetailsUI();
                    if (selectedWithdrawalAmount && elements.paymentDetails) elements.paymentDetails.classList.add('active');
                });
            }
            if(elements.amountOptionsContainer) {
                elements.amountOptionsContainer.addEventListener('click', (e) => {
                     const option = e.target.closest('.amount-option');
                     if (!option) return;
                     const amt = parseInt(option.dataset.amount);
                     if (userData && userData.points >= amt) {
                         $$('#withdrawalModal .amount-option').forEach(o => o.classList.remove('active'));
                         option.classList.add('active');
                         selectedWithdrawalAmount = amt;
                         selectedWithdrawalRs = parseInt(option.dataset.rs);
                         if (selectedWithdrawalMethod && elements.paymentDetails) elements.paymentDetails.classList.add('active');
                     } else { showToast(`Need ${amt} pts. Your balance: ${userData?.points || 0}`, "warning"); }
                });
            }
        }
        function updatePaymentDetailsUI() {
            if (!selectedWithdrawalMethod || !elements.paymentDetails) { if(elements.paymentDetails) elements.paymentDetails.classList.remove('active'); return; }
            const paymentIdLabel = elements.paymentMethodLabel;
            const paymentIdField = elements.paymentIdInput;
            const accountNameFieldGroup = elements.accountNameGroup;
            const accountNameField = elements.accountNameInput;

            if(!paymentIdLabel || !paymentIdField || !accountNameFieldGroup || !accountNameField) return; // Safety check

            paymentIdField.placeholder = "Enter details";
            accountNameFieldGroup.style.display = 'none';
            accountNameField.required = false;

            if (selectedWithdrawalMethod === 'upi') { paymentIdLabel.textContent = 'UPI ID *'; paymentIdField.placeholder = 'yourname@okbank'; }
            else if (selectedWithdrawalMethod === 'redeem') { paymentIdLabel.textContent = 'Email for Redeem Code *'; paymentIdField.placeholder = 'your.email@example.com'; }
            else if (selectedWithdrawalMethod === 'bank') { paymentIdLabel.textContent = 'Account Number *'; paymentIdField.placeholder = 'Enter Account Number'; accountNameFieldGroup.style.display = 'block'; accountNameField.required = true; }
            else if (selectedWithdrawalMethod === 'paytm' || selectedWithdrawalMethod === 'phonepe') { paymentIdLabel.textContent = `${selectedWithdrawalMethod.charAt(0).toUpperCase() + selectedWithdrawalMethod.slice(1)} Number *`; paymentIdField.placeholder = 'Enter registered mobile number'; }
        }
        if(elements.withdrawalForm) {
            elements.withdrawalForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser || !userData || !selectedWithdrawalMethod || !selectedWithdrawalAmount) { showToast("Please select method and amount.", "warning"); return; }
                if (userData.points < selectedWithdrawalAmount) { showToast("Insufficient points for selected amount.", "error"); return; }

                const paymentIdValue = elements.paymentIdInput.value.trim();
                const accountNameValue = elements.accountNameInput.value.trim();

                if (!paymentIdValue || (elements.accountNameGroup.style.display === 'block' && !accountNameValue)) { showToast("Please fill all required payment details.", "warning"); return; }

                const btn = elements.submitWithdrawalBtn;
                toggleSpinner(btn, true);

                const withdrawalData = {
                    userId: currentUser.uid, userName: userData.name || "N/A", userEmail: userData.email,
                    pointsWithdrawn: selectedWithdrawalAmount, amountRs: selectedWithdrawalRs, method: selectedWithdrawalMethod,
                    paymentIdentifier: paymentIdValue, accountHolderName: (selectedWithdrawalMethod === 'bank' && accountNameValue) ? accountNameValue : null,
                    status: 'pending', requestedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    processedAt: null, adminNotes: ''
                };

                try {
                    const userRef = db.collection('users').doc(currentUser.uid);
                    await db.runTransaction(async (transaction) => {
                        const userDoc = await transaction.get(userRef);
                        if (!userDoc.exists) throw new Error("User not found.");
                        const currentPoints = userDoc.data().points || 0;
                        if (currentPoints < selectedWithdrawalAmount) { throw new Error("Insufficient points. Please refresh."); }
                        transaction.update(userRef, { points: firebase.firestore.FieldValue.increment(-selectedWithdrawalAmount) });
                        const withdrawalRef = db.collection('withdrawals').doc(); // Auto-generate ID
                        transaction.set(withdrawalRef, withdrawalData);
                    });
                    await createNotification(currentUser.uid, "Withdrawal Request Submitted", `Your request to withdraw ${selectedWithdrawalAmount} points (${selectedWithdrawalRs}) is pending.`, "info", null, "fas fa-hourglass-half");
                    showToast("Withdrawal request submitted successfully!", "success");
                    elements.withdrawalForm.reset();
                    closeModal(elements.withdrawalModal);
                } catch (error) {
                    console.error("Error submitting withdrawal:", error);
                    showToast(`Failed to submit request: ${error.message}`, "error");
                } finally {
                    toggleSpinner(btn, false);
                }
            });
        }

        function fetchWithdrawalHistory() {
            if (!currentUser || listeners.withdrawals) return;
            if(!elements.withdrawalHistoryContainer || !elements.emptyWithdrawalHistory) return;

            renderSkeletonLoaders(elements.withdrawalHistoryContainer, 3, 'history');
            elements.emptyWithdrawalHistory.style.display = 'none';

            listeners.withdrawals = db.collection('withdrawals').where('userId', '==', currentUser.uid)
                .orderBy('requestedAt', 'desc').limit(10) // Consider pagination for long histories
                .onSnapshot(snapshot => {
                    elements.withdrawalHistoryContainer.innerHTML = '';
                    if (snapshot.empty) { elements.emptyWithdrawalHistory.style.display = 'flex'; }
                    else {
                        elements.emptyWithdrawalHistory.style.display = 'none';
                        snapshot.forEach(doc => {
                            const item = doc.data();
                            elements.withdrawalHistoryContainer.innerHTML += `
                                <div class="withdrawal-item" data-aos="fade-up" style="animation-delay: ${Math.random() * 0.2}s">
                                    <div class="withdrawal-info">
                                        <div class="withdrawal-amount">${item.pointsWithdrawn} pts (${item.amountRs})</div>
                                        <div class="withdrawal-method">Method: ${escapeHTML(item.method.toUpperCase())} | ID: ${escapeHTML(item.paymentIdentifier)}</div>
                                        <div class="withdrawal-date">Requested: ${formatDate(item.requestedAt)} ${formatTime(item.requestedAt)}</div>
                                        ${item.status !== 'pending' && item.processedAt ? `<div class="withdrawal-date" style="font-style:italic;">Processed: ${formatDate(item.processedAt)} ${formatTime(item.processedAt)}</div>` : ''}
                                        ${item.adminNotes ? `<div class="withdrawal-date" style="color:var(--primary-light);">Note: ${escapeHTML(item.adminNotes)}</div>` : ''}
                                    </div>
                                    <div class="withdrawal-status status-${item.status.toLowerCase()}">${escapeHTML(item.status)}</div>
                                </div>`;
                        });
                    }
                    AOS.refreshHard();
                }, error => {
                    console.error("Error fetching withdrawal history:", error);
                    showToast("Could not load withdrawal history.", "error");
                    elements.withdrawalHistoryContainer.innerHTML = '';
                    elements.emptyWithdrawalHistory.style.display = 'flex';
                });
        }

        // --- Credits & Survey ---
        async function handleDailyCreditClaim() {
            if (!currentUser || !userData) { showToast("Please login to claim credits.", "info"); openModal(elements.loginModal); return; }
            const btn = elements.claimDailyCreditBtn;
            toggleSpinner(btn, true);

            try {
                 // Fetch fresh user data to check last claim accurately
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (!userDoc.exists) throw new Error("User data not found.");
                const freshUserData = userDoc.data();

                const today = new Date().toISOString().split('T')[0];
                if (freshUserData.lastDailyCreditClaim === today) {
                    showToast("You've already claimed your daily bonus today!", "warning");
                    toggleSpinner(btn, false); return;
                }

                const creditsToAward = 20;
                await db.collection('users').doc(currentUser.uid).update({
                    credits: firebase.firestore.FieldValue.increment(creditsToAward),
                    lastDailyCreditClaim: today
                });
                await createNotification(currentUser.uid, "Daily Bonus Claimed!", `You received +${creditsToAward} daily credits. Come back tomorrow!`, "success", null, "fas fa-gift");
                showToast(`+${creditsToAward} daily credits claimed! Come back tomorrow.`, "success");
                // userData.credits will be updated by the onSnapshot listener
            } catch (error) {
                console.error("Error claiming daily credit:", error);
                showToast("Failed to claim daily credit. " + error.message, "error");
            } finally {
                toggleSpinner(btn, false);
            }
        }

        if(elements.headerCreditsContainer) elements.headerCreditsContainer.onclick = () => {
             if (!currentUser) { openModal(elements.loginModal); return; }
             if(elements.creditModalUserCredits) elements.creditModalUserCredits.innerHTML = `${userData?.credits || 0} <i class="fas fa-coins" style="color: var(--credit-color);"></i>`;
             openModal(elements.creditModal);
        };
        if(elements.closeCreditModal) elements.closeCreditModal.onclick=()=>closeModal(elements.creditModal);
        if(elements.claimDailyCreditBtn) elements.claimDailyCreditBtn.onclick=handleDailyCreditClaim;
        if(elements.conductSurveyBtn) elements.conductSurveyBtn.onclick = () => {
            if (!currentUser) { openModal(elements.loginModal); return; }
            showToast("Redirecting to survey... Complete it to earn credits!", "info");
            window.open("https://forms.gle/gXz2QJt5k7Yc8XFp9", "_blank"); // Placeholder survey link
            createNotification(currentUser.uid, "Survey Link Opened", "You've opened the survey link. Complete it to earn rewards!", "info", null, "fas fa-poll-h");
        };


        // --- Book Detail Modal Logic ---
        async function openBookDetailModal(bookId) {
            if (!bookId) { console.warn("openBookDetailModal called without bookId"); return; }
            if (!currentUser) { openModal(elements.loginModal); return; }

            currentBookDetailId = bookId;
            openModal(elements.bookDetailModal);
            if(elements.bookDetailContent) elements.bookDetailContent.innerHTML = `<div style="text-align:center; padding: 50px 0;"><div class="spinner" style="width: 30px; height: 30px; border-width: 4px;"></div><p style="margin-top: 15px; color: var(--text-muted);">Loading details...</p></div>`;

            try {
                const bookDoc = await db.collection('books').doc(bookId).get();
                if (!bookDoc.exists || bookDoc.data().status !== 'approved') { // Ensure book is approved
                    showToast("Book details not found or not available.", "error");
                    closeModal(elements.bookDetailModal);
                    currentBookDetailId = null;
                    return;
                }
                const bookData = { id: bookDoc.id, ...bookDoc.data() };
                renderBookDetailContent(bookData);
                loadFeedbackComments(bookId);
            } catch (error) {
                console.error("Error fetching book details:", error);
                showToast("Failed to load book details.", "error");
                if(elements.bookDetailContent) elements.bookDetailContent.innerHTML = `<p style="color: var(--text-muted); text-align: center; padding: 30px;">Could not load details. Please try again.</p>`;
            }
        }

        function renderBookDetailContent(book) {
            if (!elements.bookDetailContent) return;
            const defaultImage = 'https://via.placeholder.com/200x280/333/888?text=No+Cover';
            const imageUrl = book.imageUrl || defaultImage;
            const isOwner = book.submittedBy === currentUser?.uid;
            const downloadCostText = isOwner ? 'Free - Your Book' : `${BOOK_DOWNLOAD_COST} <i class="fas fa-coins" style="color:var(--credit-color);font-size:0.8em;"></i>`;


            elements.bookDetailContent.innerHTML = `
                <div class="book-detail-layout">
                    <div class="book-detail-image">
                        <img src="${escapeHTML(imageUrl)}" alt="${escapeHTML(book.bookName)}" onerror="this.onerror=null;this.src='${defaultImage}';">
                    </div>
                    <div class="book-detail-info">
                        <h2 class="book-detail-title">${escapeHTML(book.bookName)}</h2>
                        <p class="book-detail-author">By ${escapeHTML(book.authorName)}</p>
                        <span class="book-detail-category">${escapeHTML(book.category || 'Uncategorized')}</span>
                        <div class="book-detail-meta">
                            <span><i class="fas fa-download"></i> <span id="detailDownloadCount">${book.downloads || 0}</span> Downloads</span>
                            <span><i class="fas fa-user"></i> Shared by ${escapeHTML(book.submittedByName || 'Anon')}</span>
                             ${book.avgRating > 0 ? `<span><i class="fas fa-star" style="color:var(--star-color);"></i> ${book.avgRating.toFixed(1)} (${book.ratingCount || 0} ratings)</span>` : '<span><i class="far fa-star" style="color:var(--star-color);"></i> No ratings yet</span>'}
                        </div>
                         ${book.description ? `<div class="book-detail-description">${escapeHTML(book.description)}</div>` : '<p class="book-detail-description">No description available for this book.</p>'}
                         <div class="book-detail-actions">
                             <button class="action-btn detail-download-btn" data-action="download" data-link="${escapeHTML(book.driveLink)}" data-book-id="${book.id}">
                                 <span class="spinner" style="display:none;"></span>
                                 <span><i class="fas fa-download"></i> Download (${downloadCostText})</span>
                             </button>
                         </div>
                    </div>
                </div>
                <div class="feedback-separator"></div>
                <div class="feedback-section">
                    <h3 class="feedback-title">Rate this Book</h3>
                    <form id="feedbackForm">
                         <div class="rating-stars">
                            <label>Your Rating:</label>
                            <div class="stars" id="feedbackStars">
                                <i class="far fa-star" data-value="1" title="Terrible"></i><i class="far fa-star" data-value="2" title="Poor"></i><i class="far fa-star" data-value="3" title="Average"></i><i class="far fa-star" data-value="4" title="Good"></i><i class="far fa-star" data-value="5" title="Excellent"></i>
                            </div>
                            <input type="hidden" id="feedbackRating" value="0">
                        </div>
                        <div class="form-group">
                            <label for="feedbackComment" class="form-label">Your Feedback (Optional):</label>
                            <textarea id="feedbackComment" class="form-textarea" placeholder="Share your thoughts..." rows="3"></textarea>
                        </div>
                        <button type="submit" class="submit-btn" id="submitFeedbackBtn"><span class="spinner" style="display: none;"></span><span>Submit Feedback</span></button>
                    </form>
                    <h3 class="feedback-title" style="margin-top: 30px;">Comments</h3>
                    <div class="comments-list" id="commentsList"><div class="no-comments">Loading comments...</div></div>
                </div>
            `;
            addDetailModalListeners(book.id);
        }

        function addDetailModalListeners(bookId) {
            const downloadBtn = elements.bookDetailContent.querySelector('.detail-download-btn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', () => {
                    if (!currentUser || !userData) { openModal(elements.loginModal); return; }
                    handleBookDownload(bookId, downloadBtn.dataset.link, true, downloadBtn);
                });
            }
             const starsContainer = $('#feedbackStars');
             const ratingInput = $('#feedbackRating');
             if (starsContainer && ratingInput) {
                 const stars = starsContainer.querySelectorAll('i');
                 stars.forEach(star => {
                     star.addEventListener('mouseover', () => highlightStars(stars, parseInt(star.dataset.value), true));
                     star.addEventListener('mouseout', () => highlightStars(stars, parseInt(ratingInput.value), false));
                     star.addEventListener('click', () => { ratingInput.value = star.dataset.value; highlightStars(stars, parseInt(ratingInput.value), false); });
                 });
             }
             const feedbackForm = $('#feedbackForm');
             if (feedbackForm) feedbackForm.addEventListener('submit', (e) => handleFeedbackSubmit(e, bookId));
        }

        function highlightStars(starsNodeList, rating, isHovering) {
             starsNodeList.forEach(s => {
                 const starValue = parseInt(s.dataset.value);
                 s.classList.remove('fas', 'far', 'selected', 'hovered'); // Reset classes
                 if (starValue <= rating) {
                     s.classList.add('fas'); // Filled star
                     if (!isHovering) s.classList.add('selected');
                     if (isHovering) s.classList.add('hovered');
                 } else {
                     s.classList.add('far'); // Empty star
                 }
             });
        }

         async function handleFeedbackSubmit(event, bookId) {
            event.preventDefault();
            if (!currentUser || !userData || !bookId) { showToast("Please login to submit feedback.", "info"); if(!currentUser) openModal(elements.loginModal); return; }


            const rating = parseInt($('#feedbackRating').value);
            const comment = $('#feedbackComment').value.trim();

            if (rating === 0) { showToast("Please select a star rating to submit feedback.", "warning"); return; }

            const btn = $('#submitFeedbackBtn');
            toggleSpinner(btn, true);

            const feedbackData = {
                userId: currentUser.uid,
                userName: userData.name || "Anonymous",
                userAvatarInitials: getInitials(userData.name || "Anonymous"), // For potential future display
                rating: rating,
                comment: comment,
                submittedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('books').doc(bookId).collection('feedback').add(feedbackData);
                const bookRef = db.collection('books').doc(bookId);
                const userRef = db.collection('users').doc(currentUser.uid);

                // Transaction to update book's average rating and user's feedback count
                await db.runTransaction(async (transaction) => {
                    const bookDoc = await transaction.get(bookRef);
                    const userDoc = await transaction.get(userRef); // Also get user doc for totalFeedbackGiven
                    if (!bookDoc.exists) throw new Error("Book not found for rating update.");
                    if (!userDoc.exists) throw new Error("User data not found for stat update.");


                    const currentRatingCount = bookDoc.data().ratingCount || 0;
                    const currentAvgRating = bookDoc.data().avgRating || 0;
                    const newRatingCount = currentRatingCount + 1;
                    const newAvgRating = ((currentAvgRating * currentRatingCount) + rating) / newRatingCount;

                    transaction.update(bookRef, { ratingCount: newRatingCount, avgRating: newAvgRating });
                    transaction.update(userRef, { totalFeedbackGiven: firebase.firestore.FieldValue.increment(1) });
                });
                
                const bookSnapshot = await bookRef.get(); // Get book name after transaction
                const bookNameForNotif = bookSnapshot.exists ? bookSnapshot.data().bookName : "this book";
                await createNotification(currentUser.uid, "Feedback Submitted", `Your feedback for "${escapeHTML(bookNameForNotif)}" has been recorded.`, "success", `/#bookDetail/${bookId}`, "fas fa-comment-dots");

                showToast("Thank you! Your feedback has been submitted.", "success");
                if($('#feedbackForm')) $('#feedbackForm').reset();
                if($('#feedbackRating')) $('#feedbackRating').value = 0;
                if ($$('#feedbackStars i').length > 0) highlightStars($$('#feedbackStars i'), 0, false);
                loadFeedbackComments(bookId); // Refresh comments list

                // Update book detail meta in real-time
                const bookDocAfterRating = await db.collection('books').doc(bookId).get();
                if(bookDocAfterRating.exists && elements.bookDetailContent) {
                    const updatedBookData = bookDocAfterRating.data();
                    const avgRatingSpan = elements.bookDetailContent.querySelector('.book-detail-meta span:nth-child(3)'); // Assuming rating is 3rd
                    if (avgRatingSpan && avgRatingSpan.querySelector('.fa-star, .far.fa-star')) {
                        avgRatingSpan.innerHTML = `<i class="fas fa-star" style="color:var(--star-color);"></i> ${updatedBookData.avgRating.toFixed(1)} (${updatedBookData.ratingCount || 0} ratings)`;
                    }
                     const downloadCountSpan = elements.bookDetailContent.querySelector('#detailDownloadCount');
                     if(downloadCountSpan) downloadCountSpan.textContent = updatedBookData.downloads || 0;
                }


            } catch (error) {
                console.error("Error submitting feedback:", error);
                showToast("Failed to submit feedback. " + error.message, "error");
            } finally {
                toggleSpinner(btn, false);
            }
        }

        async function loadFeedbackComments(bookId) {
            const commentsList = $('#commentsList');
            if (!commentsList) return;
            commentsList.innerHTML = '<div class="no-comments" style="padding: 20px 0;">Loading comments...</div>';

            try {
                const snapshot = await db.collection('books').doc(bookId).collection('feedback')
                    .orderBy('submittedAt', 'desc').limit(15).get();
                if (snapshot.empty) { commentsList.innerHTML = '<div class="no-comments" style="padding: 20px 0;">Be the first to leave feedback for this book!</div>'; return; }

                commentsList.innerHTML = ''; // Clear loading/previous comments
                snapshot.forEach(doc => {
                    const data = doc.data();
                    let starsHTML = '';
                    for(let i = 1; i <= 5; i++) { starsHTML += `<i class="${i <= data.rating ? 'fas' : 'far'} fa-star"></i>`; }
                    commentsList.innerHTML += `
                        <div class="comment-item">
                            <div class="comment-header">
                                <span class="comment-author">${escapeHTML(data.userName || 'User')}</span>
                                <span class="comment-rating">${starsHTML}</span>
                            </div>
                            ${data.comment ? `<p class="comment-body">${escapeHTML(data.comment)}</p>` : '<p class="comment-body" style="opacity:0.7;"><em>No comment text.</em></p>'}
                            <p class="comment-date">${formatDate(data.submittedAt)} at ${formatTime(data.submittedAt)}</p>
                        </div>`;
                });
            } catch (error) {
                console.error("Error loading comments:", error);
                commentsList.innerHTML = '<div class="no-comments" style="padding: 20px 0;">Could not load comments at this time.</div>';
            }
        }

        // --- Notification System ---
        async function createNotification(userId, title, message, type = 'info', actionLink = null, icon = null) {
            if (!userId) { console.warn("createNotification called without userId"); return; }
            try {
                await db.collection('users').doc(userId).collection('notifications').add({
                    title: title, message: message, type: type,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false, actionLink: actionLink, // Can be like '/#bookDetail/bookId123' or external URL
                    icon: icon || getDefaultIconForType(type)
                });
            } catch (error) { console.error("Error creating notification:", error); }
        }
        function getDefaultIconForType(type) {
            switch(type) {
                case 'success': return 'fas fa-check-circle';
                case 'error': return 'fas fa-times-circle';
                case 'warning': return 'fas fa-exclamation-triangle';
                case 'announcement': return 'fas fa-bullhorn';
                default: return 'fas fa-info-circle';
            }
        }
        function updateUnreadBadge(count) {
            unreadNotificationsCount = count;
            if (elements.unreadNotificationsBadge) {
                if (count > 0) {
                    elements.unreadNotificationsBadge.textContent = count > 9 ? '9+' : count;
                    elements.unreadNotificationsBadge.style.display = 'flex';
                } else {
                    elements.unreadNotificationsBadge.style.display = 'none';
                }
            }
            // Update "Mark all read" button state based on active tab
            if (elements.notificationTabsContainer && elements.markAllNotificationsReadBtn) {
                const activeTabBtn = elements.notificationTabsContainer.querySelector('.notification-tab-btn.active');
                if (activeTabBtn) {
                    const activeTab = activeTabBtn.dataset.tab;
                    if (activeTab === 'personal') {
                        elements.markAllNotificationsReadBtn.disabled = (unreadNotificationsCount === 0);
                    } else {
                        elements.markAllNotificationsReadBtn.disabled = true; // Announcements are not "markable" by user
                    }
                } else {
                     elements.markAllNotificationsReadBtn.disabled = true; // Default if no tab active (should not happen)
                }
            }
        }

        function setupUserNotificationsListener() {
            if (!currentUser || listeners.userNotifications) return;
            if(!elements.personalNotificationsListContainer || !elements.emptyPersonalNotificationsState) return;

            renderSkeletonLoaders(elements.personalNotificationsListContainer, 5, 'notification');

            listeners.userNotifications = db.collection('users').doc(currentUser.uid).collection('notifications')
                .orderBy('timestamp', 'desc')
                .limit(50) // Limit to avoid performance issues with too many notifications
                .onSnapshot(snapshot => {
                    let unreadCount = 0;
                    const notificationsByDate = {};

                    snapshot.forEach(doc => {
                        const notification = { id: doc.id, ...doc.data() };
                        if (!notification.read) unreadCount++;
                        const dateStr = formatRelativeDate(notification.timestamp);
                        if (!notificationsByDate[dateStr]) notificationsByDate[dateStr] = [];
                        notificationsByDate[dateStr].push(notification);
                    });

                    updateUnreadBadge(unreadCount);
                    elements.personalNotificationsListContainer.innerHTML = '';

                    if (snapshot.empty) {
                        elements.emptyPersonalNotificationsState.style.display = 'flex';
                    } else {
                        elements.emptyPersonalNotificationsState.style.display = 'none';
                        const sortedDateGroups = Object.keys(notificationsByDate).sort((a, b) => {
                            const dateA = a === "Today" ? new Date() : (a === "Yesterday" ? new Date(Date.now() - 86400000) : new Date(a));
                            const dateB = b === "Today" ? new Date() : (b === "Yesterday" ? new Date(Date.now() - 86400000) : new Date(b));
                            return dateB - dateA; // Sort descending
                        });

                        sortedDateGroups.forEach(dateGroup => {
                            const groupDiv = document.createElement('div');
                            groupDiv.className = 'notification-group';
                            groupDiv.innerHTML = `<h3 class="notification-group-date">${escapeHTML(dateGroup)}</h3>`;
                            notificationsByDate[dateGroup].forEach(notif => {
                                groupDiv.innerHTML += createNotificationItemHTML(notif);
                            });
                            elements.personalNotificationsListContainer.appendChild(groupDiv);
                        });
                    }
                    AOS.refreshHard();
                }, error => {
                    console.error("Error fetching notifications:", error);
                    showToast("Could not load notifications.", "error");
                    elements.personalNotificationsListContainer.innerHTML = '';
                    elements.emptyPersonalNotificationsState.style.display = 'flex';
                });
        }

        function setupAdminAnnouncementsListener() {
            if (listeners.adminAnnouncements) listeners.adminAnnouncements();
            if(!elements.adminAnnouncementsListContainer || !elements.emptyAdminAnnouncementsState) return;

            renderSkeletonLoaders(elements.adminAnnouncementsListContainer, 3, 'notification');

            listeners.adminAnnouncements = db.collection('adminAnnouncements')
                .orderBy('timestamp', 'desc')
                .limit(20)
                .onSnapshot(snapshot => {
                    const announcementsByDate = {};
                    snapshot.forEach(doc => {
                        const announcement = { id: doc.id, ...doc.data(), type: 'announcement' };
                        const dateStr = formatRelativeDate(announcement.timestamp);
                        if (!announcementsByDate[dateStr]) announcementsByDate[dateStr] = [];
                        announcementsByDate[dateStr].push(announcement);
                    });

                    elements.adminAnnouncementsListContainer.innerHTML = '';
                    if (snapshot.empty) {
                        elements.emptyAdminAnnouncementsState.style.display = 'flex';
                    } else {
                        elements.emptyAdminAnnouncementsState.style.display = 'none';
                        const sortedDateGroups = Object.keys(announcementsByDate).sort((a, b) => {
                            const dateA = a === "Today" ? new Date() : (a === "Yesterday" ? new Date(Date.now() - 86400000) : new Date(a));
                            const dateB = b === "Today" ? new Date() : (b === "Yesterday" ? new Date(Date.now() - 86400000) : new Date(b));
                            return dateB - dateA;
                        });
                        sortedDateGroups.forEach(dateGroup => {
                            const groupDiv = document.createElement('div');
                            groupDiv.className = 'notification-group';
                            groupDiv.innerHTML = `<h3 class="notification-group-date">${escapeHTML(dateGroup)}</h3>`;
                            announcementsByDate[dateGroup].forEach(notif => {
                                groupDiv.innerHTML += createNotificationItemHTML(notif);
                            });
                            elements.adminAnnouncementsListContainer.appendChild(groupDiv);
                        });
                    }
                    AOS.refreshHard();
                }, error => {
                    console.error("Error fetching admin announcements:", error);
                    showToast("Could not load admin announcements.", "error");
                    elements.adminAnnouncementsListContainer.innerHTML = '';
                    elements.emptyAdminAnnouncementsState.style.display = 'flex';
                });
        }


        function createNotificationItemHTML(notification) {
            // Construct actionLink URL carefully, especially if it's internal hash-based routing
            let fullActionLink = '';
            if (notification.actionLink) {
                if (notification.actionLink.startsWith('/#')) { // Internal hash link
                    fullActionLink = window.location.origin + window.location.pathname + notification.actionLink.substring(1);
                } else if (notification.actionLink.startsWith('http')) { // External link
                    fullActionLink = notification.actionLink;
                }
            }

            return `
                <div class="notification-item ${notification.read ? '' : 'unread'} type-${notification.type}" 
                     data-id="${notification.id}" 
                     data-action-link="${escapeHTML(fullActionLink || '')}"
                     data-internal-route="${escapeHTML(notification.actionLink && notification.actionLink.startsWith('/#') ? notification.actionLink : '')}">
                    <div class="notification-icon"><i class="${escapeHTML(notification.icon || getDefaultIconForType(notification.type))}"></i></div>
                    <div class="notification-content">
                        <h4 class="notification-title">${escapeHTML(notification.title)}</h4>
                        <p class="notification-message">${escapeHTML(notification.message)}</p>
                        <p class="notification-timestamp">${formatTime(notification.timestamp)}</p>
                    </div>
                </div>`;
        }

        [elements.personalNotificationsListContainer, elements.adminAnnouncementsListContainer].forEach(container => {
            if (container) {
                container.addEventListener('click', async (e) => {
                    const item = e.target.closest('.notification-item');
                    if (!item || !item.dataset.id) return;
                    if (!currentUser) { openModal(elements.loginModal); return; }


                    const notifId = item.dataset.id;
                    const actionLink = item.dataset.actionLink; // Full URL or empty
                    const internalRoute = item.dataset.internalRoute; // Like /#bookDetail/ID

                    if (container === elements.personalNotificationsListContainer && item.classList.contains('unread')) {
                        try {
                            await db.collection('users').doc(currentUser.uid).collection('notifications').doc(notifId).update({ read: true });
                            // Badge will update via listener
                        } catch (error) { console.error("Error marking notification as read:", error); }
                    }

                    if (internalRoute && internalRoute.startsWith('/#bookDetail/')) {
                        const bookId = internalRoute.split('/')[2]; // Get bookId from /#bookDetail/ID
                        closePage(elements.notificationsPage); // Close current notifications page
                        activateNavItem(elements.homeBtn); // Visually switch to home section before opening modal
                        openBookDetailModal(bookId);
                    } else if (actionLink && actionLink.startsWith('http')) { // External link
                        window.open(actionLink, '_blank');
                    }
                    // If no action link, clicking just marks as read (if personal & unread)
                });
            }
        });


        if(elements.markAllNotificationsReadBtn) {
            elements.markAllNotificationsReadBtn.addEventListener('click', async () => {
                if (!currentUser || unreadNotificationsCount === 0) return;
                const activeTabBtn = elements.notificationTabsContainer.querySelector('.notification-tab-btn.active');
                if (!activeTabBtn || activeTabBtn.dataset.tab !== 'personal') return;

                toggleSpinner(elements.markAllNotificationsReadBtn, true);
                try {
                    const batch = db.batch();
                    const unreadNotifsSnapshot = await db.collection('users').doc(currentUser.uid).collection('notifications').where('read', '==', false).get();
                    unreadNotifsSnapshot.forEach(doc => {
                        batch.update(doc.ref, { read: true });
                    });
                    await batch.commit();
                    showToast("All personal notifications marked as read.", "success");
                    // Badge and UI will update via onSnapshot listener
                } catch (error) {
                    console.error("Error marking all notifications as read:", error);
                    showToast("Failed to mark all as read.", "error");
                } finally {
                    toggleSpinner(elements.markAllNotificationsReadBtn, false);
                }
            });
        }

        if(elements.notificationTabsContainer) {
            elements.notificationTabsContainer.addEventListener('click', (e) => {
                const targetTabBtn = e.target.closest('.notification-tab-btn');
                if (!targetTabBtn) return;
                elements.notificationTabBtns.forEach(btn => btn.classList.remove('active'));
                targetTabBtn.classList.add('active');
                const tabId = targetTabBtn.dataset.tab;

                if(elements.personalNotificationsListContainer) elements.personalNotificationsListContainer.classList.toggle('active', tabId === 'personal');
                if(elements.adminAnnouncementsListContainer) elements.adminAnnouncementsListContainer.classList.toggle('active', tabId === 'announcements');

                // Update mark all read button state
                if (tabId === 'personal') {
                    if(elements.markAllNotificationsReadBtn) elements.markAllNotificationsReadBtn.disabled = (unreadNotificationsCount === 0);
                } else {
                    if(elements.markAllNotificationsReadBtn) elements.markAllNotificationsReadBtn.disabled = true;
                }
                AOS.refresh();
            });
        }


        // --- General Navigation & Event Listeners ---
        window.addEventListener('scroll', ()=>{
            if (window.scrollY > 50 && elements.header) elements.header.classList.add('scrolled');
            else if (elements.header) elements.header.classList.remove('scrolled');

            // Infinite scroll for main books only on home screen (homeBtn is active)
            if (elements.homeBtn && elements.homeBtn.classList.contains('active') &&
                (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 300) &&
                !isLoadingBooksMain && hasMoreBooksMain && currentUser) {
                fetchBooksMain(true);
            }
        });

        if(elements.searchToggleBtn) {
            elements.searchToggleBtn.addEventListener('click',(e)=>{
                e.stopPropagation();
                if(elements.searchContainer) elements.searchContainer.classList.toggle('active');
                if (elements.searchContainer && elements.searchContainer.classList.contains('active') && elements.searchInput) elements.searchInput.focus();
            });
        }

        function handleSearchInput(){
            if (!elements.searchInput || !elements.searchResults) return;
            const query = elements.searchInput.value.toLowerCase().trim();
            if (query.length < 2) { elements.searchResults.style.display = 'none'; return; }

            const results = allBooksCache.filter(book =>
                book.bookName.toLowerCase().includes(query) ||
                book.authorName.toLowerCase().includes(query) ||
                (book.category && book.category.toLowerCase().includes(query))
            ).slice(0, 10); // Limit results displayed
            renderSearchResults(results, elements.searchResults);
        }
        let searchTimeoutGlobal;
        if(elements.searchInput) {
            elements.searchInput.addEventListener('input',()=>{ clearTimeout(searchTimeoutGlobal); searchTimeoutGlobal = setTimeout(handleSearchInput, 300); });
            elements.searchInput.addEventListener('focus',handleSearchInput); // Show results on focus if query is already there
        }


        function renderSearchResults(results, resCont){
            if (!resCont) return;
            if (results.length === 0) { resCont.innerHTML = '<div class="no-results">No books found.</div>'; resCont.style.display = 'block'; return; }
            resCont.innerHTML = results.map(book => `
                <div class="search-result-item" data-book-id="${book.id}">
                    <h4>${escapeHTML(book.bookName)}</h4>
                    <p>By ${escapeHTML(book.authorName)} | Category: ${escapeHTML(book.category || 'N/A')}</p>
                </div>`).join('');
            resCont.style.display = 'block';
        }

        if(elements.searchResults) {
            elements.searchResults.addEventListener('click', (e) => {
                const item = e.target.closest('.search-result-item');
                if (item && item.dataset.bookId) {
                    if (!currentUser) { openModal(elements.loginModal); return; }
                    openBookDetailModal(item.dataset.bookId);
                    elements.searchResults.style.display = 'none';
                    if (elements.searchInput) elements.searchInput.value = '';
                    if (elements.searchContainer && elements.searchContainer.classList.contains('active') && window.innerWidth <= 768) {
                        elements.searchContainer.classList.remove('active');
                    }
                }
            });
        }

        document.addEventListener('click',(e)=>{
            // Hide mobile search if active and click is outside
            if (elements.searchContainer && elements.searchContainer.classList.contains('active') && window.innerWidth <= 768 && !elements.searchContainer.contains(e.target) && e.target !== elements.searchToggleBtn) {
                elements.searchContainer.classList.remove('active');
            }
            // Hide desktop search results if click is outside
            if (elements.searchContainer && !elements.searchContainer.contains(e.target) && elements.searchResults) {
                 elements.searchResults.style.display = 'none';
            }
        });

        function openPage(pageEl){
            if (!pageEl) return;
            pageEl.classList.add('active');
            elements.body.style.overflow = 'hidden'; // Prevent scrolling of underlying content
            AOS.refresh(); // Refresh AOS for elements within the new page

            if (pageEl === elements.profilePage) {
                if(currentUser) {
                    fetchUserBooks(false, true); // forceRefresh true
                    fetchWithdrawalHistory();
                    if (elements.profileTabs) {
                        const firstTabBtn = elements.profileTabs.querySelector('.profile-tab-btn');
                        if (firstTabBtn) {
                            const firstTabContentId = `tab-${firstTabBtn.dataset.tab}`;
                            elements.profileTabBtns.forEach(btn => btn.classList.remove('active'));
                            elements.profileTabContents.forEach(content => content.classList.remove('active'));
                            firstTabBtn.classList.add('active');
                            const firstTabContent = $(`#${firstTabContentId}`);
                            if (firstTabContent) firstTabContent.classList.add('active');
                        }
                    }
                } else {
                    closePage(elements.profilePage); // Close if somehow opened without user
                    openModal(elements.loginModal);
                }
            } else if (pageEl === elements.notificationsPage) {
                if(currentUser) {
                    if(elements.notificationTabsContainer && elements.personalNotificationsListContainer && elements.adminAnnouncementsListContainer) {
                        // Activate personal tab by default
                        elements.notificationTabBtns.forEach(btn => btn.classList.remove('active'));
                        elements.personalNotificationsListContainer.classList.remove('active');
                        elements.adminAnnouncementsListContainer.classList.remove('active');

                        const personalTabBtn = elements.notificationTabsContainer.querySelector('[data-tab="personal"]');
                        if (personalTabBtn) personalTabBtn.classList.add('active');
                        elements.personalNotificationsListContainer.classList.add('active');
                        if(elements.markAllNotificationsReadBtn) elements.markAllNotificationsReadBtn.disabled = (unreadNotificationsCount === 0);
                    }
                } else {
                    closePage(elements.notificationsPage);
                    openModal(elements.loginModal);
                }
            }
        }
        function closePage(pageEl){
            if (!pageEl) return;
            pageEl.classList.remove('active');
            const anyModalActive = $$('.modal.active').length > 0;
            const anyPageActive = $$('.profile-page.active, .notifications-page.active').length > 0;
            if (!anyModalActive && !anyPageActive) {
                elements.body.style.overflow = 'auto';
            }
        }

        function openProfilePage(){ if(currentUser) { activateNavItem(elements.profileBtn); openPage(elements.profilePage); } else { openModal(elements.loginModal); } }
        function closeProfilePage(){ if(elements.profilePage) closePage(elements.profilePage); if(elements.homeBtn) activateNavItem(elements.homeBtn); }
        function openNotificationsPage(){ if(currentUser) { activateNavItem(elements.notificationsBtn); openPage(elements.notificationsPage); } else { openModal(elements.loginModal); } }
        function closeNotificationsPage(){ if(elements.notificationsPage) closePage(elements.notificationsPage); if(elements.homeBtn) activateNavItem(elements.homeBtn); }


        function activateNavItem(targetBtn){
            if (!targetBtn) return;
            elements.bottomNavItems.forEach(item => item.classList.remove('active'));
            targetBtn.classList.add('active');
        }
        function resetNavigation(){ if(elements.homeBtn) activateNavItem(elements.homeBtn); }
        function closeAllPagesAndModals(){
            if(elements.profilePage) closePage(elements.profilePage);
            if(elements.notificationsPage) closePage(elements.notificationsPage);
            $$('.modal.active').forEach(m => closeModal(m));
             const anyModalActive = $$('.modal.active').length > 0;
             const anyPageActive = $$('.profile-page.active, .notifications-page.active').length > 0;
             if (!anyModalActive && !anyPageActive) {
                elements.body.style.overflow = 'auto';
             }
            currentBookDetailId = null; // Reset current book detail context
        }

        if(elements.homeBtn) elements.homeBtn.onclick=()=>{closeAllPagesAndModals();activateNavItem(elements.homeBtn);window.scrollTo({top:0,behavior:'smooth'});};
        if(elements.logoLink) elements.logoLink.onclick=(e)=>{e.preventDefault(); if(elements.homeBtn) elements.homeBtn.click();};
        if(elements.notificationsBtn) elements.notificationsBtn.onclick = openNotificationsPage;
        if(elements.notificationsBackBtn) elements.notificationsBackBtn.onclick = closeNotificationsPage;
        if(elements.profileBtn) elements.profileBtn.onclick=openProfilePage;
        if(elements.userAvatar) elements.userAvatar.onclick=openProfilePage;
        if(elements.profileBackBtn) elements.profileBackBtn.onclick=closeProfilePage;
        if(elements.addBookBtn) elements.addBookBtn.onclick=()=>{ if(currentUser) openModal(elements.addBookModal); else openModal(elements.loginModal); };
        if(elements.closeAddBookModal) elements.closeAddBookModal.onclick=()=>closeModal(elements.addBookModal);
        if(elements.discoverBtn) elements.discoverBtn.onclick=()=>{ if(currentUser) openModal(elements.discoverModal); else openModal(elements.loginModal); };
        if(elements.closeDiscoverModal) elements.closeDiscoverModal.onclick=()=>closeModal(elements.discoverModal);
        if(elements.switchToSignup) elements.switchToSignup.onclick=()=>{ closeModal(elements.loginModal); openModal(elements.signupModal); };
        if(elements.switchToLogin) elements.switchToLogin.onclick=()=>{ closeModal(elements.signupModal); openModal(elements.loginModal); };
        if(elements.closeLoginModal) elements.closeLoginModal.onclick=()=>closeModal(elements.loginModal);
        if(elements.closeSignupModal) elements.closeSignupModal.onclick=()=>closeModal(elements.signupModal);
        if(elements.closeBookDetailModal) elements.closeBookDetailModal.onclick=()=> { closeModal(elements.bookDetailModal); currentBookDetailId = null; }
        $$('.modal').forEach(m=>{m.addEventListener('click',(e)=>{if(e.target===m)closeModal(m);});});


        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
             if(elements.loadingOverlay) elements.loadingOverlay.classList.remove('hidden');
             showRandomLoadingMessage();
             renderSkeletonLoaders(elements.booksContainer, BOOKS_PER_PAGE_MAIN, 'book');
             renderSkeletonLoaders(elements.popularBooksCarousel, 5, 'popular');
             renderCategoryFilters();
             resetNavigation();
             setupWithdrawalListeners();

             const withdrawalOptsHTML = `<div class="withdrawal-option" data-method="upi"><div class="withdrawal-icon"><i class="fas fa-mobile-alt"></i></div><div class="withdrawal-details"><div class="withdrawal-title">UPI</div><div class="withdrawal-description">Fast transfer via UPI ID</div></div></div><div class="withdrawal-option" data-method="redeem"><div class="withdrawal-icon"><i class="fab fa-google-play"></i></div><div class="withdrawal-details"><div class="withdrawal-title">Redeem Code</div><div class="withdrawal-description">Google Play Gift Card</div></div></div><div class="withdrawal-option" data-method="bank"><div class="withdrawal-icon"><i class="fas fa-university"></i></div><div class="withdrawal-details"><div class="withdrawal-title">Bank Account</div><div class="withdrawal-description">Direct bank transfer (slower)</div></div></div><div class="withdrawal-option" data-method="paytm"><div class="withdrawal-icon"><i class="fas fa-wallet"></i></div><div class="withdrawal-details"><div class="withdrawal-title">Paytm Wallet</div><div class="withdrawal-description">Transfer to Paytm</div></div></div><div class="withdrawal-option" data-method="phonepe"><div class="withdrawal-icon"><i class="fas fa-rupee-sign"></i></div><div class="withdrawal-details"><div class="withdrawal-title">PhonePe</div><div class="withdrawal-description">Transfer to PhonePe</div></div></div>`;
             if(elements.withdrawalOptionsContainer) elements.withdrawalOptionsContainer.innerHTML = withdrawalOptsHTML;
             const amountOptsHTML = `<div class="amount-option" data-amount="500" data-rs="50">500 pts = 50</div><div class="amount-option" data-amount="1000" data-rs="100">1000 pts = 100</div><div class="amount-option" data-amount="2000" data-rs="200">2000 pts = 200</div><div class="amount-option" data-amount="5000" data-rs="500">5000 pts = 500</div>`;
             if(elements.amountOptionsContainer) elements.amountOptionsContainer.innerHTML = amountOptsHTML;
        });

        /*
        FIRESTORE SECURITY RULES (Update in Firebase Console)
        -------------------------------------------------------------
        Replace YOUR_ADMIN_UID with the actual UID of your admin user(s)
        or implement a more robust role-based system using custom claims.
        For simplicity, this example uses a hardcoded admin UID for certain admin-only actions.
        Ideally, status changes (book approval/rejection, withdrawal processing)
        should be handled by Cloud Functions for better security and auditing.
        */
        /*
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {

            // --- Helper Functions ---
            function isAuthenticated() {
              return request.auth != null;
            }
            function isOwner(userId) {
              return isAuthenticated() && request.auth.uid == userId;
            }
            // Example: Simple admin check - replace with your admin UIDs or custom claims
            function isAdmin() {
              // return isAuthenticated() && request.auth.token.admin == true; // Using custom claims (recommended)
              return isAuthenticated() && (request.auth.uid == "YOUR_ADMIN_UID_1" || request.auth.uid == "YOUR_ADMIN_UID_2"); // Hardcoded UIDs (less secure)
            }
            function getRole(uid) { // Helper for custom claims if you set them
                return get(/databases/$(database)/documents/users/$(uid)).data.role;
            }


            // --- Users Collection ---
            match /users/{userId} {
              allow read: if isAuthenticated(); // Allow any authenticated user to read basic profile info for display
              allow create: if isOwner(userId)
                            && request.resource.data.uid == userId
                            && request.resource.data.email == request.auth.token.email
                            && request.resource.data.points == 0
                            && request.resource.data.credits == 50 // Initial credits
                            && request.resource.data.booksSharedCount == 0
                            && request.resource.data.booksDownloadedCount == 0
                            && request.resource.data.totalBookDownloads == 0
                            && request.resource.data.totalFeedbackGiven == 0
                            && request.resource.data.createdAt == request.time
                            && !("admin" in request.resource.data) // Prevent self-assigning admin role
                            && request.resource.data.username is string && request.resource.data.username.size() >= 3 && request.resource.data.username.size() <= 15
                            && request.resource.data.name is string && request.resource.data.name.size() > 0;

              allow update: if isOwner(userId)
                            // User can update their own name, username (if not taken, checked client-side + server potentially), bio, lastActive
                            && (request.resource.data.keys().hasOnly(['name', 'username', 'bio', 'lastActive', 'lastDailyCreditClaim', 'processedBookActions'])
                                || (request.resource.data.keys().hasAll(['credits', 'booksDownloadedCount']) && resource.data.credits - request.resource.data.credits == 30) // Book download transaction
                                || (request.resource.data.keys().hasAll(['points']) && resource.data.points - request.resource.data.points > 0) // Withdrawal transaction (points decrement)
                                || (request.resource.data.keys().has('totalFeedbackGiven') && request.resource.data.totalFeedbackGiven == resource.data.totalFeedbackGiven + 1) // Feedback given
                                || (request.resource.data.keys().has('booksSharedCount') && request.resource.data.booksSharedCount == resource.data.booksSharedCount + 1) // Book shared
                                || (request.resource.data.keys().hasAll(['points', 'totalBookDownloads']) && request.resource.data.points == resource.data.points + 1 && request.resource.data.totalBookDownloads == resource.data.totalBookDownloads + 1) // Book owner gets point for download
                                || (request.resource.data.keys().hasAll(['points', 'processedBookActions']) && request.resource.data.points == resource.data.points + 10) // Book approval points
                                || (request.resource.data.keys().hasAll(['credits', 'lastDailyCreditClaim']) && request.resource.data.credits == resource.data.credits + 20) // Daily credit claim
                            );
                            // Points increment for book sharing (approval), book download (owner) should be handled by trusted logic (e.g. Cloud Functions or careful transactions)
                            // Credit decrement for download, daily credit claim can be allowed with validation.
            }

            // --- Books Collection ---
            match /books/{bookId} {
              allow read: if isAuthenticated() && (resource.data.status == 'approved' || resource.data.submittedBy == request.auth.uid || isAdmin());
              allow create: if isAuthenticated()
                            && request.resource.data.submittedBy == request.auth.uid
                            && request.resource.data.status == 'pending'
                            && request.resource.data.downloads == 0
                            && request.resource.data.ratingCount == 0
                            && request.resource.data.avgRating == 0
                            && request.resource.data.bookName is string && request.resource.data.bookName.size() > 0 && request.resource.data.bookName.size() < 150
                            && request.resource.data.authorName is string && request.resource.data.authorName.size() > 0 && request.resource.data.authorName.size() < 100
                            && request.resource.data.category is string && request.resource.data.category.size() > 0 && request.resource.data.category.size() < 50
                            && request.resource.data.imageUrl is string && request.resource.data.imageUrl.matches('https?://.+')
                            && request.resource.data.driveLink is string && request.resource.data.driveLink.matches('https?://.+')
                            && request.resource.data.description is string && request.resource.data.description.size() < 1000
                            && request.resource.data.submittedAt == request.time;

              // For book download increment:
              allow update (writeFields: ['downloads']): if isAuthenticated()
                                                        && request.resource.data.downloads == resource.data.downloads + 1;
              // For rating updates (done via transaction, needs to be reflected here):
              allow update (writeFields: ['ratingCount', 'avgRating']): if isAuthenticated()
                                                                    && request.resource.data.ratingCount == resource.data.ratingCount + 1;

              // Admin can update status and admin-specific fields
              allow update: if isAdmin() && request.resource.data.keys().hasAny(['status', 'approvedAt', 'reviewedAt', 'reviewedBy', 'rejectionReason', 'adminNotes']);
            }

            // --- Feedback Subcollection ---
            match /books/{bookId}/feedback/{feedbackId} {
              allow read: if isAuthenticated();
              allow create: if isAuthenticated()
                            && request.resource.data.userId == request.auth.uid
                            && request.resource.data.rating >= 1 && request.resource.data.rating <= 5
                            && request.resource.data.comment is string && request.resource.data.comment.size() < 500
                            && request.resource.data.submittedAt == request.time;
              // No updates/deletes for feedback by users for simplicity
            }

            // --- Withdrawals Collection ---
            match /withdrawals/{withdrawalId} {
              allow read: if isOwner(resource.data.userId) || isAdmin();
              allow create: if isAuthenticated()
                            && request.resource.data.userId == request.auth.uid
                            && request.resource.data.status == 'pending'
                            && request.resource.data.pointsWithdrawn > 0 && request.resource.data.pointsWithdrawn <= get(/databases/$(database)/documents/users/$(request.auth.uid)).data.points // Check against current points, transaction handles actual deduction
                            && request.resource.data.amountRs > 0
                            && request.resource.data.method is string
                            && request.resource.data.paymentIdentifier is string
                            && request.resource.data.requestedAt == request.time;
              // Admin can update status and processing details
              allow update: if isAdmin() && request.resource.data.keys().hasAny(['status', 'processedAt', 'adminNotes']);
            }

            // --- User Notifications Subcollection ---
            match /users/{userId}/notifications/{notificationId} {
              allow read: if isOwner(userId);
              // Notifications are created server-side (e.g., Cloud Functions) or via trusted client actions during specific events.
              // For client-created notifications during specific events (e.g., profile update):
              allow create: if isOwner(userId) // If client needs to create some simple notifications
                            && request.resource.data.timestamp == request.time
                            && request.resource.data.read == false;
              allow update (writeFields: ['read']): if isOwner(userId) && request.resource.data.read == true; // Only allow marking as read
            }

            // --- Admin Announcements Collection ---
            match /adminAnnouncements/{announcementId} {
              allow read: if isAuthenticated(); // All authenticated users can read
              allow write: if isAdmin(); // Only admins can create/update/delete announcements
            }

            // Deny all other access by default
            // match /{document=**} {
            //  allow read, write: if false;
            // }
          }
        }
        */
    </script>
</body>
</html>